!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):((e="undefined"!=typeof globalThis?globalThis:e||self).core=e.core||{},e.core.min=t())}(this,(function(){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};function t(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}var n=function(){return(n=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function r(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){e.done?o(e.value):new n((function(t){t(e.value)})).then(s,a)}c((r=r.apply(e,t||[])).next())}))}function o(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}function i(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var r=Array(e),o=0;for(t=0;t<n;t++)for(var i=arguments[t],s=0,a=i.length;s<a;s++,o++)r[o]=i[s];return r}var s=1,a=2,c=3,u=4;function d(e){return e.type===c?"timestamp":e.type===a?"number":e.type===s?"string":e.type===u?"object":"unknown"}function p(e){return e.constructor===Date?"timestamp":"number"==typeof e?"number":"string"==typeof e?"string":"object"==typeof e?"object":"string"}function h(e){var t={},n=d(e);if("object"===n){var r=Object.keys(e.value).reduce((function(t,n){var r=p(e.value[n]);if("object"===r){var o=function e(t){return Object.keys(t).reduce((function(n,r){var o=p(t[r]);return n[r]="object"===o?{type:"object",description:"",context:{},composite:e(t[r])}:{type:o,description:"",context:{}},n}),{})}(e.value[n]);t[n]={type:"object",description:"",context:{},composite:o}}else t[n]={type:r,description:"",context:{}};return t}),{});t.composite=r}return t.name=l(e.path.join("/")+"/"+e.name),t.type=n,t.description=e.description,t.context={},t}function l(e){return void 0!==e&&e.length>0&&"/"!==e[0]?"/"+e:e}function f(e){return"timestamp"===d(e)?Date.now():function e(t){if("object"!=typeof t)return t;return Object.keys(t).reduce((function(n,r){var o=t[r];return"object"==typeof o&&o.constructor!==Date?n[r]=e(o):o.constructor===Date?n[r]=new Date(o).getTime():o.constructor===Boolean?n[r]=o.toString():n[r]=o,n}),{})}(e.value)}function g(e){var t=function e(t){return t.reduce((function(t,n){return t.concat(Array.isArray(n)?e(n):n)}),[])}(e.root.getAggregateState()),n=t.sort((function(e,t){return e.state?t.state?t.state-e.state:-1:1}))[0];return{description:function(e){var t="";return e.forEach((function(e,n,r){var o=e.path.join(".");n===r.length-1?t+=o+"."+e.name+": "+e.description:t+=o+"."+e.name+": "+e.description+","})),t.length>100?t.slice(0,100)+"...":t}(t),value:n.state}}var m=function(e,t,n){if(null===e||"object"!=typeof e)throw new Error("Missing definition");if(null===t||"object"!=typeof t)throw new Error("Missing parent");if(null===n||"object"!=typeof n)throw new Error("Missing transport")},v=function(){function e(e,t,n,r,o){this.definition=e,this.system=t,this.transport=n,this.value=r,this.type=o,this.path=[],m(e,t,n),this.path=t.path.slice(0),this.path.push(t.name),this.name=e.name,this.description=e.description,n.createMetric(this)}return Object.defineProperty(e.prototype,"repo",{get:function(){var e;return null===(e=this.system)||void 0===e?void 0:e.repo},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"id",{get:function(){return this.system.path+"/"+name},enumerable:!0,configurable:!0}),e.prototype.update=function(e){return this.value=e,this.transport.updateMetric(this)},e}(),y=function(e){function n(t,n,r,o){return e.call(this,t,n,r,o,a)||this}return t(n,e),n.prototype.incrementBy=function(e){this.update(this.value+e)},n.prototype.increment=function(){this.incrementBy(1)},n.prototype.decrement=function(){this.incrementBy(-1)},n.prototype.decrementBy=function(e){this.incrementBy(-1*e)},n}(v),b=function(e){function n(t,n,r,o){return e.call(this,t,n,r,o,u)||this}return t(n,e),n.prototype.update=function(e){return this.mergeValues(e),this.transport.updateMetric(this)},n.prototype.mergeValues=function(e){var t=this;return Object.keys(this.value).forEach((function(n){void 0!==e[n]&&(t.value[n]=e[n])}))},n}(v),w=function(e){function n(t,n,r,o){return e.call(this,t,n,r,o,s)||this}return t(n,e),n}(v),S=function(e){function n(t,n,r,o){return e.call(this,t,n,r,o,c)||this}return t(n,e),n.prototype.now=function(){this.update(new Date)},n}(v);var _=function(){function e(e,t){t.init(this),this.root=function e(t,n,r,o,i){if(!n)throw new Error("Repository is required");if(!r)throw new Error("Transport is required");var d,p,h=r,l=t,f=i||"",g=n,m=o,v=function e(t){if(!t||!t.parent)return[];var n=e(t.parent);return n.push(t.name),n}(o),_={},k=(p="/",((d=v)&&d.length>0?d.join(p):"")+t),I=n.root,M=[],x=[];function T(e,t,n,r){var o={name:""};o="string"==typeof e?{name:e}:e;var i=x.filter((function(e){return e.name===o.name}));if(i.length>0){var s=i[0];if(s.type!==t)throw new Error("A metric named "+o.name+" is already defined with different type.");return void 0!==n&&s.update(n).catch((function(){})),s}var a=r(o);return x.push(a),a}var j={get name(){return l},get description(){return f},get repo(){return g},get parent(){return m},path:v,id:k,root:I,get subSystems(){return M},get metrics(){return x},subSystem:function(t,n){if(!t||0===t.length)throw new Error("name is required");var r=M.filter((function(e){return e.name===t}));if(r.length>0)return r[0];var o=e(t,g,h,j,n);return M.push(o),o},getState:function(){return _},setState:function(e,t){_={state:e,description:t},h.updateSystem(j,_)},stringMetric:function(e,t){return T(e,s,t,(function(e){return new w(e,j,h,t)}))},timestampMetric:function(e,t){return T(e,c,t,(function(e){return new S(e,j,h,t)}))},objectMetric:function(e,t){return T(e,u,t,(function(e){return new b(e,j,h,t)}))},numberMetric:function(e,t){return T(e,a,t,(function(e){return new y(e,j,h,t)}))},getAggregateState:function(){var e=[];return Object.keys(_).length>0&&e.push({name:l,path:v,state:_.state,description:_.description}),M.forEach((function(t){var n=t.getAggregateState();n.length>0&&e.push.apply(e,n)})),e}};return h.createSystem(j),j}("",this,t),this.addSystemMetrics(this.root,e.clickStream||void 0===e.clickStream)}return e.prototype.addSystemMetrics=function(e,t){if("undefined"!=typeof navigator&&e.stringMetric("UserAgent",navigator.userAgent),t&&"undefined"!=typeof document){var n=e.subSystem("ClickStream"),r=function(e){if(e.target){var t=e.target;n.objectMetric("LastBrowserEvent",{type:"click",timestamp:new Date,target:{className:e.target?t.className:"",id:t.id,type:"<"+t.tagName.toLowerCase()+">",href:t.href||""}})}};n.objectMetric("Page",{title:document.title,page:window.location.href}),document.addEventListener?document.addEventListener("click",r):document.attachEvent("onclick",r)}e.stringMetric("StartTime",(new Date).toString());var o=e.stringMetric("StartURL",""),i=e.stringMetric("AppName","");if("undefined"!=typeof window){if(void 0!==window.location){var s=window.location.href;o.update(s)}void 0!==window.glue42gd&&i.update(window.glue42gd.appName)}},e}(),k=function(){function e(){}return e.prototype.init=function(e){},e.prototype.createSystem=function(e){return Promise.resolve()},e.prototype.updateSystem=function(e,t){return Promise.resolve()},e.prototype.createMetric=function(e){return Promise.resolve()},e.prototype.updateMetric=function(e){return Promise.resolve()},e}(),I=function(){function e(e,t,n){this.api=e,this.lastCount=0,this.initialPublishTimeout=1e4,this.publishInterval=6e4,this.initialPublishTimeout=null!=t?t:this.initialPublishTimeout,this.publishInterval=null!=n?n:this.publishInterval,this.scheduleCollection(),this.system=this.api.subSystem("performance","Performance data published by the web application")}return e.prototype.scheduleCollection=function(){var e=this;setTimeout((function(){e.collect(),setInterval((function(){e.collect()}),e.publishInterval)}),this.initialPublishTimeout)},e.prototype.collect=function(){try{this.collectMemory(),this.collectEntries()}catch(e){}},e.prototype.collectMemory=function(){var e=window.performance.memory;this.system.stringMetric("memory",JSON.stringify({totalJSHeapSize:e.totalJSHeapSize,usedJSHeapSize:e.usedJSHeapSize}))},e.prototype.collectEntries=function(){var e=window.performance.getEntries();if(!(e.length<=this.lastCount)){this.lastCount=e.length;var t=e.map((function(e){return e.toJSON()}));this.system.stringMetric("entries",JSON.stringify(t))}},e}(),M=function(e){var t;t=e.connection&&"object"==typeof e.connection?function(e,t){var i,s,a=this;if(!e||"object"!=typeof e)throw new Error("Connection is required parameter");var c=function(e){u(e.root)},u=function(e){d(e),e.metrics.forEach((function(e){p(e)})),e.subSystems.forEach((function(e){u(e)}))},d=function(e){return r(a,void 0,void 0,(function(){var t,n;return o(this,(function(r){switch(r.label){case 0:return void 0===e.parent?[2]:[4,i];case 1:return r.sent(),t={name:l(e.path.join("/")+"/"+e.name+"/State"),type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}},n={type:"define",metrics:[t]},s.send(n),[2]}}))}))},p=function(e){return r(a,void 0,void 0,(function(){var t,n,r;return o(this,(function(o){switch(o.label){case 0:return t=v(e),[4,i];case 1:return o.sent(),n=h(t),r={type:"define",metrics:[n]},s.send(r),void 0!==t.value&&m(t),[2]}}))}))},m=function(e){if(y()){var t=f(e),n={type:"publish",values:[{name:l(e.path.join("/")+"/"+e.name),value:t,timestamp:Date.now()}]};return s.sendFireAndForget(n)}return Promise.resolve()},v=function(e){var t=n({},e);return"object"==typeof e.value&&null!==e.value&&(t.value=n({},e.value)),t},y=function(){var e;try{return(null!==(e=t.canUpdateMetric)&&void 0!==e?e:function(){return!0})()}catch(e){return!0}};return{init:function(n){var r;i=new Promise((function(e){r=e})),(s=e.domain("metrics")).onJoined((function(e){!e&&r&&(r(),r=void 0);var t={type:"define",metrics:[{name:"/State",type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};s.send(t),e&&c(n)})),s.join({system:t.system,service:t.service,instance:t.instance})},createSystem:d,updateSystem:function(t,n){return r(a,void 0,void 0,(function(){var r,a,c;return o(this,(function(o){switch(o.label){case 0:return[4,i];case 1:return o.sent(),r={type:"publish",values:[{name:l(t.path.join("/")+"/"+t.name+"/State"),value:{Description:n.description,Value:n.state},timestamp:Date.now()}]},s.send(r),a=g(t),c={type:"publish",peer_id:e.peerId,values:[{name:"/State",value:{Description:a.description,Value:a.value},timestamp:Date.now()}]},s.send(c),[2]}}))}))},createMetric:p,updateMetric:function(e){return r(a,void 0,void 0,(function(){var t;return o(this,(function(n){switch(n.label){case 0:return t=v(e),[4,i];case 1:return n.sent(),m(t),[2]}}))}))}}}(e.connection,e):new k;var i=new _(e,t).root;e.disableAutoAppSystem||(i=i.subSystem("App"));var s=function(e){var t,n=e.subSystem("reporting"),r={name:"features"},o=function(e,o,i){if(void 0===e||""===e)throw new Error("name is mandatory");if(void 0===o||""===o)throw new Error("action is mandatory");if(void 0===i||""===i)throw new Error("payload is mandatory");t?t.update({name:e,action:o,payload:i}):t=n.objectMetric(r,{name:e,action:o,payload:i})};return e.featureMetric=o,e}(i);return function(e,t){var n,r;if("undefined"==typeof window)return;var o=null===(r=null===(n=null===window||void 0===window?void 0:window.glue42gd)||void 0===n?void 0:n.metrics)||void 0===r?void 0:r.pagePerformanceMetrics;o&&(t=o);(null==t?void 0:t.enabled)&&new I(e,t.initialPublishTimeout,t.publishInterval)}(s,e.pagePerformanceMetrics),s};function x(e){if(e&&e.errorHandling&&"function"!=typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"==typeof e.errorHandling&&e.errorHandling,n={};function r(n,r){var o=n instanceof Error?n:new Error(n);if(t)t(o);else{var i='[ERROR] callback-registry: User callback for key "'+r+'" failed: '+o.stack;if(e)switch(e.errorHandling){case"log":return console.error(i);case"silent":return;case"throw":throw new Error(i)}console.error(i)}}return{add:function(e,t,o){var i=n[e];return i||(i=[],n[e]=i),i.push(t),o&&setTimeout((function(){o.forEach((function(o){var i;if(null===(i=n[e])||void 0===i?void 0:i.includes(t))try{Array.isArray(o)?t.apply(void 0,o):t.apply(void 0,[o])}catch(t){r(t,e)}}))}),0),function(){var r=n[e];r&&(0===(r=r.reduce((function(e,n,r){return n===t&&e.length===r||e.push(n),e}),[])).length?delete n[e]:n[e]=r)}},execute:function(e){for(var t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];var i=n[e];if(!i||0===i.length)return[];var s=[];return i.forEach((function(n){try{var o=n.apply(void 0,t);s.push(o)}catch(t){s.push(void 0),r(t,e)}})),s},clear:function(){n={}},clearKey:function(e){n[e]&&delete n[e]}}}x.default=x;var T=x,j=function(){function e(e,t){var n=this;this.registry=T(),this.gw=e.facade,this.gw.connect((function(e,t){n.messageHandler(t)})).then((function(e){n.client=e}))}return Object.defineProperty(e.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),e.prototype.sendObject=function(e){return this.client?(this.client.send(e),Promise.resolve(void 0)):Promise.reject("not connected")},e.prototype.send=function(e){return Promise.reject("not supported")},e.prototype.onMessage=function(e){return this.registry.add("onMessage",e)},e.prototype.onConnectedChanged=function(e){e(!0)},e.prototype.close=function(){return Promise.resolve()},e.prototype.open=function(){return Promise.resolve()},e.prototype.name=function(){return"in-memory"},e.prototype.reconnect=function(){return Promise.resolve()},e.prototype.messageHandler=function(e){this.registry.execute("onMessage",e)},e}(),P=function(){function e(e,t){var n=this;this.logger=t,this.registry=T(),this.worker=new SharedWorker(e),this.worker.port.onmessage=function(e){n.messageHandler(e.data)}}return Object.defineProperty(e.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),e.prototype.sendObject=function(e){return this.worker.port.postMessage(e),Promise.resolve()},e.prototype.send=function(e){return Promise.reject("not supported")},e.prototype.onMessage=function(e){return this.registry.add("onMessage",e)},e.prototype.onConnectedChanged=function(e){e(!0)},e.prototype.close=function(){return Promise.resolve()},e.prototype.open=function(){return Promise.resolve()},e.prototype.name=function(){return"shared-worker"},e.prototype.reconnect=function(){return Promise.resolve()},e.prototype.messageHandler=function(e){this.registry.execute("onMessage",e)},e}(),C=function(){function e(){}return e.getGDMajorVersion=function(){if("undefined"!=typeof window&&window.glueDesktop&&window.glueDesktop.version){var e=Number(window.glueDesktop.version.substr(0,1));return isNaN(e)?void 0:e}},e.isNode=function(){if(void 0!==e._isNode)return e._isNode;if("undefined"!=typeof window)return e._isNode=!1,!1;try{e._isNode="[object process]"===Object.prototype.toString.call(global.process)}catch(t){e._isNode=!1}return e._isNode},e}(),R=function(){function e(){var e=this;this.rejected=!1,this.resolved=!1,this.promise=new Promise((function(t,n){e.resolve=function(n){e.resolved=!0,t(n)},e.reject=function(t){e.rejected=!0,n(t)}}))}return e.delay=function(e){return new Promise((function(t){return setTimeout(t,e)}))},Object.defineProperty(e.prototype,"ended",{get:function(){return this.rejected||this.resolved},enumerable:!0,configurable:!0}),e}(),O={};function A(e){var t=O[e];if(t)return t;var n=[];function r(){return(new Date).getTime()}var o,i,s=r();function a(e,t){var o=null!=t?t:r(),i=0;n.length>0&&(i=o-n[n.length-1].time),n.push({name:e,time:o,diff:i})}a("start",s);var c={get startTime(){return s},get endTime(){return o},get period(){return i},stop:function(){return a("end",o=r()),i=o-s},mark:a,marks:n};return O[e]=c,c}var N=C.isNode()?require("ws"):window.WebSocket,E=function(){function e(e,t){if(this.startupTimer=A("connection"),this._running=!0,this._registry=T(),this.wsRequests=[],this.settings=e,this.logger=t,!this.settings.ws)throw new Error("ws is missing")}return e.prototype.onMessage=function(e){return this._registry.add("onMessage",e)},e.prototype.send=function(e,t){var n=this;return new Promise((function(t,r){n.waitForSocketConnection((function(){var o;try{null===(o=n.ws)||void 0===o||o.send(e),t()}catch(e){r(e)}}),r)}))},e.prototype.open=function(){var e=this;return this.logger.info("opening ws..."),this._running=!0,new Promise((function(t,n){e.waitForSocketConnection(t,n)}))},e.prototype.close=function(){return this._running=!1,this.ws&&this.ws.close(),Promise.resolve()},e.prototype.onConnectedChanged=function(e){return this._registry.add("onConnectedChanged",e)},e.prototype.name=function(){return"ws "+this.settings.ws},e.prototype.reconnect=function(){var e;null===(e=this.ws)||void 0===e||e.close();var t=new R;return this.waitForSocketConnection((function(){t.resolve()})),t.promise},e.prototype.waitForSocketConnection=function(e,t){var n;t=null!=t?t:function(){},this._running?1!==(null===(n=this.ws)||void 0===n?void 0:n.readyState)?(this.wsRequests.push({callback:e,failed:t}),this.wsRequests.length>1||this.openSocket()):e():t("wait for socket on "+this.settings.ws+" failed - socket closed by user")},e.prototype.openSocket=function(e,t){return r(this,void 0,void 0,(function(){var n=this;return o(this,(function(r){switch(r.label){case 0:if(this.startupTimer.mark("opening-socket"),void 0===e&&(e=this.settings.reconnectInterval),void 0!==t){if(0===t)return this.notifyForSocketState("wait for socket on "+this.settings.ws+" failed - no more retries left"),[2];this.logger.debug("will retry "+t+" more times (every "+e+" ms)")}r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.initiateSocket()];case 2:return r.sent(),this.startupTimer.mark("socket-initiated"),this.notifyForSocketState(),[3,4];case 3:return r.sent(),setTimeout((function(){var r=void 0===t?void 0:t-1;n.openSocket(e,r)}),e),[3,4];case 4:return[2]}}))}))},e.prototype.initiateSocket=function(){var e=this,t=new R;return this.logger.debug("initiating ws to "+this.settings.ws+"..."),this.ws=new N(this.settings.ws||""),this.ws.onerror=function(n){var r="";try{r=JSON.stringify(n)}catch(e){var o=new WeakSet;r=JSON.stringify(n,(function(e,t){if("object"==typeof t&&null!==t){if(o.has(t))return;o.add(t)}return t}))}t.reject("error"),e.notifyStatusChanged(!1,r)},this.ws.onclose=function(n){e.logger.info("ws closed "+n),t.reject("closed"),e.notifyStatusChanged(!1)},this.ws.onopen=function(){var n;e.startupTimer.mark("ws-opened"),e.logger.info("ws opened "+(null===(n=e.settings.identity)||void 0===n?void 0:n.application)),t.resolve(),e.notifyStatusChanged(!0)},this.ws.onmessage=function(t){e._registry.execute("onMessage",t.data)},t.promise},e.prototype.notifyForSocketState=function(e){this.wsRequests.forEach((function(t){e?t.failed&&t.failed(e):t.callback()})),this.wsRequests=[]},e.prototype.notifyStatusChanged=function(e,t){this._registry.execute("onConnectedChanged",e,t)},e}();var L=1;var D,q,F,U={nextValue:function(){return(L=(9301*L+49297)%233280)/233280},seed:function(e){L=e}},B="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function J(){F=!1}function V(e){if(e){if(e!==D){if(e.length!==B.length)throw new Error("Custom alphabet for shortid must be "+B.length+" unique characters. You submitted "+e.length+" characters: "+e);var t=e.split("").filter((function(e,t,n){return t!==n.lastIndexOf(e)}));if(t.length)throw new Error("Custom alphabet for shortid must be "+B.length+" unique characters. These characters were not unique: "+t.join(", "));D=e,J()}}else D!==B&&(D=B,J())}function H(){return F||(F=function(){D||V(B);for(var e,t=D.split(""),n=[],r=U.nextValue();t.length>0;)r=U.nextValue(),e=Math.floor(r*t.length),n.push(t.splice(e,1)[0]);return n.join("")}())}var W={characters:function(e){return V(e),D},seed:function(e){U.seed(e),q!==e&&(J(),q=e)},lookup:function(e){return H()[e]},shuffled:H},K="object"==typeof window&&(window.crypto||window.msCrypto);var G=function(){if(!K||!K.getRandomValues)return 48&Math.floor(256*Math.random());var e=new Uint8Array(1);return K.getRandomValues(e),48&e[0]};var z=function(e,t){for(var n,r=0,o="";!n;)o+=e(t>>4*r&15|G()),n=t<Math.pow(16,r+1),r++;return o};var Y=function(e){var t=W.shuffled();return{version:15&t.indexOf(e.substr(0,1)),worker:15&t.indexOf(e.substr(1,1))}};var X=function(e){if(!e||"string"!=typeof e||e.length<6)return!1;for(var t=W.characters(),n=e.length,r=0;r<n;r++)if(-1===t.indexOf(e[r]))return!1;return!0},Q=function(e,t){return e(t={exports:{}},t.exports),t.exports}((function(e){var t,n,r=0;function o(){var e="",o=Math.floor(.001*(Date.now()-1459707606518));return o===n?t++:(t=0,n=o),e+=z(W.lookup,6),e+=z(W.lookup,r),t>0&&(e+=z(W.lookup,t)),e+=z(W.lookup,o)}e.exports=o,e.exports.generate=o,e.exports.seed=function(t){return W.seed(t),e.exports},e.exports.worker=function(t){return r=t,e.exports},e.exports.characters=function(e){return void 0!==e&&W.characters(e),W.shuffled()},e.exports.decode=Y,e.exports.isValid=X})),Z=(Q.generate,Q.seed,Q.worker,Q.characters,Q.decode,Q.isValid,Q);function $(e,t,n,r,o){null==e&&(e="global"),r=r||["success"],o=o||["error"];var i,s=!1,a=!1,c=!1,u=T();t.disconnected((function(){c=!1,n.debug("connection is down"),s=!1,a=!0,u.execute("onLeft",{disconnected:!0})})),t.loggedIn((function(){c=!0,a&&(n.debug("connection is now up - trying to reconnect..."),p(i))})),t.on("success",(function(e){return l(e)})),t.on("error",(function(e){return h(e)})),t.on("result",(function(e){return l(e)})),r&&r.forEach((function(e){t.on(e,(function(e){return l(e)}))})),o&&o.forEach((function(e){t.on(e,(function(e){return h(e)}))}));var d={};function p(t){return i=t,new Promise((function(r,o){if(s)r();else{var i;if("global"===e)i=c?Promise.resolve({}):Promise.reject("not connected to gateway");else n.debug("joining domain "+e),i=g({type:"join",destination:e,domain:"global",options:t});i.then((function(){!function(){n.debug("did join "+e),s=!0;var t=a;a=!1,u.execute("onJoined",t)}(),r()})).catch((function(t){n.debug("error joining "+e+" domain: "+JSON.stringify(t)),o(t)}))}}))}function h(t){if(e===t.domain){var n=t.request_id;if(n){var r=d[n];r&&r.error(t)}}}function l(t){if(t.domain===e){var n=t.request_id;if(n){var r=d[n];r&&r.success(t)}}}function f(){return Z()}function g(r,o,i){i=i||{},r.request_id=r.request_id||f(),r.domain=r.domain||e,i.skipPeerId||(r.peer_id=t.peerId);var s=r.request_id;return new Promise((function(e,a){d[s]={success:function(t){delete d[s],t._tag=o,e(t)},error:function(e){n.warn("GW error - "+JSON.stringify(e)+" for request "+JSON.stringify(r)),delete d[s],e._tag=o,a(e)}},t.send(r,i).catch((function(e){d[s].error({err:e})}))}))}return{join:p,leave:function(){return"global"===e?Promise.resolve():(n.debug("stopping session "+e+"..."),a=!1,g({type:"leave",destination:e,domain:"global"}).then((function(){s=!1,u.execute("onLeft")})))},onJoined:function(e){return s&&e(!1),u.add("onJoined",e)},onLeft:function(e){return s||e(),u.add("onLeft",e)},send:g,sendFireAndForget:function(n){return n.request_id=n.request_id?n.request_id:f(),n.domain=n.domain||e,n.peer_id=t.peerId,t.send(n)},on:function(r,o){t.on(r,(function(t){if(t.domain===e)try{o(t)}catch(e){n.error("Callback  failed: "+e+" \n "+e.stack+" \n msg was: "+JSON.stringify(t),e)}}))},loggedIn:function(e){return t.loggedIn(e)},connected:function(e){return t.connected(e)},disconnected:function(e){return t.disconnected(e)},get peerId(){return t.peerId},get domain(){return e}}}var ee=function(){function e(e,t,n){var r=this;this.connection=e,this.settings=t,this.logger=n,this.protocolVersion=3,this.datePrefix="#T42_DATE#",this.datePrefixLen=this.datePrefix.length,this.dateMinLen=this.datePrefixLen+1,this.datePrefixFirstChar=this.datePrefix[0],this.registry=T(),this._isLoggedIn=!1,this.shouldTryLogin=!0,this.initialLogin=!0,this.initialLoginAttempts=3,this.sessions=[],e.disconnected((function(){r.handleDisconnected()})),this.ping()}return Object.defineProperty(e.prototype,"isLoggedIn",{get:function(){return this._isLoggedIn},enumerable:!0,configurable:!0}),e.prototype.processStringMessage=function(e){var t=this,n=JSON.parse(e,(function(e,n){if("string"!=typeof n)return n;if(n.length<t.dateMinLen)return n;if(n[0]!==t.datePrefixFirstChar)return n;if(n.substring(0,t.datePrefixLen)!==t.datePrefix)return n;try{var r=parseInt(n.substring(t.datePrefixLen,n.length),10);return isNaN(r)?n:new Date(r)}catch(e){return n}}));return{msg:n,msgType:n.type}},e.prototype.createStringMessage=function(e){var t=Date.prototype.toJSON;try{var n=this.datePrefix;return Date.prototype.toJSON=function(){return n+this.getTime()},JSON.stringify(e)}finally{Date.prototype.toJSON=t}},e.prototype.processObjectMessage=function(e){if(!e.type)throw new Error("Object should have type property");return{msg:e,msgType:e.type}},e.prototype.createObjectMessage=function(e){return e},e.prototype.login=function(e,t){return r(this,void 0,void 0,(function(){var n,r,i,s,a,c,u,d,p,h;return o(this,(function(o){switch(o.label){case 0:if(this.logger.debug("logging in..."),this.loginConfig=e,this.loginConfig||(this.loginConfig={username:"",password:""}),this.shouldTryLogin=!0,n={},this.connection.gatewayToken=e.gatewayToken,!e.gatewayToken)return[3,5];if(!t)return[3,4];o.label=1;case 1:return o.trys.push([1,3,,4]),[4,this.getNewGWToken()];case 2:return d=o.sent(),e.gatewayToken=d,[3,4];case 3:return r=o.sent(),this.logger.warn("failed to get GW token when reconnecting "+((null==r?void 0:r.message)||r)),[3,4];case 4:return n.method="gateway-token",n.token=e.gatewayToken,this.connection.gatewayToken=e.gatewayToken,[3,10];case 5:return"sspi"!==e.flowName?[3,9]:(n.provider="win",n.method="access-token",e.flowCallback&&e.sessionId?(i=n,[4,e.flowCallback(e.sessionId,null)]):[3,7]);case 6:return i.token=o.sent().data.toString("base64"),[3,8];case 7:throw new Error("Invalid SSPI config");case 8:return[3,10];case 9:if(e.token)n.method="access-token",n.token=e.token;else{if(!e.username)throw new Error("invalid auth message"+JSON.stringify(e));n.method="secret",n.login=e.username,n.secret=e.password}o.label=10;case 10:s={type:"hello",identity:this.settings.identity,authentication:n},e.sessionId&&(s.request_id=e.sessionId),this.globalDomain=$("global",this.connection,this.logger.subLogger("global-domain"),["welcome","token","authentication-request"]),a={skipPeerId:!0},this.initialLogin&&(a.retryInterval=this.settings.reconnectInterval,a.maxRetries=this.settings.reconnectAttempts),o.label=11;case 11:o.trys.push([11,19,20,21]),c=void 0,o.label=12;case 12:return[4,this.globalDomain.send(s,void 0,a)];case 13:return"authentication-request"!==(u=o.sent()).type?[3,16]:(d=Buffer.from(u.authentication.token,"base64"),e.flowCallback&&e.sessionId?(p=s.authentication,[4,e.flowCallback(e.sessionId,d)]):[3,15]);case 14:p.token=o.sent().data.toString("base64"),o.label=15;case 15:return s.request_id=e.sessionId,[3,12];case 16:if("welcome"===u.type)return c=u,[3,18];throw"error"===u.type?new Error("Authentication failed: "+u.reason):new Error("Unexpected message type during authentication: "+u.type);case 17:return[3,12];case 18:return this.initialLogin=!1,this.logger.debug("login successful with peerId "+c.peer_id),this.connection.peerId=c.peer_id,this.connection.resolvedIdentity=c.resolved_identity,this.connection.availableDomains=c.available_domains,c.options&&(this.connection.token=c.options.access_token,this.connection.info=c.options.info),this.setLoggedIn(!0),[2,c.resolved_identity];case 19:throw h=o.sent(),this.logger.error("error sending hello message - "+(h.message||h.msg||h.reason||h),h),h;case 20:return e&&e.flowCallback&&e.sessionId&&e.flowCallback(e.sessionId,null),[7];case 21:return[2]}}))}))},e.prototype.logout=function(){return r(this,void 0,void 0,(function(){var e;return o(this,(function(t){switch(t.label){case 0:return this.logger.debug("logging out..."),this.shouldTryLogin=!1,this.pingTimer&&clearTimeout(this.pingTimer),e=this.sessions.map((function(e){e.leave()})),[4,Promise.all(e)];case 1:return t.sent(),[2]}}))}))},e.prototype.loggedIn=function(e){return this._isLoggedIn&&e(),this.registry.add("onLoggedIn",e)},e.prototype.domain=function(e,t,n,r){var o=this.sessions.filter((function(t){return t.domain===e}))[0];return o||(o=$(e,this.connection,t,n,r),this.sessions.push(o)),o},e.prototype.handleDisconnected=function(){var e=this;if(this.setLoggedIn(!1),this.shouldTryLogin&&this.initialLogin){if(this.initialLoginAttempts<=0)return;this.initialLoginAttempts--}if(this.logger.debug("disconnected - will try new login?"+this.shouldTryLogin),this.shouldTryLogin){if(!this.loginConfig)throw new Error("no login info");this.connection.login(this.loginConfig,!0).catch((function(){setTimeout(e.handleDisconnected.bind(e),e.settings.reconnectInterval||1e3)}))}},e.prototype.setLoggedIn=function(e){this._isLoggedIn=e,this._isLoggedIn&&this.registry.execute("onLoggedIn")},e.prototype.ping=function(){var e=this;this.shouldTryLogin&&(this._isLoggedIn&&this.connection.send({type:"ping"}),this.pingTimer=setTimeout((function(){e.ping()}),3e4))},e.prototype.authToken=function(){return this.globalDomain?this.globalDomain.send({type:"create-token"}).then((function(e){return e.token})):Promise.reject(new Error("no global domain session"))},e.prototype.getNewGWToken=function(){if(void 0!==typeof window){var e=window.glue42gd;if(e)return e.getGWToken()}return Promise.reject(new Error("not running in GD"))},e}(),te=function(){function e(e){this.specsNames=[],this.messages={},this.subs={},this.subsRefCount={},this.specs={};for(var t=0,n=e;t<n.length;t++){var r=n[t];this.specs[r.name]=r,this.specsNames.push(r.name)}}return e.prototype.init=function(e){var t=this;this.connection=e;for(var n=0,r=this.specsNames;n<r.length;n++)for(var o=r[n],i=function(n){var r=s.subsRefCount[n];if(r||(r=0),r+=1,s.subsRefCount[n]=r,r>1)return"continue";var o=e.on(n,(function(e){return t.processMessage(n,e)}));s.subs[n]=o},s=this,a=0,c=this.specs[o].types;a<c.length;a++){i(c[a])}},e.prototype.processMessage=function(e,t){if(!this.isDone&&t)for(var n=0,r=this.specsNames;n<r.length;n++){var o=r[n];if(-1!==this.specs[o].types.indexOf(e)){var i=this.messages[o]||[];this.messages[o]=i,i.push(t)}}},e.prototype.drain=function(e,t){var n;t&&(this.messages[e]||[]).forEach(t),delete this.messages[e];for(var r=0,o=this.specs[e].types;r<o.length;r++){var i=o[r];this.subsRefCount[i]-=1,this.subsRefCount[i]<=0&&(null===(n=this.connection)||void 0===n||n.off(this.subs[i]),delete this.subs[i],delete this.subsRefCount[i])}delete this.specs[e],this.specs.length||(this.isDone=!0)},e}(),ne=function(e,t,n){return new Promise((function(r,o){var i=setTimeout((function(){o(n||"Promise timeout hit: "+t)}),t);new Promise(e).then((function(e){clearTimeout(i),r(e)})).catch((function(e){clearTimeout(i),o(e)}))}))},re=function(){function e(e,t,n){this.settings=e,this.logger=t,this.identity=n,this.parentReady=!1,this.iAmConnected=!1,this.rejected=!1,this.children=[],this.parentPingTimeout=3e3,this.connectionRequestTimeout=5e3,this.defaultTargetString="*",this.registry=T(),this.messages={connectionAccepted:{name:"connectionAccepted",handle:this.handleConnectionAccepted.bind(this)},connectionRejected:{name:"connectionRejected",handle:this.handleConnectionRejected.bind(this)},connectionRequest:{name:"connectionRequest",handle:this.handleConnectionRequest.bind(this)},parentReady:{name:"parentReady",handle:this.handleParentReady.bind(this)},parentPing:{name:"parentPing",handle:this.handleParentPing.bind(this)},platformPing:{name:"platformPing",handle:this.handlePlatformPing.bind(this)},platformUnload:{name:"platformUnload",handle:this.handlePlatformUnload.bind(this)},platformReady:{name:"platformReady",handle:this.handlePlatformReady.bind(this)},clientUnload:{name:"clientUnload",handle:this.handleClientUnload.bind(this)},manualUnload:{name:"manualUnload",handle:this.handleManualUnload.bind(this)}},this.setUpMessageListener(),this.setUpUnload(),this.settings.port||(this.parent=window.opener||window.top,this.parentType=window.opener?"opener":-1!==window.name.indexOf("#wsp")?"workspace":"top")}return Object.defineProperty(e.prototype,"transportWindowId",{get:function(){return this.publicWindowId},enumerable:!0,configurable:!0}),e.prototype.sendObject=function(e){return r(this,void 0,void 0,(function(){return o(this,(function(t){if(!this.port)throw new Error("Cannot send message, because the port was not opened yet");return this.port.postMessage(e),[2]}))}))},Object.defineProperty(e.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),e.prototype.onMessage=function(e){return this.registry.add("onMessage",e)},e.prototype.send=function(){return Promise.reject("not supported")},e.prototype.onConnectedChanged=function(e){return this.registry.add("onConnectedChanged",e)},e.prototype.open=function(){return r(this,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return this.logger.debug("opening a connection to the web platform gateway."),[4,this.connect()];case 1:return e.sent(),this.notifyStatusChanged(!0),[2]}}))}))},e.prototype.close=function(){return Promise.resolve()},e.prototype.name=function(){return"web-platform"},e.prototype.reconnect=function(){return Promise.resolve()},e.prototype.connect=function(){return r(this,void 0,void 0,(function(){var e=this;return o(this,(function(t){switch(t.label){case 0:if(this.parentReady)return this.logger.debug("cancelling connection attempt, because this client's parent has already given a ready signal"),[2];if(this.settings.port)return this.logger.debug("opening an internal web platform connection"),this.port=this.settings.port,this.publicWindowId=this.settings.windowId,this.identity&&(this.identity.windowId=this.publicWindowId),this.port.onmessage=function(t){return e.registry.execute("onMessage",t.data)},this.logger.debug("internal web platform connection completed"),[2];if(!this.parentType||!this.parent)throw new Error("Cannot initiate a connection, because there is no opener, no top and no port.");return this.logger.debug("opening a "+("opener"===this.parentType?"child":"grandchild")+" client web platform connection"),[4,this.waitParent(this.parent,this.parentType)];case 1:return t.sent(),[4,this.initiateRemoteConnection(this.parent,this.parentType)];case 2:return t.sent(),this.logger.debug("the "+("opener"===this.parentType?"child":"grandchild")+" client is connected"),[2]}}))}))},e.prototype.initiateRemoteConnection=function(e,t){var n=this;return ne((function(r,o){n.connectionResolve=r,n.connectionReject=o,n.myClientId=Z();var i="workspace"===n.parentType?window.name.substring(0,window.name.indexOf("#wsp")):window.name,s={glue42core:{type:n.messages.connectionRequest.name,clientId:n.myClientId,clientType:"top"===t||"workspace"===t?"grandChild":"child",bridgeInstanceId:i}};n.logger.debug("sending connection request to "+t),e.postMessage(s,n.defaultTargetString)}),this.connectionRequestTimeout,"The connection to the opener/top window timed out")},e.prototype.waitParent=function(e,t){var n=this;return ne((function(r){n.parentPingResolve=r;var o={glue42core:{type:"opener"===t?n.messages.platformPing.name:n.messages.parentPing.name}};n.logger.debug("checking for "+t+" window availability"),e.postMessage(o,n.defaultTargetString)}),this.parentPingTimeout,"Cannot initiate glue, because this window was not opened or created by a glue client")},e.prototype.setUpMessageListener=function(){var e=this;this.settings.port?this.logger.debug("skipping generic message listener, because this is an internal client"):window.addEventListener("message",(function(t){var n,r=null===(n=t.data)||void 0===n?void 0:n.glue42core;if(r&&!e.rejected)if(e.checkMessageTypeValid(r.type)){var o=r.type;e.logger.debug("received valid glue42core message of type: "+o),e.messages[o].handle(t)}else e.logger.error("cannot handle the incoming glue42 core message, because the type is invalid: "+r.type)}))},e.prototype.setUpUnload=function(){var e=this;this.settings.port?this.logger.debug("skipping unload event listener, because this is an internal client"):window.addEventListener("beforeunload",(function(){var t,n,r={glue42core:{type:e.messages.clientUnload.name,data:{clientId:e.myClientId,ownWindowId:null===(t=e.identity)||void 0===t?void 0:t.windowId}}};e.parent&&e.parent.postMessage(r,e.defaultTargetString),null===(n=e.port)||void 0===n||n.postMessage(r)}))},e.prototype.handleParentReady=function(){if(this.logger.debug("handling the ready signal from the parent, by resoling the pending promise."),this.parentReady=!0,this.parentPingResolve)return this.parentPingResolve(),void delete this.parentPingResolve;this.logger.debug("silently handling the ready signal from the top parent, because there is no defined promise")},e.prototype.handlePlatformReady=function(){if(this.logger.debug("the web platform gave the ready signal"),this.parentReady=!0,this.parentPingResolve)return this.parentPingResolve(),void delete this.parentPingResolve;this.logger.debug("silently handling the ready signal from the top parent, because there is no defined promise")},e.prototype.handleConnectionAccepted=function(e){var t,n=null===(t=e.data)||void 0===t?void 0:t.glue42core;return this.myClientId===n.clientId?this.handleAcceptanceOfMyRequest(n):this.handleAcceptanceOfGrandChildRequest(n,e)},e.prototype.handleAcceptanceOfMyRequest=function(e){var t=this;if(this.logger.debug("handling a connection accepted signal targeted at me."),e.port){if(this.publicWindowId="opener"===this.parentType?window.name:"top"===this.parentType?e.parentWindowId:window.name.substring(0,window.name.indexOf("#wsp")),this.identity&&"top"!==this.parentType&&(this.identity.windowId=this.publicWindowId),this.identity&&e.appName&&(this.identity.application=e.appName,this.identity.applicationName=e.appName),this.port=e.port,this.port.onmessage=function(e){return t.registry.execute("onMessage",e.data)},this.connectionResolve)return this.logger.debug("my connection is set up, calling the connection resolve."),this.connectionResolve(),void delete this.connectionResolve;this.logger.error("unable to call the connection resolve, because no connection promise was found")}else this.logger.error("cannot set up my connection, because I was not provided with a port")},e.prototype.handleAcceptanceOfGrandChildRequest=function(e,t){this.logger.debug("handling a connection accepted signal targeted at a grandchild: "+e.clientId);var n=this.children.find((function(t){return t.grandChildId===e.clientId}));n?(n.connected=!0,this.logger.debug("the grandchild connection for "+e.clientId+" is set up, forwarding the success message and the gateway port"),e.parentWindowId=this.publicWindowId,n.source.postMessage(t.data,n.origin,[e.port])):this.logger.error("cannot handle connection accepted for grandchild: "+e.clientId+", because there is no grandchild with this id")},e.prototype.handleConnectionRejected=function(){this.logger.debug("handling a connection rejection. Most likely the reason is that this window was not created by a glue API call"),this.connectionReject&&(this.connectionReject("The platform connection was rejected. Most likely because this window was not created by a glue API call"),delete this.connectionReject)},e.prototype.handleConnectionRequest=function(e){var t=e.source,n=e.data.glue42core;return n.clientType&&"grandChild"===n.clientType?n.clientId?"opener"===this.parentType&&this.parent?(this.logger.debug("handling a connection request for a grandchild: "+n.clientId),this.children.push({grandChildId:n.clientId,source:t,connected:!1,origin:e.origin}),this.logger.debug("grandchild: "+n.clientId+" is prepared, forwarding connection request to the platform"),void this.parent.postMessage(e.data,this.defaultTargetString)):this.rejectConnectionRequest(t,e.origin,"Cannot forward the connection request, because no direct connection to the platform was found"):this.rejectConnectionRequest(t,e.origin,"rejecting a connection request, because the source did not provide a valid id"):this.rejectConnectionRequest(t,e.origin,"rejecting a connection request, because the source was not opened by a glue API call")},e.prototype.handleParentPing=function(e){if(this.parentReady)if(this.iAmConnected){var t={glue42core:{type:this.messages.parentReady.name}},n=e.source;this.logger.debug("responding to a parent ping with a ready message"),n.postMessage(t,e.origin)}else this.logger.debug("i am not fully connected yet, I am ignoring the parent ping");else this.logger.debug("my parent is not ready, I am ignoring the parent ping")},e.prototype.handlePlatformUnload=function(e){this.logger.debug("detected a web platform unload"),this.parentReady=!1,this.children.length&&(this.logger.debug("forwarding the platform unload to all known children and starting platform discovery polling"),this.children.forEach((function(t){return t.source.postMessage(e.data,t.origin)}))),this.notifyStatusChanged(!1,"Gateway unloaded")},e.prototype.handleManualUnload=function(){var e,t,n={glue42core:{type:this.messages.clientUnload.name,data:{clientId:this.myClientId,ownWindowId:null===(e=this.identity)||void 0===e?void 0:e.windowId}}};this.parent&&this.parent.postMessage(n,this.defaultTargetString),null===(t=this.port)||void 0===t||t.postMessage(n)},e.prototype.handleClientUnload=function(e){var t=e.data.glue42core,n=null==t?void 0:t.data.clientId;n?this.children.find((function(e){return e.grandChildId===n}))?(this.logger.debug("handling grandchild unload for id: "+n),this.children=this.children.filter((function(e){return e.grandChildId!==n}))):this.logger.warn("cannot process grand child unload, because this client is unaware of this grandchild"):this.logger.warn("cannot process grand child unload, because the provided id was not valid")},e.prototype.handlePlatformPing=function(){this.logger.error("cannot handle platform ping, because this is not a platform calls handling component")},e.prototype.notifyStatusChanged=function(e,t){this.iAmConnected=e,this.registry.execute("onConnectedChanged",e,t)},e.prototype.checkMessageTypeValid=function(e){return"string"==typeof e&&!!this.messages[e]},e.prototype.rejectConnectionRequest=function(e,t,n){this.rejected=!0,this.logger.error(n);var r={glue42core:{type:this.messages.connectionRejected.name}};e.postMessage(r,t)},e}(),oe=function(){function e(e,t){if(this.settings=e,this.logger=t,this.messageHandlers={},this.ids=1,this.registry=T(),this._connected=!1,this.isTrace=!1,(e=e||{}).reconnectAttempts=e.reconnectAttempts||10,e.reconnectInterval=e.reconnectInterval||1e3,e.inproc)this.transport=new j(e.inproc,t.subLogger("inMemory"));else if(e.sharedWorker)this.transport=new P(e.sharedWorker,t.subLogger("shared-worker"));else if(e.webPlatform)this.transport=new re(e.webPlatform,t.subLogger("web-platform"),e.identity);else{if(void 0===e.ws)throw new Error("No connection information specified");this.transport=new E(e,t.subLogger("ws"))}this.isTrace=t.canPublish("trace"),t.debug("starting with "+this.transport.name()+" transport"),this.protocol=new ee(this,e,t.subLogger("protocol")),this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),this.transport.onMessage(this.handleTransportMessage.bind(this)),e.replaySpecs&&e.replaySpecs.length&&(this.replayer=new te(e.replaySpecs),this.replayer.init(this))}return Object.defineProperty(e.prototype,"protocolVersion",{get:function(){var e;return null===(e=this.protocol)||void 0===e?void 0:e.protocolVersion},enumerable:!0,configurable:!0}),e.prototype.send=function(e,t){if(this.transport.sendObject&&this.transport.isObjectBasedTransport){var n=this.protocol.createObjectMessage(e);return this.isTrace&&this.logger.trace(">> "+JSON.stringify(n)),this.transport.sendObject(n,t)}var r=this.protocol.createStringMessage(e);return this.isTrace&&this.logger.trace(">> "+r),this.transport.send(r,t)},e.prototype.on=function(e,t){e=e.toLowerCase(),void 0===this.messageHandlers[e]&&(this.messageHandlers[e]={});var n=this.ids++;return this.messageHandlers[e][n]=t,{type:e,id:n}},e.prototype.off=function(e){delete this.messageHandlers[e.type.toLowerCase()][e.id]},Object.defineProperty(e.prototype,"isConnected",{get:function(){return this.protocol.isLoggedIn},enumerable:!0,configurable:!0}),e.prototype.connected=function(e){var t=this;return this.protocol.loggedIn((function(){e(t.settings.ws||t.settings.sharedWorker||"")}))},e.prototype.disconnected=function(e){return this.registry.add("disconnected",e)},e.prototype.login=function(e,t){return r(this,void 0,void 0,(function(){var n;return o(this,(function(r){switch(r.label){case 0:return[4,this.transport.open()];case 1:return r.sent(),A("connection").mark("transport-opened"),n=this.protocol.login(e,t),A("connection").mark("protocol-logged-in"),[2,n]}}))}))},e.prototype.logout=function(){return r(this,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return[4,this.protocol.logout()];case 1:return e.sent(),[4,this.transport.close()];case 2:return e.sent(),[2]}}))}))},e.prototype.loggedIn=function(e){return this.protocol.loggedIn(e)},e.prototype.domain=function(e,t,n){return this.protocol.domain(e,this.logger.subLogger("domain="+e),t,n)},e.prototype.authToken=function(){return this.protocol.authToken()},e.prototype.reconnect=function(){return this.transport.reconnect()},e.prototype.distributeMessage=function(e,t){var n=this,r=this.messageHandlers[t.toLowerCase()];void 0!==r&&Object.keys(r).forEach((function(t){var o=r[t];if(void 0!==o)try{o(e)}catch(e){try{n.logger.error("Message handler failed with "+e.stack,e)}catch(t){console.log("Message handler failed",e)}}}))},e.prototype.handleConnectionChanged=function(e){this._connected!==e&&(this._connected=e,e?this.registry.execute("connected"):this.registry.execute("disconnected"))},e.prototype.handleTransportMessage=function(e){var t;t="string"==typeof e?this.protocol.processStringMessage(e):this.protocol.processObjectMessage(e),this.isTrace&&this.logger.trace("<< "+JSON.stringify(t)),this.distributeMessage(t.msg,t.msgType)},e}(),ie=["trace","debug","info","warn","error","off"],se=function(){function e(e,t,n){this.name=e,this.parent=t,this.subLoggers=[],this.logFn=console,this.customLogFn=!1,this.name=e,this.path=t?t.path+"."+e:e,this.loggerFullName="["+this.path+"]",this.includeTimeAndLevel=!n,n&&(this.logFn=n,this.customLogFn=!0)}return e.prototype.subLogger=function(t){var n=this.subLoggers.filter((function(e){return e.name===t}))[0];if(void 0!==n)return n;Object.keys(this).forEach((function(e){if(e===t)throw new Error("This sub logger name is not allowed.")}));var r=new e(t,this,this.customLogFn?this.logFn:void 0);return this.subLoggers.push(r),r},e.prototype.publishLevel=function(e){var t;return e&&(this._publishLevel=e),this._publishLevel||(null===(t=this.parent)||void 0===t?void 0:t.publishLevel())},e.prototype.consoleLevel=function(e){var t;return e&&(this._consoleLevel=e),this._consoleLevel||(null===(t=this.parent)||void 0===t?void 0:t.consoleLevel())},e.prototype.log=function(e,t,n){this.publishMessage(t||"info",e,n)},e.prototype.trace=function(e){this.log(e,"trace")},e.prototype.debug=function(e){this.log(e,"debug")},e.prototype.info=function(e){this.log(e,"info")},e.prototype.warn=function(e){this.log(e,"warn")},e.prototype.error=function(e,t){this.log(e,"error")},e.prototype.canPublish=function(e,t){return ie.indexOf(e)>=ie.indexOf(t||this.consoleLevel()||"trace")},e.prototype.publishMessage=function(t,n,r){var o=this.loggerFullName;if("error"===t&&!r){var i=new Error;i.stack&&(n=n+"\n"+i.stack.split("\n").slice(3).join("\n"))}if(this.canPublish(t,this.publishLevel())){var s=e.Interop;if(s)try{s.methods({name:e.InteropMethodName}).length>0&&s.invoke(e.InteropMethodName,{msg:""+n,logger:o,level:t})}catch(e){}}if(this.canPublish(t)){var a="";if(this.includeTimeAndLevel){var c=new Date;a="["+(c.getHours()+":"+c.getMinutes()+":"+c.getSeconds()+":"+c.getMilliseconds())+"] ["+t+"] "}var u=""+a+o+": "+n;switch(t){case"trace":this.logFn.debug(u);break;case"debug":this.logFn.debug?this.logFn.debug(u):this.logFn.log(u);break;case"info":this.logFn.info(u);break;case"warn":this.logFn.warn(u);break;case"error":this.logFn.error(u,r)}}},e.InteropMethodName="T42.AppLogger.Log",e}(),ae="create-context",ce="created",ue="destroyed",de="context-created",pe="context-added",he="subscribe-context",le="subscribed-context",fe="unsubscribe-context",ge="destroy-context",me="context-destroyed",ve="update-context",ye="context-updated",be="joined",we={get name(){return"context"},get types(){return[ae,ce,ue,de,pe,he,le,fe,ge,me,ve,ye,be]}},Se="5.4.12";var _e=function(){function e(e,t,n,r){this.updateCallbacks={},this.contextId=e,this.name=t,this.isAnnounced=n,this.activityId=r,this.context={}}return e.prototype.hasCallbacks=function(){return Object.keys(this.updateCallbacks).length>0},e.prototype.getState=function(){return this.isAnnounced&&this.hasCallbacks()?3:this.isAnnounced?2:this.hasCallbacks()?1:0},e}();function ke(e,t,r){try{if((null==r?void 0:r.canPublish("trace"))&&(null==r||r.trace("applying context delta "+JSON.stringify(t)+" on context "+JSON.stringify(e))),!t)return e;if(t.reset)return e=n({},t.reset);if(e=Ie(e,void 0),t.commands){for(var o=0,i=t.commands;o<i.length;o++){var s=i[o];"remove"===s.type?je(e,s.path):"set"===s.type&&Te(e,s.value,s.path)}return e}var a=t.added,c=t.updated,u=t.removed;return a&&Object.keys(a).forEach((function(t){e[t]=a[t]})),c&&Object.keys(c).forEach((function(t){Me(t,e,c)})),u&&u.forEach((function(t){delete e[t]})),e}catch(n){return null==r||r.error("error applying context delta "+JSON.stringify(t)+" on context "+JSON.stringify(e),n),e}}function Ie(e,t){if(t=t||new WeakMap,Object(e)!==e)return e;if(e instanceof Set)return new Set(e);if(t.has(e))return t.get(e);var n=e instanceof Date?new Date(e):e instanceof RegExp?new RegExp(e.source,e.flags):e.constructor?new e.constructor:Object.create(null);return t.set(e,n),e instanceof Map&&Array.from(e,(function(e){var r=e[0],o=e[1];return n.set(r,Ie(o,t))})),Object.assign.apply(Object,i([n],Object.keys(e).map((function(n){var r;return(r={})[n]=Ie(e[n],t),r}))))}var Me=function(e,t,n){var r=n[e];if(void 0===r)return t;var o=t[e];return o&&r?"string"==typeof o||"number"==typeof o||"boolean"==typeof o||"string"==typeof r||"number"==typeof r||"boolean"==typeof r||Array.isArray(o)||Array.isArray(r)?(t[e]=r,t):(t[e]=Object.assign({},o,r),t):(t[e]=r,t)};function xe(e,t){if(e===t)return!0;if(!(e instanceof Object&&t instanceof Object))return!1;if(e.constructor!==t.constructor)return!1;for(var n in e)if(e.hasOwnProperty(n)){if(!t.hasOwnProperty(n))return!1;if(e[n]!==t[n]){if("object"!=typeof e[n])return!1;if(!xe(e[n],t[n]))return!1}}for(var n in t)if(t.hasOwnProperty(n)&&!e.hasOwnProperty(n))return!1;return!0}function Te(e,t,n){var r,o=n.split(".");for(r=0;r<o.length-1;r++)e[o[r]]||(e[o[r]]={}),"object"!=typeof e[o[r]]&&(e[o[r]]={}),e=e[o[r]];e[o[r]]=t}function je(e,t){var n,r=t.split(".");for(n=0;n<r.length-1;n++){if(!e[r[n]])return;e=e[r[n]]}delete e[r[n]]}var Pe,Ce=function(){function e(e){var t,n=this;this._contextNameToData={},this._gw3Subscriptions=[],this._nextCallbackSubscriptionNumber=0,this._contextNameToId={},this._contextIdToName={},this._protocolVersion=void 0,this._connection=e.connection,this._logger=e.logger,this._gw3Session=this._connection.domain("global",[de,le,me,ye]),this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),null===(t=this._connection.replayer)||void 0===t||t.drain(we.name,(function(e){var t=e.type;t&&(t===de||t===pe||t===ce?n.handleContextCreatedMessage(e):t===le||t===ye||t===be?n.handleContextUpdatedMessage(e):t!==me&&t!==ue||n.handleContextDestroyedMessage(e))}))}return Object.defineProperty(e.prototype,"protocolVersion",{get:function(){var e;if(!this._protocolVersion){var t=this._connection.availableDomains.find((function(e){return"context"===e.uri}));this._protocolVersion=null!==(e=null==t?void 0:t.version)&&void 0!==e?e:1}return this._protocolVersion},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"setPathSupported",{get:function(){return this.protocolVersion>=2},enumerable:!0,configurable:!0}),e.prototype.dispose=function(){for(var e=0,t=this._gw3Subscriptions;e<t.length;e++){var n=t[e];this._connection.off(n)}for(var r in this._gw3Subscriptions.length=0,this._contextNameToData)this._contextNameToId.hasOwnProperty(r)&&delete this._contextNameToData[r]},e.prototype.createContext=function(e,t){var n=this;return this._gw3Session.send({type:ae,domain:"global",name:e,data:t,lifetime:"retained"}).then((function(r){n._contextNameToId[e]=r.context_id,n._contextIdToName[r.context_id]=e;var o=n._contextNameToData[e]||new _e(r.context_id,e,!0,void 0);return o.isAnnounced=!0,o.name=e,o.contextId=r.context_id,o.context=t,n._contextNameToData[e]=o,r.context_id}))},e.prototype.all=function(){var e=this;return Object.keys(this._contextNameToData).filter((function(t){return e._contextNameToData[t].isAnnounced}))},e.prototype.update=function(e,t){var n;return r(this,void 0,void 0,(function(){var r,i,s,a=this;return o(this,(function(o){switch(o.label){case 0:return(r=this._contextNameToData[e])&&r.isAnnounced?(i=r.context,r.hasCallbacks()?[3,2]:[4,this.get(r.name)]):[2,this.createContext(e,t)];case 1:i=o.sent(),o.label=2;case 2:return s=2===this.protocolVersion?this.calculateContextDeltaV2(i,t):this.calculateContextDeltaV1(i,t),Object.keys(s.added).length||Object.keys(s.updated).length||s.removed.length||(null===(n=s.commands)||void 0===n?void 0:n.length)?[2,this._gw3Session.send({type:ve,domain:"global",context_id:r.contextId,delta:s},{},{skipPeerId:!1}).then((function(e){a.handleUpdated(r,s,{updaterId:e.peer_id})}))]:[2,Promise.resolve()]}}))}))},e.prototype.set=function(e,t){var n=this,r=this._contextNameToData[e];return r&&r.isAnnounced?this._gw3Session.send({type:ve,domain:"global",context_id:r.contextId,delta:{reset:t}},{},{skipPeerId:!1}).then((function(e){n.handleUpdated(r,{reset:t,added:{},removed:[],updated:{}},{updaterId:e.peer_id})})):this.createContext(e,t)},e.prototype.setPath=function(e,t,n){return this.setPathSupported?this.setPaths(e,[{path:t,value:n}]):Promise.reject("glue.contexts.setPath operation is not supported, use Glue42 3.10 or later")},e.prototype.setPaths=function(e,t){var n=this;if(!this.setPathSupported)return Promise.reject("glue.contexts.setPaths operation is not supported, use Glue42 3.10 or later");var r=this._contextNameToData[e];if(!r||!r.isAnnounced){for(var o={},i=0,s=t;i<s.length;i++){Te(o,(d=s[i]).value,d.path)}return this.createContext(e,o)}for(var a=[],c=0,u=t;c<u.length;c++){var d;null===(d=u[c]).value?a.push({type:"remove",path:d.path}):a.push({type:"set",path:d.path,value:d.value})}return this._gw3Session.send({type:ve,domain:"global",context_id:r.contextId,delta:{commands:a}},{},{skipPeerId:!1}).then((function(e){n.handleUpdated(r,{added:{},removed:[],updated:{},commands:a},{updaterId:e.peer_id})}))},e.prototype.get=function(e){var t,n=this,i=this._contextNameToData[e];if(!i||!i.isAnnounced)return Promise.resolve({});if(i&&!i.hasCallbacks())return new Promise((function(t,i){return r(n,void 0,void 0,(function(){var n=this;return o(this,(function(r){return this.subscribe(e,(function(e,r,o,i){n.unsubscribe(i),t(e)})),[2]}))}))}));var s=null!==(t=null==i?void 0:i.context)&&void 0!==t?t:{};return Promise.resolve(s)},e.prototype.subscribe=function(e,t){var n=this._nextCallbackSubscriptionNumber;this._nextCallbackSubscriptionNumber+=1;var r=this._contextNameToData[e];if(!r||!r.isAnnounced)return r=r||new _e(void 0,e,!1,void 0),this._contextNameToData[e]=r,r.updateCallbacks[n]=t,Promise.resolve(n);var o,i=r.hasCallbacks();return r.updateCallbacks[n]=t,i||r.joinedActivity||r.context&&r.sentExplicitSubscription?(t(o=Ie(r.context),o,[],n),Promise.resolve(n)):this.sendSubscribe(r).then((function(){return n}))},e.prototype.unsubscribe=function(e){for(var t=0,n=Object.keys(this._contextNameToData);t<n.length;t++){var r=n[t],o=(this._contextNameToId[r],this._contextNameToData[r]);if(!o)return;var i=o.hasCallbacks();delete o.updateCallbacks[e],o.isAnnounced&&i&&!o.hasCallbacks()&&o.sentExplicitSubscription&&this.sendUnsubscribe(o),o.isAnnounced||o.hasCallbacks()||delete this._contextNameToData[r]}},e.prototype.destroy=function(e){var t=this._contextNameToData[e];return t?this._gw3Session.send({type:ge,domain:"global",context_id:t.contextId}).then((function(e){})):Promise.reject("context with "+e+" does not exist")},e.prototype.handleUpdated=function(e,t,n){var r=e.context;e.context=ke(e.context,t,this._logger),this._contextNameToData[e.name]!==e||xe(r,e.context)||this.invokeUpdateCallbacks(e,t,n)},e.prototype.subscribeToContextCreatedMessages=function(){for(var e=0,t=[pe,de,ce];e<t.length;e++){var n=t[e],r=this._connection.on(n,this.handleContextCreatedMessage.bind(this));this._gw3Subscriptions.push(r)}},e.prototype.handleContextCreatedMessage=function(e){var t=e.type;t===ce?(this._contextNameToId[e.activity_id]=e.context_id,this._contextIdToName[e.context_id]=e.activity_id):t===pe&&(this._contextNameToId[e.name]=e.context_id,this._contextIdToName[e.context_id]=e.name);var n=this._contextIdToName[e.context_id];if(!n)throw new Error("Received created event for context with unknown name: "+e.context_id);if(!this._contextNameToId[n])throw new Error("Received created event for context with unknown id: "+e.context_id);var r=this._contextNameToData[n];if(r){if(r.isAnnounced)return;if(!r.hasCallbacks())throw new Error("Assertion failure: contextData.hasCallbacks()");r.isAnnounced=!0,r.contextId=e.context_id,r.activityId=e.activity_id,r.sentExplicitSubscription||this.sendSubscribe(r)}else this._contextNameToData[n]=r=new _e(e.context_id,n,!0,e.activity_id)},e.prototype.subscribeToContextUpdatedMessages=function(){for(var e=0,t=[ye,le,be];e<t.length;e++){var n=t[e],r=this._connection.on(n,this.handleContextUpdatedMessage.bind(this));this._gw3Subscriptions.push(r)}},e.prototype.handleContextUpdatedMessage=function(e){var t=e.type,n=e.context_id,r=this._contextNameToData[this._contextIdToName[n]],o=!r||!r.isAnnounced;if(t===be)r?(r.contextId=n,r.isAnnounced=!0,r.activityId=e.activity_id):(r=new _e(n,e.activity_id,!0,e.activity_id),this._contextNameToData[e.activity_id]=r,this._contextIdToName[n]=e.activity_id,this._contextNameToId[e.activity_id]=n),r.joinedActivity=!0;else if(!r||!r.isAnnounced)return void(t===le?((r=r||new _e(n,e.name,!0,void 0)).sentExplicitSubscription=!0,this._contextNameToData[e.name]=r,this._contextIdToName[n]=e.name,this._contextNameToId[e.name]=n):this._logger.error("Received 'update' for unknown context: "+n));var i=r.context;if(t===le)r.context=e.data||{};else if(t===be)r.context=e.context_snapshot||{};else{if(t!==ye)throw new Error("Unrecognized context update message "+t);r.context=ke(r.context,e.delta,this._logger)}!o&&xe(r.context,i)&&t!==le||this.invokeUpdateCallbacks(r,e.delta,{updaterId:e.updater_id})},e.prototype.invokeUpdateCallbacks=function(e,t,n){if((t=t||{added:{},updated:{},reset:{},removed:[]}).commands){t.added=t.updated=t.reset={},t.removed=[];for(var r=0,o=t.commands;r<o.length;r++){var i=o[r];"remove"===i.type?(-1===i.path.indexOf(".")&&t.removed.push(i.path),Te(t.updated,null,i.path)):"set"===i.type&&Te(t.updated,i.value,i.path)}}for(var s in e.updateCallbacks)if(e.updateCallbacks.hasOwnProperty(s))try{(0,e.updateCallbacks[s])(Ie(e.context),Object.assign({},t.added||{},t.updated||{},t.reset||{}),t.removed,parseInt(s,10),n)}catch(e){this._logger.debug("callback error: "+JSON.stringify(e))}},e.prototype.subscribeToContextDestroyedMessages=function(){for(var e=0,t=[me,ue];e<t.length;e++){var n=t[e],r=this._connection.on(n,this.handleContextDestroyedMessage.bind(this));this._gw3Subscriptions.push(r)}},e.prototype.handleContextDestroyedMessage=function(e){var t,n;if(e.type===ue){if(n=e.activity_id,!(t=this._contextNameToId[n]))return void this._logger.error("Received 'destroyed' for unknown activity: "+e.activity_id)}else if(t=e.context_id,!(n=this._contextIdToName[t]))return void this._logger.error("Received 'destroyed' for unknown context: "+e.context_id);delete this._contextIdToName[t],delete this._contextNameToId[n];var r=this._contextNameToData[n];delete this._contextNameToData[n],r&&r.isAnnounced||this._logger.error("Received 'destroyed' for unknown context: "+t)},e.prototype.sendSubscribe=function(e){return e.sentExplicitSubscription=!0,this._gw3Session.send({type:he,domain:"global",context_id:e.contextId}).then((function(e){}))},e.prototype.sendUnsubscribe=function(e){return e.sentExplicitSubscription=!1,this._gw3Session.send({type:fe,domain:"global",context_id:e.contextId}).then((function(e){}))},e.prototype.calculateContextDeltaV1=function(e,t){var n={added:{},updated:{},removed:[],reset:void 0};if(e)for(var r=0,o=Object.keys(e);r<o.length;r++){var i=o[r];-1===Object.keys(t).indexOf(i)||null===t[i]||xe(e[i],t[i])||(n.updated[i]=t[i])}for(var s=0,a=Object.keys(t);s<a.length;s++){i=a[s];e&&-1!==Object.keys(e).indexOf(i)?null===t[i]&&n.removed.push(i):null!==t[i]&&(n.added[i]=t[i])}return n},e.prototype.calculateContextDeltaV2=function(e,t){for(var n,r,o={added:{},updated:{},removed:[],reset:void 0,commands:[]},i=0,s=Object.keys(t);i<s.length;i++){var a=s[i];if(null!==t[a])xe(e?e[a]:null,t[a])||null===(n=o.commands)||void 0===n||n.push({type:"set",path:a,value:t[a]});else null===(r=o.commands)||void 0===r||r.push({type:"remove",path:a})}return o},e}(),Re=function(){function e(e){this._bridge=new Ce(e)}return e.prototype.all=function(){return this._bridge.all()},e.prototype.update=function(e,t){return this.checkName(e),this.checkData(t),this._bridge.update(e,t)},e.prototype.set=function(e,t){return this.checkName(e),this.checkData(t),this._bridge.set(e,t)},e.prototype.setPath=function(e,t,n){return this.checkName(e),this.checkPath(t),""===t?(this.checkData(n),this.set(e,n)):this._bridge.setPath(e,t,n)},e.prototype.setPaths=function(e,t){if(this.checkName(e),!Array.isArray(t))throw new Error("Please provide the paths as an array of PathValues!");for(var n=0,r=t;n<r.length;n++){var o=r[n],i=o.path,s=o.value;this.checkPath(i),""===i&&this.checkData(s)}return this._bridge.setPaths(e,t)},e.prototype.subscribe=function(e,t){var n=this;if(this.checkName(e),"function"!=typeof t)throw new Error("Please provide the callback as a function!");return this._bridge.subscribe(e,(function(e,r,o,i,s){return t(e,r,o,(function(){return n._bridge.unsubscribe(i)}),s)})).then((function(e){return function(){n._bridge.unsubscribe(e)}}))},e.prototype.get=function(e){return this.checkName(e),this._bridge.get(e)},e.prototype.ready=function(){return Promise.resolve(this)},e.prototype.destroy=function(e){return this.checkName(e),this._bridge.destroy(e)},Object.defineProperty(e.prototype,"setPathSupported",{get:function(){return this._bridge.setPathSupported},enumerable:!0,configurable:!0}),e.prototype.checkName=function(e){if("string"!=typeof e||""===e)throw new Error("Please provide the name as a non-empty string!")},e.prototype.checkPath=function(e){if("string"!=typeof e)throw new Error("Please provide the path as a dot delimited string!")},e.prototype.checkData=function(e){if("object"!=typeof e)throw new Error("Please provide the data as an object!")},e}();function Oe(e,t,n){return"function"!=typeof t&&"function"!=typeof n?e:("function"!=typeof t?t=function(){}:"function"!=typeof n&&(n=function(){}),e.then(t,n))}function Ae(e,t,n){var r;void 0===e&&(e=0);var o=function(){r&&clearTimeout(r)};return t.then((function(){o()})).catch((function(){o()})),new Promise((function(t,o){r=setTimeout((function(){return o(n)}),e)}))}!function(e){e[e.Success=0]="Success",e[e.Error=1]="Error"}(Pe||(Pe={}));var Ne=function(){function e(e,t,n,r){this.protocol=e,this.repo=t,this.instance=n,this.configuration=r}return e.prototype.subscribe=function(e,t,n,r,o){var i=this,s=function(e,n,r,s){var a;t.methodResponseTimeout=null!==(a=t.methodResponseTimeout)&&void 0!==a?a:t.waitTimeoutMs,i.protocol.client.subscribe(n,t,e,r,s,o)};return Oe(new Promise((function(n,r){var o,a=function(e){n(e)},c=function(e){r(e)};if(e)if((o="string"==typeof e?{name:e}:e).name){void 0===t&&(t={});var u=t.target;if(void 0===u&&(u="best"),"string"!=typeof u||"all"===u||"best"===u){void 0===t.methodResponseTimeout&&(t.methodResponseTimeout=t.method_response_timeout,void 0===t.methodResponseTimeout&&(t.methodResponseTimeout=i.configuration.methodResponseTimeout)),void 0===t.waitTimeoutMs&&(t.waitTimeoutMs=t.wait_for_method_timeout,void 0===t.waitTimeoutMs&&(t.waitTimeoutMs=i.configuration.waitTimeoutMs));var d=0,p=i.getServerMethodsByFilterAndTarget(o,u);if(p.length>0)s(p,p[0].methods[0],a,c);else{var h=function(){if(u&&t.waitTimeoutMs)if(d+=500,(p=i.getServerMethodsByFilterAndTarget(o,u)).length>0){var n=p[0].methods[0];s(p,n,a,c)}else if(d>=t.waitTimeoutMs){s(p,"string"==typeof e?{name:e}:e,a,c)}else setTimeout(h,500)};setTimeout(h,500)}}else r(new Error('"'+u+'" is not a valid target. Valid targets are "all", "best", or an instance.'))}else r("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");else r("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.")})),n,r)},e.prototype.servers=function(e){var t=void 0===e?void 0:n({},e);return this.getServers(t).map((function(e){return e.server.instance}))},e.prototype.methods=function(e){return e="string"==typeof e?{name:e}:n({},e),this.getMethods(e)},e.prototype.methodsForInstance=function(e){return this.getMethodsForInstance(e)},e.prototype.methodAdded=function(e){return this.repo.onMethodAdded(e)},e.prototype.methodRemoved=function(e){return this.repo.onMethodRemoved(e)},e.prototype.serverAdded=function(e){return this.repo.onServerAdded(e)},e.prototype.serverRemoved=function(e){return this.repo.onServerRemoved((function(t,n){e(t,n)}))},e.prototype.serverMethodAdded=function(e){return this.repo.onServerMethodAdded((function(t,n){e({server:t,method:n})}))},e.prototype.serverMethodRemoved=function(e){return this.repo.onServerMethodRemoved((function(t,n){e({server:t,method:n})}))},e.prototype.invoke=function(e,t,i,s,a,c){return r(this,void 0,void 0,(function(){var u=this;return o(this,(function(d){return[2,Oe(function(){return r(u,void 0,void 0,(function(){var r,a,c,u,d,p,h,l,f,g,m,v,y=this;return o(this,(function(o){switch(o.label){case 0:if(!(r="string"==typeof e?{name:e}:n({},e)).name)return[2,Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.")];if(t||(t={}),i||(i="best"),"string"==typeof i&&"all"!==i&&"best"!==i&&"skipMine"!==i)return[2,Promise.reject(new Error('"'+i+'" is not a valid target. Valid targets are "all" and "best".'))];if(s||(s={}),void 0===s.methodResponseTimeoutMs&&(s.methodResponseTimeoutMs=s.method_response_timeout,void 0===s.methodResponseTimeoutMs&&(s.methodResponseTimeoutMs=this.configuration.methodResponseTimeout)),void 0===s.waitTimeoutMs&&(s.waitTimeoutMs=s.wait_for_method_timeout,void 0===s.waitTimeoutMs&&(s.waitTimeoutMs=this.configuration.waitTimeoutMs)),void 0!==s.waitTimeoutMs&&"number"!=typeof s.waitTimeoutMs)return[2,Promise.reject(new Error('"'+s.waitTimeoutMs+'" is not a valid number for "waitTimeoutMs" '))];if("object"!=typeof t)return[2,Promise.reject(new Error("The method arguments must be an object. method: "+r.name))];if(0!==(a=this.getServerMethodsByFilterAndTarget(r,i)).length)return[3,4];o.label=1;case 1:return o.trys.push([1,3,,4]),[4,this.tryToAwaitForMethods(r,i,s)];case 2:return a=o.sent(),[3,4];case 3:return o.sent(),c=n(n({},r),{getServers:function(){return[]},supportsStreaming:!1,objectTypes:null!==(g=r.objectTypes)&&void 0!==g?g:[],flags:null!==(v=null===(m=r.flags)||void 0===m?void 0:m.metadata)&&void 0!==v?v:{}}),u={method:c,called_with:t,message:"Can not find a method matching "+JSON.stringify(e)+" with server filter "+JSON.stringify(i),executed_by:void 0,returned:void 0,status:void 0},[2,Promise.reject(u)];case 4:return d=s.methodResponseTimeoutMs,p=s,h=a.map((function(e){var n=Z(),r=e.methods[0],o=e.server,i=y.protocol.client.invoke(n,r,t,o,p);return Promise.race([i,Ae(d,i,{invocationId:n,message:"Invocation timeout ("+d+" ms) reached for method name: "+(null==r?void 0:r.name)+", target instance: "+JSON.stringify(o.instance)+", options: "+JSON.stringify(p),status:Pe.Error})])})),[4,Promise.all(h)];case 5:return l=o.sent(),f=this.getInvocationResultObj(l,r,t),l.every((function(e){return e.status===Pe.Error}))?[2,Promise.reject(f)]:[2,f]}}))}))}(),a,c)]}))}))},e.prototype.getInvocationResultObj=function(e,t,n){var r=e.filter((function(e){return e.status===Pe.Success})).reduce((function(e,r){return e=i(e,[{executed_by:r.instance,returned:r.result,called_with:n,method:t,message:r.message,status:r.status}])}),[]),o=e.filter((function(e){return e.status===Pe.Error})).reduce((function(e,r){return e=i(e,[{executed_by:r.instance,called_with:n,name:t.name,message:r.message}])}),[]),s=e[0];return{method:t,called_with:n,returned:s.result,executed_by:s.instance,all_return_values:r,all_errors:o,message:s.message,status:s.status}},e.prototype.tryToAwaitForMethods=function(e,t,n){var r=this;return new Promise((function(o,i){if(0!==n.waitTimeoutMs)var s=0,a=setInterval((function(){s+=500;var c=r.getServerMethodsByFilterAndTarget(e,t);if(c.length>0)clearInterval(a),o(c);else if(s>=(n.waitTimeoutMs||1e4))return clearInterval(a),void i()}),500);else i()}))},e.prototype.filterByTarget=function(e,t){var n=this;if("string"!=typeof e){return(Array.isArray(e)?e:[e]).reduce((function(e,r){var o=t.filter((function(e){return n.instanceMatch(r,e.server.instance)}));return e.concat(o)}),[])}if("all"===e)return i(t);if("best"===e){var r=t.find((function(e){return e.server.instance.isLocal}));if(r)return[r];if(void 0!==t[0])return[t[0]]}else if("skipMine"===e)return t.filter((function(e){return e.server.instance.peerId!==n.instance.peerId}));return[]},e.prototype.instanceMatch=function(e,t){return this.containsProps(e,t)},e.prototype.methodMatch=function(e,t){return this.containsProps(e,t)},e.prototype.containsProps=function(e,t){return Object.keys(e).filter((function(t){return void 0!==e[t]&&"function"!=typeof e[t]&&"object_types"!==t&&"display_name"!==t&&"id"!==t&&"gatewayId"!==t&&"identifier"!==t&&"_"!==t[0]})).every((function(n){var r,o=e[n],i=t[n];switch(n){case"objectTypes":r=(o||[]).every((function(e){return(i||[]).includes(e)}));break;case"flags":r=function e(t,n){return Object.keys(n).every((function(r){return"object"==typeof n[r]?e((null==t?void 0:t[r])||{},n[r]||{}):n[r]===(null==t?void 0:t[r])}))}(i||{},o||{});break;default:r=String(o).toLowerCase()===String(i).toLowerCase()}return r}))},e.prototype.getMethods=function(e){var t=this;return void 0===e?this.repo.getMethods():this.repo.getMethods().filter((function(n){return t.methodMatch(e,n)}))},e.prototype.getMethodsForInstance=function(e){var t=this,n=this.repo.getServers().filter((function(n){return t.instanceMatch(e,n.instance)}));if(0===n.length)return[];var r={};return 1===n.length?r=n[0].methods:n.forEach((function(e){Object.keys(e.methods).forEach((function(t){var n=e.methods[t];r[n.identifier]=n}))})),Object.keys(r).map((function(e){return r[e]}))},e.prototype.getServers=function(e){var t=this,n=this.repo.getServers();return void 0===e?n.map((function(e){return{server:e,methods:[]}})):n.reduce((function(n,r){var o=Object.values(r.methods).filter((function(n){return t.methodMatch(e,n)}));return o.length>0&&n.push({server:r,methods:o}),n}),[])},e.prototype.getServerMethodsByFilterAndTarget=function(e,t){var n=this.getServers(e);return this.filterByTarget(t,n)},e}(),Ee=function(){function e(e,t,n){this.protocol=e,this.repoMethod=t,this.subscription=n}return Object.defineProperty(e.prototype,"stream",{get:function(){if(!this.repoMethod.stream)throw new Error("no stream");return this.repoMethod.stream},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"arguments",{get:function(){return this.subscription.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"branchKey",{get:function(){return this.subscription.branchKey},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"instance",{get:function(){if(!this.subscription.instance)throw new Error("no instance");return this.subscription.instance},enumerable:!0,configurable:!0}),e.prototype.close=function(){this.protocol.server.closeSingleSubscription(this.repoMethod,this.subscription)},e.prototype.push=function(e){this.protocol.server.pushDataToSingle(this.repoMethod,this.subscription,e)},e}(),Le=function(){function e(e,t,n){this.protocol=e,this.repoMethod=t,this.requestContext=n,this.arguments=n.arguments,this.instance=n.instance}return e.prototype.accept=function(){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,"")},e.prototype.acceptOnBranch=function(e){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,e)},e.prototype.reject=function(e){this.protocol.server.rejectRequest(this.requestContext,this.repoMethod,e)},e}(),De=function(){function e(e,t){var n=this;this.protocol=e,this.server=t,e.server.onSubRequest((function(e,t){return n.handleSubRequest(e,t)})),e.server.onSubAdded((function(e,t){return n.handleSubAdded(e,t)})),e.server.onSubRemoved((function(e,t){return n.handleSubRemoved(e,t)}))}return e.prototype.handleSubRequest=function(e,t){if(t&&t.streamCallbacks&&"function"==typeof t.streamCallbacks.subscriptionRequestHandler){var n=new Le(this.protocol,t,e);t.streamCallbacks.subscriptionRequestHandler(n)}},e.prototype.handleSubAdded=function(e,t){if(t&&t.streamCallbacks&&"function"==typeof t.streamCallbacks.subscriptionAddedHandler){var n=new Ee(this.protocol,t,e);t.streamCallbacks.subscriptionAddedHandler(n)}},e.prototype.handleSubRemoved=function(e,t){if(t&&t.streamCallbacks&&"function"==typeof t.streamCallbacks.subscriptionRemovedHandler){var n=new Ee(this.protocol,t,e);t.streamCallbacks.subscriptionRemovedHandler(n)}},e}(),qe=function(){function e(e,t,n){this.key=e,this.protocol=t,this.repoMethod=n}return e.prototype.subscriptions=function(){var e=this;return this.protocol.server.getSubscriptionList(this.repoMethod,this.key).map((function(t){return new Ee(e.protocol,e.repoMethod,t)}))},e.prototype.close=function(){this.protocol.server.closeAllSubscriptions(this.repoMethod,this.key)},e.prototype.push=function(e){this.protocol.server.pushData(this.repoMethod,e,[this.key])},e}(),Fe=function(){function e(e,t,n){this._protocol=e,this._repoMethod=t,this._server=n,this.name=this._repoMethod.definition.name}return e.prototype.branches=function(e){var t=this,n=this._protocol.server.getBranchList(this._repoMethod);return e?n.indexOf(e)>-1?new qe(e,this._protocol,this._repoMethod):void 0:n.map((function(e){return new qe(e,t._protocol,t._repoMethod)}))},e.prototype.branch=function(e){return this.branches(e)},e.prototype.subscriptions=function(){var e=this;return this._protocol.server.getSubscriptionList(this._repoMethod).map((function(t){return new Ee(e._protocol,e._repoMethod,t)}))},Object.defineProperty(e.prototype,"definition",{get:function(){var e,t=this._repoMethod.definition;return{accepts:t.accepts,description:t.description,displayName:t.displayName,name:t.name,objectTypes:t.objectTypes,returns:t.returns,supportsStreaming:t.supportsStreaming,flags:null===(e=t.flags)||void 0===e?void 0:e.metadata}},enumerable:!0,configurable:!0}),e.prototype.close=function(){this._protocol.server.closeAllSubscriptions(this._repoMethod),this._server.unregister(this._repoMethod.definition,!0)},e.prototype.push=function(e,t){if("string"!=typeof t&&!Array.isArray(t)&&void 0!==t)throw new Error("invalid branches should be string or string array");if("object"!=typeof e)throw new Error("Invalid arguments. Data must be an object.");this._protocol.server.pushData(this._repoMethod,e,t)},e.prototype.updateRepoMethod=function(e){this._repoMethod=e},e}(),Ue=function(){function e(e,t){this.protocol=e,this.serverRepository=t,this.invocations=0,this.currentlyUnregistering={},this.streaming=new De(e,this),this.protocol.server.onInvoked(this.onMethodInvoked.bind(this))}return e.prototype.createStream=function(e,t,r,o,i){var s=this;return Oe(new Promise((function(r,o){if(e){var a;if(!(a="string"==typeof e?{name:""+e}:n({},e)).name)return o("The name property is required for the streamDefinition object and must be unique. Stream definition: "+JSON.stringify(a));if(s.serverRepository.getList().some((function(e){return e.definition.name===a.name})))return o('A stream with the name "'+a.name+'" already exists! Please, provide a unique name for the stream.');a.supportsStreaming=!0,t||(t={}),"function"!=typeof t.subscriptionRequestHandler&&(t.subscriptionRequestHandler=function(e){e.accept()});var c=s.serverRepository.add({definition:a,streamCallbacks:t,protocolState:{}});s.protocol.server.createStream(c).then((function(){var e;i?(e=i,i.updateRepoMethod(c)):e=new Fe(s.protocol,c,s),c.stream=e,r(e)})).catch((function(e){c.repoId&&s.serverRepository.remove(c.repoId),o(e)}))}else o("The stream name must be unique! Please, provide either a unique string for a stream name to glue.interop.createStream() or a methodDefinition object with a unique name property for the stream.")})),r,o)},e.prototype.register=function(e,t){var n=this;if(!e)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");if("function"!=typeof t)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof e?e:e.name));var i=function(e,i){return r(n,void 0,void 0,(function(){var n,r,s;return o(this,(function(o){switch(o.label){case 0:return o.trys.push([0,4,,5]),(n=t(e.args,e.instance))&&"function"==typeof n.then?[4,n]:[3,2];case 1:return r=o.sent(),i(void 0,r),[3,3];case 2:i(void 0,n),o.label=3;case 3:return[3,5];case 4:return(s=o.sent())||(s=""),i(s,s),[3,5];case 5:return[2]}}))}))};return i.userCallback=t,this.registerCore(e,i)},e.prototype.registerAsync=function(e,t){if(!e)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");if("function"!=typeof t)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof e?e:e.name));var n=function(e,n){try{var r=!1,o=function(e){r||n(void 0,e),r=!0},i=function(e){r||(e||(e=""),n(e,e)),r=!0},s=t(e.args,e.instance,o,i);s&&"function"==typeof s.then&&s.then(o).catch(i)}catch(e){n(e,void 0)}};return n.userCallbackAsync=t,this.registerCore(e,n)},e.prototype.unregister=function(e,t){return void 0===t&&(t=!1),r(this,void 0,void 0,(function(){var n,r;return o(this,(function(o){switch(o.label){case 0:return void 0===e?[2,Promise.reject("Please, provide either a unique string for a name or an object containing a name property.")]:"function"!=typeof e?[3,2]:[4,this.unregisterWithPredicate(e,t)];case 1:return o.sent(),[2];case 2:return void 0===(n="string"==typeof e?{name:e}:e).name?[2,Promise.reject("Method name is required. Cannot find a method if the method name is undefined!")]:(r=this.serverRepository.getList().find((function(e){return e.definition.name===n.name&&(e.definition.supportsStreaming||!1)===t})))?[4,this.removeMethodsOrStreams([r])]:[2,Promise.reject('Method with a name "'+n.name+'" does not exist or is not registered by your application!')];case 3:return o.sent(),[2]}}))}))},e.prototype.unregisterWithPredicate=function(e,t){return r(this,void 0,void 0,(function(){var n;return o(this,(function(r){switch(r.label){case 0:return(n=this.serverRepository.getList().filter((function(t){return e(t.definition)})).filter((function(e){return(e.definition.supportsStreaming||!1)===t})))&&0!==n.length?[4,this.removeMethodsOrStreams(n)]:[2,Promise.reject("Could not find a "+(t?"stream":"method")+" matching the specified condition!")];case 1:return r.sent(),[2]}}))}))},e.prototype.removeMethodsOrStreams=function(e){var t=this,n=[];return e.forEach((function(e){var r=t.protocol.server.unregister(e).then((function(){e.repoId&&t.serverRepository.remove(e.repoId)}));n.push(r),t.addAsCurrentlyUnregistering(e.definition.name,r)})),Promise.all(n)},e.prototype.addAsCurrentlyUnregistering=function(e,t){return r(this,void 0,void 0,(function(){var n,r=this;return o(this,(function(o){return n=new Promise((function(e){return setTimeout(e,5e3)})),this.currentlyUnregistering[e]=Promise.race([t,n]).then((function(){delete r.currentlyUnregistering[e]})),[2]}))}))},e.prototype.registerCore=function(e,t){return r(this,void 0,void 0,(function(){var r,i,s,a=this;return o(this,(function(o){switch(o.label){case 0:return(r="string"==typeof e?{name:""+e}:n({},e)).name?(i=this.currentlyUnregistering[r.name])?[4,i]:[3,2]:[2,Promise.reject("Please, provide a (unique) string value for the name property in the methodDefinition object: "+JSON.stringify(e))];case 1:o.sent(),o.label=2;case 2:return this.serverRepository.getList().some((function(e){return e.definition.name===r.name}))?[2,Promise.reject('A method with the name "'+r.name+'" already exists! Please, provide a unique name for the method.')]:r.supportsStreaming?[2,Promise.reject("When you create methods with glue.interop.register() or glue.interop.registerAsync() the property supportsStreaming cannot be true. If you want "+r.name+" to be a stream, please use the glue.interop.createStream() method.")]:(s=this.serverRepository.add({definition:r,theFunction:t,protocolState:{}}),[2,this.protocol.server.register(s).catch((function(e){throw(null==s?void 0:s.repoId)&&a.serverRepository.remove(s.repoId),e}))])}}))}))},e.prototype.onMethodInvoked=function(e,t,n){var r=this;e&&e.theFunction&&e.theFunction(n,(function(n,o){if(null!=n)if(n.message&&"string"==typeof n.message)n=n.message;else if("string"!=typeof n)try{n=JSON.stringify(n)}catch(e){n="un-stringifyable error in onMethodInvoked! Top level prop names: "+Object.keys(n)}o?("object"!=typeof o||Array.isArray(o))&&(o={_value:o}):o={},r.protocol.server.methodInvocationResult(e,t,n,o)}))},e}(),Be=function(){function e(e,t,n){var r=this;this.wrapped={},this.wrapped.getMethods=function(){return e.methodsForInstance(this)},this.wrapped.getStreams=function(){return e.methodsForInstance(this).filter((function(e){return e.supportsStreaming}))},t&&this.refreshWrappedObject(t),n&&(n.loggedIn((function(){r.refresh(n)})),this.refresh(n))}return e.prototype.unwrap=function(){return this.wrapped},e.prototype.refresh=function(e){if(e){var t=null==e?void 0:e.resolvedIdentity,n=Object.assign({},null!=t?t:{},{peerId:null==e?void 0:e.peerId});this.refreshWrappedObject(n)}},e.prototype.refreshWrappedObject=function(e){var t,n,r,o;this.wrapped.user=e.user,this.wrapped.instance=e.instance,this.wrapped.application=null!==(t=e.application)&&void 0!==t?t:Z(),this.wrapped.applicationName=e.applicationName,this.wrapped.pid=null!==(r=null!==(n=e.pid)&&void 0!==n?n:e.process)&&void 0!==r?r:Math.floor(1e10*Math.random()),this.wrapped.machine=e.machine,this.wrapped.environment=e.environment,this.wrapped.region=e.region,this.wrapped.windowId=e.windowId,this.wrapped.isLocal=null===(o=e.isLocal)||void 0===o||o,this.wrapped.api=e.api,this.wrapped.service=e.service,this.wrapped.peerId=e.peerId},e}(),Je=function(e){return n(n({},e),{flags:e.flags.metadata||{}})},Ve=function(){function e(e,t){this.logger=e,this.API=t,this.servers={},this.methodsCount={},this.callbacks=T();var n=this.API.instance.peerId;this.myServer={id:n,methods:{},instance:this.API.instance,wrapper:this.API.unwrappedInstance},this.servers[n]=this.myServer}return e.prototype.addServer=function(e,t){this.logger.debug("adding server "+t);var n=this.servers[t];if(n)return n.id;var r=new Be(this.API,e),o={id:t,methods:{},instance:r.unwrap(),wrapper:r};return this.servers[t]=o,this.callbacks.execute("onServerAdded",o.instance),t},e.prototype.removeServerById=function(e,t){var n=this,r=this.servers[e];r?(this.logger.debug("removing server "+e),Object.keys(r.methods).forEach((function(t){n.removeServerMethod(e,t)})),delete this.servers[e],this.callbacks.execute("onServerRemoved",r.instance,t)):this.logger.warn("not aware of server "+e+", my state "+JSON.stringify(Object.keys(this.servers)))},e.prototype.addServerMethod=function(e,t){var n,r=this.servers[e];if(!r)throw new Error("server does not exists");if(!r.methods[t.id]){var o=this.createMethodIdentifier(t),i=this,s={identifier:o,gatewayId:t.id,name:t.name,displayName:t.display_name,description:t.description,version:t.version,objectTypes:t.object_types||[],accepts:t.input_signature,returns:t.result_signature,supportsStreaming:void 0!==t.flags&&t.flags.streaming,flags:null!==(n=t.flags)&&void 0!==n?n:{},getServers:function(){return i.getServersByMethod(o)}};s.object_types=s.objectTypes,s.display_name=s.displayName,s.version=s.version,r.methods[t.id]=s;var a=Je(s);return this.methodsCount[o]||(this.methodsCount[o]=0,this.callbacks.execute("onMethodAdded",a)),this.methodsCount[o]=this.methodsCount[o]+1,this.callbacks.execute("onServerMethodAdded",r.instance,a),s}},e.prototype.removeServerMethod=function(e,t){var n=this.servers[e];if(!n)throw new Error("server does not exists");var r=n.methods[t];delete n.methods[t];var o=Je(r);this.methodsCount[r.identifier]=this.methodsCount[r.identifier]-1,0===this.methodsCount[r.identifier]&&this.callbacks.execute("onMethodRemoved",o),this.callbacks.execute("onServerMethodRemoved",n.instance,o)},e.prototype.getMethods=function(){return this.extractMethodsFromServers(Object.values(this.servers)).map(Je)},e.prototype.getServers=function(){return Object.values(this.servers).map(this.hideServerMethodSystemFlags)},e.prototype.onServerAdded=function(e){var t=this.callbacks.add("onServerAdded",e),n=this.getServers().map((function(e){return e.instance}));return this.returnUnsubWithDelayedReplay(t,n,e)},e.prototype.onMethodAdded=function(e){var t=this.callbacks.add("onMethodAdded",e),n=this.getMethods();return this.returnUnsubWithDelayedReplay(t,n,e)},e.prototype.onServerMethodAdded=function(e){var t=this.callbacks.add("onServerMethodAdded",e),n=!1,r=this.getServers();return setTimeout((function(){r.forEach((function(t){var r=t.methods;Object.keys(r).forEach((function(o){n||e(t.instance,r[o])}))}))}),0),function(){n=!0,t()}},e.prototype.onMethodRemoved=function(e){return this.callbacks.add("onMethodRemoved",e)},e.prototype.onServerRemoved=function(e){return this.callbacks.add("onServerRemoved",e)},e.prototype.onServerMethodRemoved=function(e){return this.callbacks.add("onServerMethodRemoved",e)},e.prototype.getServerById=function(e){return this.hideServerMethodSystemFlags(this.servers[e])},e.prototype.reset=function(){var e,t=this;Object.keys(this.servers).forEach((function(e){t.removeServerById(e,"reset")})),this.servers=((e={})[this.myServer.id]=this.myServer,e),this.methodsCount={}},e.prototype.createMethodIdentifier=function(e){var t=void 0!==e.input_signature?e.input_signature:"",n=void 0!==e.result_signature?e.result_signature:"";return(e.name+t+n).toLowerCase()},e.prototype.getServersByMethod=function(e){var t=[];return Object.values(this.servers).forEach((function(n){Object.values(n.methods).forEach((function(r){r.identifier===e&&t.push(n.instance)}))})),t},e.prototype.returnUnsubWithDelayedReplay=function(e,t,n){var r=!1;return setTimeout((function(){t.forEach((function(e){r||n(e)}))}),0),function(){r=!0,e()}},e.prototype.hideServerMethodSystemFlags=function(e){var t={};return Object.entries(e.methods).forEach((function(e){var n=e[0],r=e[1];t[n]=Je(r)})),n(n({},e),{methods:t})},e.prototype.extractMethodsFromServers=function(e){return Object.values(e).reduce((function(e,t){return i(e,Object.values(t.methods))}),[])},e}(),He=function(){function e(){this.nextId=0,this.methods=[]}return e.prototype.add=function(e){return e.repoId=String(this.nextId),this.nextId+=1,this.methods.push(e),e},e.prototype.remove=function(e){if("string"!=typeof e)return new TypeError("Expecting a string");this.methods=this.methods.filter((function(t){return t.repoId!==e}))},e.prototype.getById=function(e){if("string"==typeof e)return this.methods.find((function(t){return t.repoId===e}))},e.prototype.getList=function(){return this.methods.map((function(e){return e}))},e.prototype.length=function(){return this.methods.length},e.prototype.reset=function(){this.methods=[]},e}(),We="onSubscriptionRequest",Ke="onSubscriptionAdded",Ge="onSubscriptionRemoved",ze=function(){function e(e,t,n){var r=this;this.session=e,this.repository=t,this.serverRepository=n,this.ERR_URI_SUBSCRIPTION_FAILED="com.tick42.agm.errors.subscription.failure",this.callbacks=T(),this.nextStreamId=0,e.on("add-interest",(function(e){r.handleAddInterest(e)})),e.on("remove-interest",(function(e){r.handleRemoveInterest(e)}))}return e.prototype.acceptRequestOnBranch=function(e,t,n){if("string"!=typeof n&&(n=""),"object"!=typeof t.protocolState.subscriptionsMap)throw new TypeError("The streaming method is missing its subscriptions.");if(!Array.isArray(t.protocolState.branchKeyToStreamIdMap))throw new TypeError("The streaming method is missing its branches.");var r=this.getStreamId(t,n),o=e.msg.subscription_id,i={id:o,arguments:e.arguments,instance:e.instance,branchKey:n,streamId:r,subscribeMsg:e.msg};t.protocolState.subscriptionsMap[o]=i,this.session.sendFireAndForget({type:"accepted",subscription_id:o,stream_id:r}),this.callbacks.execute(Ke,i,t)},e.prototype.rejectRequest=function(e,t,n){"string"!=typeof n&&(n=""),this.sendSubscriptionFailed("Subscription rejected by user. "+n,e.msg.subscription_id)},e.prototype.pushData=function(e,t,n){var r=this;if("object"==typeof e&&Array.isArray(e.protocolState.branchKeyToStreamIdMap)){if("object"!=typeof t)throw new Error("Invalid arguments. Data must be an object.");"string"==typeof n?n=[n]:(!Array.isArray(n)||n.length<=0)&&(n=[]),e.protocolState.branchKeyToStreamIdMap.filter((function(e){return!n||0===n.length||n.indexOf(e.key)>=0})).map((function(e){return e.streamId})).forEach((function(e){var n={type:"publish",stream_id:e,data:t};r.session.sendFireAndForget(n)}))}},e.prototype.pushDataToSingle=function(e,t,n){if("object"!=typeof n)throw new Error("Invalid arguments. Data must be an object.");var r={type:"post",subscription_id:t.id,data:n};this.session.sendFireAndForget(r)},e.prototype.closeSingleSubscription=function(e,t){e.protocolState.subscriptionsMap&&delete e.protocolState.subscriptionsMap[t.id];var n={type:"drop-subscription",subscription_id:t.id,reason:"Server dropping a single subscription"};this.session.sendFireAndForget(n);t.instance;this.callbacks.execute(Ge,t,e)},e.prototype.closeMultipleSubscriptions=function(e,t){var n=this;if("object"==typeof e&&"object"==typeof e.protocolState.subscriptionsMap&&e.protocolState.subscriptionsMap){var r=e.protocolState.subscriptionsMap,o=Object.keys(r).map((function(e){return r[e]}));"string"==typeof t&&(o=o.filter((function(e){return e.branchKey===t}))),o.forEach((function(e){delete r[e.id];var t={type:"drop-subscription",subscription_id:e.id,reason:"Server dropping all subscriptions on stream_id: "+e.streamId};n.session.sendFireAndForget(t)}))}},e.prototype.getSubscriptionList=function(e,t){if("object"!=typeof e)return[];if(!e.protocolState.subscriptionsMap)return[];var n=e.protocolState.subscriptionsMap,r=Object.keys(n).map((function(e){return n[e]}));return"string"!=typeof t?r:r.filter((function(e){return e.branchKey===t}))},e.prototype.getBranchList=function(e){if("object"!=typeof e)return[];if(!e.protocolState.subscriptionsMap)return[];var t=e.protocolState.subscriptionsMap,n=Object.keys(t).map((function(e){return t[e]})),r=[];return n.forEach((function(e){var t="";"object"==typeof e&&"string"==typeof e.branchKey&&(t=e.branchKey),-1===r.indexOf(t)&&r.push(t)})),r},e.prototype.onSubAdded=function(e){this.onSubscriptionLifetimeEvent(Ke,e)},e.prototype.onSubRequest=function(e){this.onSubscriptionLifetimeEvent(We,e)},e.prototype.onSubRemoved=function(e){this.onSubscriptionLifetimeEvent(Ge,e)},e.prototype.handleRemoveInterest=function(e){var t=this.serverRepository.getById(e.method_id);if("string"==typeof e.subscription_id&&"object"==typeof t&&t.protocolState.subscriptionsMap&&"object"==typeof t.protocolState.subscriptionsMap[e.subscription_id]){var n=t.protocolState.subscriptionsMap[e.subscription_id];delete t.protocolState.subscriptionsMap[e.subscription_id],this.callbacks.execute(Ge,n,t)}},e.prototype.onSubscriptionLifetimeEvent=function(e,t){this.callbacks.add(e,t)},e.prototype.getNextStreamId=function(){return this.nextStreamId+++""},e.prototype.handleAddInterest=function(e){var t=this.repository.getServerById(e.caller_id).instance,n={msg:e,arguments:e.arguments_kv||{},instance:t},r=this.serverRepository.getById(e.method_id);if(void 0!==r)r.protocolState.subscriptionsMap&&r.protocolState.subscriptionsMap[e.subscription_id]?this.sendSubscriptionFailed("A subscription with id "+e.subscription_id+" already exists.",e.subscription_id):this.callbacks.execute(We,n,r);else{var o="No method with id "+e.method_id+" on this server.";this.sendSubscriptionFailed(o,e.subscription_id)}},e.prototype.sendSubscriptionFailed=function(e,t){var n={type:"error",reason_uri:this.ERR_URI_SUBSCRIPTION_FAILED,reason:e,request_id:t};this.session.sendFireAndForget(n)},e.prototype.getStreamId=function(e,t){if("string"!=typeof t&&(t=""),!e.protocolState.branchKeyToStreamIdMap)throw new Error("streaming "+e.definition.name+" method without protocol state");var n=e.protocolState.branchKeyToStreamIdMap.filter((function(e){return e.key===t}))[0],r=n?n.streamId:void 0;return"string"==typeof r&&""!==r||(r=this.getNextStreamId(),e.protocolState.branchKeyToStreamIdMap.push({key:t,streamId:r})),r},e}(),Ye=function(){function e(e,t,n,r){var o=this;this.session=e,this.clientRepository=t,this.serverRepository=n,this.logger=r,this.callbacks=T(),this.streaming=new ze(e,t,n),this.session.on("invoke",(function(e){return o.handleInvokeMessage(e)}))}return e.prototype.createStream=function(e){return e.protocolState.subscriptionsMap={},e.protocolState.branchKeyToStreamIdMap=[],this.register(e,!0)},e.prototype.register=function(e,t){var n,r=this,o=e.definition,i=Object.assign({},{metadata:null!==(n=o.flags)&&void 0!==n?n:{}},{streaming:t||!1}),s={type:"register",methods:[{id:e.repoId,name:o.name,display_name:o.displayName,description:o.description,version:o.version,flags:i,object_types:o.objectTypes||o.object_types,input_signature:o.accepts,result_signature:o.returns,restrictions:void 0}]};return this.session.send(s,{methodId:e.repoId}).then((function(){r.logger.debug("registered method "+e.definition.name+" with id "+e.repoId)})).catch((function(t){throw r.logger.warn("failed to register method "+e.definition.name+" with id "+e.repoId+" - "+JSON.stringify(t)),t}))},e.prototype.onInvoked=function(e){this.callbacks.add("onInvoked",e)},e.prototype.methodInvocationResult=function(e,t,n,r){var o;o=n||""===n?{type:"error",request_id:t,reason_uri:"agm.errors.client_error",reason:n,context:r,peer_id:void 0}:{type:"yield",invocation_id:t,peer_id:this.session.peerId,result:r,request_id:void 0},this.session.sendFireAndForget(o)},e.prototype.unregister=function(e){return r(this,void 0,void 0,(function(){var t;return o(this,(function(n){switch(n.label){case 0:return t={type:"unregister",methods:[e.repoId]},[4,this.session.send(t)];case 1:return n.sent(),[2]}}))}))},e.prototype.getBranchList=function(e){return this.streaming.getBranchList(e)},e.prototype.getSubscriptionList=function(e,t){return this.streaming.getSubscriptionList(e,t)},e.prototype.closeAllSubscriptions=function(e,t){this.streaming.closeMultipleSubscriptions(e,t)},e.prototype.pushData=function(e,t,n){this.streaming.pushData(e,t,n)},e.prototype.pushDataToSingle=function(e,t,n){this.streaming.pushDataToSingle(e,t,n)},e.prototype.closeSingleSubscription=function(e,t){this.streaming.closeSingleSubscription(e,t)},e.prototype.acceptRequestOnBranch=function(e,t,n){this.streaming.acceptRequestOnBranch(e,t,n)},e.prototype.rejectRequest=function(e,t,n){this.streaming.rejectRequest(e,t,n)},e.prototype.onSubRequest=function(e){this.streaming.onSubRequest(e)},e.prototype.onSubAdded=function(e){this.streaming.onSubAdded(e)},e.prototype.onSubRemoved=function(e){this.streaming.onSubRemoved(e)},e.prototype.handleInvokeMessage=function(e){var t=e.invocation_id,n=e.caller_id,r=e.method_id,o=e.arguments_kv,i=this.serverRepository.getList().filter((function(e){return e.repoId===r}))[0];if(void 0!==i){var s={args:o,instance:this.clientRepository.getServerById(n).instance};this.callbacks.execute("onInvoked",i,t,s)}},e}(),Xe=function(){function e(e,t){this.repository=e,this.subscriptionData=t}return Object.defineProperty(e.prototype,"requestArguments",{get:function(){return this.subscriptionData.params.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"servers",{get:function(){var e=this;return this.subscriptionData.trackedServers.filter((function(e){return e.subscriptionId})).map((function(t){return e.repository.getServerById(t.serverId).instance}))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"serverInstance",{get:function(){return this.servers[0]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stream",{get:function(){return this.subscriptionData.method},enumerable:!0,configurable:!0}),e.prototype.onData=function(e){if("function"!=typeof e)throw new TypeError("The data callback must be a function.");this.subscriptionData.handlers.onData.push(e),1===this.subscriptionData.handlers.onData.length&&this.subscriptionData.queued.data.length>0&&this.subscriptionData.queued.data.forEach((function(t){e(t)}))},e.prototype.onClosed=function(e){if("function"!=typeof e)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onClosed.push(e)},e.prototype.onFailed=function(e){},e.prototype.onConnected=function(e){if("function"!=typeof e)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onConnected.push(e)},e.prototype.close=function(){this.subscriptionData.close()},e.prototype.setNewSubscription=function(e){this.subscriptionData=e},e}(),Qe="awaitingAccept",Ze="subscribed",$e="Subscription failed.",et="ClientInitiated",tt=function(){function e(e,t,n){var r=this;this.session=e,this.repository=t,this.logger=n,this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},this.nextSubLocalKey=0,this.handleErrorSubscribing=function(e){var t=e._tag,n=t.subLocalKey,o=r.subscriptionsList[n];if("object"==typeof o&&(o.trackedServers=o.trackedServers.filter((function(e){return e.serverId!==t.serverId})),o.trackedServers.length<=0)){if(clearTimeout(o.timeoutId),o.status===Qe){var i="string"==typeof e.reason&&""!==e.reason?' Publisher said "'+e.reason+'".':" No reason given.",s="object"==typeof o.params.arguments?JSON.stringify(o.params.arguments):"{}";o.error({message:"Subscription rejected."+i+" Called with:"+s,called_with:o.params.arguments,method:o.method})}else o.status===Ze&&r.callOnClosedHandlers(o);delete r.subscriptionsList[n]}},this.handleSubscribed=function(e){var t=e._tag.subLocalKey,n=r.subscriptionsList[t];if("object"==typeof n){var o=e._tag.serverId,i=n.trackedServers.filter((function(e){return e.serverId===o}))[0];if("object"==typeof i){i.subscriptionId=e.subscription_id,r.subscriptionIdToLocalKeyMap[e.subscription_id]=t;var s=n.status===Qe;if(n.status=Ze,s){var a=!1,c=n.subscription;c?(c.setNewSubscription(n),n.success(c),a=!0):(c=new Xe(r.repository,n),n.subscription=c,n.success(c));for(var u=0,d=n.handlers.onConnected;u<d.length;u++){var p=d[u];try{p(c.serverInstance,a)}catch(e){}}}}}},this.handleEventData=function(e){var t=r.subscriptionIdToLocalKeyMap[e.subscription_id];if(void 0!==t){var n=r.subscriptionsList[t];if("object"==typeof n){var o=n.trackedServers.filter((function(t){return t.subscriptionId===e.subscription_id}));if(1===o.length){var i=e.oob,s=o[0].serverId,a=function(){return{data:e.data,server:r.repository.getServerById(s).instance,requestArguments:n.params.arguments,message:void 0,private:i}},c=n.handlers.onData,u=n.queued.data;c.length>0?c.forEach((function(e){"function"==typeof e&&e(a())})):u.push(a())}}}},this.handleSubscriptionCancelled=function(e){var t=r.subscriptionIdToLocalKeyMap[e.subscription_id];if(void 0!==t){var n=r.subscriptionsList[t];if("object"==typeof n){var o=n.trackedServers.length-1;n.trackedServers=n.trackedServers.filter((function(t){return t.subscriptionId!==e.subscription_id||(n.queued.closers.push(t.serverId),!1)})),n.trackedServers.length===o&&(n.trackedServers.length<=0&&(clearTimeout(n.timeoutId),r.callOnClosedHandlers(n),delete r.subscriptionsList[t]),delete r.subscriptionIdToLocalKeyMap[e.subscription_id])}}},e.on("subscribed",this.handleSubscribed),e.on("event",this.handleEventData),e.on("subscription-cancelled",this.handleSubscriptionCancelled)}return e.prototype.subscribe=function(e,t,n,r,o,i){var s=this;if(0!==n.length){var a=this.getNextSubscriptionLocalKey(),c=this.registerSubscription(a,e,t,r,o,t.methodResponseTimeout||1e4,i);"object"==typeof c?n.forEach((function(n){var r=n.server.id,o=n.methods.find((function(t){return t.name===e.name}));if(o){c.trackedServers.push({serverId:r,subscriptionId:void 0});var i={type:"subscribe",server_id:r,method_id:o.gatewayId,arguments_kv:t.arguments};s.session.send(i,{serverId:r,subLocalKey:a}).then((function(e){return s.handleSubscribed(e)})).catch((function(e){return s.handleErrorSubscribing(e)}))}else s.logger.error("can not find method "+e.name+" for target "+n.server.id)})):o({method:e,called_with:t.arguments,message:$e+" Unable to register the user callbacks."})}else o({method:e,called_with:t.arguments,message:$e+" No available servers matched the target params."})},e.prototype.drainSubscriptions=function(){var e=Object.values(this.subscriptionsList);return this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},e},e.prototype.getNextSubscriptionLocalKey=function(){var e=this.nextSubLocalKey;return this.nextSubLocalKey+=1,e},e.prototype.registerSubscription=function(e,t,n,r,o,i,s){var a=this,c={localKey:e,status:Qe,method:t,params:n,success:r,error:o,trackedServers:[],handlers:{onData:(null==s?void 0:s.handlers.onData)||[],onClosed:(null==s?void 0:s.handlers.onClosed)||[],onConnected:(null==s?void 0:s.handlers.onConnected)||[]},queued:{data:[],closers:[]},timeoutId:void 0,close:function(){return a.closeSubscription(e)},subscription:null==s?void 0:s.subscription};return s||(n.onData&&c.handlers.onData.push(n.onData),n.onClosed&&c.handlers.onClosed.push(n.onClosed),n.onConnected&&c.handlers.onConnected.push(n.onConnected)),this.subscriptionsList[e]=c,c.timeoutId=setTimeout((function(){if(void 0!==a.subscriptionsList[e]){var r=a.subscriptionsList[e];r.status===Qe?(o({method:t,called_with:n.arguments,message:$e+" Subscription attempt timed out after "+i+" ms."}),delete a.subscriptionsList[e]):r.status===Ze&&r.trackedServers.length>0&&(r.trackedServers=r.trackedServers.filter((function(e){return void 0!==e.subscriptionId})),delete r.timeoutId,r.trackedServers.length<=0&&(a.callOnClosedHandlers(r),delete a.subscriptionsList[e]))}}),i),c},e.prototype.callOnClosedHandlers=function(e,t){var n,r=e.queued.closers.length,o=r>0?e.queued.closers[r-1]:null;void 0!==o&&"string"==typeof o&&(n=this.repository.getServerById(o).instance),e.handlers.onClosed.forEach((function(r){"function"==typeof r&&r({message:t||"ServerInitiated",requestArguments:e.params.arguments||{},server:n,stream:e.method})}))},e.prototype.closeSubscription=function(e){var t=this,n=this.subscriptionsList[e];"object"==typeof n&&(n.trackedServers.forEach((function(e){void 0!==e.subscriptionId&&(n.queued.closers.push(e.serverId),t.session.sendFireAndForget({type:"unsubscribe",subscription_id:e.subscriptionId,reason_uri:"",reason:et}),delete t.subscriptionIdToLocalKeyMap[e.subscriptionId])})),n.trackedServers=[],this.callOnClosedHandlers(n,et),delete this.subscriptionsList[e])},e}(),nt=function(){function e(e,t,n){var r=this;this.session=e,this.repository=t,this.logger=n,e.on("peer-added",(function(e){return r.handlePeerAdded(e)})),e.on("peer-removed",(function(e){return r.handlePeerRemoved(e)})),e.on("methods-added",(function(e){return r.handleMethodsAddedMessage(e)})),e.on("methods-removed",(function(e){return r.handleMethodsRemovedMessage(e)})),this.streaming=new tt(e,t,n)}return e.prototype.subscribe=function(e,t,n,r,o,i){this.streaming.subscribe(e,t,n,r,o,i)},e.prototype.invoke=function(e,t,n,r){var o=this,i=r.id,s={type:"call",server_id:i,method_id:t.gatewayId,arguments_kv:n};return this.session.send(s,{invocationId:e,serverId:i}).then((function(e){return o.handleResultMessage(e)})).catch((function(e){return o.handleInvocationError(e)}))},e.prototype.drainSubscriptions=function(){return this.streaming.drainSubscriptions()},e.prototype.handlePeerAdded=function(e){var t=e.new_peer_id,n=e.identity,r=!e.meta||e.meta.local,o=Number(n.process),i={machine:n.machine,pid:isNaN(o)?n.process:o,instance:n.instance,application:n.application,applicationName:n.applicationName,environment:n.environment,region:n.region,user:n.user,windowId:n.windowId,peerId:t,api:n.api,isLocal:r};this.repository.addServer(i,t)},e.prototype.handlePeerRemoved=function(e){var t=e.removed_id,n=e.reason;this.repository.removeServerById(t,n)},e.prototype.handleMethodsAddedMessage=function(e){var t=this,n=e.server_id;e.methods.forEach((function(e){t.repository.addServerMethod(n,e)}))},e.prototype.handleMethodsRemovedMessage=function(e){var t=this,n=e.server_id,r=e.methods,o=this.repository.getServerById(n);Object.keys(o.methods).forEach((function(e){var i=o.methods[e];r.indexOf(i.gatewayId)>-1&&t.repository.removeServerMethod(n,e)}))},e.prototype.handleResultMessage=function(e){var t=e._tag.invocationId,n=e.result,r=e._tag.serverId;return{invocationId:t,result:n,instance:this.repository.getServerById(r).instance,status:Pe.Success,message:""}},e.prototype.handleInvocationError=function(e){if(this.logger.debug("handle invocation error "+JSON.stringify(e)),"_tag"in e){var t=e._tag.invocationId,n=e._tag.serverId,r=this.repository.getServerById(n),o=e.reason;return{invocationId:t,result:e.context,instance:r.instance,status:Pe.Error,message:o}}return{invocationId:"",message:e.message,status:Pe.Error,error:e}},e}();function rt(e,t,n,r,o,i){var s,a=o.logger.subLogger("gw3-protocol"),c=new Promise((function(e){s=e})),u=t.domain("agm",["subscribed"]),d=new Ye(u,n,r,a.subLogger("server")),p=new nt(u,n,a.subLogger("client"));return u.onJoined((function(o){n.addServer(e,t.peerId),o?function(){a.info("reconnected - will replay registered methods and subscriptions");for(var e=0,t=p.drainSubscriptions();e<t.length;e++){var n=t[e],o=n.method,s=Object.assign({},n.params);a.info("trying to re-subscribe to method "+o.name),i.client.subscribe(o,s,void 0,void 0,n)}var c=r.getList();r.reset();for(var u=0,d=c;u<d.length;u++){var h=d[u],l=h.definition;a.info("re-publishing method "+l.name),h.stream?i.server.createStream(l,h.streamCallbacks,void 0,void 0,h.stream):h.theFunction&&h.theFunction.userCallback?i.register(l,h.theFunction.userCallback):h.theFunction&&h.theFunction.userCallbackAsync&&i.registerAsync(l,h.theFunction.userCallbackAsync)}}():s&&(s({client:p,server:d}),s=void 0)})),u.onLeft((function(){n.reset()})),u.join(),c}var ot=function(){function e(e){var t=this;if(void 0===e)throw new Error("configuration is required");if(void 0===e.connection)throw new Error("configuration.connections is required");var n,r=e.connection;if("number"!=typeof e.methodResponseTimeout&&(e.methodResponseTimeout=3e4),"number"!=typeof e.waitTimeoutMs&&(e.waitTimeoutMs=3e4),this.unwrappedInstance=new Be(this,void 0,r),this.instance=this.unwrappedInstance.unwrap(),this.clientRepository=new Ve(e.logger.subLogger("cRep"),this),this.serverRepository=new He,3!==r.protocolVersion)throw new Error("protocol "+r.protocolVersion+" not supported");n=rt(this.instance,r,this.clientRepository,this.serverRepository,e,this),this.readyPromise=n.then((function(n){return t.protocol=n,t.client=new Ne(t.protocol,t.clientRepository,t.instance,e),t.server=new Ue(t.protocol,t.serverRepository),t}))}return e.prototype.ready=function(){return this.readyPromise},e.prototype.serverRemoved=function(e){return this.client.serverRemoved(e)},e.prototype.serverAdded=function(e){return this.client.serverAdded(e)},e.prototype.serverMethodRemoved=function(e){return this.client.serverMethodRemoved(e)},e.prototype.serverMethodAdded=function(e){return this.client.serverMethodAdded(e)},e.prototype.methodRemoved=function(e){return this.client.methodRemoved(e)},e.prototype.methodAdded=function(e){return this.client.methodAdded(e)},e.prototype.methodsForInstance=function(e){return this.client.methodsForInstance(e)},e.prototype.methods=function(e){return this.client.methods(e)},e.prototype.servers=function(e){return this.client.servers(e)},e.prototype.subscribe=function(e,t,n,r){return this.client.subscribe(e,t,n,r)},e.prototype.createStream=function(e,t,n,r){return this.server.createStream(e,t,n,r)},e.prototype.unregister=function(e){return this.server.unregister(e)},e.prototype.registerAsync=function(e,t){return this.server.registerAsync(e,t)},e.prototype.register=function(e,t){return this.server.register(e,t)},e.prototype.invoke=function(e,t,n,r,o,i){return this.client.invoke(e,t,n,r,o,i)},e.prototype.waitForMethod=function(e){var t=new R,n=this.client.methodAdded((function(r){r.name===e&&(n(),t.resolve(r))}));return t.promise},e}(),it=["subscribed","success"],st=function(){function e(e,t){var n=this;this.publish=function(e,t,r){var o=r||{},i=o.routingKey,s=o.target,a=n.removeEmptyValues({type:"publish",topic:e,data:t,peer_id:n.peerId,routing_key:i,target_identity:s});n.session.send(a)},this.subscribe=function(e,t,r){return new Promise((function(o,i){var s=r||{},a=s.routingKey,c=s.target,u=n.removeEmptyValues({type:"subscribe",topic:e,peer_id:n.peerId,routing_key:a,source:c});n.session.send(u).then((function(r){var i=r.subscription_id;n.subscriptions.push({subscription_id:i,topic:e,callback:t,source:c}),o({unsubscribe:function(){return n.session.send({type:"unsubscribe",subscription_id:i,peer_id:n.peerId}),n.subscriptions=n.subscriptions.filter((function(e){return e.subscription_id!==i})),Promise.resolve()}})})).catch((function(e){return i(e)}))}))},this.watchOnEvent=function(){n.session.on("event",(function(e){var t=e.data,r=e.subscription_id,o=e["publisher-identity"],i=n.subscriptions.find((function(e){return e.subscription_id===r}));i&&(i.source?n.keysMatch(i.source,o)&&i.callback(t,i.topic,o):i.callback(t,i.topic,o))}))},this.connection=e,this.logger=t,this.peerId=e.peerId,this.subscriptions=[],this.session=e.domain("bus",it),this.readyPromise=this.session.join(),this.readyPromise.then((function(){n.watchOnEvent()}))}return e.prototype.ready=function(){return this.readyPromise},e.prototype.removeEmptyValues=function(e){var t={};return Object.keys(e).forEach((function(n){void 0!==e[n]&&null!==e[n]&&(t[n]=e[n])})),t},e.prototype.keysMatch=function(e,t){var n=Object.keys(e),r=!0;return n.forEach((function(n){e[n]!==t[n]&&(r=!1)})),r},e}(),at=function(e,t){var n,i=C.getGDMajorVersion(),s=Promise.resolve();if(i){if(i<3)throw new Error("GD v2 is not supported. Use v4 of the API to run in that context.");i>=3&&(n=window.glue42gd,s=window.gdPreloadPromise||s)}var a,c,u,d,p,h,l,f=A("glue"),g=function(e,t,n){var r,o,i,s,a,c;if(C.isNode()){var u=process.env._GD_STARTING_CONTEXT_;if(u)try{c=JSON.parse(u)}catch(e){}}function d(){if(e.application)return e.application;if(n)return n.applicationName;var t=Z();return C.isNode()?c?c.applicationConfig.name:"NodeJS"+t:"undefined"!=typeof window&&"undefined"!=typeof document?document.title+" ("+t+")":t}var p=function(){var r,o,i,s,a,u,p,h,l,f,g=e.gateway,m=null!==(r=null==g?void 0:g.protocolVersion)&&void 0!==r?r:3,v=null==g?void 0:g.reconnectInterval,y=null==g?void 0:g.reconnectAttempts,b=null==g?void 0:g.ws,w=null==g?void 0:g.sharedWorker,S=null==g?void 0:g.inproc,_=null!==(o=null==g?void 0:g.webPlatform)&&void 0!==o?o:void 0;n&&(b=n.gwURL),C.isNode()&&c&&c.gwURL&&(b=c.gwURL),b||w||S||(b="ws://localhost:8385");var k=d(),I=k;void 0!==n?(p=n.windowId,h=n.pid,n.env&&(l=n.env.env,f=n.env.region),I=null!==(i=n.application)&&void 0!==i?i:"glue-app",u=n.appInstanceId):C.isNode()&&(h=process.pid,c&&(l=c.env,f=c.region,u=c.instanceId));var M=null!==(a=null===(s=e.gateway)||void 0===s?void 0:s.replaySpecs)&&void 0!==a?a:[];return M.push(we),{identity:{application:I,applicationName:k,windowId:p,instance:u,process:h,region:f,environment:l,api:t.version||Se},reconnectInterval:v,ws:b,sharedWorker:w,webPlatform:_,inproc:S,protocolVersion:m,reconnectAttempts:y,replaySpecs:M}}(),h=d();if("undefined"!=typeof window){var l=window,f=l.htmlContainer?l.htmlContainer.containerName+"."+l.htmlContainer.application:null===(r=null==l?void 0:l.glue42gd)||void 0===r?void 0:r.application;f&&(h=f)}return{bus:null!==(o=e.bus)&&void 0!==o&&o,application:h,auth:function(){var t,n,r;return"string"==typeof e.auth?{token:e.auth}:e.auth?e.auth:C.isNode()&&c&&c.gwToken?{gatewayToken:c.gwToken}:(null===(t=e.gateway)||void 0===t?void 0:t.webPlatform)||(null===(n=e.gateway)||void 0===n?void 0:n.inproc)||(null===(r=e.gateway)||void 0===r?void 0:r.sharedWorker)?{username:"glue42",password:"glue42"}:void 0}(),logger:function(){var t,r,o,i=e.logger,s="warn";return i||(i=s),n&&(o=n.consoleLogLevel),"string"==typeof i?{console:null!=o?o:i,publish:s}:{console:null!==(t=null!=o?o:i.console)&&void 0!==t?t:s,publish:null!==(r=i.publish)&&void 0!==r?r:s}}(),connection:p,metrics:null===(i=e.metrics)||void 0===i||i,contexts:null===(s=e.contexts)||void 0===s||s,version:t.version||Se,libs:null!==(a=t.libs)&&void 0!==a?a:[],customLogger:e.customLogger}}(e=e||{},t=t||{},n),m={};function v(e,t,n){(l=u.canPublish("trace"))&&u.trace("registering "+e+" module");var r=function(){t.initTime=n.stop(),t.initEndTime=n.endTime,t.marks=n.marks,l&&u.trace(e+" is ready - "+(n.endTime-n.startTime))};t.initStartTime=n.startTime,t.ready?t.ready().then((function(){r()})):r(),Array.isArray(e)||(e=[e]),e.forEach((function(e){m[e]=t,at[e]=t}))}function y(){var e=A("interop"),t={connection:a,logger:u.subLogger("interop")};return c=new ot(t),se.Interop=c,v(["interop","agm"],c,e),Promise.resolve()}function b(){var e=g.activities&&3===a.protocolVersion;if(g.contexts||e){var t=A("contexts");return v("contexts",p=new Re({connection:a,logger:u.subLogger("contexts")}),t),p}var n=a.replayer;n&&n.drain(we.name)}function w(){return r(this,void 0,void 0,(function(){var e;return o(this,(function(t){return g.bus?(e=A("bus"),v("bus",h=new st(a,u.subLogger("bus")),e),[2,Promise.resolve()]):[2,Promise.resolve()]}))}))}function S(e){try{return e.forEach((function(e){!function(e,t){var n=A(e),r=t(m);r&&v(e,r,n)}(e.name,e.create)})),Promise.resolve()}catch(e){return Promise.reject(e)}}return s.then((function(){var e,t=A("logger");return(u=new se(""+(null===(e=g.connection.identity)||void 0===e?void 0:e.application),void 0,g.customLogger)).consoleLevel(g.logger.console),u.publishLevel(g.logger.publish),u.canPublish("debug")&&u.debug("initializing glue..."),v("logger",u,t),Promise.resolve(void 0)})).then((function(){var e=A("connection");a=new oe(g.connection,u.subLogger("connection"));var t=Promise.resolve(g.auth);return g.connection&&!g.auth&&(t=n?n.getGWToken().then((function(e){return{gatewayToken:e}})):Promise.reject("You need to provide auth information")),t.then((function(t){var n;if(e.mark("auth-promise-resolved"),"[object Object]"!==Object.prototype.toString.call(t))throw new Error("Invalid auth object - "+JSON.stringify(t));return n=t,a.login(n)})).then((function(){return v("connection",a,e),g})).catch((function(e){throw a&&a.logout(),e}))})).then((function(){return Promise.all([(s=A("metrics"),c=g.metrics,p=null==n?void 0:n.getMetricsPublishingEnabled,h=g.connection.identity,l=p||function(){return!0},f=null!==(e="boolean"!=typeof c&&c.disableAutoAppSystem)&&void 0!==e&&e,v("metrics",d=M({connection:c?a:void 0,logger:u.subLogger("metrics"),canUpdateMetric:l,system:"Glue42",service:null!==(r=null!==(t=null==h?void 0:h.service)&&void 0!==t?t:null==n?void 0:n.applicationName)&&void 0!==r?r:g.application,instance:null!==(i=null!==(o=null==h?void 0:h.instance)&&void 0!==o?o:null==h?void 0:h.windowId)&&void 0!==i?i:Z(),disableAutoAppSystem:f,pagePerformanceMetrics:"boolean"!=typeof c?null==c?void 0:c.pagePerformanceMetrics:void 0}),s),Promise.resolve()),y(),b(),w()]);var e,t,r,o,i,s,c,p,h,l,f})).then((function(){return c.readyPromise})).then((function(){return S(g.libs||[])})).then((function(){var e=Object.keys(m).map((function(e){var t=m[e];return t.ready?t.ready():Promise.resolve()}));return Promise.all(e)})).then((function(){var r={coreVersion:Se,version:g.version};f.stop();var o={feedback:function(e){c&&c.invoke("T42.ACS.Feedback",e,"best")},info:r,logger:u,interop:c,agm:c,connection:a,metrics:d,contexts:p,bus:h,version:g.version,userConfig:e,done:function(){return null==u||u.info("done called by user..."),a.logout()}};if(o.performance={get glueVer(){return g.version},get glueConfig(){return JSON.stringify(e)},get browser(){return window.performance.timing.toJSON()},get memory(){return window.performance.memory},get initTimes(){var e=O;return Object.keys(e).map((function(t){var n=e[t];return{name:t,duration:n.endTime-n.startTime,marks:n.marks,startTime:n.startTime,endTime:n.endTime}}))}},Object.keys(m).forEach((function(e){var t=m[e];o[e]=t})),o.config={},Object.keys(g).forEach((function(e){o.config[e]=g[e]})),t&&t.extOptions&&Object.keys(t.extOptions).forEach((function(e){o.config[e]=null==t?void 0:t.extOptions[e]})),(null==t?void 0:t.enrichGlue)&&t.enrichGlue(o),n&&n.updatePerfData&&n.updatePerfData(o.performance),o.agm){var i=function(e,t,n){return function(){return o.logger.warn("glue.js - 'glue.agm."+t+"' method is deprecated, use 'glue.interop."+n+"' instead."),e.apply(o.agm,arguments)}},s=o.agm;s.method_added=i(o.agm.methodAdded,"method_added","methodAdded"),s.method_removed=i(o.agm.methodRemoved,"method_removed","methodRemoved"),s.server_added=i(o.agm.serverAdded,"server_added","serverAdded"),s.server_method_aded=i(o.agm.serverMethodAdded,"server_method_aded","serverMethodAdded"),s.server_method_removed=i(o.agm.serverMethodRemoved,"server_method_removed","serverMethodRemoved")}return o})).catch((function(e){return Promise.reject({err:e,libs:m})}))};return"undefined"!=typeof window&&(window.GlueCore=at),at.version=Se,at.default=at,at}));
//# sourceMappingURL=core.umd.min.js.map

{"version":3,"file":"core.es.js","sources":["../src/metrics/const/metric-types.ts","../src/metrics/protocols/gw3/serializer.ts","../src/metrics/protocols/gw3/gw3.ts","../src/metrics/helpers.ts","../src/metrics/metrics/base.ts","../src/metrics/metrics/number.ts","../src/metrics/metrics/object.ts","../src/metrics/metrics/string.ts","../src/metrics/metrics/timestamp.ts","../src/metrics/system.ts","../src/metrics/repository.ts","../src/metrics/protocols/null/null.ts","../src/metrics/pertTracker.ts","../src/metrics/main.ts","../node_modules/callback-registry/lib/index.js","../src/connection/transports/inProc.ts","../src/connection/transports/worker.ts","../src/utils/utils.ts","../src/utils/pw.ts","../src/utils/timer.ts","../src/connection/transports/ws.ts","../node_modules/shortid/lib/random/random-from-seed.js","../node_modules/shortid/lib/alphabet.js","../node_modules/shortid/lib/random/random-byte-browser.js","../node_modules/shortid/lib/encode.js","../node_modules/shortid/lib/decode.js","../node_modules/shortid/lib/is-valid.js","../node_modules/shortid/lib/index.js","../node_modules/shortid/index.js","../src/connection/protocols/gw3Domain.ts","../src/connection/protocols/gw3.ts","../src/connection/replayer.ts","../src/utils/promise-plus.ts","../src/connection/transports/webPlatform.ts","../src/connection/connection.ts","../src/logger/logger.ts","../src/contexts/bridges/gw3/messages.ts","../src/contexts/contextMessageReplaySpec.ts","../src/config.ts","../src/contexts/bridges/gw3/contextData.ts","../src/contexts/helpers.ts","../src/contexts/bridges/gw3/bridge.ts","../src/contexts/contextsModule.ts","../src/interop/helpers/promisify.ts","../src/interop/helpers/promiseHelpers.ts","../src/interop/client/client.ts","../src/interop/server/subscription.ts","../src/interop/server/request.ts","../src/interop/server/streaming.ts","../src/interop/server/branch.ts","../src/interop/server/stream.ts","../src/interop/server/server.ts","../src/interop/instance.ts","../src/interop/client/repository.ts","../src/interop/server/repository.ts","../src/interop/protocols/gw3/server-streaming.ts","../src/interop/protocols/gw3/server.ts","../src/interop/protocols/gw3/subscription.ts","../src/interop/protocols/gw3/client-streaming.ts","../src/interop/protocols/gw3/client.ts","../src/interop/protocols/gw3/factory.ts","../src/interop/interop.ts","../src/bus/main.ts","../src/index.ts"],"sourcesContent":["export default {\r\n    STRING: 1,\r\n    NUMBER: 2,\r\n    TIMESTAMP: 3,\r\n    OBJECT: 4\r\n};\r\n","import { Glue42Core } from \"../../../../glue\";\r\nimport MetricTypes from \"../../const/metric-types\";\r\n\r\nfunction getMetricTypeByValue(metric: Glue42Core.Metrics.Metric): string {\r\n\r\n    if (metric.type === MetricTypes.TIMESTAMP) {\r\n        return \"timestamp\";\r\n    } else if (metric.type === MetricTypes.NUMBER) {\r\n        return \"number\";\r\n    } else if (metric.type === MetricTypes.STRING) {\r\n        return \"string\";\r\n    } else if (metric.type === MetricTypes.OBJECT) {\r\n        return \"object\";\r\n    }\r\n\r\n    return \"unknown\";\r\n}\r\n\r\nfunction getTypeByValue(value: any): string {\r\n\r\n    if (value.constructor === Date) {\r\n        return \"timestamp\";\r\n    } else if (typeof value === \"number\") {\r\n        return \"number\";\r\n    } else if (typeof value === \"string\") {\r\n        return \"string\";\r\n    } else if (typeof value === \"object\") {\r\n        return \"object\";\r\n    } else {\r\n        return \"string\";\r\n    }\r\n}\r\n\r\nfunction serializeMetric(metric: Glue42Core.Metrics.Metric): any {\r\n\r\n    const serializedMetrics: any = {};\r\n    const type = getMetricTypeByValue(metric);\r\n    if (type === \"object\") {\r\n        const values = Object.keys(metric.value).reduce((memo: any, key: any) => {\r\n            const innerType = getTypeByValue(metric.value[key]);\r\n            if (innerType === \"object\") {\r\n                const composite = defineNestedComposite(metric.value[key]);\r\n                memo[key] = {\r\n                    type: \"object\",\r\n                    description: \"\",\r\n                    context: {},\r\n                    composite,\r\n                };\r\n            } else {\r\n                memo[key] = {\r\n                    type: innerType,\r\n                    description: \"\",\r\n                    context: {},\r\n                };\r\n            }\r\n\r\n            return memo;\r\n        }, {});\r\n\r\n        serializedMetrics.composite = values;\r\n    }\r\n\r\n    serializedMetrics.name = normalizeMetricName(metric.path.join(\"/\") + \"/\" + metric.name);\r\n    serializedMetrics.type = type;\r\n    serializedMetrics.description = metric.description;\r\n    serializedMetrics.context = {};\r\n\r\n    return serializedMetrics;\r\n}\r\n\r\nfunction defineNestedComposite(values: any): any {\r\n    return Object.keys(values).reduce((memo: any, key: any) => {\r\n        const type = getTypeByValue(values[key]);\r\n        if (type === \"object\") {\r\n            memo[key] = {\r\n                type: \"object\",\r\n                description: \"\",\r\n                context: {},\r\n                composite: defineNestedComposite(values[key]),\r\n            };\r\n        } else {\r\n            memo[key] = {\r\n                type,\r\n                description: \"\",\r\n                context: {},\r\n            };\r\n        }\r\n\r\n        return memo;\r\n    }, {});\r\n}\r\n\r\nfunction normalizeMetricName(name: string): string {\r\n    if (typeof name !== \"undefined\" && name.length > 0 && name[0] !== \"/\") {\r\n        return \"/\" + name;\r\n    } else {\r\n        return name;\r\n    }\r\n}\r\n\r\nfunction getMetricValueByType(metric: Glue42Core.Metrics.Metric) {\r\n    const type: string = getMetricTypeByValue(metric);\r\n    if (type === \"timestamp\") {\r\n        return Date.now();\r\n    } else {\r\n        return publishNestedComposite(metric.value);\r\n    }\r\n}\r\n\r\nfunction publishNestedComposite(values: any) {\r\n    if (typeof values !== \"object\") {\r\n        return values;\r\n    }\r\n    return Object.keys(values).reduce((memo: any, key: any) => {\r\n        const value = values[key];\r\n        if (typeof value === \"object\" && value.constructor !== Date) {\r\n            memo[key] = publishNestedComposite(value);\r\n        } else if (value.constructor === Date) {\r\n            memo[key] = new Date(value).getTime();\r\n        } else if (value.constructor === Boolean) {\r\n            memo[key] = value.toString();\r\n        } else {\r\n            memo[key] = value;\r\n        }\r\n\r\n        return memo;\r\n    }, {});\r\n}\r\n\r\nfunction flatten(arr: any[]): Glue42Core.Metrics.SystemStateInfo[] {\r\n    return arr.reduce((flat: Glue42Core.Metrics.SystemStateInfo[], toFlatten: Glue42Core.Metrics.SystemStateInfo | Glue42Core.Metrics.SystemStateInfo[]): Glue42Core.Metrics.SystemStateInfo[] => {\r\n        return flat.concat(Array.isArray(toFlatten) ? flatten(toFlatten) : toFlatten);\r\n    }, []);\r\n}\r\n\r\nfunction getHighestState(arr: Glue42Core.Metrics.SystemStateInfo[]): Glue42Core.Metrics.SystemStateInfo {\r\n    return arr.sort((a, b) => {\r\n        if (!a.state) { return 1; }\r\n        if (!b.state) { return -1; }\r\n\r\n        return b.state - a.state;\r\n    })[0];\r\n}\r\n\r\nfunction aggregateDescription(arr: Glue42Core.Metrics.SystemStateInfo[]): string {\r\n    let msg = \"\";\r\n    arr.forEach((m: any, idx: number, a: any[]) => {\r\n        const path = m.path.join(\".\");\r\n        if (idx === a.length - 1) {\r\n            msg += path + \".\" + m.name + \": \" + m.description;\r\n        } else {\r\n            msg += path + \".\" + m.name + \": \" + m.description + \",\";\r\n        }\r\n    });\r\n    if (msg.length > 100) {\r\n        return msg.slice(0, 100) + \"...\";\r\n    } else {\r\n        return msg;\r\n    }\r\n}\r\n\r\nfunction composeMsgForRootStateMetric(system: Glue42Core.Metrics.System): any {\r\n    const aggregatedState: Glue42Core.Metrics.SystemStateInfo[] = system.root.getAggregateState();\r\n    const merged = flatten(aggregatedState);\r\n    const highestState = getHighestState(merged);\r\n    const aggregateDesc = aggregateDescription(merged);\r\n    return {\r\n        description: aggregateDesc,\r\n        value: highestState.state,\r\n    };\r\n}\r\n\r\nexport { normalizeMetricName, serializeMetric, getMetricValueByType, composeMsgForRootStateMetric };\r\n","import { Glue42Core } from \"../../../../glue\";\r\nimport { Protocol, MetricsSettings } from \"../../types\";\r\nimport { composeMsgForRootStateMetric, getMetricValueByType, normalizeMetricName, serializeMetric } from \"./serializer\";\r\nimport Connection from \"../../../connection/connection\";\r\n\r\nexport default function (connection: Connection, config: MetricsSettings): Protocol {\r\n    if (!connection || typeof connection !== \"object\") {\r\n        throw new Error(\"Connection is required parameter\");\r\n    }\r\n\r\n    let joinPromise: Promise<any>;\r\n    let session: Glue42Core.Connection.GW3DomainSession;\r\n\r\n    const init = (repo: Glue42Core.Metrics.Repository): void => {\r\n        let resolveReadyPromise: (() => void) | undefined;\r\n        joinPromise = new Promise((resolve) => {\r\n            resolveReadyPromise = resolve;\r\n        });\r\n\r\n        session = connection.domain(\"metrics\");\r\n\r\n        session.onJoined((reconnect) => {\r\n            if (!reconnect && resolveReadyPromise) {\r\n                resolveReadyPromise();\r\n                resolveReadyPromise = undefined;\r\n            }\r\n\r\n            // Creating root state metric\r\n            const rootStateMetric: any = {\r\n                name: \"/State\",\r\n                type: \"object\",\r\n                composite: {\r\n                    Description: {\r\n                        type: \"string\",\r\n                        description: \"\",\r\n                    },\r\n                    Value: {\r\n                        type: \"number\",\r\n                        description: \"\",\r\n                    },\r\n                },\r\n                description: \"System state\",\r\n                context: {},\r\n            };\r\n\r\n            const defineRootMetricsMsg = {\r\n                type: \"define\",\r\n                metrics: [rootStateMetric],\r\n            };\r\n\r\n            session.send(defineRootMetricsMsg);\r\n\r\n            if (reconnect) {\r\n                replayRepo(repo);\r\n            }\r\n\r\n        });\r\n\r\n        session.join({\r\n            system: config.system,\r\n            service: config.service,\r\n            instance: config.instance\r\n        });\r\n    };\r\n\r\n    const replayRepo = (repo: Glue42Core.Metrics.Repository) => {\r\n        replaySystem(repo.root);\r\n    };\r\n\r\n    const replaySystem = (system: Glue42Core.Metrics.System) => {\r\n        // replay system\r\n        createSystem(system);\r\n\r\n        // replay all metrics in the system\r\n        system.metrics.forEach((m) => {\r\n            createMetric(m);\r\n        });\r\n\r\n        // replay all sub-systems\r\n        system.subSystems.forEach((ss) => {\r\n            replaySystem(ss);\r\n        });\r\n    };\r\n\r\n    const createSystem = async (system: Glue42Core.Metrics.System): Promise<void> => {\r\n        if (system.parent === undefined) {\r\n            return;\r\n        }\r\n\r\n        await joinPromise;\r\n        const metric = {\r\n            name: normalizeMetricName(system.path.join(\"/\") + \"/\" + system.name + \"/State\"),\r\n            type: \"object\",\r\n            composite: {\r\n                Description: {\r\n                    type: \"string\",\r\n                    description: \"\",\r\n                },\r\n                Value: {\r\n                    type: \"number\",\r\n                    description: \"\",\r\n                },\r\n            },\r\n            description: \"System state\",\r\n            context: {},\r\n        };\r\n\r\n        const createMetricsMsg = {\r\n            type: \"define\",\r\n            metrics: [metric],\r\n        };\r\n\r\n        session.send(createMetricsMsg);\r\n    };\r\n\r\n    const updateSystem = async (system: Glue42Core.Metrics.System, state: Glue42Core.Metrics.State): Promise<void> => {\r\n        await joinPromise;\r\n\r\n        const shadowedUpdateMetric = {\r\n            type: \"publish\",\r\n            values: [{\r\n                name: normalizeMetricName(system.path.join(\"/\") + \"/\" + system.name + \"/State\"),\r\n                value: {\r\n                    Description: state.description,\r\n                    Value: state.state,\r\n                },\r\n                timestamp: Date.now(),\r\n            }],\r\n        };\r\n\r\n        session.send(shadowedUpdateMetric);\r\n\r\n        const stateObj = composeMsgForRootStateMetric(system);\r\n        const rootMetric = {\r\n            type: \"publish\",\r\n            peer_id: connection.peerId,\r\n            values: [{\r\n                name: \"/State\",\r\n                value: {\r\n                    Description: stateObj.description,\r\n                    Value: stateObj.value,\r\n                },\r\n                timestamp: Date.now(),\r\n            }],\r\n        };\r\n\r\n        session.send(rootMetric);\r\n    };\r\n\r\n    const createMetric = async (metric: Glue42Core.Metrics.Metric): Promise<void> => {\r\n        const metricClone = cloneMetric(metric);\r\n        await joinPromise;\r\n        const m = serializeMetric(metricClone);\r\n\r\n        const createMetricsMsg = {\r\n            type: \"define\",\r\n            metrics: [m],\r\n        };\r\n\r\n        session.send(createMetricsMsg);\r\n        if (typeof metricClone.value !== \"undefined\") {\r\n            // do not use updateMetric because it will dispatch the call (joinPromise.then)\r\n            // which leads to method calls reorder. It is safe to call updateMetricCore directly\r\n            // because we are being executed in joinPromise.then\r\n            updateMetricCore(metricClone);\r\n        }\r\n    };\r\n\r\n    const updateMetric = async (metric: Glue42Core.Metrics.Metric): Promise<void> => {\r\n        const metricClone = cloneMetric(metric);\r\n        await joinPromise;\r\n        updateMetricCore(metricClone);\r\n    };\r\n\r\n    const updateMetricCore = (metric: Glue42Core.Metrics.Metric): Promise<void> => {\r\n        if (canUpdate()) {\r\n            const value = getMetricValueByType(metric);\r\n            const publishMetricsMsg = {\r\n                type: \"publish\",\r\n                values: [{\r\n                    name: normalizeMetricName(metric.path.join(\"/\") + \"/\" + metric.name),\r\n                    value,\r\n                    timestamp: Date.now(),\r\n                }],\r\n            };\r\n            return session.sendFireAndForget(publishMetricsMsg);\r\n        }\r\n        return Promise.resolve();\r\n    };\r\n\r\n    const cloneMetric = (metric: Glue42Core.Metrics.Metric): Glue42Core.Metrics.Metric => {\r\n        const metricClone: Glue42Core.Metrics.Metric = { ...metric };\r\n        if (typeof metric.value === \"object\" && metric.value !== null) {\r\n            metricClone.value = { ...metric.value };\r\n        }\r\n        return metricClone;\r\n    };\r\n\r\n    const canUpdate = (): boolean => {\r\n        try {\r\n            const func = config.canUpdateMetric ?? (() => true);\r\n            return func();\r\n        } catch {\r\n            return true;\r\n        }\r\n    };\r\n\r\n    return {\r\n        init,\r\n        createSystem,\r\n        updateSystem,\r\n        createMetric,\r\n        updateMetric,\r\n    };\r\n}\r\n","import { Glue42Core } from \"../../glue\";\r\nimport { Protocol } from \"./types\";\r\n\r\nexport default {\r\n    validate: (definition: Glue42Core.Metrics.MetricDefinition, parent: Glue42Core.Metrics.System, transport: Protocol) => {\r\n        if (definition === null || typeof definition !== \"object\") {\r\n            throw new Error(\"Missing definition\");\r\n        }\r\n        if (parent === null || typeof parent !== \"object\") {\r\n            throw new Error(\"Missing parent\");\r\n        }\r\n        if (transport === null || typeof transport !== \"object\") {\r\n            throw new Error(\"Missing transport\");\r\n        }\r\n    },\r\n};\r\n","import { Glue42Core } from \"../../../glue\";\r\nimport Helpers from \"../helpers\";\r\nimport { Protocol } from \"../types\";\r\n\r\nexport class BaseMetric<T> implements Glue42Core.Metrics.Metric {\r\n    public readonly path: string[] = [];\r\n    public readonly name: string;\r\n    public readonly description: string | undefined;\r\n\r\n    public get repo() {\r\n        return this.system?.repo;\r\n    }\r\n\r\n    public get id() { return `${this.system.path}/${name}`; }\r\n\r\n    constructor(public definition: Glue42Core.Metrics.MetricDefinition, public system: Glue42Core.Metrics.System, protected transport: Protocol, public value: T, public type: number) {\r\n        Helpers.validate(definition, system, transport);\r\n\r\n        this.path = system.path.slice(0);\r\n        this.path.push(system.name);\r\n\r\n        this.name = definition.name;\r\n        this.description = definition.description;\r\n\r\n        transport.createMetric(this);\r\n    }\r\n\r\n    public update(newValue: T): Promise<void> {\r\n        this.value = newValue;\r\n        return this.transport.updateMetric(this);\r\n    }\r\n}\r\n","import { Glue42Core } from \"../../../glue\";\r\nimport { Protocol } from \"../types\";\r\nimport { BaseMetric } from \"./base\";\r\nimport metricTypes from \"../const/metric-types\";\r\n\r\nexport class NumberMetric extends BaseMetric<number> implements Glue42Core.Metrics.NumberMetric {\r\n\r\n    constructor(definition: Glue42Core.Metrics.MetricDefinition, system: Glue42Core.Metrics.System, transport: Protocol, value: number) {\r\n        super(definition, system, transport, value, metricTypes.NUMBER);\r\n    }\r\n\r\n    public incrementBy(num: number): void {\r\n        this.update(this.value + num);\r\n    }\r\n\r\n    public increment(): void {\r\n        this.incrementBy(1);\r\n    }\r\n\r\n    public decrement(): void {\r\n        this.incrementBy(-1);\r\n    }\r\n\r\n    public decrementBy(num: number): void {\r\n        this.incrementBy(num * -1);\r\n    }\r\n}\r\n","import { Glue42Core } from \"../../../glue\";\r\nimport { Protocol } from \"../types\";\r\nimport { BaseMetric } from \"./base\";\r\nimport metricTypes from \"../const/metric-types\";\r\n\r\nexport class ObjectMetric extends BaseMetric<object> implements Glue42Core.Metrics.ObjectMetric {\r\n\r\n    constructor(definition: Glue42Core.Metrics.MetricDefinition, system: Glue42Core.Metrics.System, transport: Protocol, value: object) {\r\n        super(definition, system, transport, value, metricTypes.OBJECT);\r\n    }\r\n\r\n    public update(newValue: object): Promise<void> {\r\n        this.mergeValues(newValue);\r\n        return this.transport.updateMetric(this);\r\n    }\r\n\r\n    private mergeValues(values: any) {\r\n        return Object.keys(this.value).forEach((k) => {\r\n            if (typeof values[k] !== \"undefined\") {\r\n                (this.value as any)[k] = values[k];\r\n            }\r\n        });\r\n    }\r\n}\r\n","import { Glue42Core } from \"../../../glue\";\r\nimport { Protocol } from \"../types\";\r\nimport { BaseMetric } from \"./base\";\r\nimport metricTypes from \"../const/metric-types\";\r\n\r\nexport class StringMetric extends BaseMetric<string> implements Glue42Core.Metrics.StringMetric {\r\n    constructor(definition: Glue42Core.Metrics.MetricDefinition, system: Glue42Core.Metrics.System, transport: Protocol, value: string) {\r\n        super(definition, system, transport, value, metricTypes.STRING);\r\n    }\r\n}\r\n","import { Glue42Core } from \"../../../glue\";\r\nimport { Protocol } from \"../types\";\r\nimport { BaseMetric } from \"./base\";\r\nimport metricTypes from \"../const/metric-types\";\r\n\r\nexport class TimestampMetric extends BaseMetric<Date> implements Glue42Core.Metrics.TimestampMetric {\r\n    constructor(definition: Glue42Core.Metrics.MetricDefinition, system: Glue42Core.Metrics.System, transport: Protocol, value: Date) {\r\n        super(definition, system, transport, value, metricTypes.TIMESTAMP);\r\n    }\r\n\r\n    public now(): void {\r\n        this.update(new Date());\r\n    }\r\n}\r\n","import { NumberMetric } from \"./metrics/number\";\r\nimport { ObjectMetric } from \"./metrics/object\";\r\nimport { StringMetric } from \"./metrics/string\";\r\nimport { TimestampMetric } from \"./metrics/timestamp\";\r\n\r\nimport { Glue42Core } from \"./../../glue\";\r\nimport MetricTypes from \"./const/metric-types\";\r\nimport { Protocol } from \"./types\";\r\n\r\nexport default function system(name: string, repo: Glue42Core.Metrics.Repository, protocol: Protocol, parent?: Glue42Core.Metrics.System, description?: any): Glue42Core.Metrics.System {\r\n    // Validation\r\n    // if (!name) throw new Error(\"Name is required. \");\r\n\r\n    if (!repo) {\r\n        throw new Error(\"Repository is required\");\r\n    }\r\n\r\n    if (!protocol) {\r\n        throw new Error(\"Transport is required\");\r\n    }\r\n\r\n    const _transport: Protocol = protocol;\r\n\r\n    const _name: string = name;\r\n    const _description: string = description || \"\";\r\n    const _repo: Glue42Core.Metrics.Repository = repo;\r\n    const _parent: Glue42Core.Metrics.System | undefined = parent;\r\n    const _path: string[] = _buildPath(parent);\r\n    let _state: Glue42Core.Metrics.State = {};\r\n\r\n    const id: string = _arrayToString(_path, \"/\") + name;\r\n    const root: Glue42Core.Metrics.System = repo.root;\r\n    const _subSystems: Glue42Core.Metrics.System[] = [];\r\n    const _metrics: Glue42Core.Metrics.Metric[] = [];\r\n\r\n    function subSystem(nameSystem: string, descriptionSystem?: string): Glue42Core.Metrics.System {\r\n        if (!nameSystem || nameSystem.length === 0) {\r\n            throw new Error(\"name is required\");\r\n        }\r\n\r\n        const match: Glue42Core.Metrics.System[] = _subSystems.filter((s) => s.name === nameSystem);\r\n        if (match.length > 0) {\r\n            return match[0];\r\n        }\r\n\r\n        const _system: Glue42Core.Metrics.System = system(nameSystem, _repo, _transport, me, descriptionSystem);\r\n        _subSystems.push(_system);\r\n        return _system;\r\n    }\r\n\r\n    function setState(state: number, stateDescription?: string): void {\r\n        _state = { state, description: stateDescription };\r\n        _transport.updateSystem(me, _state);\r\n    }\r\n\r\n    function stringMetric(definition: Glue42Core.Metrics.MetricDefinition | string, value: string): Glue42Core.Metrics.StringMetric {\r\n        return _getOrCreateMetric<StringMetric>(definition, MetricTypes.STRING, value, (metricDef: Glue42Core.Metrics.MetricDefinition) => new StringMetric(metricDef, me, _transport, value));\r\n    }\r\n\r\n    function numberMetric(definition: Glue42Core.Metrics.MetricDefinition | string, value: number): Glue42Core.Metrics.NumberMetric {\r\n        return _getOrCreateMetric<NumberMetric>(definition, MetricTypes.NUMBER, value, (metricDef: Glue42Core.Metrics.MetricDefinition) => new NumberMetric(metricDef, me, _transport, value));\r\n    }\r\n\r\n    function objectMetric(definition: Glue42Core.Metrics.MetricDefinition | string, value: any): Glue42Core.Metrics.ObjectMetric {\r\n        return _getOrCreateMetric<ObjectMetric>(definition, MetricTypes.OBJECT, value, (metricDef: Glue42Core.Metrics.MetricDefinition) => new ObjectMetric(metricDef, me, _transport, value));\r\n    }\r\n\r\n    function timestampMetric(definition: Glue42Core.Metrics.MetricDefinition | string, value: any): Glue42Core.Metrics.TimestampMetric {\r\n        return _getOrCreateMetric<TimestampMetric>(definition, MetricTypes.TIMESTAMP, value, (metricDef: Glue42Core.Metrics.MetricDefinition) => new TimestampMetric(metricDef, me, _transport, value));\r\n    }\r\n\r\n    function _getOrCreateMetric<T extends Glue42Core.Metrics.Metric>(metricObject: Glue42Core.Metrics.MetricDefinition | string, expectedType: number, value: any, createMetric: (metricDef: Glue42Core.Metrics.MetricDefinition, me?: Glue42Core.Metrics.System, _transport?: Protocol, value?: any) => T): T {\r\n        let metricDef = { name: \"\" };\r\n        if (typeof metricObject === \"string\") {\r\n            metricDef = { name: metricObject };\r\n        } else {\r\n            metricDef = metricObject;\r\n        }\r\n        const matching: Glue42Core.Metrics.Metric[] = _metrics.filter((shadowedMetric) => shadowedMetric.name === metricDef.name);\r\n\r\n        if (matching.length > 0) {\r\n            const existing: Glue42Core.Metrics.Metric = matching[0];\r\n            if (existing.type !== expectedType) {\r\n                // NOTE: Extend the error with the already defined metric?\r\n                throw new Error(`A metric named ${metricDef.name} is already defined with different type.`);\r\n            }\r\n\r\n            if (typeof value !== \"undefined\") {\r\n                existing\r\n                    .update(value)\r\n                    .catch(() => { /** swallow */});\r\n            }\r\n\r\n            return existing as T;\r\n        }\r\n\r\n        const metric: T = createMetric(metricDef);\r\n        _metrics.push(metric);\r\n        return metric;\r\n    }\r\n\r\n    function _buildPath(shadowedSystem?: Glue42Core.Metrics.System): string[] {\r\n        if (!shadowedSystem || !shadowedSystem.parent) {\r\n            return [];\r\n        }\r\n\r\n        const path = _buildPath(shadowedSystem.parent);\r\n        path.push(shadowedSystem.name);\r\n        return path;\r\n    }\r\n\r\n    function _arrayToString(path: string[], separator: string) {\r\n        return ((path && path.length > 0) ? path.join(separator) : \"\");\r\n    }\r\n\r\n    function getAggregateState(): Glue42Core.Metrics.SystemStateInfo[] {\r\n        const aggState: Glue42Core.Metrics.SystemStateInfo[] = [];\r\n        if (Object.keys(_state).length > 0) {\r\n            aggState.push({\r\n                name: _name,\r\n                path: _path,\r\n                state: _state.state,\r\n                description: _state.description,\r\n            });\r\n        }\r\n\r\n        _subSystems.forEach((shadowedSubSystem) => {\r\n            const result = shadowedSubSystem.getAggregateState();\r\n            if (result.length > 0) {\r\n                aggState.push(...result);\r\n            }\r\n        });\r\n\r\n        return aggState;\r\n    }\r\n\r\n    const me: Glue42Core.Metrics.System = {\r\n        get name() {\r\n            return _name;\r\n        },\r\n\r\n        get description() {\r\n            return _description;\r\n        },\r\n\r\n        get repo() {\r\n            return _repo;\r\n        },\r\n\r\n        get parent() {\r\n            return _parent;\r\n        },\r\n        path: _path,\r\n        id,\r\n        root,\r\n\r\n        get subSystems() {\r\n            return _subSystems;\r\n        },\r\n\r\n        get metrics() {\r\n            return _metrics;\r\n        },\r\n        subSystem,\r\n        getState: () => {\r\n            return _state;\r\n        },\r\n        setState,\r\n        stringMetric,\r\n        timestampMetric,\r\n        objectMetric,\r\n        numberMetric,\r\n        getAggregateState,\r\n    };\r\n\r\n    _transport.createSystem(me);\r\n\r\n    return me;\r\n}\r\n","import { Glue42Core } from \"../../glue\";\r\nimport system from \"./system\";\r\nimport { MetricsSettings, Protocol } from \"./types\";\r\n\r\nexport class Repository implements Glue42Core.Metrics.Repository {\r\n    public root: Glue42Core.Metrics.System;\r\n\r\n    constructor(options: MetricsSettings, protocol: Protocol) {\r\n        protocol.init(this);\r\n        this.root = system(\"\", this, protocol);\r\n\r\n        this.addSystemMetrics(this.root, options.clickStream || options.clickStream === undefined);\r\n    }\r\n\r\n    private addSystemMetrics(rootSystem: Glue42Core.Metrics.System, useClickStream: any) {\r\n        // Create some system metrics\r\n        if (typeof navigator !== \"undefined\") {\r\n            rootSystem.stringMetric(\"UserAgent\", navigator.userAgent);\r\n        }\r\n\r\n        if (useClickStream && typeof document !== \"undefined\") {\r\n            const clickStream: Glue42Core.Metrics.System = rootSystem.subSystem(\"ClickStream\");\r\n\r\n            const documentClickHandler = (e: Event) => {\r\n                if (!e.target) {\r\n                    return;\r\n                }\r\n                const target = e.target as HTMLAnchorElement;\r\n                clickStream.objectMetric(\"LastBrowserEvent\", {\r\n                    type: \"click\",\r\n                    timestamp: new Date(),\r\n                    target: {\r\n                        className: e.target ? target.className : \"\",\r\n                        id: target.id,\r\n                        type: \"<\" + target.tagName.toLowerCase() + \">\",\r\n                        href: target.href || \"\",\r\n                    },\r\n                });\r\n            };\r\n\r\n            // Create click stream record\r\n            clickStream.objectMetric(\"Page\", {\r\n                title: document.title,\r\n                page: window.location.href,\r\n            });\r\n\r\n            if (document.addEventListener) {\r\n                document.addEventListener(\"click\", documentClickHandler);\r\n            } else {\r\n                // For IE versions prior to IE9, attachEvent method should be used to register the specified listener\r\n                // to the EventTarget it is called on, for others addEventListener should be used.\r\n                // (<any>document)\r\n                (document as any).attachEvent(\"onclick\", documentClickHandler);\r\n            }\r\n        }\r\n\r\n        const startTime = rootSystem.stringMetric(\"StartTime\", (new Date()).toString());\r\n        const urlMetric = rootSystem.stringMetric(\"StartURL\", \"\");\r\n        const appNameMetric = rootSystem.stringMetric(\"AppName\", \"\");\r\n        if (typeof window !== \"undefined\") {\r\n            if (typeof window.location !== \"undefined\") {\r\n                const startUrl = window.location.href;\r\n                urlMetric.update(startUrl);\r\n            }\r\n\r\n            if (typeof window.glue42gd !== \"undefined\") {\r\n                appNameMetric.update(window.glue42gd.appName);\r\n            }\r\n        }\r\n    }\r\n}\r\n","import { Protocol } from \"../../types\";\r\nimport { Glue42Core } from \"../../../../glue\";\r\n\r\nexport class NullProtocol implements Protocol {\r\n    public init(repo: Glue42Core.Metrics.Repository): void {\r\n        // do nothing\r\n    }\r\n\r\n    public createSystem(system: Glue42Core.Metrics.System): Promise<void> {\r\n        return Promise.resolve();\r\n    }\r\n\r\n    public updateSystem(metric: Glue42Core.Metrics.System, state: Glue42Core.Metrics.State): Promise<void> {\r\n        return Promise.resolve();\r\n    }\r\n\r\n    public createMetric(metric: Glue42Core.Metrics.Metric): Promise<void> {\r\n        return Promise.resolve();\r\n    }\r\n\r\n    public updateMetric(metric: Glue42Core.Metrics.Metric): Promise<void> {\r\n        return Promise.resolve();\r\n    }\r\n}\r\n","import { Glue42Core } from \"../../glue\";\r\nimport { count } from \"console\";\r\n\r\nexport class PerfTracker {\r\n\r\n    private lastCount = 0;\r\n\r\n    private initialPublishTimeout = 10 * 1000; // 10 sec\r\n    private publishInterval = 60 * 1000; // 60 sec\r\n    private system: Glue42Core.Metrics.System;\r\n\r\n    constructor(private api: Glue42Core.Metrics.API, initialPublishTimeout?: number, publishInterval?: number) {\r\n        this.initialPublishTimeout = initialPublishTimeout ?? this.initialPublishTimeout;\r\n        this.publishInterval = publishInterval ?? this.publishInterval;\r\n        this.scheduleCollection();\r\n        this.system = this.api.subSystem(\"performance\", \"Performance data published by the web application\");\r\n    }\r\n\r\n    private scheduleCollection() {\r\n        setTimeout(() => {\r\n            this.collect();\r\n            setInterval(() => {\r\n                this.collect();\r\n            }, this.publishInterval);\r\n        }, this.initialPublishTimeout);\r\n    }\r\n\r\n    private collect() {\r\n        try {\r\n            // tslint:disable-next-line:no-console\r\n            this.collectMemory();\r\n            this.collectEntries();\r\n        } catch {\r\n            // DO NOTHING\r\n        }\r\n    }\r\n\r\n    private collectMemory() {\r\n        // memory - use performance.memory\r\n        const memory = (window.performance as any).memory;\r\n        this.system.stringMetric(\"memory\", JSON.stringify({\r\n            totalJSHeapSize: memory.totalJSHeapSize,\r\n            usedJSHeapSize: memory.usedJSHeapSize\r\n        }));\r\n    }\r\n\r\n    private collectEntries() {\r\n        const allEntries = window.performance.getEntries();\r\n        if (allEntries.length <= this.lastCount) {\r\n            return;\r\n        }\r\n        this.lastCount = allEntries.length;\r\n        const jsonfiedEntries = allEntries.map((i) => i.toJSON());\r\n\r\n        this.system.stringMetric(\"entries\", JSON.stringify(jsonfiedEntries));\r\n    }\r\n}\r\n","import { Glue42Core } from \"../../glue\";\r\nimport gw3 from \"./protocols/gw3/gw3\";\r\nimport { Repository } from \"./repository\";\r\nimport { Protocol, MetricsSettings } from \"./types\";\r\nimport { NullProtocol } from \"./protocols/null/null\";\r\nimport { PerfTracker } from \"./pertTracker\";\r\n\r\nexport default (options: MetricsSettings): Glue42Core.Metrics.API => {\r\n\r\n    let protocol: Protocol;\r\n    if (!options.connection || typeof options.connection !== \"object\") {\r\n        protocol = new NullProtocol();\r\n    } else {\r\n        protocol = gw3(options.connection, options);\r\n    }\r\n\r\n    const repo = new Repository(options, protocol);\r\n    let rootSystem = repo.root;\r\n    if (!options.disableAutoAppSystem) {\r\n        rootSystem = rootSystem.subSystem(\"App\");\r\n    }\r\n\r\n    // add FAV support\r\n    const api = addFAVSupport(rootSystem);\r\n    // initialize page performance\r\n    initPerf(api, options.pagePerformanceMetrics);\r\n\r\n    return api;\r\n};\r\n\r\nlet perf: PerfTracker;\r\nfunction initPerf(api: Glue42Core.Metrics.API, config?: Glue42Core.PagePerformanceMetricsConfig) {\r\n    if (typeof window === \"undefined\") {\r\n        return;\r\n    }\r\n\r\n    // allow Glue42 Enterprise to override\r\n    const perfConfig = window?.glue42gd?.metrics?.pagePerformanceMetrics;\r\n    if (perfConfig) {\r\n        // allow Glue42 Enterprise to override\r\n        config = perfConfig;\r\n    }\r\n\r\n    if (config?.enabled) {\r\n        perf = new PerfTracker(api, config.initialPublishTimeout, config.publishInterval);\r\n    }\r\n}\r\n\r\nfunction addFAVSupport(system: Glue42Core.Metrics.System): Glue42Core.Metrics.API {\r\n    // Creating subsystem for reporting and feature metric\r\n    const reportingSystem: Glue42Core.Metrics.System = system.subSystem(\"reporting\");\r\n    const def = {\r\n        name: \"features\"\r\n    };\r\n\r\n    let featureMetric: Glue42Core.Metrics.ObjectMetric;\r\n\r\n    const featureMetricFunc = (name: string, action: string, payload: string) => {\r\n        if (typeof name === \"undefined\" || name === \"\") {\r\n            throw new Error(\"name is mandatory\");\r\n        } else if (typeof action === \"undefined\" || action === \"\") {\r\n            throw new Error(\"action is mandatory\");\r\n        } else if (typeof payload === \"undefined\" || payload === \"\") {\r\n            throw new Error(\"payload is mandatory\");\r\n        }\r\n\r\n        if (!featureMetric) {\r\n            featureMetric = reportingSystem.objectMetric(def, { name, action, payload });\r\n        } else {\r\n            featureMetric.update({\r\n                name,\r\n                action,\r\n                payload\r\n            });\r\n        }\r\n    };\r\n    (system as any).featureMetric = featureMetricFunc;\r\n    return system as Glue42Core.Metrics.API;\r\n}\r\n","\"use strict\";\r\nfunction createRegistry(options) {\r\n    if (options && options.errorHandling\r\n        && typeof options.errorHandling !== \"function\"\r\n        && options.errorHandling !== \"log\"\r\n        && options.errorHandling !== \"silent\"\r\n        && options.errorHandling !== \"throw\") {\r\n        throw new Error(\"Invalid options passed to createRegistry. Prop errorHandling should be [\\\"log\\\" | \\\"silent\\\" | \\\"throw\\\" | (err) => void], but \" + typeof options.errorHandling + \" was passed\");\r\n    }\r\n    var _userErrorHandler = options && typeof options.errorHandling === \"function\" && options.errorHandling;\r\n    var callbacks = {};\r\n    function add(key, callback, replayArgumentsArr) {\r\n        var callbacksForKey = callbacks[key];\r\n        if (!callbacksForKey) {\r\n            callbacksForKey = [];\r\n            callbacks[key] = callbacksForKey;\r\n        }\r\n        callbacksForKey.push(callback);\r\n        if (replayArgumentsArr) {\r\n            setTimeout(function () {\r\n                replayArgumentsArr.forEach(function (replayArgument) {\r\n                    var _a;\r\n                    if ((_a = callbacks[key]) === null || _a === void 0 ? void 0 : _a.includes(callback)) {\r\n                        try {\r\n                            if (Array.isArray(replayArgument)) {\r\n                                callback.apply(undefined, replayArgument);\r\n                            }\r\n                            else {\r\n                                callback.apply(undefined, [replayArgument]);\r\n                            }\r\n                        }\r\n                        catch (err) {\r\n                            _handleError(err, key);\r\n                        }\r\n                    }\r\n                });\r\n            }, 0);\r\n        }\r\n        return function () {\r\n            var allForKey = callbacks[key];\r\n            if (!allForKey) {\r\n                return;\r\n            }\r\n            allForKey = allForKey.reduce(function (acc, element, index) {\r\n                if (!(element === callback && acc.length === index)) {\r\n                    acc.push(element);\r\n                }\r\n                return acc;\r\n            }, []);\r\n            if (allForKey.length === 0) {\r\n                delete callbacks[key];\r\n            }\r\n            else {\r\n                callbacks[key] = allForKey;\r\n            }\r\n        };\r\n    }\r\n    function execute(key) {\r\n        var argumentsArr = [];\r\n        for (var _i = 1; _i < arguments.length; _i++) {\r\n            argumentsArr[_i - 1] = arguments[_i];\r\n        }\r\n        var callbacksForKey = callbacks[key];\r\n        if (!callbacksForKey || callbacksForKey.length === 0) {\r\n            return [];\r\n        }\r\n        var results = [];\r\n        callbacksForKey.forEach(function (callback) {\r\n            try {\r\n                var result = callback.apply(undefined, argumentsArr);\r\n                results.push(result);\r\n            }\r\n            catch (err) {\r\n                results.push(undefined);\r\n                _handleError(err, key);\r\n            }\r\n        });\r\n        return results;\r\n    }\r\n    function _handleError(exceptionArtifact, key) {\r\n        var errParam = exceptionArtifact instanceof Error ? exceptionArtifact : new Error(exceptionArtifact);\r\n        if (_userErrorHandler) {\r\n            _userErrorHandler(errParam);\r\n            return;\r\n        }\r\n        var msg = \"[ERROR] callback-registry: User callback for key \\\"\" + key + \"\\\" failed: \" + errParam.stack;\r\n        if (options) {\r\n            switch (options.errorHandling) {\r\n                case \"log\":\r\n                    return console.error(msg);\r\n                case \"silent\":\r\n                    return;\r\n                case \"throw\":\r\n                    throw new Error(msg);\r\n            }\r\n        }\r\n        console.error(msg);\r\n    }\r\n    function clear() {\r\n        callbacks = {};\r\n    }\r\n    function clearKey(key) {\r\n        var callbacksForKey = callbacks[key];\r\n        if (!callbacksForKey) {\r\n            return;\r\n        }\r\n        delete callbacks[key];\r\n    }\r\n    return {\r\n        add: add,\r\n        execute: execute,\r\n        clear: clear,\r\n        clearKey: clearKey\r\n    };\r\n}\r\n;\r\ncreateRegistry.default = createRegistry;\r\nmodule.exports = createRegistry;\r\n//# sourceMappingURL=index.js.map","import { Transport } from \"../types\";\r\nimport { default as CallbackRegistryFactory, CallbackRegistry, UnsubscribeFunction } from \"callback-registry\";\r\nimport { Glue42Core } from \"../../../glue\";\r\nimport { Logger } from \"../../logger/logger\";\r\n\r\nexport default class InProcTransport implements Transport {\r\n\r\n    private gw: Glue42Core.Connection.GW3Facade;\r\n    private registry: CallbackRegistry = CallbackRegistryFactory();\r\n    private client?: Glue42Core.Connection.GW3Client;\r\n\r\n    constructor(settings: Glue42Core.InprocGWSettings, logger: Logger) {\r\n        this.gw = settings.facade;\r\n        this.gw.connect((_client, message) => {\r\n            this.messageHandler(message);\r\n        }).then((client) => {\r\n            this.client = client;\r\n        });\r\n    }\r\n\r\n    public get isObjectBasedTransport() {\r\n        return true;\r\n    }\r\n\r\n    public sendObject(msg: object): Promise<void> {\r\n        if (this.client) {\r\n            this.client.send(msg);\r\n            return Promise.resolve(undefined);\r\n        } else {\r\n            return Promise.reject(`not connected`);\r\n        }\r\n    }\r\n\r\n    public send(_msg: string) {\r\n        return Promise.reject(\"not supported\");\r\n    }\r\n\r\n    public onMessage(callback: (msg: string | object) => void): UnsubscribeFunction {\r\n        return this.registry.add(\"onMessage\", callback);\r\n    }\r\n\r\n    public onConnectedChanged(callback: (connected: boolean) => void) {\r\n        callback(true);\r\n    }\r\n\r\n    public close() {\r\n        // DO NOTHING\r\n        return Promise.resolve();\r\n    }\r\n\r\n    public open() {\r\n        return Promise.resolve();\r\n    }\r\n\r\n    public name(): string {\r\n        return \"in-memory\";\r\n    }\r\n\r\n    public reconnect(): Promise<void> {\r\n        return Promise.resolve();\r\n    }\r\n\r\n    private messageHandler(msg: object) {\r\n        this.registry.execute(\"onMessage\", msg);\r\n    }\r\n}\r\n","import { Transport } from \"../types\";\r\nimport {\r\n    default as CallbackRegistryFactory,\r\n    CallbackRegistry,\r\n    UnsubscribeFunction,\r\n} from \"callback-registry\";\r\nimport { Logger } from \"../../logger/logger\";\r\n\r\n// tslint:disable-next-line:no-namespace\r\ndeclare namespace SharedWorker {\r\n    interface AbstractWorker extends EventTarget {\r\n        onerror: (ev: ErrorEvent) => any;\r\n    }\r\n\r\n    export interface SharedWorker extends AbstractWorker {\r\n        /**\r\n         * the value it was assigned by the object's constructor.\r\n         * It represents the MessagePort for communicating with the shared worker.\r\n         * @type {MessagePort}\r\n         */\r\n        port: MessagePort;\r\n    }\r\n\r\n    export interface SharedWorkerGlobalScope extends Worker {\r\n        onconnect: (event: MessageEvent) => void;\r\n    }\r\n}\r\n\r\n/**\r\n * Shared worker transport\r\n */\r\nexport default class SharedWorkerTransport implements Transport {\r\n    private worker: any;\r\n    private registry: CallbackRegistry = CallbackRegistryFactory();\r\n\r\n    constructor(workerFile: string, private logger: Logger) {\r\n        this.worker = new SharedWorker(workerFile);\r\n        this.worker.port.onmessage = (e: { data: any; timestamp: number }) => {\r\n            this.messageHandler(e.data);\r\n        };\r\n    }\r\n\r\n    public get isObjectBasedTransport() {\r\n        return true;\r\n    }\r\n\r\n    public sendObject(msg: object): Promise<void> {\r\n        this.worker.port.postMessage(msg);\r\n        return Promise.resolve();\r\n    }\r\n\r\n    public send(_msg: string) {\r\n        return Promise.reject(\"not supported\");\r\n    }\r\n\r\n    public onMessage(\r\n        callback: (msg: string | object) => void\r\n    ): UnsubscribeFunction {\r\n        return this.registry.add(\"onMessage\", callback);\r\n    }\r\n\r\n    public onConnectedChanged(callback: (connected: boolean) => void) {\r\n        callback(true);\r\n    }\r\n\r\n    public close() {\r\n        // DO NOTHING\r\n        return Promise.resolve();\r\n    }\r\n\r\n    public open() {\r\n        // DO NOTHING\r\n        return Promise.resolve();\r\n    }\r\n\r\n    public name(): string {\r\n        return \"shared-worker\";\r\n    }\r\n\r\n    public reconnect(): Promise<void> {\r\n        return Promise.resolve();\r\n    }\r\n\r\n    private messageHandler(msg: object) {\r\n        this.registry.execute(\"onMessage\", msg);\r\n    }\r\n}\r\n\r\ninterface SharedWorkerOptions {\r\n    credentials?: RequestCredentials;\r\n    name?: string;\r\n    type?: WorkerType;\r\n}\r\n\r\n// eslint-disable-next-line\r\ndeclare var SharedWorker: {\r\n    prototype: SharedWorker.SharedWorker;\r\n\r\n    /**\r\n     *\r\n     * @param {string} stringUrl                          Pathname to JavaScript file\r\n     * @param {string|SharedWorkerOptions} [options]      Name of the worker to execute\r\n     *                                                    or an object containing option properties\r\n     */\r\n    new(\r\n        stringUrl: string,\r\n        options?: string | SharedWorkerOptions\r\n    ): SharedWorker.SharedWorker;\r\n};\r\n","export default class Utils {\r\n\r\n    public static getGDMajorVersion(): number | undefined {\r\n        if (typeof window === \"undefined\") {\r\n            return undefined;\r\n        }\r\n        if (!window.glueDesktop) {\r\n            return undefined;\r\n        }\r\n        if (!window.glueDesktop.version) {\r\n            return undefined;\r\n        }\r\n        const ver = Number(window.glueDesktop.version.substr(0, 1));\r\n        return isNaN(ver) ? undefined : ver;\r\n    }\r\n\r\n    public static isNode() {\r\n        if (typeof Utils._isNode !== \"undefined\") {\r\n            return Utils._isNode;\r\n        }\r\n\r\n        if (typeof window !== \"undefined\") {\r\n            Utils._isNode = false;\r\n            return false;\r\n        }\r\n\r\n        // Only Node.JS has a process variable that is of [[Class]] process\r\n        try {\r\n            Utils._isNode = Object.prototype.toString.call(global.process) === \"[object process]\";\r\n        } catch (e) {\r\n            Utils._isNode = false;\r\n        }\r\n        return Utils._isNode;\r\n    }\r\n    private static _isNode?: boolean;\r\n}\r\n","export class PromiseWrapper<T> {\r\n\r\n    public static delay(time: number): Promise<void> {\r\n        return new Promise((resolve) => setTimeout(resolve, time));\r\n    }\r\n\r\n    public resolve!: (arg?: T | PromiseLike<T>) => void;\r\n    public reject!: (err: any) => void;\r\n    public promise: Promise<T>;\r\n    public rejected: boolean = false;\r\n    public resolved: boolean = false;\r\n    public get ended(): boolean {\r\n        return this.rejected || this.resolved;\r\n    }\r\n\r\n    constructor() {\r\n        this.promise = new Promise<T>((resolve, reject) => {\r\n            this.resolve = (t: any) => {\r\n                this.resolved = true;\r\n                resolve(t);\r\n            };\r\n\r\n            this.reject = (err: any) => {\r\n                this.rejected = true;\r\n                reject(err);\r\n            };\r\n        });\r\n    }\r\n}\r\n","import { Timer, Mark } from \"../types\";\r\n\r\nconst timers: { [index: string]: Timer } = {};\r\n\r\nexport function getAllTimers() {\r\n    return timers;\r\n}\r\n\r\nexport default function (timerName: string): Timer {\r\n    const existing = timers[timerName];\r\n    if (existing) {\r\n        return existing;\r\n    }\r\n\r\n    const marks: Mark[] = [];\r\n    function now(): number {\r\n        return new Date().getTime();\r\n    }\r\n\r\n    const startTime = now();\r\n    mark(\"start\", startTime);\r\n    let endTime: number;\r\n    let period: number;\r\n\r\n    function stop(): number {\r\n        endTime = now();\r\n        mark(\"end\", endTime);\r\n        period = endTime - startTime;\r\n        return period;\r\n    }\r\n\r\n    function mark(name: string, time?: number): void {\r\n        const currentTime = time ?? now();\r\n        let diff = 0;\r\n        if (marks.length > 0) {\r\n            diff = currentTime - marks[marks.length - 1].time;\r\n        }\r\n        marks.push({ name, time: currentTime, diff });\r\n    }\r\n\r\n    const timerObj = {\r\n        get startTime(): number {\r\n            return startTime;\r\n        },\r\n        get endTime(): number {\r\n            return endTime;\r\n        },\r\n        get period(): number {\r\n            return period;\r\n        },\r\n        stop,\r\n        mark,\r\n        marks\r\n    };\r\n\r\n    timers[timerName] = timerObj;\r\n    return timerObj;\r\n}\r\n","import {\r\n    default as CallbackRegistryFactory,\r\n    CallbackRegistry,\r\n} from \"callback-registry\";\r\nimport { Transport, ConnectionSettings } from \"../types\";\r\nimport { Logger } from \"../../logger/logger\";\r\nimport { Glue42Core } from \"../../../glue\";\r\nimport Utils from \"../../utils/utils\";\r\nimport { PromiseWrapper } from \"../../utils/pw\";\r\nimport timer from \"../../utils/timer\";\r\n\r\nconst WebSocketConstructor = Utils.isNode() ? require(\"ws\") : window.WebSocket;\r\n\r\nexport default class WS implements Transport {\r\n    private ws: WebSocket | undefined;\r\n    private logger: Logger;\r\n    private settings: ConnectionSettings;\r\n    private startupTimer = timer(\"connection\");\r\n\r\n    /**\r\n     * If the flag is true the connection should keep trying to connect.\r\n     * If false the user explicitly closed it and it should not reconnect\r\n     */\r\n    private _running = true;\r\n\r\n    private _registry: CallbackRegistry = CallbackRegistryFactory();\r\n    private wsRequests: Array<{ callback: () => void, failed?: (err?: string) => void }> = [];\r\n\r\n    constructor(settings: ConnectionSettings, logger: Logger) {\r\n        this.settings = settings;\r\n        this.logger = logger;\r\n        if (!this.settings.ws) {\r\n            throw new Error(\"ws is missing\");\r\n        }\r\n    }\r\n\r\n    public onMessage(callback: (msg: string) => void): () => void {\r\n        return this._registry.add(\"onMessage\", callback);\r\n    }\r\n\r\n    // Create a function for sending a message\r\n    public send(msg: string, options?: Glue42Core.Connection.SendMessageOptions): Promise<void> {\r\n        return new Promise<void>((resolve, reject) => {\r\n            options = options || {};\r\n            this.waitForSocketConnection(\r\n                () => {\r\n                    try {\r\n                        this.ws?.send(msg);\r\n                        resolve();\r\n                    } catch (e) {\r\n                        reject(e);\r\n                    }\r\n                },\r\n                reject\r\n            );\r\n        });\r\n    }\r\n\r\n    public open() {\r\n        this.logger.info(`opening ws...`);\r\n        this._running = true;\r\n        return new Promise<void>((resolve, reject) => {\r\n            this.waitForSocketConnection(\r\n                resolve,\r\n                reject\r\n            );\r\n        });\r\n    }\r\n\r\n    public close() {\r\n        this._running = false;\r\n        if (this.ws) {\r\n            this.ws.close();\r\n        }\r\n        return Promise.resolve();\r\n    }\r\n\r\n    public onConnectedChanged(callback: (connected: boolean, reason?: string) => void): () => void {\r\n        return this._registry.add(\"onConnectedChanged\", callback);\r\n    }\r\n\r\n    public name(): string {\r\n        return `ws ${this.settings.ws}`;\r\n    }\r\n\r\n    public reconnect(): Promise<void> {\r\n        this.ws?.close();\r\n        const pw = new PromiseWrapper<void>();\r\n        this.waitForSocketConnection(() => {\r\n            pw.resolve();\r\n        });\r\n        return pw.promise;\r\n    }\r\n\r\n    // Holds callback execution until socket connection is established.\r\n    private waitForSocketConnection(\r\n        callback: () => void,\r\n        failed?: (err?: string) => void\r\n    ) {\r\n        failed = failed ?? (() => { /** DO nothing */ });\r\n\r\n        // check if we're still running\r\n        if (!this._running) {\r\n            failed(\r\n                `wait for socket on ${this.settings.ws} failed - socket closed by user`\r\n            );\r\n            return;\r\n        }\r\n\r\n        // if socket is opened - returned immediately\r\n        if (this.ws?.readyState === 1) {\r\n            callback();\r\n            return;\r\n        }\r\n\r\n        // store the callback\r\n        this.wsRequests.push({ callback, failed });\r\n        // if someone has already initiated the socket return\r\n        if (this.wsRequests.length > 1) {\r\n            return;\r\n        }\r\n\r\n        this.openSocket();\r\n    }\r\n\r\n    private async openSocket(retryInterval?: number, retriesLeft?: number) {\r\n        this.startupTimer.mark(\"opening-socket\");\r\n        if (retryInterval === undefined) {\r\n            retryInterval = this.settings.reconnectInterval;\r\n        }\r\n\r\n        if (retriesLeft !== undefined) {\r\n            if (retriesLeft === 0) {\r\n                this.notifyForSocketState(\r\n                    `wait for socket on ${this.settings.ws} failed - no more retries left`\r\n                );\r\n                return;\r\n            }\r\n            this.logger.debug(\r\n                `will retry ${retriesLeft} more times (every ${retryInterval} ms)`\r\n            );\r\n        }\r\n\r\n        try {\r\n            await this.initiateSocket();\r\n            this.startupTimer.mark(\"socket-initiated\");\r\n            this.notifyForSocketState();\r\n        } catch {\r\n            setTimeout(() => {\r\n                const retries =\r\n                    retriesLeft === undefined ? undefined : retriesLeft - 1;\r\n                this.openSocket(\r\n                    retryInterval,\r\n                    retries,\r\n                );\r\n            }, retryInterval); // wait X milliseconds for the connection...\r\n        }\r\n    }\r\n\r\n    private initiateSocket(): Promise<void> {\r\n        const pw = new PromiseWrapper<void>();\r\n        this.logger.debug(`initiating ws to ${this.settings.ws}...`);\r\n        this.ws = new WebSocketConstructor(this.settings.ws || \"\") as WebSocket;\r\n        this.ws.onerror = (err: any) => {\r\n            let reason: string = \"\";\r\n            try {\r\n                reason = JSON.stringify(err);\r\n            } catch (error) {\r\n                const seen = new WeakSet();\r\n                const replacer = (key: string, value: any) => {\r\n                    if (typeof value === \"object\" && value !== null) {\r\n                        if (seen.has(value)) {\r\n                            return;\r\n                        }\r\n                        seen.add(value);\r\n                    }\r\n                    return value;\r\n                };\r\n\r\n                reason = JSON.stringify(err, replacer);\r\n            }\r\n\r\n            pw.reject(\"error\");\r\n            this.notifyStatusChanged(false, reason);\r\n        };\r\n        this.ws.onclose = (err) => {\r\n            this.logger.info(`ws closed ${err}`);\r\n            pw.reject(\"closed\");\r\n            this.notifyStatusChanged(false);\r\n        };\r\n        // Log on connection\r\n        this.ws.onopen = () => {\r\n            // tslint:disable-next-line:no-console\r\n            this.startupTimer.mark(\"ws-opened\");\r\n            this.logger.info(`ws opened ${this.settings.identity?.application}`);\r\n            pw.resolve();\r\n            this.notifyStatusChanged(true);\r\n        };\r\n        // Attach handler\r\n        this.ws.onmessage = (message: { data: object }) => {\r\n            this._registry.execute(\"onMessage\", message.data);\r\n        };\r\n\r\n        return pw.promise;\r\n    }\r\n\r\n    private notifyForSocketState(error?: string) {\r\n        this.wsRequests.forEach((wsRequest) => {\r\n            if (error) {\r\n                if (wsRequest.failed) {\r\n                    wsRequest.failed(error);\r\n                }\r\n            } else {\r\n                wsRequest.callback();\r\n            }\r\n        });\r\n        this.wsRequests = [];\r\n    }\r\n\r\n    private notifyStatusChanged(status: boolean, reason?: string) {\r\n        this._registry.execute(\"onConnectedChanged\", status, reason);\r\n    }\r\n}\r\n","'use strict';\n\n// Found this seed-based random generator somewhere\n// Based on The Central Randomizer 1.3 (C) 1997 by Paul Houle (houle@msc.cornell.edu)\n\nvar seed = 1;\n\n/**\n * return a random number based on a seed\n * @param seed\n * @returns {number}\n */\nfunction getNextValue() {\n    seed = (seed * 9301 + 49297) % 233280;\n    return seed/(233280.0);\n}\n\nfunction setSeed(_seed_) {\n    seed = _seed_;\n}\n\nmodule.exports = {\n    nextValue: getNextValue,\n    seed: setSeed\n};\n","'use strict';\n\nvar randomFromSeed = require('./random/random-from-seed');\n\nvar ORIGINAL = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-';\nvar alphabet;\nvar previousSeed;\n\nvar shuffled;\n\nfunction reset() {\n    shuffled = false;\n}\n\nfunction setCharacters(_alphabet_) {\n    if (!_alphabet_) {\n        if (alphabet !== ORIGINAL) {\n            alphabet = ORIGINAL;\n            reset();\n        }\n        return;\n    }\n\n    if (_alphabet_ === alphabet) {\n        return;\n    }\n\n    if (_alphabet_.length !== ORIGINAL.length) {\n        throw new Error('Custom alphabet for shortid must be ' + ORIGINAL.length + ' unique characters. You submitted ' + _alphabet_.length + ' characters: ' + _alphabet_);\n    }\n\n    var unique = _alphabet_.split('').filter(function(item, ind, arr){\n       return ind !== arr.lastIndexOf(item);\n    });\n\n    if (unique.length) {\n        throw new Error('Custom alphabet for shortid must be ' + ORIGINAL.length + ' unique characters. These characters were not unique: ' + unique.join(', '));\n    }\n\n    alphabet = _alphabet_;\n    reset();\n}\n\nfunction characters(_alphabet_) {\n    setCharacters(_alphabet_);\n    return alphabet;\n}\n\nfunction setSeed(seed) {\n    randomFromSeed.seed(seed);\n    if (previousSeed !== seed) {\n        reset();\n        previousSeed = seed;\n    }\n}\n\nfunction shuffle() {\n    if (!alphabet) {\n        setCharacters(ORIGINAL);\n    }\n\n    var sourceArray = alphabet.split('');\n    var targetArray = [];\n    var r = randomFromSeed.nextValue();\n    var characterIndex;\n\n    while (sourceArray.length > 0) {\n        r = randomFromSeed.nextValue();\n        characterIndex = Math.floor(r * sourceArray.length);\n        targetArray.push(sourceArray.splice(characterIndex, 1)[0]);\n    }\n    return targetArray.join('');\n}\n\nfunction getShuffled() {\n    if (shuffled) {\n        return shuffled;\n    }\n    shuffled = shuffle();\n    return shuffled;\n}\n\n/**\n * lookup shuffled letter\n * @param index\n * @returns {string}\n */\nfunction lookup(index) {\n    var alphabetShuffled = getShuffled();\n    return alphabetShuffled[index];\n}\n\nmodule.exports = {\n    characters: characters,\n    seed: setSeed,\n    lookup: lookup,\n    shuffled: getShuffled\n};\n","'use strict';\n\nvar crypto = typeof window === 'object' && (window.crypto || window.msCrypto); // IE 11 uses window.msCrypto\n\nfunction randomByte() {\n    if (!crypto || !crypto.getRandomValues) {\n        return Math.floor(Math.random() * 256) & 0x30;\n    }\n    var dest = new Uint8Array(1);\n    crypto.getRandomValues(dest);\n    return dest[0] & 0x30;\n}\n\nmodule.exports = randomByte;\n","'use strict';\n\nvar randomByte = require('./random/random-byte');\n\nfunction encode(lookup, number) {\n    var loopCounter = 0;\n    var done;\n\n    var str = '';\n\n    while (!done) {\n        str = str + lookup( ( (number >> (4 * loopCounter)) & 0x0f ) | randomByte() );\n        done = number < (Math.pow(16, loopCounter + 1 ) );\n        loopCounter++;\n    }\n    return str;\n}\n\nmodule.exports = encode;\n","'use strict';\nvar alphabet = require('./alphabet');\n\n/**\n * Decode the id to get the version and worker\n * Mainly for debugging and testing.\n * @param id - the shortid-generated id.\n */\nfunction decode(id) {\n    var characters = alphabet.shuffled();\n    return {\n        version: characters.indexOf(id.substr(0, 1)) & 0x0f,\n        worker: characters.indexOf(id.substr(1, 1)) & 0x0f\n    };\n}\n\nmodule.exports = decode;\n","'use strict';\nvar alphabet = require('./alphabet');\n\nfunction isShortId(id) {\n    if (!id || typeof id !== 'string' || id.length < 6 ) {\n        return false;\n    }\n\n    var characters = alphabet.characters();\n    var len = id.length;\n    for(var i = 0; i < len;i++) {\n        if (characters.indexOf(id[i]) === -1) {\n            return false;\n        }\n    }\n    return true;\n}\n\nmodule.exports = isShortId;\n","'use strict';\n\nvar alphabet = require('./alphabet');\nvar encode = require('./encode');\nvar decode = require('./decode');\nvar isValid = require('./is-valid');\n\n// Ignore all milliseconds before a certain time to reduce the size of the date entropy without sacrificing uniqueness.\n// This number should be updated every year or so to keep the generated id short.\n// To regenerate `new Date() - 0` and bump the version. Always bump the version!\nvar REDUCE_TIME = 1459707606518;\n\n// don't change unless we change the algos or REDUCE_TIME\n// must be an integer and less than 16\nvar version = 6;\n\n// if you are using cluster or multiple servers use this to make each instance\n// has a unique value for worker\n// Note: I don't know if this is automatically set when using third\n// party cluster solutions such as pm2.\nvar clusterWorkerId = require('./util/cluster-worker-id') || 0;\n\n// Counter is used when shortid is called multiple times in one second.\nvar counter;\n\n// Remember the last time shortid was called in case counter is needed.\nvar previousSeconds;\n\n/**\n * Generate unique id\n * Returns string id\n */\nfunction generate() {\n\n    var str = '';\n\n    var seconds = Math.floor((Date.now() - REDUCE_TIME) * 0.001);\n\n    if (seconds === previousSeconds) {\n        counter++;\n    } else {\n        counter = 0;\n        previousSeconds = seconds;\n    }\n\n    str = str + encode(alphabet.lookup, version);\n    str = str + encode(alphabet.lookup, clusterWorkerId);\n    if (counter > 0) {\n        str = str + encode(alphabet.lookup, counter);\n    }\n    str = str + encode(alphabet.lookup, seconds);\n\n    return str;\n}\n\n\n/**\n * Set the seed.\n * Highly recommended if you don't want people to try to figure out your id schema.\n * exposed as shortid.seed(int)\n * @param seed Integer value to seed the random alphabet.  ALWAYS USE THE SAME SEED or you might get overlaps.\n */\nfunction seed(seedValue) {\n    alphabet.seed(seedValue);\n    return module.exports;\n}\n\n/**\n * Set the cluster worker or machine id\n * exposed as shortid.worker(int)\n * @param workerId worker must be positive integer.  Number less than 16 is recommended.\n * returns shortid module so it can be chained.\n */\nfunction worker(workerId) {\n    clusterWorkerId = workerId;\n    return module.exports;\n}\n\n/**\n *\n * sets new characters to use in the alphabet\n * returns the shuffled alphabet\n */\nfunction characters(newCharacters) {\n    if (newCharacters !== undefined) {\n        alphabet.characters(newCharacters);\n    }\n\n    return alphabet.shuffled();\n}\n\n\n// Export all other functions as properties of the generate function\nmodule.exports = generate;\nmodule.exports.generate = generate;\nmodule.exports.seed = seed;\nmodule.exports.worker = worker;\nmodule.exports.characters = characters;\nmodule.exports.decode = decode;\nmodule.exports.isValid = isValid;\n","'use strict';\nmodule.exports = require('./lib/index');\n","import { Glue42Core } from \"../../../glue\";\r\nimport { default as CallbackRegistryFactory, CallbackRegistry } from \"callback-registry\";\r\nimport generate from \"shortid\";\r\nimport { Logger } from \"../../logger/logger\";\r\nimport Connection from \"../connection\";\r\n\r\ninterface GW3Message {\r\n    request_id?: string;\r\n    domain?: string;\r\n    peer_id?: string;\r\n    _tag?: object;\r\n}\r\n\r\n/**\r\n * Handles domain session lifetime and events for a given connection/domain pair\r\n */\r\nexport default function (domain: string, connection: Connection, logger: Logger, successMessages?: string[], errorMessages?: string[]): Glue42Core.Connection.GW3DomainSession {\r\n\r\n    if (domain == null) {\r\n        domain = \"global\";\r\n    }\r\n\r\n    successMessages = successMessages || [\"success\"];\r\n    errorMessages = errorMessages || [\"error\"];\r\n\r\n    let isJoined = false;\r\n    let tryReconnecting = false;\r\n    /** holds latest options passed to join - used when doing reconnects */\r\n    let _latestOptions: object | undefined;\r\n    // #deleteme TODO: verify this gets properly set to true\r\n    let _connectionOn: boolean = false;\r\n\r\n    const callbacks: CallbackRegistry = CallbackRegistryFactory();\r\n\r\n    // attach event handlers to connection\r\n    connection.disconnected(handleConnectionDisconnected);\r\n    connection.loggedIn(handleConnectionLoggedIn);\r\n    connection.on(\"success\", (msg: GW3Message) => handleSuccessMessage(msg));\r\n    connection.on(\"error\", (msg: GW3Message) => handleErrorMessage(msg));\r\n    connection.on(\"result\", (msg: GW3Message) => handleSuccessMessage(msg));\r\n\r\n    if (successMessages) {\r\n        successMessages.forEach((sm) => {\r\n            connection.on(sm, (msg: GW3Message) => handleSuccessMessage(msg));\r\n        });\r\n    }\r\n    if (errorMessages) {\r\n        errorMessages.forEach((sm) => {\r\n            connection.on(sm, (msg: GW3Message) => handleErrorMessage(msg));\r\n        });\r\n    }\r\n\r\n    interface RequestHandler {\r\n        success: (success: { _tag?: object }) => void;\r\n        error: (error: { _tag?: object, err?: string }) => void;\r\n    }\r\n\r\n    const requestsMap: { [key: string]: RequestHandler } = {};\r\n\r\n    function join(options?: object): Promise<{}> {\r\n        _latestOptions = options;\r\n\r\n        return new Promise((resolve, reject) => {\r\n\r\n            if (isJoined) {\r\n                resolve();\r\n                return;\r\n            }\r\n            let joinPromise: Promise<{}>;\r\n\r\n            if (domain === \"global\") {\r\n                joinPromise = _connectionOn ? Promise.resolve<{}>({}) : Promise.reject<{}>(\"not connected to gateway\");\r\n            } else {\r\n                logger.debug(`joining domain ${domain}`);\r\n\r\n                const joinMsg = {\r\n                    type: \"join\",\r\n                    destination: domain,\r\n                    domain: \"global\",\r\n                    options,\r\n                };\r\n\r\n                // #deleteme TODO: what happens if multiple clients try to open the same domain?\r\n                // e.g. contexts\r\n                joinPromise = send(joinMsg);\r\n            }\r\n            joinPromise\r\n                .then(() => {\r\n                    handleJoined();\r\n                    resolve();\r\n                })\r\n                .catch((err) => {\r\n                    logger.debug(\"error joining \" + domain + \" domain: \" + JSON.stringify(err));\r\n                    reject(err);\r\n                });\r\n        });\r\n    }\r\n\r\n    // terminology: join vs leave (domain), connect vs login vs disconnect (to/from GW)\r\n    function leave(): Promise<void> {\r\n        if (domain === \"global\") {\r\n            return Promise.resolve();\r\n        }\r\n\r\n        logger.debug(\"stopping session \" + domain + \"...\");\r\n        const leaveMsg = {\r\n            type: \"leave\",\r\n            destination: domain,\r\n            domain: \"global\",\r\n        };\r\n        tryReconnecting = false;\r\n        // #deleteme - handling\r\n        return send(leaveMsg).then(() => {\r\n            isJoined = false;\r\n            callbacks.execute(\"onLeft\");\r\n        });\r\n    }\r\n\r\n    function handleJoined() {\r\n        logger.debug(\"did join \" + domain);\r\n\r\n        isJoined = true;\r\n        const wasReconnect = tryReconnecting;\r\n        tryReconnecting = false;\r\n        callbacks.execute(\"onJoined\", wasReconnect);\r\n    }\r\n\r\n    function handleConnectionDisconnected() {\r\n        _connectionOn = false;\r\n        logger.debug(\"connection is down\");\r\n        isJoined = false;\r\n        tryReconnecting = true;\r\n        callbacks.execute(\"onLeft\", { disconnected: true });\r\n    }\r\n\r\n    function handleConnectionLoggedIn() {\r\n        _connectionOn = true;\r\n        if (tryReconnecting) {\r\n            logger.debug(\"connection is now up - trying to reconnect...\");\r\n            join(_latestOptions);\r\n        }\r\n    }\r\n\r\n    function onJoined(callback: (wasReconnect: boolean) => void) {\r\n        if (isJoined) {\r\n            callback(false);\r\n        }\r\n\r\n        return callbacks.add(\"onJoined\", callback);\r\n    }\r\n\r\n    function onLeft(callback: () => void) {\r\n        if (!isJoined) {\r\n            callback();\r\n        }\r\n\r\n        return callbacks.add(\"onLeft\", callback);\r\n    }\r\n\r\n    function handleErrorMessage(msg: GW3Message) {\r\n        if (domain !== msg.domain) {\r\n            return;\r\n        }\r\n\r\n        const requestId = msg.request_id;\r\n        if (!requestId) {\r\n            return;\r\n        }\r\n        const entry = requestsMap[requestId];\r\n        if (!entry) {\r\n            return;\r\n        }\r\n\r\n        entry.error(msg);\r\n    }\r\n\r\n    function handleSuccessMessage(msg: GW3Message) {\r\n        if (msg.domain !== domain) {\r\n            return;\r\n        }\r\n        const requestId = msg.request_id;\r\n        if (!requestId) {\r\n            return;\r\n        }\r\n        const entry = requestsMap[requestId];\r\n        if (!entry) {\r\n            return;\r\n        }\r\n        entry.success(msg);\r\n    }\r\n\r\n    function getNextRequestId() {\r\n        return generate();\r\n    }\r\n\r\n    /**\r\n     * Send a message\r\n     * @param msg message to send\r\n     * @param tag a custom object (tag) - it will be transferred to success/error callback\r\n     * @param success\r\n     * @param error\r\n     */\r\n    function send<T>(msg: GW3Message, tag?: object, options?: Glue42Core.Connection.SendMessageOptions): Promise<T> {\r\n        options = options || {};\r\n        // Allows function caller to override request_id\r\n        msg.request_id = msg.request_id || getNextRequestId();\r\n        // Allows function caller to override domain (join/leave messages are in global domain)\r\n        msg.domain = msg.domain || domain;\r\n        if (!options.skipPeerId) {\r\n            msg.peer_id = connection.peerId;\r\n        }\r\n\r\n        const requestId = msg.request_id;\r\n\r\n        return new Promise((resolve, reject) => {\r\n            requestsMap[requestId] = {\r\n                success: (successMsg: any) => {\r\n                    delete requestsMap[requestId];\r\n                    successMsg._tag = tag;\r\n                    resolve(successMsg);\r\n                },\r\n                error: (errorMsg: { _tag?: any, error?: string }) => {\r\n                    logger.warn(`GW error - ${JSON.stringify(errorMsg)} for request ${JSON.stringify(msg)}`);\r\n                    delete requestsMap[requestId];\r\n                    errorMsg._tag = tag;\r\n                    reject(errorMsg);\r\n                },\r\n            };\r\n            connection\r\n                .send(msg, options)\r\n                .catch((err: string) => {\r\n                    requestsMap[requestId].error({ err });\r\n                });\r\n        });\r\n    }\r\n\r\n    function sendFireAndForget(msg: GW3Message): Promise<void> {\r\n        // Allows function caller to override request_id\r\n        msg.request_id = msg.request_id ? msg.request_id : getNextRequestId();\r\n        // Allows function caller to override domain (join/leave messages are in global domain)\r\n        msg.domain = msg.domain || domain;\r\n        msg.peer_id = connection.peerId;\r\n\r\n        return connection.send(msg);\r\n    }\r\n\r\n    return {\r\n        join,\r\n        leave,\r\n        onJoined,\r\n        onLeft,\r\n        send,\r\n        sendFireAndForget,\r\n        on: <T>(type: string, callback: (msg: T) => void) => {\r\n            connection.on(type, (msg: any) => {\r\n                if (msg.domain !== domain) {\r\n                    return;\r\n                }\r\n\r\n                try {\r\n                    callback(msg);\r\n                } catch (e) {\r\n                    logger.error(`Callback  failed: ${e} \\n ${e.stack} \\n msg was: ${JSON.stringify(msg)}`, e);\r\n                }\r\n            });\r\n        },\r\n        loggedIn: (callback: () => void) => connection.loggedIn(callback),\r\n        connected: (callback: (server: string) => void) => connection.connected(callback),\r\n        disconnected: (callback: () => void) => connection.disconnected(callback),\r\n        get peerId() {\r\n            return connection.peerId;\r\n        },\r\n        get domain() {\r\n            return domain;\r\n        },\r\n    };\r\n}\r\n","import domainSession from \"./gw3Domain\";\r\nimport { Glue42Core } from \"../../../glue\";\r\nimport { default as CallbackRegistryFactory, CallbackRegistry } from \"callback-registry\";\r\nimport { GW3Protocol, Identity, ConnectionSettings } from \"../types\";\r\nimport Connection from \"../connection\";\r\nimport { Logger } from \"../../logger/logger\";\r\nimport { WelcomeMessage, CreateTokenReq, CreateTokenRes } from \"./messages\";\r\nexport default class GW3ProtocolImpl implements GW3Protocol {\r\n    public protocolVersion: number = 3;\r\n\r\n    private datePrefix = \"#T42_DATE#\";\r\n    private datePrefixLen = this.datePrefix.length;\r\n    private dateMinLen = this.datePrefixLen + 1; // prefix + at least one char (1970/01/01 = 0)\r\n    private datePrefixFirstChar = this.datePrefix[0];\r\n    private registry: CallbackRegistry = CallbackRegistryFactory();\r\n\r\n    private globalDomain: Glue42Core.Connection.GW3DomainSession | undefined;\r\n\r\n    /* Flag indicating if the user is currently logged in */\r\n    private _isLoggedIn = false;\r\n\r\n    /*\r\n     * If true(default) the user wants to be connected.\r\n     * If the user explicitly calls logout this will become false.\r\n     * This is used to determine if it should retry trying to login.\r\n     */\r\n    private shouldTryLogin = true;\r\n\r\n    /* True only if this is the initial login attempt. */\r\n    private initialLogin = true;\r\n    private initialLoginAttempts = 3;\r\n    private pingTimer: any;\r\n    private sessions: Glue42Core.Connection.GW3DomainSession[] = [];\r\n    private loginConfig: Glue42Core.Auth | undefined;\r\n\r\n    constructor(private connection: Connection, private settings: ConnectionSettings, private logger: Logger) {\r\n        connection.disconnected(() => {\r\n            this.handleDisconnected();\r\n        });\r\n\r\n        this.ping();\r\n    }\r\n\r\n    public get isLoggedIn() {\r\n        return this._isLoggedIn;\r\n    }\r\n\r\n    public processStringMessage(message: string): { msg: object, msgType: string } {\r\n        const msg: { type: string } = JSON.parse(message, (key, value) => {\r\n\r\n            // check for date - we have custom protocol for dates\r\n            if (typeof value !== \"string\") {\r\n                return value;\r\n            }\r\n            if (value.length < this.dateMinLen) {\r\n                return value;\r\n            }\r\n            if (value[0] !== this.datePrefixFirstChar) {\r\n                return value;\r\n            }\r\n            if (value.substring(0, this.datePrefixLen) !== this.datePrefix) {\r\n                return value;\r\n            }\r\n            try {\r\n                const milliseconds = parseInt(value.substring(this.datePrefixLen, value.length), 10);\r\n                if (isNaN(milliseconds)) {\r\n                    return value;\r\n                }\r\n                return new Date(milliseconds);\r\n            } catch (ex) {\r\n                return value;\r\n            }\r\n        });\r\n\r\n        return {\r\n            msg,\r\n            msgType: msg.type,\r\n        };\r\n    }\r\n\r\n    public createStringMessage(message: object): string {\r\n        const oldToJson = Date.prototype.toJSON;\r\n        try {\r\n            const datePrefix = this.datePrefix;\r\n            Date.prototype.toJSON = function () {\r\n                return datePrefix + this.getTime();\r\n            };\r\n            const result = JSON.stringify(message);\r\n            return result;\r\n        } finally {\r\n            Date.prototype.toJSON = oldToJson;\r\n        }\r\n    }\r\n\r\n    public processObjectMessage(message: { type: string }): { msg: object, msgType: string } {\r\n        if (!message.type) {\r\n            throw new Error(\"Object should have type property\");\r\n        }\r\n        return {\r\n            msg: message,\r\n            msgType: message.type,\r\n        };\r\n    }\r\n\r\n    public createObjectMessage(message: object): object {\r\n        return message;\r\n    }\r\n\r\n    public async login(config: Glue42Core.Auth, reconnect?: boolean): Promise<Identity> {\r\n        this.logger.debug(\"logging in...\");\r\n        this.loginConfig = config;\r\n\r\n        if (!this.loginConfig) {\r\n            // in case of no auth send empty username and password\r\n            this.loginConfig = { username: \"\", password: \"\" };\r\n        }\r\n        this.shouldTryLogin = true;\r\n\r\n        const authentication: {\r\n            method?: string,\r\n            token?: string,\r\n            login?: string,\r\n            secret?: string,\r\n            provider?: string\r\n        } = {};\r\n\r\n        this.connection.gatewayToken = config.gatewayToken;\r\n        if (config.gatewayToken) {\r\n            // in case of re-connect try to refresh the GW token\r\n            if (reconnect) {\r\n                try {\r\n                    const token = await this.getNewGWToken();\r\n                    config.gatewayToken = token;\r\n                } catch (e) {\r\n                    this.logger.warn(`failed to get GW token when reconnecting ${e?.message || e}`);\r\n                }\r\n            }\r\n            authentication.method = \"gateway-token\";\r\n            authentication.token = config.gatewayToken;\r\n            this.connection.gatewayToken = config.gatewayToken;\r\n        } else if (config.flowName === \"sspi\") {\r\n            authentication.provider = \"win\";\r\n            authentication.method = \"access-token\";\r\n\r\n            if (config.flowCallback && config.sessionId) {\r\n                authentication.token =\r\n                    (await config.flowCallback(config.sessionId, null))\r\n                        .data\r\n                        .toString(\"base64\");\r\n            } else {\r\n                throw new Error(\"Invalid SSPI config\");\r\n            }\r\n        } else if (config.token) {\r\n            authentication.method = \"access-token\";\r\n            authentication.token = config.token;\r\n        } else if (config.username) {\r\n            authentication.method = \"secret\";\r\n            authentication.login = config.username;\r\n            authentication.secret = config.password;\r\n        } else {\r\n            throw new Error(\"invalid auth message\" + JSON.stringify(config));\r\n        }\r\n\r\n        const helloMsg: any = {\r\n            type: \"hello\",\r\n            identity: this.settings.identity,\r\n            authentication\r\n        };\r\n\r\n        if (config.sessionId) {\r\n            helloMsg.request_id = config.sessionId;\r\n        }\r\n\r\n        this.globalDomain = domainSession(\r\n            \"global\",\r\n            this.connection,\r\n            this.logger.subLogger(\"global-domain\"),\r\n            [\r\n                \"welcome\",\r\n                \"token\",\r\n                \"authentication-request\"\r\n            ]);\r\n\r\n        const sendOptions: Glue42Core.Connection.SendMessageOptions = { skipPeerId: true };\r\n        if (this.initialLogin) {\r\n            sendOptions.retryInterval = this.settings.reconnectInterval;\r\n            sendOptions.maxRetries = this.settings.reconnectAttempts;\r\n        }\r\n\r\n        try {\r\n            let welcomeMsg: WelcomeMessage;\r\n\r\n            while (true) {\r\n                const msg: any = await this.globalDomain.send(helloMsg, undefined, sendOptions);\r\n                if (msg.type === \"authentication-request\") {\r\n                    // respond to auth challenge\r\n                    const token = Buffer.from(msg.authentication.token, \"base64\");\r\n                    if (config.flowCallback && config.sessionId) {\r\n                        helloMsg.authentication.token =\r\n                            (await config.flowCallback(config.sessionId, token))\r\n                                .data\r\n                                .toString(\"base64\");\r\n                    }\r\n                    helloMsg.request_id = config.sessionId;\r\n                    continue;\r\n                } else if (msg.type === \"welcome\") {\r\n                    // we're in\r\n                    welcomeMsg = msg as WelcomeMessage;\r\n                    break;\r\n                } else if (msg.type === \"error\") {\r\n                    throw new Error(\"Authentication failed: \" + msg.reason);\r\n                } else {\r\n                    throw new Error(\"Unexpected message type during authentication: \" + msg.type);\r\n                }\r\n            }\r\n            // we've logged in once - set this to false for the rest of the lifetime\r\n            this.initialLogin = false;\r\n            this.logger.debug(\"login successful with peerId \" + welcomeMsg.peer_id);\r\n\r\n            this.connection.peerId = welcomeMsg.peer_id;\r\n            this.connection.resolvedIdentity = welcomeMsg.resolved_identity;\r\n            this.connection.availableDomains = welcomeMsg.available_domains as any;\r\n            if (welcomeMsg.options) {\r\n                this.connection.token = welcomeMsg.options.access_token;\r\n                this.connection.info = welcomeMsg.options.info;\r\n            }\r\n            this.setLoggedIn(true);\r\n            return welcomeMsg.resolved_identity;\r\n        } catch (err) {\r\n            this.logger.error(\"error sending hello message - \" + (err.message || err.msg || err.reason || err), err);\r\n            throw err;\r\n        } finally {\r\n            if (config && config.flowCallback && config.sessionId) {\r\n                config.flowCallback(config.sessionId, null);\r\n            }\r\n        }\r\n    }\r\n\r\n    public async logout(): Promise<void> {\r\n        this.logger.debug(\"logging out...\");\r\n        this.shouldTryLogin = false;\r\n\r\n        if (this.pingTimer) {\r\n            clearTimeout(this.pingTimer);\r\n        }\r\n\r\n        // go through all sessions and leave the corresponding domain\r\n        const promises = this.sessions.map((session) => {\r\n            session.leave();\r\n        });\r\n        await Promise.all(promises);\r\n    }\r\n\r\n    public loggedIn(callback: (() => void)): () => void {\r\n        if (this._isLoggedIn) {\r\n            callback();\r\n        }\r\n        return this.registry.add(\"onLoggedIn\", callback);\r\n    }\r\n\r\n    public domain(domainName: string, domainLogger: Logger, successMessages?: string[], errorMessages?: string[]): Glue42Core.Connection.GW3DomainSession {\r\n        let session = this.sessions.filter((s) => s.domain === domainName)[0];\r\n        if (!session) {\r\n            session = domainSession(domainName, this.connection, domainLogger, successMessages, errorMessages);\r\n            this.sessions.push(session);\r\n        }\r\n        return session;\r\n    }\r\n\r\n    public handleDisconnected() {\r\n        this.setLoggedIn(false);\r\n        const tryToLogin = this.shouldTryLogin;\r\n        if (tryToLogin && this.initialLogin) {\r\n            if (this.initialLoginAttempts <= 0) {\r\n                return;\r\n            }\r\n            this.initialLoginAttempts--;\r\n        }\r\n\r\n        this.logger.debug(\"disconnected - will try new login?\" + this.shouldTryLogin);\r\n        if (this.shouldTryLogin) {\r\n            if (!this.loginConfig) {\r\n                throw new Error(\"no login info\");\r\n            }\r\n\r\n            this.connection.login(this.loginConfig, true)\r\n                .catch(() => {\r\n                    setTimeout(this.handleDisconnected.bind(this), this.settings.reconnectInterval || 1000);\r\n                });\r\n        }\r\n    }\r\n\r\n    public setLoggedIn(value: boolean) {\r\n        this._isLoggedIn = value;\r\n        if (this._isLoggedIn) {\r\n            this.registry.execute(\"onLoggedIn\");\r\n        }\r\n    }\r\n\r\n    public ping() {\r\n        // if we don't want to be connected return\r\n        if (!this.shouldTryLogin) {\r\n            return;\r\n        }\r\n\r\n        // if logged in ping\r\n        if (this._isLoggedIn) {\r\n            this.connection.send({ type: \"ping\" });\r\n        }\r\n\r\n        // schedule next after 30 sec\r\n        this.pingTimer = setTimeout(() => {\r\n            this.ping();\r\n        }, 30 * 1000);\r\n    }\r\n\r\n    public authToken(): Promise<string> {\r\n        const createTokenReq: CreateTokenReq = {\r\n            type: \"create-token\"\r\n        };\r\n\r\n        if (!this.globalDomain) {\r\n            return Promise.reject(new Error(\"no global domain session\"));\r\n        }\r\n\r\n        return this.globalDomain.send<CreateTokenRes>(createTokenReq)\r\n            .then((res: CreateTokenRes) => {\r\n                return res.token;\r\n            });\r\n    }\r\n\r\n    private getNewGWToken(): Promise<string | undefined> {\r\n        if (typeof window !== undefined) {\r\n            // pull up a new token from gd\r\n            const glue42gd = window.glue42gd;\r\n            if (glue42gd) {\r\n                return glue42gd.getGWToken();\r\n            }\r\n        }\r\n        return Promise.reject(new Error(\"not running in GD\"));\r\n    }\r\n}\r\n","import { Glue42Core } from \"../../glue\";\r\n\r\nexport class MessageReplayerImpl implements Glue42Core.Connection.MessageReplayer {\r\n    private specs: { [name: string]: Glue42Core.Connection.MessageReplaySpec };\r\n    private specsNames: string[] = [];\r\n    private messages: { [type: string]: object[] } = {};\r\n    private isDone: boolean | undefined;\r\n    private subs: { [type: string]: any } = {};\r\n    private subsRefCount: { [type: string]: number } = {};\r\n    private connection: Glue42Core.Connection.API | undefined;\r\n\r\n    constructor(specs: Glue42Core.Connection.MessageReplaySpec[]) {\r\n        this.specs = {};\r\n        for (const spec of specs) {\r\n            this.specs[spec.name] = spec;\r\n            this.specsNames.push(spec.name);\r\n        }\r\n    }\r\n\r\n    public init(connection: Glue42Core.Connection.API) {\r\n        this.connection = connection;\r\n        for (const name of this.specsNames) {\r\n            for (const type of this.specs[name].types) {\r\n                let refCount = this.subsRefCount[type];\r\n                if (!refCount) {\r\n                    refCount = 0;\r\n                }\r\n                refCount += 1;\r\n                this.subsRefCount[type] = refCount;\r\n                if (refCount > 1) {\r\n                    continue;\r\n                }\r\n\r\n                const sub = connection.on<object>(\r\n                    type,\r\n                    (msg) => this.processMessage(type, msg));\r\n\r\n                this.subs[type] = sub;\r\n            }\r\n        }\r\n    }\r\n\r\n    public processMessage(type: string, msg: object) {\r\n        if (this.isDone || !msg) {\r\n            return;\r\n        }\r\n\r\n        for (const name of this.specsNames) {\r\n            if (this.specs[name].types.indexOf(type) !== -1) {\r\n                const messages = this.messages[name] || [];\r\n                this.messages[name] = messages;\r\n                messages.push(msg);\r\n            }\r\n        }\r\n    }\r\n\r\n    public drain(name: string, callback?: (msg: object) => void) {\r\n        if (callback) {\r\n            (this.messages[name] || []).forEach(callback);\r\n        }\r\n\r\n        delete this.messages[name];\r\n\r\n        for (const type of this.specs[name].types) {\r\n            this.subsRefCount[type] -= 1;\r\n            if (this.subsRefCount[type] <= 0) {\r\n                this.connection?.off(this.subs[type]);\r\n                delete this.subs[type];\r\n                delete this.subsRefCount[type];\r\n            }\r\n        }\r\n\r\n        delete this.specs[name];\r\n\r\n        if (!this.specs.length) {\r\n            this.isDone = true;\r\n        }\r\n    }\r\n}\r\n","/* eslint-disable @typescript-eslint/no-explicit-any */\r\nexport const PromisePlus = <T>(executor: (resolve: (value?: T | PromiseLike<T> | undefined) => void, reject: (reason?: any) => void) => void, timeoutMilliseconds: number, timeoutMessage?: string): Promise<T> => {\r\n\r\n    return new Promise<T>((resolve, reject) => {\r\n        const timeout = setTimeout(() => {\r\n\r\n            const message = timeoutMessage || `Promise timeout hit: ${timeoutMilliseconds}`;\r\n\r\n            reject(message);\r\n        }, timeoutMilliseconds);\r\n\r\n        const providedPromise = new Promise<T>(executor);\r\n\r\n        providedPromise\r\n            .then((result) => {\r\n                clearTimeout(timeout);\r\n                resolve(result);\r\n            })\r\n            .catch((error) => {\r\n                clearTimeout(timeout);\r\n                reject(error);\r\n            });\r\n    });\r\n\r\n};\r\n","import { Glue42Core } from \"../../../glue\";\r\nimport { Identity, Transport } from \"../types\";\r\nimport { Logger } from \"../../logger/logger\";\r\nimport {\r\n    default as CallbackRegistryFactory,\r\n    CallbackRegistry,\r\n    UnsubscribeFunction,\r\n} from \"callback-registry\";\r\nimport generate from \"shortid\";\r\nimport { PromisePlus } from \"../../utils/promise-plus\";\r\n\r\ntype MessageType = \"connectionAccepted\" | \"connectionRejected\" | \"connectionRequest\" | \"parentReady\" | \"parentPing\" | \"platformPing\" | \"platformUnload\" | \"platformReady\" | \"clientUnload\" | \"manualUnload\";\r\n\r\nexport default class WebPlatformTransport implements Transport {\r\n\r\n    private publicWindowId: string | undefined;\r\n    private parentReady = false;\r\n    private iAmConnected = false;\r\n    private rejected = false;\r\n    private parentPingResolve: ((value?: void | PromiseLike<void> | undefined) => void) | undefined;\r\n    private connectionResolve: ((value?: void | PromiseLike<void> | undefined) => void) | undefined;\r\n    private connectionReject: ((reason?: unknown) => void) | undefined;\r\n    private port: MessagePort | undefined;\r\n    private myClientId: string | undefined;\r\n    private children: Array<{ grandChildId: string; source: Window; connected: boolean; origin: string }> = [];\r\n\r\n    private readonly parent: Window | undefined;\r\n    private readonly parentType: \"opener\" | \"top\" | \"workspace\" | undefined;\r\n    private readonly parentPingTimeout = 3000;\r\n    private readonly connectionRequestTimeout = 5000;\r\n    private readonly defaultTargetString = \"*\";\r\n    private readonly registry: CallbackRegistry = CallbackRegistryFactory();\r\n    private readonly messages: { [key in MessageType]: { name: string; handle: (event: MessageEvent) => void } } = {\r\n        connectionAccepted: { name: \"connectionAccepted\", handle: this.handleConnectionAccepted.bind(this) },\r\n        connectionRejected: { name: \"connectionRejected\", handle: this.handleConnectionRejected.bind(this) },\r\n        connectionRequest: { name: \"connectionRequest\", handle: this.handleConnectionRequest.bind(this) },\r\n        parentReady: { name: \"parentReady\", handle: this.handleParentReady.bind(this) },\r\n        parentPing: { name: \"parentPing\", handle: this.handleParentPing.bind(this) },\r\n        platformPing: { name: \"platformPing\", handle: this.handlePlatformPing.bind(this) },\r\n        platformUnload: { name: \"platformUnload\", handle: this.handlePlatformUnload.bind(this) },\r\n        platformReady: { name: \"platformReady\", handle: this.handlePlatformReady.bind(this) },\r\n        clientUnload: { name: \"clientUnload\", handle: this.handleClientUnload.bind(this) },\r\n        manualUnload: { name: \"manualUnload\", handle: this.handleManualUnload.bind(this) }\r\n    };\r\n\r\n    constructor(private readonly settings: Glue42Core.WebPlatformConnection, private readonly logger: Logger, private readonly identity?: Identity) {\r\n        this.setUpMessageListener();\r\n        this.setUpUnload();\r\n\r\n        if (!this.settings.port) {\r\n            this.parent = window.opener || window.top;\r\n\r\n            this.parentType = window.opener ? \"opener\" :\r\n                window.name.indexOf(\"#wsp\") !== -1 ? \"workspace\" : \"top\";\r\n        }\r\n    }\r\n\r\n    public get transportWindowId(): string | undefined {\r\n        return this.publicWindowId;\r\n    }\r\n\r\n    public async sendObject(msg: object): Promise<void> {\r\n        if (!this.port) {\r\n            throw new Error(\"Cannot send message, because the port was not opened yet\");\r\n        }\r\n        this.port.postMessage(msg);\r\n    }\r\n\r\n    public get isObjectBasedTransport(): boolean {\r\n        return true;\r\n    }\r\n\r\n    public onMessage(callback: (msg: string | object) => void): UnsubscribeFunction {\r\n        return this.registry.add(\"onMessage\", callback);\r\n    }\r\n\r\n    public send(): Promise<void> {\r\n        return Promise.reject(\"not supported\");\r\n    }\r\n\r\n    public onConnectedChanged(callback: (connected: boolean, reason?: string) => void): UnsubscribeFunction {\r\n        return this.registry.add(\"onConnectedChanged\", callback);\r\n    }\r\n\r\n    public async open(): Promise<void> {\r\n\r\n        this.logger.debug(\"opening a connection to the web platform gateway.\");\r\n\r\n        await this.connect();\r\n\r\n        this.notifyStatusChanged(true);\r\n    }\r\n\r\n    public close(): Promise<void> {\r\n        // DO NOTHING\r\n        return Promise.resolve();\r\n    }\r\n\r\n    public name(): string {\r\n        return \"web-platform\";\r\n    }\r\n\r\n    public reconnect(): Promise<void> {\r\n        // DO NOTHING\r\n        return Promise.resolve();\r\n    }\r\n\r\n    private async connect(): Promise<void> {\r\n\r\n        if (this.parentReady) {\r\n            this.logger.debug(\"cancelling connection attempt, because this client's parent has already given a ready signal\");\r\n            return;\r\n        }\r\n\r\n        if (this.settings.port) {\r\n            this.logger.debug(\"opening an internal web platform connection\");\r\n            this.port = this.settings.port;\r\n\r\n            this.publicWindowId = this.settings.windowId;\r\n\r\n            if (this.identity) {\r\n                this.identity.windowId = this.publicWindowId;\r\n            }\r\n\r\n            this.port.onmessage = (event): object[] => this.registry.execute(\"onMessage\", event.data);\r\n            this.logger.debug(\"internal web platform connection completed\");\r\n            return;\r\n        }\r\n\r\n        if (!this.parentType || !this.parent) {\r\n            throw new Error(\"Cannot initiate a connection, because there is no opener, no top and no port.\");\r\n        }\r\n\r\n        this.logger.debug(`opening a ${this.parentType === \"opener\" ? \"child\" : \"grandchild\"} client web platform connection`);\r\n\r\n        await this.waitParent(this.parent, this.parentType);\r\n        await this.initiateRemoteConnection(this.parent, this.parentType);\r\n        // I AM READY HERE\r\n        this.logger.debug(`the ${this.parentType === \"opener\" ? \"child\" : \"grandchild\"} client is connected`);\r\n    }\r\n\r\n    private initiateRemoteConnection(target: Window, parentType: \"opener\" | \"top\" | \"workspace\"): Promise<void> {\r\n\r\n        return PromisePlus<void>((resolve, reject) => {\r\n            this.connectionResolve = resolve;\r\n            this.connectionReject = reject;\r\n\r\n            this.myClientId = generate();\r\n\r\n            const bridgeInstanceId = this.parentType === \"workspace\" ? window.name.substring(0, window.name.indexOf(\"#wsp\")) : window.name;\r\n\r\n            const request = {\r\n                glue42core: {\r\n                    type: this.messages.connectionRequest.name,\r\n                    clientId: this.myClientId,\r\n                    clientType: parentType === \"top\" || parentType === \"workspace\" ? \"grandChild\" : \"child\",\r\n                    bridgeInstanceId\r\n                }\r\n            };\r\n\r\n            this.logger.debug(`sending connection request to ${parentType}`);\r\n\r\n            target.postMessage(request, this.defaultTargetString);\r\n        }, this.connectionRequestTimeout, \"The connection to the opener/top window timed out\");\r\n\r\n    }\r\n\r\n    private waitParent(target: Window, parentType: \"opener\" | \"top\" | \"workspace\"): Promise<void> {\r\n        return PromisePlus<void>((resolve) => {\r\n            this.parentPingResolve = resolve;\r\n\r\n            const message = {\r\n                glue42core: {\r\n                    type: parentType === \"opener\" ? this.messages.platformPing.name : this.messages.parentPing.name\r\n                }\r\n            };\r\n\r\n            this.logger.debug(`checking for ${parentType} window availability`);\r\n\r\n            target.postMessage(message, this.defaultTargetString);\r\n        }, this.parentPingTimeout, \"Cannot initiate glue, because this window was not opened or created by a glue client\");\r\n    }\r\n\r\n    private setUpMessageListener(): void {\r\n        if (this.settings.port) {\r\n            this.logger.debug(\"skipping generic message listener, because this is an internal client\");\r\n            // do not set up listener, because this is running as an internal client for the platform\r\n            return;\r\n        }\r\n\r\n        window.addEventListener(\"message\", (event) => {\r\n            const data = event.data?.glue42core;\r\n\r\n            if (!data || this.rejected) {\r\n                return;\r\n            }\r\n\r\n            if (!this.checkMessageTypeValid(data.type)) {\r\n                this.logger.error(`cannot handle the incoming glue42 core message, because the type is invalid: ${data.type}`);\r\n                return;\r\n            }\r\n\r\n            const messageType = data.type as MessageType;\r\n\r\n            this.logger.debug(`received valid glue42core message of type: ${messageType}`);\r\n\r\n            this.messages[messageType].handle(event);\r\n        });\r\n    }\r\n\r\n    private setUpUnload(): void {\r\n        if (this.settings.port) {\r\n            this.logger.debug(\"skipping unload event listener, because this is an internal client\");\r\n            // do not set up listener, because this is running as an internal client for the platform\r\n            return;\r\n        }\r\n\r\n        window.addEventListener(\"beforeunload\", () => {\r\n            const message = {\r\n                glue42core: {\r\n                    type: this.messages.clientUnload.name,\r\n                    data: {\r\n                        clientId: this.myClientId,\r\n                        ownWindowId: this.identity?.windowId\r\n                    }\r\n                }\r\n            };\r\n\r\n            if (this.parent) {\r\n                this.parent.postMessage(message, this.defaultTargetString);\r\n            }\r\n\r\n            this.port?.postMessage(message);\r\n        });\r\n    }\r\n\r\n    private handleParentReady(): void {\r\n        this.logger.debug(\"handling the ready signal from the parent, by resoling the pending promise.\");\r\n        this.parentReady = true;\r\n\r\n        if (this.parentPingResolve) {\r\n            this.parentPingResolve();\r\n            delete this.parentPingResolve;\r\n            return;\r\n        }\r\n\r\n        this.logger.debug(\"silently handling the ready signal from the top parent, because there is no defined promise\");\r\n    }\r\n\r\n    private handlePlatformReady(): void {\r\n        this.logger.debug(\"the web platform gave the ready signal\");\r\n        this.parentReady = true;\r\n\r\n        if (this.parentPingResolve) {\r\n            this.parentPingResolve();\r\n            delete this.parentPingResolve;\r\n            return;\r\n        }\r\n\r\n        this.logger.debug(\"silently handling the ready signal from the top parent, because there is no defined promise\");\r\n    }\r\n\r\n    private handleConnectionAccepted(event: MessageEvent): void {\r\n        const data = event.data?.glue42core;\r\n\r\n        if (this.myClientId === data.clientId) {\r\n            return this.handleAcceptanceOfMyRequest(data);\r\n        }\r\n\r\n        return this.handleAcceptanceOfGrandChildRequest(data, event);\r\n    }\r\n\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    private handleAcceptanceOfMyRequest(data: any): void {\r\n        this.logger.debug(\"handling a connection accepted signal targeted at me.\");\r\n\r\n        if (!data.port) {\r\n            this.logger.error(\"cannot set up my connection, because I was not provided with a port\");\r\n            return;\r\n        }\r\n\r\n        this.publicWindowId = this.parentType === \"opener\" ? window.name :\r\n            this.parentType === \"top\" ? data.parentWindowId :\r\n                window.name.substring(0, window.name.indexOf(\"#wsp\"));\r\n\r\n        if (this.identity && this.parentType !== \"top\") {\r\n            this.identity.windowId = this.publicWindowId;\r\n        }\r\n\r\n        if (this.identity && data.appName) {\r\n            this.identity.application = data.appName;\r\n            this.identity.applicationName = data.appName;\r\n        }\r\n\r\n        this.port = data.port as MessagePort;\r\n        this.port.onmessage = (e): object[] => this.registry.execute(\"onMessage\", e.data);\r\n\r\n        if (this.connectionResolve) {\r\n            this.logger.debug(\"my connection is set up, calling the connection resolve.\");\r\n            this.connectionResolve();\r\n            delete this.connectionResolve;\r\n            return;\r\n        }\r\n\r\n        this.logger.error(\"unable to call the connection resolve, because no connection promise was found\");\r\n    }\r\n\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    private handleAcceptanceOfGrandChildRequest(data: any, event: MessageEvent): void {\r\n        this.logger.debug(`handling a connection accepted signal targeted at a grandchild: ${data.clientId}`);\r\n\r\n        const child = this.children.find((c) => c.grandChildId === data.clientId);\r\n\r\n        if (!child) {\r\n            this.logger.error(`cannot handle connection accepted for grandchild: ${data.clientId}, because there is no grandchild with this id`);\r\n            return;\r\n        }\r\n\r\n        child.connected = true;\r\n\r\n        this.logger.debug(`the grandchild connection for ${data.clientId} is set up, forwarding the success message and the gateway port`);\r\n\r\n        data.parentWindowId = this.publicWindowId;\r\n\r\n        child.source.postMessage(event.data, child.origin, [data.port]);\r\n        return;\r\n    }\r\n\r\n    private handleConnectionRejected(): void {\r\n        this.logger.debug(\"handling a connection rejection. Most likely the reason is that this window was not created by a glue API call\");\r\n        if (this.connectionReject) {\r\n            this.connectionReject(\"The platform connection was rejected. Most likely because this window was not created by a glue API call\");\r\n            delete this.connectionReject;\r\n        }\r\n    }\r\n\r\n    private handleConnectionRequest(event: MessageEvent): void {\r\n        const source = event.source as Window;\r\n        const data = event.data.glue42core;\r\n\r\n        if (!data.clientType || data.clientType !== \"grandChild\") {\r\n            return this.rejectConnectionRequest(source, event.origin, \"rejecting a connection request, because the source was not opened by a glue API call\");\r\n        }\r\n\r\n        if (!data.clientId) {\r\n            return this.rejectConnectionRequest(source, event.origin, \"rejecting a connection request, because the source did not provide a valid id\");\r\n        }\r\n\r\n        if (this.parentType !== \"opener\" || !this.parent) {\r\n            return this.rejectConnectionRequest(source, event.origin, \"Cannot forward the connection request, because no direct connection to the platform was found\");\r\n        }\r\n\r\n        this.logger.debug(`handling a connection request for a grandchild: ${data.clientId}`);\r\n\r\n        this.children.push({ grandChildId: data.clientId, source, connected: false, origin: event.origin });\r\n\r\n        this.logger.debug(`grandchild: ${data.clientId} is prepared, forwarding connection request to the platform`);\r\n\r\n        this.parent.postMessage(event.data, this.defaultTargetString);\r\n    }\r\n\r\n    private handleParentPing(event: MessageEvent): void {\r\n\r\n        if (!this.parentReady) {\r\n            this.logger.debug(\"my parent is not ready, I am ignoring the parent ping\");\r\n            return;\r\n        }\r\n\r\n        if (!this.iAmConnected) {\r\n            this.logger.debug(\"i am not fully connected yet, I am ignoring the parent ping\");\r\n            return;\r\n        }\r\n\r\n        const message = {\r\n            glue42core: {\r\n                type: this.messages.parentReady.name\r\n            }\r\n        };\r\n\r\n        const source = event.source as Window;\r\n\r\n        this.logger.debug(\"responding to a parent ping with a ready message\");\r\n\r\n        source.postMessage(message, event.origin);\r\n    }\r\n\r\n    private handlePlatformUnload(event: MessageEvent): void {\r\n        this.logger.debug(\"detected a web platform unload\");\r\n\r\n        this.parentReady = false;\r\n\r\n        if (this.children.length) {\r\n            this.logger.debug(\"forwarding the platform unload to all known children and starting platform discovery polling\");\r\n            this.children.forEach((child) => child.source.postMessage(event.data, child.origin));\r\n        }\r\n\r\n        this.notifyStatusChanged(false, \"Gateway unloaded\");\r\n\r\n    }\r\n\r\n    private handleManualUnload(): void {\r\n        const message = {\r\n            glue42core: {\r\n                type: this.messages.clientUnload.name,\r\n                data: {\r\n                    clientId: this.myClientId,\r\n                    ownWindowId: this.identity?.windowId\r\n                }\r\n            }\r\n        };\r\n\r\n        if (this.parent) {\r\n            this.parent.postMessage(message, this.defaultTargetString);\r\n        }\r\n\r\n        this.port?.postMessage(message);\r\n    }\r\n\r\n    private handleClientUnload(event: MessageEvent): void {\r\n        const data = event.data.glue42core;\r\n        const clientId = data?.data.clientId;\r\n\r\n        if (!clientId) {\r\n            this.logger.warn(\"cannot process grand child unload, because the provided id was not valid\");\r\n            return;\r\n        }\r\n\r\n        const foundChild = this.children.find((child) => child.grandChildId === clientId);\r\n\r\n        if (!foundChild) {\r\n            this.logger.warn(\"cannot process grand child unload, because this client is unaware of this grandchild\");\r\n            return;\r\n        }\r\n\r\n        this.logger.debug(`handling grandchild unload for id: ${clientId}`);\r\n\r\n        this.children = this.children.filter((child) => child.grandChildId !== clientId);\r\n    }\r\n\r\n    private handlePlatformPing(): void {\r\n        this.logger.error(\"cannot handle platform ping, because this is not a platform calls handling component\");\r\n    }\r\n\r\n    private notifyStatusChanged(status: boolean, reason?: string): void {\r\n        this.iAmConnected = status;\r\n        this.registry.execute(\"onConnectedChanged\", status, reason);\r\n    }\r\n\r\n    private checkMessageTypeValid(typeToValidate: string): boolean {\r\n        return typeof typeToValidate === \"string\" && !!this.messages[typeToValidate as MessageType];\r\n    }\r\n\r\n    private rejectConnectionRequest(source: Window, origin: string, reason: string): void {\r\n        this.rejected = true;\r\n        this.logger.error(reason);\r\n\r\n        const rejection = {\r\n            glue42core: {\r\n                type: this.messages.connectionRejected.name\r\n            }\r\n        };\r\n\r\n        source.postMessage(rejection, origin);\r\n    }\r\n}\r\n","import {\r\n    default as CallbackFactory,\r\n    CallbackRegistry,\r\n} from \"callback-registry\";\r\nimport {\r\n    GW3Protocol,\r\n    Transport,\r\n    ConnectionSettings,\r\n    Identity,\r\n} from \"./types\";\r\nimport { Logger } from \"../logger/logger\";\r\n\r\nimport { Glue42Core } from \"../../glue\";\r\nimport InProcTransport from \"./transports/inProc\";\r\nimport SharedWorkerTransport from \"./transports/worker\";\r\nimport WS from \"./transports/ws\";\r\nimport GW3ProtocolImpl from \"./protocols/gw3\";\r\nimport { MessageReplayerImpl } from \"./replayer\";\r\nimport timer from \"../utils/timer\";\r\nimport WebPlatformTransport from \"./transports/webPlatform\";\r\n\r\n/**\r\n * A template for gateway connections - this is extended from specific protocols and transports.\r\n */\r\nexport default class Connection implements Glue42Core.Connection.API {\r\n\r\n    public peerId!: string;\r\n    public token!: string;\r\n    public info!: object;\r\n    public resolvedIdentity!: any;\r\n    public availableDomains!: Glue42Core.Connection.GWDomainInfo[];\r\n    public gatewayToken: string | undefined;\r\n    public replayer?: MessageReplayerImpl;\r\n\r\n    protected protocol: GW3Protocol;\r\n\r\n    // The message handlers that have to be executed for each received message\r\n    protected messageHandlers: {\r\n        [key: string]: { [key: string]: (msg: any) => void };\r\n    } = {};\r\n    protected ids = 1;\r\n    protected registry: CallbackRegistry = CallbackFactory();\r\n    protected _connected = false;\r\n    private isTrace = false;\r\n    private transport: Transport;\r\n\r\n    public get protocolVersion() {\r\n        return this.protocol?.protocolVersion;\r\n    }\r\n\r\n    constructor(private settings: ConnectionSettings, private logger: Logger) {\r\n        settings = settings || {};\r\n        settings.reconnectAttempts = settings.reconnectAttempts || 10;\r\n        settings.reconnectInterval = settings.reconnectInterval || 1000;\r\n\r\n        if (settings.inproc) {\r\n            this.transport = new InProcTransport(settings.inproc, logger.subLogger(\"inMemory\"));\r\n        } else if (settings.sharedWorker) {\r\n            this.transport = new SharedWorkerTransport(settings.sharedWorker, logger.subLogger(\"shared-worker\"));\r\n        } else if (settings.webPlatform) {\r\n            this.transport = new WebPlatformTransport(settings.webPlatform, logger.subLogger(\"web-platform\"), settings.identity);\r\n        } else if (settings.ws !== undefined) {\r\n            this.transport = new WS(settings, logger.subLogger(\"ws\"));\r\n        } else {\r\n            throw new Error(\"No connection information specified\");\r\n        }\r\n\r\n        this.isTrace = logger.canPublish(\"trace\");\r\n        logger.debug(`starting with ${this.transport.name()} transport`);\r\n\r\n        this.protocol = new GW3ProtocolImpl(this, settings, logger.subLogger(\"protocol\"));\r\n        this.transport.onConnectedChanged(\r\n            this.handleConnectionChanged.bind(this)\r\n        );\r\n        this.transport.onMessage(this.handleTransportMessage.bind(this));\r\n\r\n        if (settings.replaySpecs && settings.replaySpecs.length) {\r\n            this.replayer = new MessageReplayerImpl(settings.replaySpecs);\r\n            this.replayer.init(this);\r\n        }\r\n    }\r\n\r\n    public send(message: object, options?: Glue42Core.Connection.SendMessageOptions): Promise<void> {\r\n        // create a message using the protocol\r\n        if (\r\n            this.transport.sendObject &&\r\n            this.transport.isObjectBasedTransport\r\n        ) {\r\n            const msg = this.protocol.createObjectMessage(message);\r\n            if (this.isTrace) {\r\n                this.logger.trace(`>> ${JSON.stringify(msg)}`);\r\n            }\r\n            return this.transport.sendObject(msg, options);\r\n        } else {\r\n            const strMessage = this.protocol.createStringMessage(message);\r\n            if (this.isTrace) {\r\n                this.logger.trace(`>> ${strMessage}`);\r\n            }\r\n            return this.transport.send(strMessage, options);\r\n        }\r\n    }\r\n\r\n    public on<T>(\r\n        type: string,\r\n        messageHandler: (msg: T) => void\r\n    ): any {\r\n        type = type.toLowerCase();\r\n        if (this.messageHandlers[type] === undefined) {\r\n            this.messageHandlers[type] = {};\r\n        }\r\n\r\n        const id = this.ids++;\r\n        this.messageHandlers[type][id] = messageHandler;\r\n\r\n        return {\r\n            type,\r\n            id,\r\n        };\r\n    }\r\n\r\n    // Remove a handler\r\n    public off(info: { type: string; id: number }) {\r\n        delete this.messageHandlers[info.type.toLowerCase()][info.id];\r\n    }\r\n\r\n    public get isConnected() {\r\n        return this.protocol.isLoggedIn;\r\n    }\r\n\r\n    public connected(callback: (server: string) => void): () => void {\r\n        return this.protocol.loggedIn(() => {\r\n            callback(this.settings.ws || this.settings.sharedWorker || \"\");\r\n        });\r\n    }\r\n\r\n    public disconnected(callback: () => void): () => void {\r\n        return this.registry.add(\"disconnected\", callback);\r\n    }\r\n\r\n    public async login(authRequest: Glue42Core.Auth, reconnect?: boolean): Promise<Identity> {\r\n        // open the protocol in case it was closed by explicity logout\r\n        await this.transport.open();\r\n        timer(\"connection\").mark(\"transport-opened\");\r\n        const identity = this.protocol.login(authRequest, reconnect);\r\n        timer(\"connection\").mark(\"protocol-logged-in\");\r\n        return identity;\r\n    }\r\n\r\n    public async logout() {\r\n        await this.protocol.logout();\r\n        await this.transport.close();\r\n    }\r\n\r\n    public loggedIn(callback: () => void) {\r\n        return this.protocol.loggedIn(callback);\r\n    }\r\n\r\n    public domain(\r\n        domain: string,\r\n        successMessages?: string[],\r\n        errorMessages?: string[]\r\n    ): Glue42Core.Connection.GW3DomainSession {\r\n        return this.protocol.domain(\r\n            domain,\r\n            this.logger.subLogger(`domain=${domain}`),\r\n            successMessages,\r\n            errorMessages\r\n        );\r\n    }\r\n\r\n    public authToken(): Promise<string> {\r\n        return this.protocol.authToken();\r\n    }\r\n\r\n    public reconnect(): Promise<void> {\r\n        return this.transport.reconnect();\r\n    }\r\n\r\n    private distributeMessage(message: object, type: string) {\r\n        // Retrieve handlers for the message type\r\n        const handlers = this.messageHandlers[type.toLowerCase()];\r\n        if (handlers !== undefined) {\r\n            // Execute them\r\n            Object.keys(handlers).forEach((handlerId) => {\r\n                const handler = handlers[handlerId];\r\n                if (handler !== undefined) {\r\n                    try {\r\n                        handler(message);\r\n                    } catch (error) {\r\n                        try {\r\n                            // logger might not be there yet\r\n                            this.logger.error(`Message handler failed with ${error.stack}`, error);\r\n                        } catch (loggerError) {\r\n                            // tslint:disable-next-line:no-console\r\n                            console.log(\"Message handler failed\", error);\r\n                        }\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    }\r\n\r\n    private handleConnectionChanged(connected: boolean) {\r\n        if (this._connected === connected) {\r\n            return;\r\n        }\r\n        this._connected = connected;\r\n\r\n        if (connected) {\r\n            this.registry.execute(\"connected\");\r\n        } else {\r\n            this.registry.execute(\"disconnected\");\r\n        }\r\n    }\r\n\r\n    private handleTransportMessage(msg: string | object) {\r\n        let msgObj;\r\n        if (typeof msg === \"string\") {\r\n            msgObj = this.protocol.processStringMessage(msg);\r\n        } else {\r\n            msgObj = this.protocol.processObjectMessage(msg);\r\n        }\r\n\r\n        if (this.isTrace) {\r\n            this.logger.trace(`<< ${JSON.stringify(msgObj)}`);\r\n        }\r\n\r\n        this.distributeMessage(msgObj.msg, msgObj.msgType);\r\n    }\r\n}\r\n","import { Glue42Core } from \"../../glue\";\r\n\r\nconst order: Glue42Core.LogLevel[] = [\"trace\", \"debug\", \"info\", \"warn\", \"error\", \"off\"];\r\n\r\nexport class Logger implements Glue42Core.Logger.API {\r\n    public static Interop: Glue42Core.Interop.API;\r\n    public static InteropMethodName = \"T42.AppLogger.Log\";\r\n\r\n    public static Instance: string;\r\n    public readonly path: string;\r\n\r\n    private subLoggers: Logger[] = [];\r\n    private _consoleLevel: Glue42Core.LogLevel | undefined;\r\n    private _publishLevel: Glue42Core.LogLevel | undefined;\r\n    private loggerFullName: string;\r\n    private includeTimeAndLevel: boolean;\r\n    private logFn: Glue42Core.CustomLogger = console;\r\n    private customLogFn: boolean = false;\r\n\r\n    constructor(public readonly name: string, private parent?: Logger, logFn?: Glue42Core.CustomLogger) {\r\n        this.name = name;\r\n\r\n        if (parent) {\r\n            this.path = `${parent.path}.${name}`;\r\n        } else {\r\n            this.path = name;\r\n        }\r\n\r\n        this.loggerFullName = `[${this.path}]`;\r\n        this.includeTimeAndLevel = !logFn;\r\n        if (logFn) {\r\n            this.logFn = logFn;\r\n            this.customLogFn = true;\r\n        }\r\n    }\r\n\r\n    public subLogger(name: string): Logger {\r\n        // Check if the sub-logger is already created\r\n        const existingSub = this.subLoggers.filter((subLogger) => {\r\n            return subLogger.name === name;\r\n        })[0];\r\n\r\n        if (existingSub !== undefined) {\r\n            return existingSub;\r\n        }\r\n\r\n        // Check if the name isn't the same as one of the parent properties\r\n        Object.keys(this).forEach((key) => {\r\n            if (key === name) {\r\n                throw new Error(\"This sub logger name is not allowed.\");\r\n            }\r\n        });\r\n\r\n        const sub = new Logger(name, this, this.customLogFn ? this.logFn : undefined);\r\n\r\n        // add sub-logger to sub-loggers array\r\n        this.subLoggers.push(sub);\r\n\r\n        return sub;\r\n    }\r\n\r\n    public publishLevel(level?: Glue42Core.LogLevel): Glue42Core.LogLevel | undefined {\r\n        if (level) {\r\n            this._publishLevel = level;\r\n        }\r\n\r\n        return this._publishLevel || this.parent?.publishLevel();\r\n    }\r\n\r\n    public consoleLevel(level?: Glue42Core.LogLevel): Glue42Core.LogLevel | undefined {\r\n        if (level) {\r\n            this._consoleLevel = level;\r\n        }\r\n\r\n        return this._consoleLevel || this.parent?.consoleLevel();\r\n    }\r\n\r\n    public log(message: string, level?: Glue42Core.LogLevel, error?: Error) {\r\n        this.publishMessage(level || \"info\", message, error);\r\n    }\r\n\r\n    public trace(message: string) {\r\n        this.log(message, \"trace\");\r\n    }\r\n\r\n    public debug(message: string) {\r\n        this.log(message, \"debug\");\r\n    }\r\n\r\n    public info(message: string) {\r\n        this.log(message, \"info\");\r\n    }\r\n\r\n    public warn(message: string) {\r\n        this.log(message, \"warn\");\r\n    }\r\n\r\n    public error(message: string, err?: Error) {\r\n        this.log(message, \"error\");\r\n    }\r\n\r\n    public canPublish(level: Glue42Core.LogLevel, compareWith?: Glue42Core.LogLevel) {\r\n        const levelIdx = order.indexOf(level);\r\n        const restrictionIdx = order.indexOf(compareWith || this.consoleLevel() || \"trace\");\r\n\r\n        return levelIdx >= restrictionIdx;\r\n    }\r\n\r\n    private publishMessage(level: Glue42Core.LogLevel, message: string, error?: Error) {\r\n        // Retrieve logger name and levels\r\n        const loggerName = this.loggerFullName;\r\n\r\n        // Add stack trace if the message is an error\r\n        if (level === \"error\" && !error) {\r\n            const e = new Error();\r\n            if (e.stack) {\r\n                message =\r\n                    message +\r\n                    \"\\n\" +\r\n                    e.stack\r\n                        .split(\"\\n\")\r\n                        .slice(3)\r\n                        .join(\"\\n\");\r\n            }\r\n        }\r\n\r\n        if (this.canPublish(level, this.publishLevel())) {\r\n            const interop = Logger.Interop;\r\n            if (interop) {\r\n                try {\r\n                    if (interop.methods({ name: Logger.InteropMethodName }).length > 0) {\r\n                        interop.invoke(Logger.InteropMethodName, {\r\n                            msg: `${message}`,\r\n                            logger: loggerName,\r\n                            level\r\n                        });\r\n                    }\r\n                } catch {\r\n                    // interop might not be ready yet\r\n                }\r\n            }\r\n        }\r\n\r\n        // Publish in console\r\n        if (this.canPublish(level)) {\r\n            let prefix = \"\";\r\n            if (this.includeTimeAndLevel) {\r\n                const date = new Date();\r\n                const time = `${date.getHours()}:${date.getMinutes()}:${date.getSeconds()}:${date.getMilliseconds()}`;\r\n                prefix = `[${time}] [${level}] `;\r\n            }\r\n            const toPrint = `${prefix}${loggerName}: ${message}`;\r\n            switch (level) {\r\n                case \"trace\":\r\n                    // tslint:disable-next-line:no-console\r\n                    this.logFn.debug(toPrint);\r\n                    break;\r\n                case \"debug\":\r\n                    // tslint:disable-next-line:no-console\r\n                    if (this.logFn.debug) {\r\n                        // tslint:disable-next-line:no-console\r\n                        this.logFn.debug(toPrint);\r\n                    } else {\r\n                        // tslint:disable-next-line:no-console\r\n                        this.logFn.log(toPrint);\r\n                    }\r\n                    break;\r\n                case \"info\":\r\n                    // tslint:disable-next-line:no-console\r\n                    this.logFn.info(toPrint);\r\n                    break;\r\n                case \"warn\":\r\n                    // tslint:disable-next-line:no-console\r\n                    this.logFn.warn(toPrint);\r\n                    break;\r\n                case \"error\":\r\n                    // tslint:disable-next-line:no-console\r\n                    this.logFn.error(toPrint, error);\r\n                    break;\r\n            }\r\n        }\r\n    }\r\n}\r\n","export const GW_MESSAGE_CREATE_CONTEXT = \"create-context\";\r\nexport const GW_MESSAGE_ACTIVITY_CREATED = \"created\";\r\nexport const GW_MESSAGE_ACTIVITY_DESTROYED = \"destroyed\";\r\nexport const GW_MESSAGE_CONTEXT_CREATED = \"context-created\";\r\nexport const GW_MESSAGE_CONTEXT_ADDED = \"context-added\";\r\n\r\nexport const GW_MESSAGE_SUBSCRIBE_CONTEXT = \"subscribe-context\";\r\nexport const GW_MESSAGE_SUBSCRIBED_CONTEXT = \"subscribed-context\";\r\nexport const GW_MESSAGE_UNSUBSCRIBE_CONTEXT = \"unsubscribe-context\";\r\n\r\nexport const GW_MESSAGE_DESTROY_CONTEXT = \"destroy-context\";\r\nexport const GW_MESSAGE_CONTEXT_DESTROYED = \"context-destroyed\";\r\n\r\nexport const GW_MESSAGE_UPDATE_CONTEXT = \"update-context\";\r\nexport const GW_MESSAGE_CONTEXT_UPDATED = \"context-updated\";\r\nexport const GW_MESSAGE_JOINED_ACTIVITY = \"joined\";\r\n","import { Glue42Core} from \"../../glue\";\r\n\r\nimport * as msg from \"./bridges/gw3/messages\";\r\n\r\nexport const ContextMessageReplaySpec: Glue42Core.Connection.MessageReplaySpec = {\r\n    get name(): string {\r\n        return \"context\";\r\n    },\r\n\r\n    get types(): string[] {\r\n        return [\r\n            msg.GW_MESSAGE_CREATE_CONTEXT,\r\n            msg.GW_MESSAGE_ACTIVITY_CREATED,\r\n            msg.GW_MESSAGE_ACTIVITY_DESTROYED,\r\n            msg.GW_MESSAGE_CONTEXT_CREATED,\r\n            msg.GW_MESSAGE_CONTEXT_ADDED,\r\n            msg.GW_MESSAGE_SUBSCRIBE_CONTEXT,\r\n            msg.GW_MESSAGE_SUBSCRIBED_CONTEXT,\r\n            msg.GW_MESSAGE_UNSUBSCRIBE_CONTEXT,\r\n            msg.GW_MESSAGE_DESTROY_CONTEXT,\r\n            msg.GW_MESSAGE_CONTEXT_DESTROYED,\r\n            msg.GW_MESSAGE_UPDATE_CONTEXT,\r\n            msg.GW_MESSAGE_CONTEXT_UPDATED,\r\n            msg.GW_MESSAGE_JOINED_ACTIVITY\r\n        ];\r\n    }\r\n};\r\n","import { Glue42Core } from \"../glue\";\r\nimport { InternalConfig, GDStaringContext } from \"./types\";\r\nimport generate from \"shortid\";\r\nimport Utils from \"./utils/utils\";\r\nimport { ContextMessageReplaySpec } from \"./contexts/contextMessageReplaySpec\";\r\nimport { version as pjsonVersion } from \"../package.json\";\r\nimport { ConnectionSettings } from \"./connection/types\";\r\n\r\nexport default function (configuration: Glue42Core.Config, ext: Glue42Core.Extension, glue42gd: Glue42Core.GDObject | undefined): InternalConfig {\r\n\r\n    let nodeStartingContext: GDStaringContext;\r\n    if (Utils.isNode()) {\r\n        const startingContextString = process.env._GD_STARTING_CONTEXT_;\r\n        if (startingContextString) {\r\n            try {\r\n                nodeStartingContext = JSON.parse(startingContextString);\r\n            } catch {\r\n                // Do nothing - we will continue with the flow as if there is no starting context\r\n            }\r\n        }\r\n    }\r\n\r\n    function getConnection(): ConnectionSettings {\r\n\r\n        const gwConfig = configuration.gateway;\r\n\r\n        const protocolVersion = gwConfig?.protocolVersion ?? 3;\r\n        const reconnectInterval = gwConfig?.reconnectInterval;\r\n        const reconnectAttempts = gwConfig?.reconnectAttempts;\r\n\r\n        const defaultWs = \"ws://localhost:8385\";\r\n        let ws = gwConfig?.ws;\r\n        const sharedWorker = gwConfig?.sharedWorker;\r\n        const inproc = gwConfig?.inproc;\r\n        const webPlatform = gwConfig?.webPlatform ?? undefined;\r\n\r\n        // If running in GD use the injected ws URL\r\n        if (glue42gd) {\r\n            // GD3\r\n            ws = glue42gd.gwURL;\r\n        }\r\n        // if running in Node app, started from GD, use the ws from starting context\r\n        if (Utils.isNode() && nodeStartingContext && nodeStartingContext.gwURL) {\r\n            ws = nodeStartingContext.gwURL;\r\n        }\r\n\r\n        // if nothing specified use default WS\r\n        if (!ws && !sharedWorker && !inproc) {\r\n            ws = defaultWs;\r\n        }\r\n\r\n        let instanceId: string | undefined;\r\n        let windowId: string | undefined;\r\n        let pid: number | undefined;\r\n        let environment: string | undefined;\r\n        let region: string | undefined;\r\n        const appName = getApplication();\r\n        let uniqueAppName = appName;\r\n        if (typeof glue42gd !== \"undefined\") {\r\n            windowId = glue42gd.windowId;\r\n            pid = glue42gd.pid;\r\n            if (glue42gd.env) {\r\n                environment = glue42gd.env.env;\r\n                region = glue42gd.env.region;\r\n            }\r\n            // G4E-1668\r\n            uniqueAppName = glue42gd.application ?? \"glue-app\";\r\n            instanceId = glue42gd.appInstanceId;\r\n        } else if (Utils.isNode()) {\r\n            pid = process.pid;\r\n            if (nodeStartingContext) {\r\n                environment = nodeStartingContext.env;\r\n                region = nodeStartingContext.region;\r\n                instanceId = nodeStartingContext.instanceId;\r\n            }\r\n        } else {\r\n            // this is the case where this is is running in Glue42 Core V2\r\n            // in this case the windowId of the identity is set by the WebTransport, because it needs to communicate with possible parents\r\n        }\r\n\r\n        // replay specs for core connection\r\n        const replaySpecs = configuration.gateway?.replaySpecs ?? [];\r\n        // inject Context message replay\r\n        replaySpecs.push(ContextMessageReplaySpec);\r\n\r\n        return {\r\n            identity: {\r\n                application: uniqueAppName,\r\n                applicationName: appName,\r\n                windowId,\r\n                instance: instanceId,\r\n                process: pid,\r\n                region,\r\n                environment,\r\n                api: ext.version || pjsonVersion\r\n            },\r\n            reconnectInterval,\r\n            ws,\r\n            sharedWorker,\r\n            webPlatform,\r\n            inproc,\r\n            protocolVersion,\r\n            reconnectAttempts,\r\n            replaySpecs,\r\n        };\r\n    }\r\n\r\n    function getApplication() {\r\n        if (configuration.application) {\r\n            return configuration.application;\r\n        }\r\n\r\n        if (glue42gd) {\r\n            return glue42gd.applicationName;\r\n        }\r\n\r\n        const uid = generate();\r\n        if (Utils.isNode()) {\r\n            if (nodeStartingContext) {\r\n                return nodeStartingContext.applicationConfig.name;\r\n            }\r\n\r\n            return \"NodeJS\" + uid;\r\n        }\r\n\r\n        if (typeof window !== \"undefined\" && typeof document !== \"undefined\") {\r\n            return document.title + ` (${uid})`;\r\n        }\r\n\r\n        return uid;\r\n    }\r\n\r\n    function getAuth(): Glue42Core.Auth | undefined {\r\n        if (typeof configuration.auth === \"string\") {\r\n            return {\r\n                token: configuration.auth\r\n            };\r\n        }\r\n\r\n        if (configuration.auth) {\r\n            return configuration.auth;\r\n        }\r\n\r\n        if (Utils.isNode() && nodeStartingContext && nodeStartingContext.gwToken) {\r\n            return {\r\n                gatewayToken: nodeStartingContext.gwToken\r\n            };\r\n        }\r\n\r\n        if (configuration.gateway?.webPlatform || configuration.gateway?.inproc || configuration.gateway?.sharedWorker) {\r\n            return {\r\n                username: \"glue42\", password: \"glue42\"\r\n            };\r\n        }\r\n    }\r\n\r\n    function getLogger(): { console: Glue42Core.LogLevel; publish: Glue42Core.LogLevel } {\r\n        let config = configuration.logger;\r\n        const defaultLevel = \"warn\";\r\n        if (!config) {\r\n            config = defaultLevel;\r\n        }\r\n\r\n        // console level can be overridden by a gd setting\r\n        let gdConsoleLevel: Glue42Core.LogLevel | undefined;\r\n        if (glue42gd) {\r\n            gdConsoleLevel = glue42gd.consoleLogLevel;\r\n        }\r\n\r\n        if (typeof config === \"string\") {\r\n            return { console: gdConsoleLevel ?? config, publish: defaultLevel };\r\n        }\r\n\r\n        return {\r\n            console: gdConsoleLevel ?? config.console ?? defaultLevel,\r\n            publish: config.publish ?? defaultLevel\r\n        };\r\n    }\r\n\r\n    const connection = getConnection();\r\n    let application: string = getApplication();\r\n    if (typeof window !== \"undefined\") {\r\n        const windowAsAny = window as any;\r\n        const containerApplication = windowAsAny.htmlContainer ?\r\n            `${windowAsAny.htmlContainer.containerName}.${windowAsAny.htmlContainer.application}` :\r\n            windowAsAny?.glue42gd?.application;\r\n        if (containerApplication) {\r\n            application = containerApplication;\r\n        }\r\n    }\r\n\r\n    return {\r\n        bus: configuration.bus ?? false,\r\n        application,\r\n        auth: getAuth(),\r\n        logger: getLogger(),\r\n        connection,\r\n        metrics: configuration.metrics ?? true,\r\n        contexts: configuration.contexts ?? true,\r\n        version: ext.version || pjsonVersion,\r\n        libs: ext.libs ?? [],\r\n        customLogger: configuration.customLogger\r\n    };\r\n}\r\n","import { Glue42Core } from \"../../../../glue\";\r\nimport { ContextSubscriptionKey } from \"../types\";\r\n\r\nexport class GW3ContextData {\r\n    // invariants:\r\n    // - at least one of { isAnnounced, hasCallbacks() } must be truthy\r\n    //     (so no state (0) instances are kept)\r\n    // - name is defined\r\n    // - isAnnounced cannot go from true to false\r\n    // - !isAnnounced => activityId === undefined\r\n    // - !isAnnounced => contextId === undefined\r\n    // - isAnnounced => contextId !== undefined\r\n    // - !isAnnounced => context == {}\r\n    // - !isAnnounced => !joinedActivity\r\n    // - activityId === undefined => !joinedActivity\r\n    // - joinedActivity => activityId !== undefined !\r\n    // - activityId != undefined => name === activityId\r\n    // - !isAnnounced => sentExplicitSubscription === false\r\n    // - !hasCallbacks => sentExplicitSubscription === false\r\n    // - context is defaulted to {}, not null or undefined\r\n\r\n    // the name of this context; it's what our clients use to (un)subscribe\r\n    // to it; for an activity context it's the same as activityId\r\n    public name: string;\r\n\r\n    // the id of the context as assigned by the GW; only known after it has\r\n    // been announced\r\n    public contextId: string | undefined;\r\n\r\n    // since GW3 only sends a snapshot on subscription/activity creation,\r\n    // we need to keep track of the context state ourselves, for the sake\r\n    // of any additional subsequent subscribers (i.e. so we can give them\r\n    // the context snapshot so far)\r\n    public context: {};\r\n\r\n    // has the context been announced by the GW?\r\n    public isAnnounced: boolean;\r\n\r\n    public joinedActivity: boolean | undefined;\r\n\r\n    // callbacks to invoke on context update\r\n    public updateCallbacks: { [index: number]: (data: any, delta: any, removed: string[], key: ContextSubscriptionKey, extraData?: any) => void } = {};\r\n\r\n    // iff activity context, the id of the activity to which it belongs\r\n    public activityId: string | undefined;\r\n\r\n    public sentExplicitSubscription: boolean | undefined;\r\n\r\n    constructor(contextId: string | undefined, name: string, isAnnounced: boolean, activityId?: string) {\r\n        this.contextId = contextId;\r\n        this.name = name;\r\n        this.isAnnounced = isAnnounced;\r\n        this.activityId = activityId;\r\n        this.context = {};\r\n    }\r\n\r\n    public hasCallbacks() {\r\n        return Object.keys(this.updateCallbacks).length > 0;\r\n    }\r\n\r\n    // for reference only\r\n    // should never return 0\r\n    public getState(): number {\r\n        if (this.isAnnounced && this.hasCallbacks()) {\r\n            return 3;\r\n        }\r\n\r\n        if (this.isAnnounced) {\r\n            return 2;\r\n        }\r\n\r\n        if (this.hasCallbacks()) {\r\n            return 1;\r\n        }\r\n\r\n        return 0;\r\n    }\r\n}\r\n","import { Glue42Core } from \"../../glue\";\r\nimport { ContextDelta } from \"./bridges/types\";\r\nimport { Logger } from \"../logger/logger\";\r\n\r\nexport function applyContextDelta(\r\n    context: any,\r\n    delta: ContextDelta,\r\n    logger: Logger) {\r\n\r\n    try {\r\n        if (logger?.canPublish(\"trace\")) {\r\n            logger?.trace(`applying context delta ${JSON.stringify(delta)} on context ${JSON.stringify(context)}`);\r\n        }\r\n        if (!delta) {\r\n            return context;\r\n        }\r\n\r\n        if (delta.reset) {\r\n            context = { ...delta.reset };\r\n            return context;\r\n        }\r\n\r\n        context = deepClone(context, undefined);\r\n\r\n        if (delta.commands) {\r\n            for (const command of delta.commands) {\r\n                if (command.type === \"remove\") {\r\n                    deletePath(context, command.path);\r\n                } else if (command.type === \"set\") {\r\n                    setValueToPath(context, command.value, command.path);\r\n                }\r\n            }\r\n            // if there is a commands property ignore the rest (v1 added/updated/removed)\r\n            return context;\r\n        }\r\n\r\n        const added = delta.added;\r\n        const updated = delta.updated;\r\n        const removed = delta.removed;\r\n\r\n        if (added) {\r\n            Object.keys(added).forEach((key) => {\r\n                context[key] = added[key];\r\n            });\r\n        }\r\n\r\n        if (updated) {\r\n            Object.keys(updated).forEach((key) => {\r\n                mergeObjectsProperties(key, context, updated);\r\n            });\r\n        }\r\n\r\n        if (removed) {\r\n            removed.forEach((key) => {\r\n                delete context[key];\r\n            });\r\n        }\r\n\r\n        return context;\r\n    } catch (e) {\r\n        logger?.error(`error applying context delta ${JSON.stringify(delta)} on context ${JSON.stringify(context)}`, e);\r\n        return context;\r\n    }\r\n}\r\n\r\n// https://stackoverflow.com/a/40294058/1527706\r\nexport function deepClone(obj: any, hash?: WeakMap<any, any>): any {\r\n    hash = hash || new WeakMap<any, any>();\r\n    if (Object(obj) !== obj) { return obj; } // primitives\r\n    if (obj instanceof Set) { return new Set(obj); } // See note about this!\r\n    if (hash.has(obj)) { return hash.get(obj); } // cyclic reference\r\n    const result = obj instanceof Date ? new Date(obj)\r\n        : obj instanceof RegExp ? new RegExp(obj.source, obj.flags)\r\n            : obj.constructor ? new obj.constructor()\r\n                : Object.create(null);\r\n    hash.set(obj, result);\r\n    if (obj instanceof Map) {\r\n        Array.from(obj, ([key, val]) => result.set(key, deepClone(val, hash)));\r\n    }\r\n    return Object.assign(result, ...Object.keys(obj).map(\r\n        (key) => ({ [key]: deepClone(obj[key], hash) })));\r\n}\r\n\r\n/*\r\nmergeObjectsProperties(\r\n    \"a\",\r\n    { a: { b: { c: 1, e: 1 }, x: { y: 1 }, foo: { moo: \"bar\" } } },\r\n    { a: { b: { d: 1, e: 2 }, foo: \"bar\" } });\r\n\r\n    => { a: { b: { c: 1, e: 2 } }, x: { y: 1 }, foo: \"bar\" }\r\n*/\r\n\r\nconst mergeObjectsProperties = (key: string, what: any, withWhat: any) => {\r\n\r\n    const right = withWhat[key];\r\n\r\n    if (right === undefined) {\r\n        return what;\r\n    }\r\n\r\n    const left = what[key];\r\n\r\n    if (!left || !right) {\r\n        what[key] = right;\r\n        return what;\r\n    }\r\n\r\n    if (typeof left === \"string\" ||\r\n        typeof left === \"number\" ||\r\n        typeof left === \"boolean\" ||\r\n        typeof right === \"string\" ||\r\n        typeof right === \"number\" ||\r\n        typeof right === \"boolean\" ||\r\n        Array.isArray(left) ||\r\n        Array.isArray(right)) {\r\n        what[key] = right;\r\n        return what;\r\n    }\r\n\r\n    what[key] = Object.assign({}, left, right);\r\n\r\n    return what;\r\n};\r\n\r\n// https://stackoverflow.com/a/6713782/1527706\r\nexport function deepEqual(x: any, y: any) {\r\n    if (x === y) {\r\n        return true;\r\n    }\r\n    // if both x and y are null or undefined and exactly the same\r\n\r\n    if (!(x instanceof Object) || !(y instanceof Object)) {\r\n        return false;\r\n    }\r\n    // if they are not strictly equal, they both need to be Objects\r\n\r\n    if (x.constructor !== y.constructor) {\r\n        return false;\r\n    }\r\n    // they must have the exact same prototype chain, the closest we can do is\r\n    // test there constructor.\r\n\r\n    for (const p in x) {\r\n        if (!x.hasOwnProperty(p)) {\r\n            continue;\r\n        }\r\n        // other properties were tested using x.constructor === y.constructor\r\n\r\n        if (!y.hasOwnProperty(p)) {\r\n            return false;\r\n        }\r\n        // allows to compare x[ p ] and y[ p ] when set to undefined\r\n\r\n        if (x[p] === y[p]) {\r\n            continue;\r\n        }\r\n        // if they have the same strict value or identity then they are equal\r\n\r\n        if (typeof (x[p]) !== \"object\") {\r\n            return false;\r\n        }\r\n        // Numbers, Strings, Functions, Booleans must be strictly equal\r\n\r\n        if (!deepEqual(x[p], y[p])) {\r\n            return false;\r\n        }\r\n        // Objects and Arrays must be tested recursively\r\n    }\r\n\r\n    for (const p in y) {\r\n        if (y.hasOwnProperty(p) && !x.hasOwnProperty(p)) {\r\n            return false;\r\n        }\r\n        // allows x[ p ] to be set to undefined\r\n    }\r\n\r\n    return true;\r\n}\r\n\r\nexport function setValueToPath(obj: any, value: any, path: string) {\r\n    const pathArr = path.split(\".\");\r\n    let i;\r\n    for (i = 0; i < pathArr.length - 1; i++) {\r\n        if (!obj[pathArr[i]]) {\r\n            // path does not exist, create empty object\r\n            obj[pathArr[i]] = {};\r\n        }\r\n        if (typeof obj[pathArr[i]] !== \"object\") {\r\n            // handle the case where we have {a: 1} and we call set({a: {aa: 2}})\r\n            obj[pathArr[i]] = {};\r\n        }\r\n        obj = obj[pathArr[i]];\r\n    }\r\n    obj[pathArr[i]] = value;\r\n}\r\n\r\nexport function isSubset(superObj: any, subObj: any): boolean {\r\n    return Object.keys(subObj).every((ele) => {\r\n        if (typeof subObj[ele] === \"object\") {\r\n            return isSubset(superObj?.[ele] || {}, subObj[ele] || {});\r\n        }\r\n        return subObj[ele] === superObj?.[ele];\r\n    });\r\n}\r\n\r\nfunction deletePath(obj: any, path: string) {\r\n    const pathArr = path.split(\".\");\r\n    let i;\r\n    for (i = 0; i < pathArr.length - 1; i++) {\r\n        if (!obj[pathArr[i]]) {\r\n            // path does not exist, we're not removing anything\r\n            return;\r\n        }\r\n        obj = obj[pathArr[i]];\r\n    }\r\n    delete obj[pathArr[i]];\r\n}\r\n","import { Glue42Core } from \"../../../../glue\";\r\nimport { ContextBridge } from \"../../contextBridge\";\r\nimport { GW3ContextData as ContextData } from \"./contextData\";\r\nimport { applyContextDelta, deepEqual, deepClone, setValueToPath } from \"../../helpers\";\r\nimport * as msg from \"./messages\";\r\nimport { ContextMessage } from \"./contextMessage\";\r\nimport { ContextMessageReplaySpec } from \"../../contextMessageReplaySpec\";\r\nimport { Logger } from \"../../../logger/logger\";\r\nimport Connection from \"../../../connection/connection\";\r\nimport { ContextsConfig } from \"../../contextsModule\";\r\nimport { ContextName, ContextSubscriptionKey, ContextDelta, ContextDeltaCommand } from \"../types\";\r\n\r\n// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n// GW3Bridge implementation notes\r\n// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n//\r\n// ===========================\r\n// Terminology used\r\n// ===========================\r\n//\r\n// - gw-subscribe (verb):\r\n//      send SUBSCRIBE CONTEXT to GW se we see CONTEXT UPDATED messages,\r\n//      or\r\n//      get implicitly subscribed as consequence of joining activity\r\n//      sending the SUBSCRIBE CONTEXT message is done internally by this\r\n//      class whenever a ContextData item in _contextNameToData reaches\r\n//      state (3) (see 'States of a context' in gw3ContextData.ts)\r\n// - bridge-subscribe (verb):\r\n//      call gw3Bridge.subscribe method; we need to make sure we've\r\n//      gw-subscribed if/as soon as the target context is announced\r\n//      this is what consumers of this class do\r\n// - bridge-subscription (noun):\r\n//      the result of bridge-subscribe, and the state of having a handler\r\n//      subscribed to a context\r\n// - active subscription: bridge-subscription which will cause the handler\r\n//      to observe context changes until someone calls unsubscribe() here\r\n//      or the subscription becomes 'inactive'\r\n// - inactive subscription: bridge-subscription which will NOT cause the\r\n//      handler to observe context changes; this happens to\r\n//      bridge-subscriptions on activity contexts if we leave the activity.\r\n//      There is NO way to check if a subscription is active or not and it's\r\n//      not reflected in the contextData state.\r\n//\r\n// ===========================\r\n// General information\r\n// ===========================\r\n//\r\n// This class exposes the GW context subscription and updating features\r\n// using the subscribe/unsubscribe/update/createContext methods.\r\n//\r\n// The main logic is related to tracking the states of contexts (shared or\r\n// activity), represented by ContextData entries in _contextNameToData, and\r\n// reacting to gateway messages accordingly.\r\n//\r\n// ===========================\r\n// States of an ContextData object\r\n// ===========================\r\n//\r\n// (0) nothing (not defined, or deleted) - such entries are NOT kept in collections\r\n// (1) unknown but bridge-subscribed to\r\n// (2) announced but not bridge-subscribed to\r\n// (3) both announced and bridge-subscribed to (so also gw-subscribed)\r\n//\r\n//       sub/unsub   GW ann\r\n//      +-------->(1)-----+\r\n//      |                 |\r\n//      |                 |\r\n//      V       destroy   v\r\n// *-->(0)<--------------(3)\r\n//      |^---------+      ^\r\n//      |  destroy |      |\r\n//      |          |      |\r\n//      +-------->(2)<----+\r\n//        GW ann    subscribe/unsub\r\n//\r\n// You can look for the states and transitions in the code below, e.g.\r\n// (0) -> (1)\r\n//\r\n// Note: if it's not our activity context, we need to gw-(un)subscribe to the\r\n// GW update messages on certain transitions:\r\n// - on changes from { (1), (2) } -> (3) we send a subscribe message\r\n// - on changes from (3) -> (2) we send an unsubscribe message\r\n// - on destruction, we drop all the information about the context; let\r\n// anyone subscribe to it and create a new contextData in state (1), we don't\r\n// care - these subscriptions are inactive from the get go, since the context\r\n// can't be created again.\r\n//\r\n// The contextData also contains the current snapshot of the context if it's\r\n// currently gw-subscribed to (so states (2\"') and (3) below).\r\n//\r\n// Note: We're mostly going to the trouble of keeping unannounced contexts\r\n// (state (1)) in order to allow other GW message subscribers to see a new\r\n// context being created and subscribe to it before the message has reached\r\n// our handler. Also, only sending a CONTEXT SUBSCRIBE on state (3) instead\r\n// of on GW announce means no unnecessary updates are being distributed to\r\n// every instance of this library.\r\n//\r\n// Also, in the HC subscribing to an unknown context is OK as well so we're\r\n// keeping this behavior.\r\n//\r\n// Note: above is an abridged version of the state machine; states (2) and (3)\r\n// have three substates depending on whether the context is a global context,\r\n// our own activity context, or a foreign activity's context. Subscription\r\n// messages are only sent on { (1), (2'), (2\") } -> { (3'), (3\") }, with the\r\n// unsubscribe message sent on { (3'), (3\"), (3\"') } -> { (1), (2'), (2\") }\r\n// if a  subscribe was sent previously (so we'll send a final unsubscribe if\r\n// we subscribe to a foreign activity's context, then join the activity, then\r\n// unsubscribe - this is to avoid still potentially receiving unwanted updates\r\n// if we leave the activity).\r\n//\r\n// Full state diagram (not showing 'destroy' transitions):\r\n//\r\n//        join activity\r\n//      +------------------>(3\"')<------+\r\n//      |                    ^          |\r\n//      |                    | join     |\r\n//      |                    | activity |\r\n//      | activity created   |          |\r\n//      +------------------>(3\")<----+  |\r\n//      |                            |  |\r\n//      | global ctx ann             |  |\r\n//      +------------------>(3')<-+  |  |\r\n//      |                         |  |  |\r\n//      |                         |  |  |\r\n//     (1)                        |  |  |\r\n//      ^                         |  |  |\r\n//      | bridge-(un)subscribe   bridge-(un)subscribe\r\n//      |                         |  |  |\r\n//      V                         |  |  |\r\n// *-->(0)                        |  |  |\r\n//      |                         |  |  |\r\n//      | global ctx ann          |  |  |\r\n//      +------------------>(2')<-+  |  |\r\n//      |                            |  |\r\n//      | activity created           |  |\r\n//      +------------------>(2\")<----+  |\r\n//      |                    |          |\r\n//      |                    | join     |\r\n//      |                    | activity |\r\n//      | join activity      V          |\r\n//      +------------------>(2\"')<------+\r\n//\r\n// ===========================\r\n// Supported use cases\r\n// ===========================\r\n//\r\n// - bridge-(un)subscribe to shared context by name\r\n// - bridge-(un)subscribe to activity context for activity we ARE a member of\r\n//      - the context name is the activity id\r\n//      - here the subscriptions become inactive if we leave the activity\r\n//      - HOWEVER these subscriptions will become inactive if we leave the\r\n//      activity, and any further subscriptions to the activity's context\r\n//      will be inactive.\r\n//          The protocol provides no way for us to know other than through\r\n//      the LEAVE ACTIVITY success message which is sent by our peer and we\r\n//      can't observe it here, so we have no way to know to send an explicit\r\n//      subscription in order to reactivate the bridge-subscription.\r\n//          We could deal with this by extending the GW connection to allow\r\n//      us to inspect outgoing messages and react to the LEAVE ACTIVITY, but\r\n//      keeping a few stale objects around isn't worth the code complexity.\r\n//          This transition would be represented by (2\"') -> (2\") and\r\n//      (3\"') -> (3\") in the state diagram, where (3\"') -> (3\") would prompt\r\n//      a subscribe message.\r\n// - bridge-(un)subscribe to context of activity we're NOT in\r\n//      - the context name is the activity id\r\n//      - the subscription will stay active even if we join the activity later\r\n//      - again, these subscriptions will become inactive if we leave the\r\n//      activity\r\n//\r\n// Also note that unsubscribing from destroyed contexts is not required,\r\n// as the data is cleared up automatically (but it doesn't hurt).\r\n// Unsubscriptions are guaranteed to be safe and idempotent.\r\nexport class GW3Bridge implements ContextBridge {\r\n    private _logger: Logger;\r\n    private _connection: Connection;\r\n    // used for sending messages as it provides a promise-based interface\r\n    private _gw3Session: Glue42Core.Connection.GW3DomainSession;\r\n\r\n    // contexts in state { (1), (2), (3) }\r\n    private _contextNameToData: { [contextName: string]: ContextData } = {};\r\n\r\n    // for disposing purposes only\r\n    private _gw3Subscriptions: any[] = [];\r\n\r\n    // increment for every bridge-subscribe; used to unsubscribe()\r\n    private _nextCallbackSubscriptionNumber = 0;\r\n\r\n    // mapping announced contexts' name <-> id\r\n    private _contextNameToId: { [contextName: string]: string } = {};\r\n    private _contextIdToName: { [contextId: string]: string } = {};\r\n    private _protocolVersion?: number = undefined;\r\n    private get protocolVersion(): number {\r\n        if (!this._protocolVersion) {\r\n            const contextsDomainInfo = this._connection.availableDomains.find((d) => d.uri === \"context\");\r\n            this._protocolVersion = contextsDomainInfo?.version ?? 1;\r\n        }\r\n        return this._protocolVersion;\r\n    }\r\n\r\n    public get setPathSupported() {\r\n        return this.protocolVersion >= 2;\r\n    }\r\n\r\n    public constructor(config: ContextsConfig) {\r\n        this._connection = config.connection;\r\n        this._logger = config.logger;\r\n        this._gw3Session = this._connection.domain(\r\n            \"global\",\r\n            [\r\n                msg.GW_MESSAGE_CONTEXT_CREATED,\r\n                msg.GW_MESSAGE_SUBSCRIBED_CONTEXT,\r\n                msg.GW_MESSAGE_CONTEXT_DESTROYED,\r\n                msg.GW_MESSAGE_CONTEXT_UPDATED,\r\n            ]);\r\n\r\n        // TODO: logging, validation and error handling\r\n\r\n        this.subscribeToContextCreatedMessages();\r\n\r\n        this.subscribeToContextUpdatedMessages();\r\n\r\n        this.subscribeToContextDestroyedMessages();\r\n\r\n        this._connection.replayer?.drain(\r\n            ContextMessageReplaySpec.name,\r\n            (message) => {\r\n                const type = (message as any).type;\r\n                if (!type) {\r\n                    return;\r\n                }\r\n\r\n                if (type === msg.GW_MESSAGE_CONTEXT_CREATED ||\r\n                    type === msg.GW_MESSAGE_CONTEXT_ADDED ||\r\n                    type === msg.GW_MESSAGE_ACTIVITY_CREATED) {\r\n                    this.handleContextCreatedMessage(message as ContextMessage);\r\n                } else if (type === msg.GW_MESSAGE_SUBSCRIBED_CONTEXT ||\r\n                    type === msg.GW_MESSAGE_CONTEXT_UPDATED ||\r\n                    type === msg.GW_MESSAGE_JOINED_ACTIVITY) {\r\n                    this.handleContextUpdatedMessage(message as ContextMessage);\r\n                } else if (type === msg.GW_MESSAGE_CONTEXT_DESTROYED ||\r\n                    type === msg.GW_MESSAGE_ACTIVITY_DESTROYED) {\r\n                    this.handleContextDestroyedMessage(message as ContextMessage);\r\n                }\r\n            });\r\n    }\r\n\r\n    public dispose(): void {\r\n        for (const sub of this._gw3Subscriptions) {\r\n            this._connection.off(sub);\r\n        }\r\n        this._gw3Subscriptions.length = 0;\r\n        for (const contextName in this._contextNameToData) {\r\n            if (this._contextNameToId.hasOwnProperty(contextName)) {\r\n                delete this._contextNameToData[contextName];\r\n            }\r\n        }\r\n    }\r\n\r\n    public createContext(name: ContextName, data: any): Promise<string> {\r\n        return this._gw3Session\r\n            .send<ContextMessage>({\r\n                type: msg.GW_MESSAGE_CREATE_CONTEXT,\r\n                domain: \"global\",\r\n                name,\r\n                data,\r\n                lifetime: \"retained\",\r\n            })\r\n            .then((createContextMsg: ContextMessage) => {\r\n                this._contextNameToId[name] = createContextMsg.context_id;\r\n                this._contextIdToName[createContextMsg.context_id] = name;\r\n                const contextData = this._contextNameToData[name] || new ContextData(createContextMsg.context_id, name, true, undefined);\r\n                contextData.isAnnounced = true;\r\n                contextData.name = name;\r\n                contextData.contextId = createContextMsg.context_id;\r\n                contextData.context = data;\r\n                this._contextNameToData[name] = contextData;\r\n                return createContextMsg.context_id;\r\n            });\r\n    }\r\n\r\n    public all(): ContextName[] {\r\n        return Object.keys(this._contextNameToData)\r\n            .filter((name) => this._contextNameToData[name].isAnnounced);\r\n    }\r\n\r\n    public async update(name: ContextName, delta: any): Promise<void> {\r\n\r\n        // - send context update message\r\n        //\r\n        // - on success, apply delta to context currently in contextData\r\n\r\n        // should we implicitly create the context?\r\n\r\n        const contextData = this._contextNameToData[name];\r\n\r\n        if (!contextData || !contextData.isAnnounced) {\r\n            return this.createContext(name, delta) as any as Promise<void>;\r\n        }\r\n\r\n        // TODO: explain why --> because this\r\n        let currentContext = contextData.context;\r\n        if (!contextData.hasCallbacks()) {\r\n            currentContext = await this.get(contextData.name);\r\n        }\r\n\r\n        const calculatedDelta =\r\n            this.protocolVersion === 2 ?\r\n                this.calculateContextDeltaV2(currentContext, delta) :\r\n                this.calculateContextDeltaV1(currentContext, delta);\r\n\r\n        if (!Object.keys(calculatedDelta.added).length\r\n            && !Object.keys(calculatedDelta.updated).length\r\n            && !calculatedDelta.removed.length\r\n            && !calculatedDelta.commands?.length) {\r\n            return Promise.resolve();\r\n        }\r\n\r\n        return this._gw3Session\r\n            .send({\r\n                type: msg.GW_MESSAGE_UPDATE_CONTEXT,\r\n                domain: \"global\",\r\n                context_id: contextData.contextId,\r\n                delta: calculatedDelta,\r\n            }, {}, { skipPeerId: false })\r\n            .then((gwResponse: any) => {\r\n                this.handleUpdated(contextData, calculatedDelta, {\r\n                    updaterId: gwResponse.peer_id\r\n                });\r\n            });\r\n    }\r\n\r\n    public set(name: ContextName, data: any): Promise<void> {\r\n\r\n        const contextData = this._contextNameToData[name];\r\n\r\n        if (!contextData || !contextData.isAnnounced) {\r\n            return this.createContext(name, data) as any as Promise<void>;\r\n        }\r\n\r\n        // SBGW_D-194\r\n        return this._gw3Session\r\n            .send({\r\n                type: msg.GW_MESSAGE_UPDATE_CONTEXT,\r\n                domain: \"global\",\r\n                context_id: contextData.contextId,\r\n                delta: { reset: data },\r\n            }, {}, { skipPeerId: false })\r\n            .then((gwResponse: any) => {\r\n                this.handleUpdated(contextData, { reset: data, added: {}, removed: [], updated: {} }, { updaterId: gwResponse.peer_id });\r\n            });\r\n    }\r\n\r\n    public setPath(name: ContextName, path: string, value: any): Promise<void> {\r\n        if (!this.setPathSupported) {\r\n            return Promise.reject(\"glue.contexts.setPath operation is not supported, use Glue42 3.10 or later\");\r\n        }\r\n        return this.setPaths(name, [{ path, value }]);\r\n    }\r\n\r\n    public setPaths(name: ContextName, pathValues: Glue42Core.Contexts.PathValue[]): Promise<void> {\r\n        if (!this.setPathSupported) {\r\n            return Promise.reject(\"glue.contexts.setPaths operation is not supported, use Glue42 3.10 or later\");\r\n        }\r\n        const contextData = this._contextNameToData[name];\r\n\r\n        if (!contextData || !contextData.isAnnounced) {\r\n            const obj = {};\r\n            for (const pathValue of pathValues) {\r\n                setValueToPath(obj, pathValue.value, pathValue.path);\r\n            }\r\n\r\n            return this.createContext(name, obj) as any as Promise<void>;\r\n        }\r\n\r\n        const commands: ContextDeltaCommand[] = [];\r\n        for (const pathValue of pathValues) {\r\n            if (pathValue.value === null) {\r\n                commands.push({ type: \"remove\", path: pathValue.path });\r\n            } else {\r\n                commands.push({ type: \"set\", path: pathValue.path, value: pathValue.value });\r\n            }\r\n        }\r\n        return this._gw3Session\r\n            .send({\r\n                type: msg.GW_MESSAGE_UPDATE_CONTEXT,\r\n                domain: \"global\",\r\n                context_id: contextData.contextId,\r\n                delta: { commands }\r\n            }, {}, { skipPeerId: false })\r\n            .then((gwResponse: any) => {\r\n                this.handleUpdated(contextData, { added: {}, removed: [], updated: {}, commands }, { updaterId: gwResponse.peer_id });\r\n            });\r\n    }\r\n\r\n    /**\r\n     * Return a context's data asynchronously as soon as any becomes available\r\n     */\r\n    public get(name: ContextName): Promise<any> {\r\n\r\n        const contextData = this._contextNameToData[name];\r\n        // Three cases here:\r\n        // 1) The context does not exist and is not announced by the GW -> return {}\r\n        // 2) The context exists but we don't track it -> subscribe and return the object when we get the subscription result from GW\r\n        // 3) The context exists and we're tracking it -> just return the last state we have\r\n\r\n        // 1)\r\n        if (!contextData || !contextData.isAnnounced) {\r\n            return Promise.resolve({});\r\n        }\r\n\r\n        // 2)\r\n        if (contextData && !contextData.hasCallbacks()) {\r\n            return new Promise<any>(async (resolve, _) => {\r\n                this.subscribe(name, (data: any, _d: any, _r: string[], un: ContextSubscriptionKey) => {\r\n                    this.unsubscribe(un);\r\n                    resolve(data);\r\n                });\r\n            });\r\n        }\r\n\r\n        // 3)\r\n        const context = contextData?.context ?? {};\r\n        return Promise.resolve(context);\r\n    }\r\n\r\n    /**\r\n     * Creates a subscription to a given context which may or may not exist/be\r\n     * announced as of yet.\r\n     *\r\n     * NB: This method publishes an initial snapshot on subscription. Note that\r\n     * at this point the method itself may not have returned and the returned\r\n     * ContextSubscriptionKey is not saved in the return variable; if you want\r\n     * to unsubscribe from within the subscription callback, use the key argument\r\n     * of the callback.\r\n     */\r\n    public subscribe(\r\n        name: ContextName,\r\n        callback: (\r\n            data: any,\r\n            delta: any,\r\n            removed: string[],\r\n            key: ContextSubscriptionKey,\r\n            extraData?: any) => void)\r\n        : Promise<ContextSubscriptionKey> {\r\n\r\n        // - populate contextData's updateCallbacks with new entry\r\n        //\r\n        // - examine contextData and determine if we need to send a subscribe\r\n        //\r\n        // - if the context is announced, ensure handler gets snapshot\r\n\r\n        const thisCallbackSubscriptionNumber = this._nextCallbackSubscriptionNumber;\r\n        this._nextCallbackSubscriptionNumber += 1;\r\n\r\n        let contextData = this._contextNameToData[name];\r\n\r\n        if (!contextData ||\r\n            !contextData.isAnnounced) {\r\n            // (0) -> (1)\r\n            contextData = contextData || new ContextData(undefined, name, false, undefined);\r\n            this._contextNameToData[name] = contextData;\r\n            contextData.updateCallbacks[thisCallbackSubscriptionNumber] = callback;\r\n\r\n            // this will end up in handleContextUpdate which will cause a snapshot to get sent\r\n            // return this.createContext(name, {})\r\n            // \t.then(() => thisCallbackSubscriptionNumber);\r\n            return Promise.resolve(thisCallbackSubscriptionNumber);\r\n        }\r\n\r\n        const hadCallbacks = contextData.hasCallbacks();\r\n\r\n        contextData.updateCallbacks[thisCallbackSubscriptionNumber] = callback;\r\n\r\n        if (!hadCallbacks) {\r\n            // first subscriber: (2) -> (3)\r\n\r\n            if (!contextData.joinedActivity) {\r\n\r\n                // if we've created the context ourselves using\r\n                // createContext\r\n                if (contextData.context && contextData.sentExplicitSubscription) {\r\n                    const clone = deepClone(contextData.context);\r\n                    callback(clone, clone, [], thisCallbackSubscriptionNumber);\r\n                    return Promise.resolve(thisCallbackSubscriptionNumber);\r\n                }\r\n\r\n                // (2') -> (3') or (2\") -> (3\")\r\n                // shared context or not our activity;\r\n                // we need to gw-subscribe\r\n\r\n                // OTOH, no need to explicitly push a snapshot here,\r\n                // the GW will reply with a SUBSCRIBED CONTEXT with a snapshot\r\n                // which we'll push through subscribeToContextUpdatedMessages\r\n                // (not that we have a snapshot right now - it's not our activity,\r\n                // and we haven't subscribed already so we can't have received updates)\r\n\r\n                return this.sendSubscribe(contextData)\r\n                    .then(() => thisCallbackSubscriptionNumber);\r\n            } else {\r\n\r\n                // (2\"') -> (3\"')\r\n                // our activity, which we're tracking anyway\r\n                // no need to gw-subscribe, just push the snapshot to the new subscriber\r\n\r\n                const clone = deepClone(contextData.context);\r\n                callback(clone, clone, [], thisCallbackSubscriptionNumber);\r\n                return Promise.resolve(thisCallbackSubscriptionNumber);\r\n            }\r\n        } else {\r\n            // not first subscriber; no need to gw-subscribe, just push snapshot\r\n            // (3) -> (3)\r\n\r\n            const clone = deepClone(contextData.context);\r\n            callback(clone, clone, [], thisCallbackSubscriptionNumber);\r\n            return Promise.resolve(thisCallbackSubscriptionNumber);\r\n        }\r\n    }\r\n\r\n    public unsubscribe(subscriptionKey: ContextSubscriptionKey): void {\r\n        for (const name of Object.keys(this._contextNameToData)) {\r\n            const contextId = this._contextNameToId[name];\r\n            const contextData = this._contextNameToData[name];\r\n\r\n            if (!contextData) {\r\n                return;\r\n            }\r\n\r\n            const hadCallbacks = contextData.hasCallbacks();\r\n\r\n            delete contextData.updateCallbacks[subscriptionKey];\r\n\r\n            if (contextData.isAnnounced &&\r\n                hadCallbacks &&\r\n                !contextData.hasCallbacks() &&\r\n                contextData.sentExplicitSubscription) {\r\n                // (3) -> (2)\r\n                this.sendUnsubscribe(contextData);\r\n            }\r\n\r\n            if (!contextData.isAnnounced &&\r\n                // (1) -> (0)\r\n                !contextData.hasCallbacks()) {\r\n                delete this._contextNameToData[name];\r\n            }\r\n        }\r\n    }\r\n\r\n    public destroy(name: string) {\r\n        const contextData = this._contextNameToData[name];\r\n        if (!contextData) {\r\n            return Promise.reject(`context with ${name} does not exist`);\r\n        }\r\n\r\n        return this._gw3Session\r\n            .send({\r\n                type: msg.GW_MESSAGE_DESTROY_CONTEXT,\r\n                domain: \"global\",\r\n                context_id: contextData.contextId,\r\n            }).then((_) => undefined);\r\n    }\r\n\r\n    private handleUpdated(contextData: ContextData, delta: ContextDelta, extraData?: any) {\r\n        // for correctness proof, see note about serialized context\r\n        // updates in subscribeToContextUpdatedMessages\r\n\r\n        const oldContext = contextData.context;\r\n        contextData.context = applyContextDelta(contextData.context, delta, this._logger);\r\n\r\n        if (this._contextNameToData[contextData.name] === contextData &&\r\n            !deepEqual(oldContext, contextData.context)) {\r\n            this.invokeUpdateCallbacks(contextData, delta, extraData);\r\n        }\r\n    }\r\n\r\n    private subscribeToContextCreatedMessages() {\r\n\r\n        // when a new context is announced:\r\n        //\r\n        // - record the fact that it's announced, so when the first\r\n        //      bridge-subscribers come in, we do a gw-subscribe\r\n        //\r\n        // - record its name/contextId association\r\n        //\r\n        // - record its activity information, and the fact that this\r\n        //      activity exists and that we're not joined in it (yet?)\r\n        //\r\n        // - if any bridge-subscribers already present, do a gw-subscribe\r\n\r\n        const createdMessageTypes =\r\n            [\r\n                msg.GW_MESSAGE_CONTEXT_ADDED,\r\n                msg.GW_MESSAGE_CONTEXT_CREATED,\r\n                msg.GW_MESSAGE_ACTIVITY_CREATED,\r\n            ];\r\n\r\n        for (const createdMessageType of createdMessageTypes) {\r\n            const sub = this._connection.on(\r\n                createdMessageType,\r\n                this.handleContextCreatedMessage.bind(this));\r\n            this._gw3Subscriptions.push(sub);\r\n        }\r\n    }\r\n\r\n    private handleContextCreatedMessage(contextCreatedMsg: ContextMessage): void {\r\n        const createdMessageType = contextCreatedMsg.type;\r\n        if (createdMessageType === msg.GW_MESSAGE_ACTIVITY_CREATED) {\r\n            // activity context\r\n\r\n            this._contextNameToId[contextCreatedMsg.activity_id] = contextCreatedMsg.context_id;\r\n            this._contextIdToName[contextCreatedMsg.context_id] = contextCreatedMsg.activity_id;\r\n        } else if (createdMessageType === msg.GW_MESSAGE_CONTEXT_ADDED) {\r\n            // shared context\r\n\r\n            this._contextNameToId[contextCreatedMsg.name] = contextCreatedMsg.context_id;\r\n            this._contextIdToName[contextCreatedMsg.context_id] = contextCreatedMsg.name;\r\n        } else if (createdMessageType === msg.GW_MESSAGE_CONTEXT_CREATED) {\r\n            // created by us, data already populated\r\n\r\n            // NB: the promise resolution from createContext is supposed to run *before*\r\n            // we see the CONTEXT CREATED here, so _contextIdToName/_contextNameToId\r\n            // are supposed to already be populated (this is because the gw connection\r\n            // success handler is subscribed long before this one)\r\n        }\r\n\r\n        const name = this._contextIdToName[contextCreatedMsg.context_id];\r\n\r\n        if (!name) {\r\n            // we're supposed to have recorded the name\r\n            throw new Error(\"Received created event for context with unknown name: \" + contextCreatedMsg.context_id);\r\n        }\r\n\r\n        if (!this._contextNameToId[name]) {\r\n            // we're also supposed to have recorded it in the opposite direction\r\n            throw new Error(\"Received created event for context with unknown id: \" + contextCreatedMsg.context_id);\r\n        }\r\n\r\n        let contextData = this._contextNameToData[name];\r\n\r\n        if (contextData) {\r\n            if (contextData.isAnnounced) {\r\n                return;\r\n            } else {\r\n                // (1) -> (3') or (1) -> (3\")\r\n\r\n                // someone's already expressed interest in this context and now\r\n                // it's being announced\r\n\r\n                // you might think that since the activity context's id is\r\n                // auto-generated no one could have already context-subscribed, but\r\n                // there might be another ACTIVITY CREATED observer on the same\r\n                // GW connection who saw this message before us and reacted by\r\n                // subscribing to the context - so we need to handle this case\r\n\r\n                if (!contextData.hasCallbacks()) {\r\n                    throw new Error(\"Assertion failure: contextData.hasCallbacks()\");\r\n                }\r\n\r\n                // update its state and send a gw-subscribe; we're expecting an update message\r\n\r\n                contextData.isAnnounced = true;\r\n                contextData.contextId = contextCreatedMsg.context_id;\r\n                contextData.activityId = contextCreatedMsg.activity_id;\r\n\r\n                // if we're observing the ACTIVITY CREATED message,\r\n                // we're not one of its members and we need to gw-subscribe\r\n                // explicitly; of course we could be getting joined to the activity\r\n                // pretty soon which would subscribe us to context updates implicitly\r\n\r\n                // long story short, if we're about to be joined to the activity\r\n                // and an observer to ACTIVITY CREATED subscribes to the activity's context\r\n                // before we get to this point, we'll send a needless SUBSCRIBE CONTEXT\r\n                // but there's no harm done by beating that to the punch, and there's\r\n                // no clean way to avoid this situation so we leave this as an artifact\r\n                // of the implementation\r\n\r\n                // whether activity or not, we'll push the initial snapshot in the\r\n                // subscribeToContextUpdatedMessages handler\r\n\r\n                if (!contextData.sentExplicitSubscription) {\r\n                    this.sendSubscribe(contextData);\r\n                }\r\n            }\r\n        } else {\r\n            // (0) -> (2') or (0) -> (2\")\r\n            // first time we hear about this context\r\n            // we're not subscribed to it in the GW so just create a placeholder\r\n            // and wait for someone to subscribe to it - we'll THEN send a subscribe to the GW\r\n\r\n            this._contextNameToData[name] = contextData =\r\n                new ContextData(contextCreatedMsg.context_id, name, true, contextCreatedMsg.activity_id);\r\n        }\r\n    }\r\n\r\n    private subscribeToContextUpdatedMessages() {\r\n\r\n        // receiving a context update or snapshot\r\n        //\r\n        // if it's JOINED ACTIVITY, we may be a new peer as part of activity\r\n        // creation, so it's the first time we've heard about it -\r\n        // record the activity information in the contextData\r\n        //\r\n        // otherwise, this message is a response/consequence of our gw-subscribe\r\n        // message sent on entering state (3)\r\n        //\r\n        // in any case, apply any deltas to the contextData.context, and\r\n        // propagate the context data and delta to any bridge-subscription\r\n        // handlers\r\n        //\r\n        // note that context updates are always performed when reacting to\r\n        // a GW message, so the data over time is tied to the flow of\r\n        // messages coming in through the gateway connection; the GW decides\r\n        // which update comes before which and our view of the changes to\r\n        // the context is consistent with it (i.e. the GW is the serializing\r\n        // agent)\r\n\r\n        const updatedMessageTypes =\r\n            [\r\n                msg.GW_MESSAGE_CONTEXT_UPDATED,\r\n                msg.GW_MESSAGE_SUBSCRIBED_CONTEXT,\r\n                msg.GW_MESSAGE_JOINED_ACTIVITY,\r\n            ];\r\n\r\n        for (const updatedMessageType of updatedMessageTypes) {\r\n            const sub = this._connection.on(\r\n                updatedMessageType,\r\n                this.handleContextUpdatedMessage.bind(this));\r\n            this._gw3Subscriptions.push(sub);\r\n        }\r\n    }\r\n\r\n    private handleContextUpdatedMessage(contextUpdatedMsg: ContextMessage): void {\r\n        const updatedMessageType = contextUpdatedMsg.type;\r\n        const contextId = contextUpdatedMsg.context_id;\r\n        let contextData = this._contextNameToData[this._contextIdToName[contextId]];\r\n        // this flag is basically used to make sure we raise an update for a new activity\r\n        // even if its initial context is empty\r\n        // see \"long analysis for callback behavior in GW3: several cases\" comment in\r\n        // activityMyApi.ts in js-activity, case 1-1-1\r\n        // it serves a similar purpose for gw_message_subscribed_context\r\n        const justSeen = !contextData || !contextData.isAnnounced;\r\n\r\n        if (updatedMessageType === msg.GW_MESSAGE_JOINED_ACTIVITY) {\r\n            if (!contextData) {\r\n                // (0) -> (2\"')\r\n\r\n                // we're in the middle of activity creation\r\n                contextData = new ContextData(contextId, contextUpdatedMsg.activity_id, true, contextUpdatedMsg.activity_id);\r\n                this._contextNameToData[contextUpdatedMsg.activity_id] = contextData;\r\n                this._contextIdToName[contextId] = contextUpdatedMsg.activity_id;\r\n                this._contextNameToId[contextUpdatedMsg.activity_id] = contextId;\r\n            } else {\r\n                // (1) -> (3\"'), (2\") -> (2\"') or (3\") -> (3\"')\r\n\r\n                contextData.contextId = contextId;\r\n                contextData.isAnnounced = true;\r\n                contextData.activityId = contextUpdatedMsg.activity_id;\r\n            }\r\n            contextData.joinedActivity = true;\r\n        } else {\r\n            if (!contextData || !contextData.isAnnounced) {\r\n                if (updatedMessageType === msg.GW_MESSAGE_SUBSCRIBED_CONTEXT) {\r\n                    // we've tried to create a context that already exists\r\n                    contextData = contextData || new ContextData(contextId, contextUpdatedMsg.name, true, undefined);\r\n                    contextData.sentExplicitSubscription = true;\r\n                    this._contextNameToData[contextUpdatedMsg.name] = contextData;\r\n                    this._contextIdToName[contextId] = contextUpdatedMsg.name;\r\n                    this._contextNameToId[contextUpdatedMsg.name] = contextId;\r\n                } else {\r\n                    this._logger.error(`Received 'update' for unknown context: ${contextId}`);\r\n                }\r\n                return;\r\n            }\r\n        }\r\n\r\n        const oldContext = contextData.context;\r\n\r\n        if (updatedMessageType === msg.GW_MESSAGE_SUBSCRIBED_CONTEXT) {\r\n            contextData.context = contextUpdatedMsg.data || {};\r\n        } else if (updatedMessageType === msg.GW_MESSAGE_JOINED_ACTIVITY) {\r\n            contextData.context = contextUpdatedMsg.context_snapshot || {};\r\n        } else if (updatedMessageType === msg.GW_MESSAGE_CONTEXT_UPDATED) {\r\n            contextData.context = applyContextDelta(\r\n                contextData.context,\r\n                contextUpdatedMsg.delta as ContextDelta,\r\n                this._logger);\r\n        } else {\r\n            throw new Error(\"Unrecognized context update message \" + updatedMessageType);\r\n        }\r\n\r\n        if (justSeen ||\r\n            !deepEqual(contextData.context, oldContext) ||\r\n            updatedMessageType === msg.GW_MESSAGE_SUBSCRIBED_CONTEXT) {\r\n            this.invokeUpdateCallbacks(contextData, contextUpdatedMsg.delta, { updaterId: contextUpdatedMsg.updater_id });\r\n        }\r\n    }\r\n\r\n    private invokeUpdateCallbacks(contextData: ContextData, delta?: ContextDelta, extraData?: any) {\r\n        delta = delta || { added: {}, updated: {}, reset: {}, removed: [] };\r\n        if (delta.commands) {\r\n            // clear added, updated, removed, reset\r\n            delta.added = delta.updated = delta.reset = {};\r\n            delta.removed = [];\r\n            for (const command of delta.commands) {\r\n                if (command.type === \"remove\") {\r\n                    // push the removal of top level props only\r\n                    if (command.path.indexOf(\".\") === -1) {\r\n                        delta.removed.push(command.path);\r\n                    }\r\n                    setValueToPath(delta.updated, null, command.path);\r\n                } else if (command.type === \"set\") {\r\n                    setValueToPath(delta.updated, command.value, command.path);\r\n                }\r\n            }\r\n\r\n        }\r\n\r\n        for (const updateCallbackIndex in contextData.updateCallbacks) {\r\n            if (contextData.updateCallbacks.hasOwnProperty(updateCallbackIndex)) {\r\n                try {\r\n                    const updateCallback = contextData.updateCallbacks[updateCallbackIndex];\r\n                    updateCallback(deepClone(contextData.context), Object.assign({}, delta.added || {}, delta.updated || {}, delta.reset || {}), delta.removed, parseInt(updateCallbackIndex, 10), extraData);\r\n                } catch (err) {\r\n                    this._logger.debug(\"callback error: \" + JSON.stringify(err));\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    private subscribeToContextDestroyedMessages() {\r\n        // wipe all bookkeeping related to this context\r\n\r\n        const destroyedMessageTypes =\r\n            [\r\n                msg.GW_MESSAGE_CONTEXT_DESTROYED,\r\n                msg.GW_MESSAGE_ACTIVITY_DESTROYED,\r\n            ];\r\n\r\n        for (const destroyedMessageType of destroyedMessageTypes) {\r\n            const sub = this._connection.on(\r\n                destroyedMessageType,\r\n                this.handleContextDestroyedMessage.bind(this));\r\n            this._gw3Subscriptions.push(sub);\r\n        }\r\n    }\r\n\r\n    private handleContextDestroyedMessage(destroyedMsg: ContextMessage): void {\r\n        const destroyedMessageType = destroyedMsg.type;\r\n        let contextId;\r\n        let name;\r\n\r\n        // (?) -> (0)\r\n\r\n        if (destroyedMessageType === msg.GW_MESSAGE_ACTIVITY_DESTROYED) {\r\n            name = destroyedMsg.activity_id;\r\n            contextId = this._contextNameToId[name];\r\n            if (!contextId) {\r\n                this._logger.error(`Received 'destroyed' for unknown activity: ${destroyedMsg.activity_id}`);\r\n                return;\r\n            }\r\n        } else {\r\n            contextId = destroyedMsg.context_id;\r\n            name = this._contextIdToName[contextId];\r\n            if (!name) {\r\n                this._logger.error(`Received 'destroyed' for unknown context: ${destroyedMsg.context_id}`);\r\n                return;\r\n            }\r\n        }\r\n\r\n        delete this._contextIdToName[contextId];\r\n        delete this._contextNameToId[name];\r\n\r\n        const contextData = this._contextNameToData[name];\r\n        delete this._contextNameToData[name];\r\n\r\n        if (!contextData || !contextData.isAnnounced) {\r\n            this._logger.error(`Received 'destroyed' for unknown context: ${contextId}`);\r\n            return;\r\n        }\r\n    }\r\n\r\n    private sendSubscribe(contextData: ContextData): Promise<void> {\r\n        contextData.sentExplicitSubscription = true;\r\n\r\n        return this._gw3Session\r\n            .send({\r\n                type: msg.GW_MESSAGE_SUBSCRIBE_CONTEXT,\r\n                domain: \"global\",\r\n                context_id: contextData.contextId,\r\n            }).then((_) => undefined);\r\n    }\r\n\r\n    private sendUnsubscribe(contextData: ContextData): Promise<void> {\r\n        contextData.sentExplicitSubscription = false;\r\n\r\n        return this._gw3Session\r\n            .send({\r\n                type: msg.GW_MESSAGE_UNSUBSCRIBE_CONTEXT,\r\n                domain: \"global\",\r\n                context_id: contextData.contextId,\r\n            }).then((_) => undefined);\r\n    }\r\n\r\n    private calculateContextDeltaV1(from: any, to: any): ContextDelta {\r\n        const delta: ContextDelta = { added: {}, updated: {}, removed: [], reset: undefined };\r\n        if (from) {\r\n            for (const x of Object.keys(from)) {\r\n                if (Object.keys(to).indexOf(x) !== -1\r\n                    && to[x] !== null\r\n                    && !deepEqual(from[x], to[x])) {\r\n                    delta.updated[x] = to[x];\r\n                }\r\n            }\r\n        }\r\n        for (const x of Object.keys(to)) {\r\n            if (!from || (Object.keys(from).indexOf(x) === -1)) {\r\n                if (to[x] !== null) {\r\n                    delta.added[x] = to[x];\r\n                }\r\n            } else if (to[x] === null) {\r\n                delta.removed.push(x);\r\n            }\r\n        }\r\n        return delta;\r\n    }\r\n\r\n    private calculateContextDeltaV2(from: any, to: any): ContextDelta {\r\n        const delta: ContextDelta = { added: {}, updated: {}, removed: [], reset: undefined, commands: [] };\r\n\r\n        for (const x of Object.keys(to)) {\r\n            if (to[x] !== null) {\r\n                const fromX = from ? from[x] : null;\r\n                if (!deepEqual(fromX, to[x])) {\r\n                    delta.commands?.push({ type: \"set\", path: x, value: to[x] });\r\n                }\r\n            } else {\r\n                delta.commands?.push({ type: \"remove\", path: x });\r\n            }\r\n        }\r\n\r\n        return delta;\r\n    }\r\n}\r\n","import { Glue42Core } from \"../../glue\";\r\nimport { GW3Bridge } from \"./bridges/gw3/bridge\";\r\nimport { ContextBridge } from \"./contextBridge\";\r\nimport Connection from \"../connection/connection\";\r\nimport { Logger } from \"../logger/logger\";\r\nimport { ContextName, ContextSubscriptionKey } from \"./bridges/types\";\r\n\r\n/** @ignore */\r\nexport interface ContextsConfig {\r\n    connection: Connection;\r\n    logger: Logger;\r\n}\r\n\r\nexport class ContextsModule implements Glue42Core.Contexts.API {\r\n\r\n    public initTime: number | undefined;\r\n    public initStartTime: number | undefined;\r\n    public initEndTime?: number;\r\n    private _bridge: ContextBridge;\r\n\r\n    public constructor(config: ContextsConfig) {\r\n        this._bridge = new GW3Bridge(config);\r\n    }\r\n\r\n    public all(): string[] {\r\n        return this._bridge.all();\r\n    }\r\n\r\n    /**\r\n     * Updates a context with some object. The object properties will replace the context properties, any other\r\n     * context properties will remain in the context. If the context does not exists the update call will create it.\r\n     *\r\n     * @example\r\n     * // if theme does not exists creates a context called theme with initial value\r\n     * glue.contexts.update(\"theme\", {font:10, font-family:\"Arial\"})\r\n     *\r\n     * // increases font to 11, after that call context is {font:10, font-family:\"Arial\"}\r\n     * glue.contexts.update(\"theme\", {font:11})\r\n     *\r\n     * @function\r\n     * @param name Name of the context to be updated\r\n     * @param data The object that will be applied to the context\r\n     */\r\n    public update(name: ContextName, data: any): Promise<void> {\r\n        this.checkName(name);\r\n        this.checkData(data);\r\n\r\n        return this._bridge.update(name, data);\r\n    }\r\n\r\n    /**\r\n     * Replaces a context\r\n     * @function\r\n     * @param name Name of the context to be updated\r\n     * @param data The object that will be applied to the context\r\n     */\r\n    public set(name: ContextName, data: any): Promise<void> {\r\n        this.checkName(name);\r\n        this.checkData(data);\r\n\r\n        return this._bridge.set(name, data);\r\n    }\r\n\r\n    public setPath(name: ContextName, path: string, data: any): Promise<void> {\r\n        this.checkName(name);\r\n        this.checkPath(path);\r\n        const isTopLevelPath = path === \"\";\r\n\r\n        if (isTopLevelPath) {\r\n            // Check the data only in the case of a top level path as the inner props can be of type any.\r\n            this.checkData(data);\r\n\r\n            return this.set(name, data);\r\n        }\r\n\r\n        return this._bridge.setPath(name, path, data);\r\n    }\r\n\r\n    public setPaths(name: ContextName, paths: Glue42Core.Contexts.PathValue[]): Promise<void> {\r\n        this.checkName(name);\r\n\r\n        if (!Array.isArray(paths)) {\r\n            throw new Error(\"Please provide the paths as an array of PathValues!\");\r\n        }\r\n\r\n        for (const { path, value } of paths) {\r\n            this.checkPath(path);\r\n            const isTopLevelPath = path === \"\";\r\n\r\n            if (isTopLevelPath) {\r\n                // Check the value only in the case of a top level path as the inner props can be of type any.\r\n                this.checkData(value);\r\n            }\r\n        }\r\n\r\n        return this._bridge.setPaths(name, paths);\r\n    }\r\n\r\n    /**\r\n     * Subscribe for context events\r\n     *\r\n     * NB: This method publishes an initial snapshot on subscription.\r\n     * To unsubscribe from within the callback, use the unsubscribe argument\r\n     * of the callback, since the method itself may not have returned and the returned\r\n     * callback is not available in the calling code.\r\n     *\r\n     * @function\r\n     *\r\n     * @param name name of the context to subscribe for\r\n     * @param callback function that will receive updates.\r\n     * @returns Function execute the returned function to unsubscribe\r\n     */\r\n    public subscribe(\r\n        name: ContextName,\r\n        callback: (data: any, delta: any, removed: string[], unsubscribe: () => void, extraData?: any) => void): Promise<() => void> {\r\n        this.checkName(name);\r\n        if (typeof callback !== \"function\") {\r\n            throw new Error(\"Please provide the callback as a function!\");\r\n        }\r\n\r\n        return this._bridge\r\n            .subscribe(name, (data: any, delta: any, removed: string[], key: ContextSubscriptionKey, extraData?: any) => callback(data, delta, removed, () => this._bridge.unsubscribe(key), extraData))\r\n            .then((key) =>\r\n                () => {\r\n                    this._bridge.unsubscribe(key);\r\n                });\r\n\r\n    }\r\n\r\n    /**\r\n     * Return a context's data\r\n     */\r\n    public get(name: ContextName): Promise<any> {\r\n        this.checkName(name);\r\n\r\n        return this._bridge.get(name);\r\n    }\r\n\r\n    public ready(): Promise<any> {\r\n        return Promise.resolve(this);\r\n    }\r\n\r\n    public destroy(name: string): Promise<any> {\r\n        this.checkName(name);\r\n\r\n        return this._bridge.destroy(name);\r\n    }\r\n\r\n    public get setPathSupported() {\r\n        return this._bridge.setPathSupported;\r\n    }\r\n\r\n    private checkName(name: ContextName) {\r\n        if (typeof name !== \"string\" || name === \"\") {\r\n            throw new Error(\"Please provide the name as a non-empty string!\");\r\n        }\r\n    }\r\n\r\n    private checkPath(path: string) {\r\n        if (typeof path !== \"string\") {\r\n            throw new Error(\"Please provide the path as a dot delimited string!\");\r\n        }\r\n    }\r\n\r\n    // TODO: Update the typings everywhere to disallow strings, numbers, etc.\r\n    private checkData(data: any) {\r\n        // Allows null.\r\n        if (typeof data !== \"object\") {\r\n            throw new Error(\"Please provide the data as an object!\");\r\n        }\r\n    }\r\n}\r\n","export default function <T>(promise: Promise<any>, successCallback: any, errorCallback: any): Promise<T> {\r\n\r\n    if (typeof successCallback !== \"function\" && typeof errorCallback !== \"function\") {\r\n        return promise;\r\n    }\r\n\r\n    if (typeof successCallback !== \"function\") {\r\n        successCallback = () => { /* DO NOTHING */ };\r\n    } else if (typeof errorCallback !== \"function\") {\r\n        errorCallback = () => {  /* DO NOTHING */ };\r\n    }\r\n\r\n    return promise.then(successCallback, errorCallback);\r\n}\r\n","export const waitFor = async (ms: number = 0, callback: () => void) => {\r\n    await resolveAfter(ms);\r\n    callback();\r\n};\r\n\r\nfunction resolveAfter<T>(ms: number = 0, result?: T): Promise<T> {\r\n    return new Promise((resolve) => setTimeout(() => resolve(result), ms));\r\n}\r\n\r\nexport function rejectAfter<T>(ms: number = 0, promise: Promise<T>, error?: T): Promise<T> {\r\n    let timeout: any;\r\n    const clearTimeoutIfThere = () => {\r\n        if (timeout) {\r\n            clearTimeout(timeout);\r\n        }\r\n    };\r\n    promise\r\n        .then(() => {\r\n            clearTimeoutIfThere();\r\n        })\r\n        .catch(() => {\r\n            clearTimeoutIfThere();\r\n        });\r\n\r\n    return new Promise((resolve, reject) => {\r\n        timeout = setTimeout(() => reject(error), ms);\r\n    });\r\n}\r\n","/*\r\n  The AGM Client analyses server presences, collects information about their methods and allows users to invoke these methods.\r\n */\r\nimport promisify from \"../helpers/promisify\";\r\nimport { Protocol, SubscribeError, InteropSettings, SubscriptionInner } from \"../types\";\r\nimport { ClientMethodInfo, ServerInfo, ServerMethodsPair } from \"./types\";\r\nimport { Glue42Core } from \"../../../glue\";\r\nimport ClientRepository from \"./repository\";\r\nimport { UnsubscribeFunction } from \"callback-registry\";\r\nimport random from \"shortid\";\r\nimport { rejectAfter } from \"../helpers/promiseHelpers\";\r\nimport { isSubset } from \"../../contexts/helpers\";\r\nimport InvocationResult = Glue42Core.AGM.InvocationResult;\r\nimport MethodDefinition = Glue42Core.AGM.MethodDefinition;\r\nimport Method = Glue42Core.Interop.Method;\r\n\r\nexport enum InvokeStatus {\r\n    Success = 0,\r\n    Error = 1,\r\n}\r\n\r\nexport interface InvokeResultMessage {\r\n    invocationId: string;\r\n    result?: object;\r\n    instance?: Glue42Core.AGM.Instance;\r\n    status: InvokeStatus;\r\n    message: string;\r\n    error?: Error;\r\n}\r\n\r\nexport default class Client {\r\n    constructor(private protocol: Protocol, private repo: ClientRepository, private instance: Glue42Core.AGM.Instance, private configuration: InteropSettings) {\r\n        //\r\n    }\r\n\r\n    /**\r\n     * Subscribes to an AGM streaming method\r\n     */\r\n    public subscribe(method: string | Glue42Core.AGM.MethodDefinition, options: Glue42Core.AGM.SubscriptionParams, successCallback?: (subscription: Glue42Core.AGM.Subscription) => void, errorCallback?: (err: SubscribeError) => void, existingSub?: SubscriptionInner): Promise<Glue42Core.AGM.Subscription> {\r\n        // options can have arguments:{}, target: 'best'/'all'/{server_instance}, waitTimeoutMs:10000\r\n\r\n        const callProtocolSubscribe = (targetServers: ServerMethodsPair[], stream: Glue42Core.AGM.MethodDefinition, successProxy: (sub: Glue42Core.AGM.Subscription) => void, errorProxy: (err: SubscribeError) => void) => {\r\n\r\n            options.methodResponseTimeout = options.methodResponseTimeout ?? options.waitTimeoutMs;\r\n\r\n            this.protocol.client.subscribe(\r\n                stream,\r\n                options,\r\n                targetServers,\r\n                successProxy,\r\n                errorProxy,\r\n                existingSub\r\n            );\r\n        };\r\n\r\n        const promise = new Promise<Glue42Core.AGM.Subscription>((resolve, reject) => {\r\n\r\n            const successProxy = (sub: Glue42Core.AGM.Subscription) => {\r\n                resolve(sub);\r\n            };\r\n            const errorProxy = (err: SubscribeError) => {\r\n                reject(err);\r\n            };\r\n\r\n            if (!method) {\r\n                reject(`Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.`);\r\n                return;\r\n            }\r\n\r\n            let methodDef: Glue42Core.AGM.MethodDefinition;\r\n            if (typeof method === \"string\") {\r\n                methodDef = { name: method };\r\n            } else {\r\n                methodDef = method;\r\n            }\r\n\r\n            if (!methodDef.name) {\r\n                reject(`Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.`);\r\n                return;\r\n            }\r\n\r\n            if (options === undefined) {\r\n                options = {};\r\n            }\r\n            let target = options.target;\r\n            if (target === undefined) {\r\n                target = \"best\";\r\n            }\r\n            if (typeof target === \"string\" && target !== \"all\" && target !== \"best\") {\r\n                reject(new Error(`\"${target}\" is not a valid target. Valid targets are \"all\", \"best\", or an instance.`));\r\n                return;\r\n            }\r\n\r\n            if (options.methodResponseTimeout === undefined) {\r\n                // legacy support\r\n                options.methodResponseTimeout = (options as any).method_response_timeout;\r\n                if (options.methodResponseTimeout === undefined) {\r\n                    // fallback to default\r\n                    options.methodResponseTimeout = this.configuration.methodResponseTimeout;\r\n                }\r\n            }\r\n\r\n            if (options.waitTimeoutMs === undefined) {\r\n                // legacy support\r\n                options.waitTimeoutMs = (options as any).wait_for_method_timeout;\r\n                if (options.waitTimeoutMs === undefined) {\r\n                    // fallback to default\r\n                    options.waitTimeoutMs = this.configuration.waitTimeoutMs;\r\n                }\r\n            }\r\n\r\n            const delayStep = 500;\r\n            let delayTillNow = 0;\r\n\r\n            // don't check if the method is streaming or not, subscribing to non-streaming method has to invoke it\r\n\r\n            // get all servers that have method(s) matching the filter\r\n            let currentServers = this.getServerMethodsByFilterAndTarget(methodDef, target);\r\n            if (currentServers.length > 0) {\r\n                callProtocolSubscribe(currentServers, currentServers[0].methods[0], successProxy, errorProxy);\r\n            } else {\r\n                const retry = () => {\r\n                    if (!target || !(options.waitTimeoutMs)) {\r\n                        return;\r\n                    }\r\n                    delayTillNow += delayStep;\r\n                    // get all servers that have method(s) matching the filter\r\n                    currentServers = this.getServerMethodsByFilterAndTarget(methodDef, target);\r\n                    if (currentServers.length > 0) {\r\n                        const streamInfo = currentServers[0].methods[0];\r\n                        callProtocolSubscribe(currentServers, streamInfo, successProxy, errorProxy);\r\n                    } else if (delayTillNow >= options.waitTimeoutMs) {\r\n                        const def = typeof method === \"string\" ? { name: method } : method;\r\n                        callProtocolSubscribe(currentServers, def, successProxy, errorProxy);\r\n                    } else {\r\n                        setTimeout(retry, delayStep);\r\n                    }\r\n                };\r\n                setTimeout(retry, delayStep);\r\n            }\r\n        });\r\n\r\n        return promisify(promise, successCallback, errorCallback);\r\n    }\r\n\r\n    /**\r\n     * Returns all servers. If methodFilter is specified will return a list of servers\r\n     * having a method matching the filter.\r\n     */\r\n    public servers(methodFilter: Glue42Core.AGM.MethodDefinition): Glue42Core.AGM.Instance[] {\r\n        const filterCopy = methodFilter === undefined\r\n            ? undefined\r\n            : { ...methodFilter };\r\n\r\n        // We want only the announced servers\r\n        return this.getServers(filterCopy).map((serverMethodMap) => {\r\n            return serverMethodMap.server.instance;\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Returns all methods that match the given filter. If no filter specified returns all methods.\r\n     */\r\n    public methods(methodFilter: Glue42Core.AGM.MethodDefinition | string): Glue42Core.AGM.Method[] {\r\n        if (typeof methodFilter === \"string\") {\r\n            methodFilter = { name: methodFilter };\r\n        } else {\r\n            // Must not be mutated\r\n            methodFilter = { ...methodFilter };\r\n        }\r\n\r\n        return this.getMethods(methodFilter);\r\n    }\r\n\r\n    /**\r\n     * Returns all agm method registered by some server\r\n     */\r\n    public methodsForInstance(instance: Glue42Core.AGM.Instance): Glue42Core.AGM.Method[] {\r\n        return this.getMethodsForInstance(instance);\r\n    }\r\n\r\n    /**\r\n     * Called when a method is added for the first time by any application\r\n     */\r\n    public methodAdded(callback: (def: Glue42Core.AGM.Method) => void): UnsubscribeFunction {\r\n        return this.repo.onMethodAdded(callback);\r\n    }\r\n\r\n    /**\r\n     * Called when a method is removed from the last application offering it\r\n     * @function methodRemoved\r\n     * @param {MethodCallback} callback\r\n     */\r\n    public methodRemoved(callback: (def: Glue42Core.AGM.Method) => void): UnsubscribeFunction {\r\n        return this.repo.onMethodRemoved(callback);\r\n    }\r\n\r\n    /**\r\n     * Called when an application offering methods (server) is discovered\r\n     * @param {InstanceCallback} callback Callback that will be invoked with the {@link Instance} of the new sever\r\n     */\r\n    public serverAdded(callback: (instance: Glue42Core.AGM.Instance) => void): UnsubscribeFunction {\r\n        return this.repo.onServerAdded(callback);\r\n    }\r\n\r\n    /**\r\n     * Called when an app offering methods stops offering them or exits\r\n     * @param {InstanceCallback} callback Callback that will be invoked with the {@link Instance} of the removed server\r\n     */\r\n    public serverRemoved(callback: (instance: Glue42Core.AGM.Instance, reason: string) => void): UnsubscribeFunction {\r\n        return this.repo.onServerRemoved((server: Glue42Core.AGM.Instance, reason: string) => {\r\n            callback(server, reason);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Called when a method is offered by an application. This will be called for each server offering the method\r\n     * where {@link methodAdded} will be called only for the first time the method is registered.\r\n     *\r\n     * @param {ServerMethodCallback} callback\r\n     */\r\n    public serverMethodAdded(callback: (info: { server: Glue42Core.AGM.Instance, method: Glue42Core.AGM.Method }) => void): UnsubscribeFunction {\r\n        return this.repo.onServerMethodAdded((server: Glue42Core.AGM.Instance, method: ClientMethodInfo) => {\r\n            callback({ server, method });\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Called when a server stops offering a method\r\n     * @param {ServerMethodCallback} callback\r\n     */\r\n    public serverMethodRemoved(callback: (info: { server: Glue42Core.AGM.Instance, method: Glue42Core.AGM.Method }) => void): UnsubscribeFunction {\r\n        return this.repo.onServerMethodRemoved((server: Glue42Core.AGM.Instance, method: ClientMethodInfo) => {\r\n            callback({ server, method });\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Invokes an AGM method\r\n     * @param {MethodDefinition} methodFilter Method to invoke\r\n     * @param {Object} argumentObj Arguments for the invocation\r\n     * @param {Instance|Instance[]|string} [target] Defines which server(s) to target with the invocation - can be one of:\r\n     * * ’best' - executes the method on the best (or first) server\r\n     * * 'all' - executes the method on all servers offering it\r\n     * * AGM instance (or a subset, used for filtering), e.g. { application: 'appName' }\r\n     * * an array of AGM instances/filters\r\n     * @param {InvocationOptions} [additionalOptions] Additional options for the invocation\r\n     * @param {function} [success] - (use this if you prefer callback style instead of promises)\r\n     * Callback that will be called with {@link InvocationResult} object when the invocation is successful\r\n     * @param {function} [error] -  (use this if you prefer callback style instead of promises)\r\n     * Callback that will be called with {@link InvocationError} object when the invocation is not successful\r\n     * @returns {Promise<InvocationResult>}\r\n     * @example\r\n     * const result = await glue.agm.invoke(\"Sum\", { a: 37, b: 5 }); // everything else is optional\r\n     * console.log('37 + 5 = ' + result.returned.answer);\r\n     */\r\n\r\n    public async invoke(methodFilter: string | Glue42Core.AGM.MethodDefinition, argumentObj?: object, target?: Glue42Core.AGM.InstanceTarget, additionalOptions?: Glue42Core.AGM.InvokeOptions, success?: Glue42Core.AGM.InvokeSuccessHandler<any>, error?: Glue42Core.AGM.InvokeErrorHandler)\r\n        : Promise<Glue42Core.AGM.InvocationResult<any>> {\r\n        const getInvokePromise = async () => {\r\n\r\n            let methodDefinition: Glue42Core.AGM.MethodDefinition;\r\n            if (typeof methodFilter === \"string\") {\r\n                methodDefinition = { name: methodFilter };\r\n            } else {\r\n                methodDefinition = { ...methodFilter };\r\n            }\r\n\r\n            if (!methodDefinition.name) {\r\n                return Promise.reject(`Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.`);\r\n            }\r\n\r\n            if (!argumentObj) {\r\n                argumentObj = {};\r\n            }\r\n            if (!target) {\r\n                target = \"best\";\r\n            }\r\n            if (typeof target === \"string\" && target !== \"all\" && target !== \"best\" && target !== \"skipMine\") {\r\n                return Promise.reject(new Error(`\"${target}\" is not a valid target. Valid targets are \"all\" and \"best\".`));\r\n            }\r\n            if (!additionalOptions) {\r\n                additionalOptions = {};\r\n            }\r\n\r\n            if (additionalOptions.methodResponseTimeoutMs === undefined) {\r\n                // legacy support\r\n                additionalOptions.methodResponseTimeoutMs = (additionalOptions as any).method_response_timeout;\r\n                if (additionalOptions.methodResponseTimeoutMs === undefined) {\r\n                    // fallback to default\r\n                    additionalOptions.methodResponseTimeoutMs = this.configuration.methodResponseTimeout;\r\n                }\r\n            }\r\n\r\n            if (additionalOptions.waitTimeoutMs === undefined) {\r\n                // legacy support\r\n                additionalOptions.waitTimeoutMs = (additionalOptions as any).wait_for_method_timeout;\r\n                if (additionalOptions.waitTimeoutMs === undefined) {\r\n                    // fallback to default\r\n                    additionalOptions.waitTimeoutMs = this.configuration.waitTimeoutMs;\r\n                }\r\n            }\r\n\r\n            if (additionalOptions.waitTimeoutMs !== undefined && typeof additionalOptions.waitTimeoutMs !== \"number\") {\r\n                return Promise.reject(new Error(`\"${additionalOptions.waitTimeoutMs}\" is not a valid number for \"waitTimeoutMs\" `));\r\n            }\r\n\r\n            // Check if the arguments are an object\r\n            if (typeof argumentObj !== \"object\") {\r\n                return Promise.reject(new Error(`The method arguments must be an object. method: ${methodDefinition.name}`));\r\n            }\r\n\r\n            let serversMethodMap: ServerMethodsPair[] = this.getServerMethodsByFilterAndTarget(methodDefinition, target);\r\n\r\n            // Try to await them and then continue\r\n            if (serversMethodMap.length === 0) {\r\n                try {\r\n                    // because of the additionalOptions\r\n                    serversMethodMap = await this.tryToAwaitForMethods(methodDefinition, target, additionalOptions);\r\n                } catch (err) {\r\n                    const method: Glue42Core.Interop.Method = {\r\n                        ...methodDefinition,\r\n                        getServers: () => [],\r\n                        supportsStreaming: false,\r\n                        objectTypes: methodDefinition.objectTypes ?? [],\r\n                        flags: methodDefinition.flags?.metadata ?? {}\r\n                    };\r\n                    const errorObj: InvocationResult = {\r\n                        method,\r\n                        called_with: argumentObj,\r\n                        message: `Can not find a method matching ${JSON.stringify(methodFilter)} with server filter ${JSON.stringify(target)}`,\r\n                        executed_by: undefined,\r\n                        returned: undefined,\r\n                        status: undefined,\r\n                    };\r\n\r\n                    return Promise.reject(errorObj);\r\n                }\r\n            }\r\n\r\n            const timeout = additionalOptions.methodResponseTimeoutMs;\r\n            // ts be happy\r\n            const additionalOptionsCopy: Glue42Core.AGM.InvokeOptions = additionalOptions;\r\n            const invokePromises: Array<Promise<InvokeResultMessage>> = serversMethodMap.map(\r\n                (serversMethodPair) => {\r\n                    const invId = random();\r\n                    const method = serversMethodPair.methods[0];\r\n                    const server = serversMethodPair.server;\r\n                    const invokePromise = this.protocol.client.invoke(invId, method, argumentObj, server, additionalOptionsCopy);\r\n\r\n                    return Promise.race([\r\n                        invokePromise,\r\n                        rejectAfter(timeout, invokePromise, {\r\n                            invocationId: invId,\r\n                            message: `Invocation timeout (${timeout} ms) reached for method name: ${method?.name}, target instance: ${JSON.stringify(server.instance)}, options: ${JSON.stringify(additionalOptionsCopy)}`,\r\n                            status: InvokeStatus.Error,\r\n                        })\r\n                    ]);\r\n                }\r\n            );\r\n\r\n            const invocationMessages: InvokeResultMessage[] = await Promise.all(invokePromises);\r\n\r\n            const results = this.getInvocationResultObj(invocationMessages, methodDefinition, argumentObj);\r\n\r\n            const allRejected = invocationMessages.every((result) => result.status === InvokeStatus.Error);\r\n            if (allRejected) {\r\n                return Promise.reject(results);\r\n            }\r\n\r\n            return results;\r\n        };\r\n\r\n        // I would call this\r\n        return promisify(getInvokePromise(), success, error);\r\n    }\r\n\r\n    private getInvocationResultObj(invocationResults: InvokeResultMessage[], method: MethodDefinition, calledWith: object): InvocationResult<any> {\r\n        /* tslint:disable:variable-name*/\r\n        const all_return_values = invocationResults\r\n            .filter((invokeMessage) => invokeMessage.status === InvokeStatus.Success)\r\n            .reduce<InvocationResult[]>(\r\n                (allValues, currentValue) => {\r\n                    allValues = [\r\n                        ...allValues,\r\n                        {\r\n                            executed_by: currentValue.instance,\r\n                            returned: currentValue.result,\r\n                            called_with: calledWith,\r\n                            method,\r\n                            message: currentValue.message,\r\n                            status: currentValue.status,\r\n                        }\r\n                    ];\r\n\r\n                    return allValues;\r\n                }, []\r\n            );\r\n\r\n        /* tslint:disable:variable-name*/\r\n        const all_errors = invocationResults\r\n            .filter((invokeMessage) => invokeMessage.status === InvokeStatus.Error)\r\n            .reduce<object[]>((allErrors, currError) => {\r\n                allErrors = [\r\n                    ...allErrors,\r\n                    {\r\n                        executed_by: currError.instance,\r\n                        called_with: calledWith,\r\n                        name: method.name,\r\n                        message: currError.message,\r\n                    }\r\n                ];\r\n\r\n                return allErrors;\r\n            }, []);\r\n\r\n        const invResult = invocationResults[0];\r\n\r\n        const result: InvocationResult = {\r\n            method,\r\n            called_with: calledWith,\r\n            returned: invResult.result,\r\n            executed_by: invResult.instance,\r\n            all_return_values,\r\n            all_errors,\r\n            message: invResult.message,\r\n            status: invResult.status\r\n        };\r\n\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * Called when the user tries to invoke a method which does not exist\r\n     */\r\n    private tryToAwaitForMethods(methodDefinition: MethodDefinition, target: Glue42Core.AGM.InstanceTarget, additionalOptions: Glue42Core.AGM.InvokeOptions): Promise<ServerMethodsPair[]> {\r\n        return new Promise((resolve, reject) => {\r\n            if (additionalOptions.waitTimeoutMs === 0) {\r\n                reject();\r\n                return;\r\n            }\r\n\r\n            const delayStep = 500;\r\n            let delayTillNow = 0;\r\n\r\n            const retry = () => {\r\n                delayTillNow += delayStep;\r\n\r\n                // get all servers that have method(s) matching the filter\r\n                const serversMethodMap = this.getServerMethodsByFilterAndTarget(methodDefinition, target);\r\n                if (serversMethodMap.length > 0) {\r\n                    clearInterval(interval);\r\n                    resolve(serversMethodMap);\r\n                } else if (delayTillNow >= (additionalOptions.waitTimeoutMs || 10000)) {\r\n                    clearInterval(interval);\r\n                    reject();\r\n                    return;\r\n                }\r\n            };\r\n            const interval = setInterval(retry, delayStep);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Filters an array of servers and returns the ones which match the target criteria\r\n     */\r\n    private filterByTarget(target: Glue42Core.AGM.InstanceTarget, serverMethodMap: ServerMethodsPair[]): ServerMethodsPair[] {\r\n        // If the user specified target as string:\r\n        if (typeof target === \"string\") {\r\n            if (target === \"all\") {\r\n                return [...serverMethodMap];\r\n            } else if (target === \"best\") {\r\n                // Returns first app found\r\n                const localMachine = serverMethodMap\r\n                    .find((s) => s.server.instance.isLocal);\r\n\r\n                if (localMachine) {\r\n                    return [localMachine];\r\n                }\r\n\r\n                if (serverMethodMap[0] !== undefined) {\r\n                    return [serverMethodMap[0]];\r\n                }\r\n            } else if (target === \"skipMine\") {\r\n                return serverMethodMap.filter(({ server }) => server.instance.peerId !== this.instance.peerId);\r\n            }\r\n        } else {\r\n            let targetArray: Glue42Core.AGM.Instance[];\r\n            if (!Array.isArray(target)) {\r\n                targetArray = [target];\r\n            } else {\r\n                targetArray = target;\r\n            }\r\n\r\n            // Retrieve all getServers that match the filters\r\n            const allServersMatching = targetArray.reduce((matches: ServerMethodsPair[], filter) => {\r\n                // Add matches for each filter\r\n                const myMatches = serverMethodMap.filter((serverMethodPair) => {\r\n                    return this.instanceMatch(filter, serverMethodPair.server.instance);\r\n                });\r\n                return matches.concat(myMatches);\r\n            }, []);\r\n\r\n            return allServersMatching;\r\n        }\r\n        return [];\r\n    }\r\n\r\n    /**\r\n     * Matches a server definition against a server filter\r\n     */\r\n    private instanceMatch(instanceFilter: Glue42Core.AGM.Instance, instanceDefinition: Glue42Core.AGM.Instance): boolean {\r\n        return this.containsProps(instanceFilter, instanceDefinition);\r\n    }\r\n\r\n    /**\r\n     * Matches a method definition against a method filter\r\n     */\r\n    private methodMatch(methodFilter: Glue42Core.AGM.MethodDefinition, methodDefinition: Glue42Core.AGM.MethodDefinition): boolean {\r\n        return this.containsProps(methodFilter, methodDefinition);\r\n    }\r\n\r\n    /**\r\n     * Checks if all properties of filter match properties in object\r\n     */\r\n    private containsProps(filter: any, repoMethod: any): boolean {\r\n        const filterProps = Object.keys(filter)\r\n            .filter((prop) => {\r\n                return filter[prop] !== undefined\r\n                    && typeof filter[prop] !== \"function\"\r\n                    && prop !== \"object_types\"\r\n                    && prop !== \"display_name\"\r\n                    && prop !== \"id\"\r\n                    && prop !== \"gatewayId\"\r\n                    && prop !== \"identifier\"\r\n                    && prop[0] !== \"_\";\r\n            });\r\n\r\n        return filterProps.every((prop) => {\r\n            let isMatch;\r\n\r\n            const filterValue = filter[prop];\r\n            const repoMethodValue = repoMethod[prop];\r\n\r\n            switch (prop) {\r\n                case \"objectTypes\":\r\n                    // filterValue needs to be a subset of repoMethodValue.\r\n                    isMatch = ((filterValue || []) as string[]).every((filterValueEl) => {\r\n                        return ((repoMethodValue || []) as string[]).includes(filterValueEl);\r\n                    });\r\n                    break;\r\n                case \"flags\":\r\n                    // filterValue needs to be a subset of repoMethodValue.\r\n                    isMatch = isSubset(repoMethodValue || {}, filterValue || {});\r\n                    break;\r\n                default:\r\n                    isMatch = String(filterValue).toLowerCase() === String(repoMethodValue).toLowerCase();\r\n            }\r\n\r\n            return isMatch;\r\n        });\r\n    }\r\n\r\n    private getMethods(methodFilter: Glue42Core.AGM.MethodDefinition): ClientMethodInfo[] {\r\n        if (methodFilter === undefined) {\r\n            return this.repo.getMethods();\r\n        }\r\n\r\n        const methods = this.repo.getMethods().filter((method) => {\r\n            return this.methodMatch(methodFilter, method);\r\n        });\r\n\r\n        return methods;\r\n    }\r\n\r\n    private getMethodsForInstance(instanceFilter: Glue42Core.AGM.Instance): ClientMethodInfo[] {\r\n        const allServers: ServerInfo[] = this.repo.getServers();\r\n\r\n        const matchingServers = allServers.filter((server) => {\r\n            return this.instanceMatch(instanceFilter, server.instance);\r\n        });\r\n\r\n        if (matchingServers.length === 0) {\r\n            return [];\r\n        }\r\n\r\n        let resultMethodsObject: { [key: string]: ClientMethodInfo } = {};\r\n\r\n        if (matchingServers.length === 1) {\r\n            resultMethodsObject = matchingServers[0].methods;\r\n        } else {\r\n            // we have more than one server matching, join all methods\r\n            matchingServers.forEach((server) => {\r\n                Object.keys(server.methods).forEach((methodKey) => {\r\n                    const method = server.methods[methodKey];\r\n                    // group by method identifier\r\n                    resultMethodsObject[method.identifier] = method;\r\n                });\r\n            });\r\n        }\r\n\r\n        // transform the object to array\r\n        return Object.keys(resultMethodsObject)\r\n            .map((key) => {\r\n                return resultMethodsObject[key];\r\n            });\r\n    }\r\n\r\n    private getServers(methodFilter?: Glue42Core.AGM.MethodDefinition): ServerMethodsPair[] {\r\n        const servers = this.repo.getServers();\r\n\r\n        // No method - get all getServers\r\n        if (methodFilter === undefined) {\r\n            return servers.map((server) => {\r\n                return { server, methods: [] };\r\n            });\r\n        }\r\n\r\n        // // Non-existing method - return an empty array\r\n        // const methods = this.getMethods(methodFilter);\r\n        // if (methods === undefined) {\r\n        //     return [];\r\n        // }\r\n\r\n        return servers.reduce<ServerMethodsPair[]>((prev, current) => {\r\n\r\n            const methodsForServer = Object.values(current.methods);\r\n\r\n            const matchingMethods = methodsForServer.filter((method) => {\r\n                return this.methodMatch(methodFilter, method);\r\n            });\r\n\r\n            if (matchingMethods.length > 0) {\r\n                prev.push({ server: current, methods: matchingMethods });\r\n            }\r\n\r\n            return prev;\r\n        }, []);\r\n    }\r\n\r\n    /**\r\n     * Returns an array of server-methods pairs for all servers that match the target and have at lease one method matching the method filter\r\n     */\r\n    private getServerMethodsByFilterAndTarget(methodFilter: Glue42Core.AGM.MethodDefinition, target: Glue42Core.AGM.InstanceTarget): ServerMethodsPair[] {\r\n        // get all servers that have method(s) matching the filter\r\n        const serversMethodMap = this.getServers(methodFilter);\r\n        // filter the server-method map by target\r\n        return this.filterByTarget(target, serversMethodMap);\r\n    }\r\n\r\n}\r\n","import { Protocol } from \"../types\";\r\nimport { Glue42Core } from \"../../../glue\";\r\n\r\nimport { WrappedCallbackFunction, ResultContext, ServerMethodInfo, ServerSubscriptionInfo } from \"./types\";\r\n\r\nexport default class ServerSubscription implements Glue42Core.AGM.StreamSubscription {\r\n\r\n    constructor(private protocol: Protocol, private repoMethod: ServerMethodInfo, private subscription: ServerSubscriptionInfo) {\r\n    }\r\n\r\n    public get stream(): Glue42Core.AGM.Stream {\r\n        if (!this.repoMethod.stream) {\r\n            throw new Error(\"no stream\");\r\n        }\r\n        return this.repoMethod.stream;\r\n    }\r\n    public get arguments() { return this.subscription.arguments || {}; }\r\n    public get branchKey(): string { return this.subscription.branchKey; }\r\n    public get instance(): Glue42Core.AGM.Instance {\r\n        if (!this.subscription.instance) {\r\n            throw new Error(\"no instance\");\r\n        }\r\n        return this.subscription.instance;\r\n    }\r\n\r\n    public close() {\r\n        this.protocol.server.closeSingleSubscription(this.repoMethod, this.subscription);\r\n    }\r\n\r\n    public push(data: object) {\r\n        this.protocol.server.pushDataToSingle(this.repoMethod, this.subscription, data);\r\n    }\r\n}\r\n","import { Protocol } from \"../types\";\r\nimport { Glue42Core } from \"../../../glue\";\r\nimport { ServerMethodInfo, RequestContext } from \"./types\";\r\n\r\nexport default class Request implements Glue42Core.AGM.SubscriptionRequest {\r\n    public arguments: object;\r\n    public instance: Glue42Core.AGM.Instance;\r\n\r\n    constructor(private protocol: Protocol, private repoMethod: ServerMethodInfo, private requestContext: RequestContext) {\r\n        this.arguments = requestContext.arguments;\r\n        this.instance = requestContext.instance;\r\n    }\r\n\r\n    public accept() {\r\n        this.protocol.server.acceptRequestOnBranch(this.requestContext, this.repoMethod, \"\");\r\n    }\r\n\r\n    public acceptOnBranch(branch: string) {\r\n        this.protocol.server.acceptRequestOnBranch(this.requestContext, this.repoMethod, branch);\r\n    }\r\n\r\n    public reject(reason: string) {\r\n        this.protocol.server.rejectRequest(this.requestContext, this.repoMethod, reason);\r\n    }\r\n}\r\n","import { Protocol } from \"../types\";\r\nimport { ServerMethodInfo, RequestContext, ServerSubscriptionInfo } from \"./types\";\r\nimport ServerSubscription from \"./subscription\";\r\nimport Server from \"./server\";\r\nimport Request from \"./request\";\r\n\r\n/*\r\n The streaming module defines the user objects relevant to the streaming api, and\r\n attaches to relevant events exposed by the protocol.\r\n */\r\nexport default class ServerStreaming {\r\n    constructor(public protocol: Protocol, private server: Server) {\r\n\r\n        /** Attach to stream 'events' */\r\n        protocol.server.onSubRequest((rc, rm) => this.handleSubRequest(rc, rm));\r\n\r\n        protocol.server.onSubAdded((sub, rm) => this.handleSubAdded(sub, rm));\r\n\r\n        protocol.server.onSubRemoved((sub, rm) => this.handleSubRemoved(sub, rm));\r\n    }\r\n\r\n    private handleSubRequest(requestContext: RequestContext, repoMethod: ServerMethodInfo) {\r\n\r\n        if (!(repoMethod &&\r\n            repoMethod.streamCallbacks &&\r\n            typeof repoMethod.streamCallbacks.subscriptionRequestHandler === \"function\")) {\r\n            return;\r\n        }\r\n\r\n        const request = new Request(this.protocol, repoMethod, requestContext);\r\n        repoMethod.streamCallbacks.subscriptionRequestHandler(request);\r\n    }\r\n\r\n    private handleSubAdded(subscription: ServerSubscriptionInfo, repoMethod: ServerMethodInfo) {\r\n        if (!(repoMethod &&\r\n            repoMethod.streamCallbacks &&\r\n            typeof repoMethod.streamCallbacks.subscriptionAddedHandler === \"function\")) {\r\n            return;\r\n        }\r\n\r\n        const sub = new ServerSubscription(this.protocol, repoMethod, subscription);\r\n        repoMethod.streamCallbacks.subscriptionAddedHandler(sub);\r\n    }\r\n\r\n    private handleSubRemoved(subscription: ServerSubscriptionInfo, repoMethod: ServerMethodInfo) {\r\n        if (!(repoMethod &&\r\n            repoMethod.streamCallbacks &&\r\n            typeof repoMethod.streamCallbacks.subscriptionRemovedHandler === \"function\")) {\r\n            return;\r\n        }\r\n\r\n        const sub = new ServerSubscription(this.protocol, repoMethod, subscription);\r\n        repoMethod.streamCallbacks.subscriptionRemovedHandler(sub);\r\n    }\r\n}\r\n","import { Protocol } from \"../types\";\r\nimport { Glue42Core } from \"../../../glue\";\r\nimport ServerSubscription from \"./subscription\";\r\nimport { ServerMethodInfo } from \"./types\";\r\n\r\nexport default class ServerBranch implements Glue42Core.AGM.StreamBranch {\r\n\r\n    constructor(public key: string, private protocol: Protocol, private repoMethod: ServerMethodInfo) {\r\n    }\r\n\r\n    public subscriptions() {\r\n        const subList = this.protocol.server.getSubscriptionList(this.repoMethod, this.key);\r\n        return subList.map((sub) => {\r\n            return new ServerSubscription(this.protocol, this.repoMethod, sub);\r\n        });\r\n    }\r\n\r\n    public close() {\r\n        this.protocol.server.closeAllSubscriptions(this.repoMethod, this.key);\r\n    }\r\n\r\n    public push(data: object) {\r\n        this.protocol.server.pushData(this.repoMethod, data, [this.key]);\r\n    }\r\n}\r\n","import { Glue42Core } from \"../../../glue\";\r\nimport { Protocol } from \"../types\";\r\nimport { ServerMethodInfo } from \"./types\";\r\nimport ServerSubscription from \"./subscription\";\r\nimport ServerBranch from \"./branch\";\r\nimport Server from \"./server\";\r\n\r\nexport default class ServerStream implements Glue42Core.AGM.Stream {\r\n    public readonly name: string;\r\n\r\n    constructor(private _protocol: Protocol, private _repoMethod: ServerMethodInfo, private _server: Server) {\r\n        this.name = this._repoMethod.definition.name;\r\n    }\r\n\r\n    public branches(): Glue42Core.AGM.StreamBranch[];\r\n    public branches(key: string): Glue42Core.AGM.StreamBranch | undefined;\r\n    public branches(key?: string): Glue42Core.AGM.StreamBranch[] | Glue42Core.AGM.StreamBranch | undefined {\r\n        const bList: string[] = this._protocol.server.getBranchList(this._repoMethod);\r\n        if (key) {\r\n            if (bList.indexOf(key) > -1) {\r\n                return new ServerBranch(key, this._protocol, this._repoMethod);\r\n            }\r\n            return undefined;\r\n\r\n        } else {\r\n            return bList.map((branchKey: string) => {\r\n                return new ServerBranch(branchKey, this._protocol, this._repoMethod);\r\n            });\r\n        }\r\n    }\r\n\r\n    public branch(key: string) {\r\n        return this.branches(key);\r\n    }\r\n\r\n    public subscriptions(): Glue42Core.AGM.StreamSubscription[] {\r\n        const subList = this._protocol.server.getSubscriptionList(this._repoMethod);\r\n        return subList.map((sub) => {\r\n            return new ServerSubscription(this._protocol, this._repoMethod, sub);\r\n        });\r\n    }\r\n\r\n    public get definition(): Glue42Core.AGM.MethodDefinition {\r\n        const def2 = this._repoMethod.definition;\r\n        return {\r\n            accepts: def2.accepts,\r\n            description: def2.description,\r\n            displayName: def2.displayName,\r\n            name: def2.name,\r\n            objectTypes: def2.objectTypes,\r\n            returns: def2.returns,\r\n            supportsStreaming: def2.supportsStreaming,\r\n            flags: def2.flags?.metadata,\r\n        };\r\n    }\r\n\r\n    public close() {\r\n        this._protocol.server.closeAllSubscriptions(this._repoMethod);\r\n        this._server.unregister(this._repoMethod.definition, true);\r\n    }\r\n\r\n    public push(data: object, branches: string[]) {\r\n        if (typeof branches !== \"string\" && !Array.isArray(branches) && branches !== undefined) {\r\n            throw new Error(\"invalid branches should be string or string array\");\r\n        }\r\n        // TODO validate if is plain object\r\n        if (typeof data !== \"object\") {\r\n            throw new Error(\"Invalid arguments. Data must be an object.\");\r\n        }\r\n        this._protocol.server.pushData(this._repoMethod, data, branches);\r\n    }\r\n\r\n    public updateRepoMethod(repoMethod: ServerMethodInfo) {\r\n        this._repoMethod = repoMethod;\r\n    }\r\n}\r\n","import promisify from \"../helpers/promisify\";\r\nimport ServerStreaming from \"./streaming\";\r\nimport { Protocol, InteropSettings } from \"../types\";\r\nimport ServerRepository from \"./repository\";\r\nimport { Glue42Core } from \"../../../glue\";\r\nimport { WrappedCallbackFunction, ResultContext, ServerMethodInfo } from \"./types\";\r\nimport ServerStream from \"./stream\";\r\n\r\n/*\r\n The AGM Server allows users register AGM methods.\r\n It exposes these methods to AGM clients (using presence messages) and listens for their invocation\r\n */\r\nexport default class Server {\r\n    private streaming: ServerStreaming;\r\n    private invocations: number = 0;\r\n    private currentlyUnregistering: { [method: string]: Promise<void> } = {};\r\n\r\n    constructor(private protocol: Protocol, private serverRepository: ServerRepository) {\r\n        // An array of the server's methods\r\n        this.streaming = new ServerStreaming(protocol, this);\r\n\r\n        this.protocol.server.onInvoked(this.onMethodInvoked.bind(this));\r\n    }\r\n\r\n    // Registers a new streaming agm method\r\n    public createStream(streamDef: string | Glue42Core.AGM.MethodDefinition, callbacks?: Glue42Core.AGM.StreamOptions, successCallback?: (args?: object) => void, errorCallback?: (error?: string | object) => void, existingStream?: ServerStream): Promise<Glue42Core.AGM.Stream> {\r\n        // in callbacks we have subscriptionRequestHandler, subscriptionAddedHandler, subscriptionRemovedHandler\r\n        const promise = new Promise((resolve, reject) => {\r\n            if (!streamDef) {\r\n                reject(`The stream name must be unique! Please, provide either a unique string for a stream name to “glue.interop.createStream()” or a “methodDefinition” object with a unique “name” property for the stream.`);\r\n                return;\r\n            }\r\n\r\n            // transform to a definition\r\n            let streamMethodDefinition: Glue42Core.AGM.MethodDefinition;\r\n\r\n            // This is important because if you change the name for example this will change here as well and it shouldn't change by reference\r\n            if (typeof streamDef === \"string\") {\r\n                streamMethodDefinition = { name: \"\" + streamDef };\r\n            } else {\r\n                streamMethodDefinition = { ...streamDef };\r\n            }\r\n\r\n            if (!streamMethodDefinition.name) {\r\n                return reject(`The “name” property is required for the “streamDefinition” object and must be unique. Stream definition: ${JSON.stringify(streamMethodDefinition)}`);\r\n            }\r\n\r\n            const nameAlreadyExists = this.serverRepository.getList()\r\n                .some((serverMethod) => serverMethod.definition.name === streamMethodDefinition.name);\r\n\r\n            if (nameAlreadyExists) {\r\n                return reject(`A stream with the name \"${streamMethodDefinition.name}\" already exists! Please, provide a unique name for the stream.`);\r\n            }\r\n\r\n            streamMethodDefinition.supportsStreaming = true;\r\n\r\n            // User-supplied subscription callbacks\r\n            if (!callbacks) {\r\n                callbacks = {};\r\n            }\r\n\r\n            if (typeof callbacks.subscriptionRequestHandler !== \"function\") {\r\n                callbacks.subscriptionRequestHandler = (request: Glue42Core.AGM.SubscriptionRequest) => {\r\n                    request.accept();\r\n                };\r\n            }\r\n            // Add the method\r\n            const repoMethod = this.serverRepository.add({\r\n                definition: streamMethodDefinition, // store un-formatted definition for checkups in un-register method\r\n                streamCallbacks: callbacks,\r\n                protocolState: {},\r\n            });\r\n\r\n            this.protocol.server.createStream(repoMethod)\r\n                .then(() => {\r\n                    let streamUserObject: ServerStream;\r\n                    if (existingStream) {\r\n                        streamUserObject = existingStream;\r\n                        existingStream.updateRepoMethod(repoMethod);\r\n                    } else {\r\n                        streamUserObject = new ServerStream(this.protocol, repoMethod, this);\r\n                    }\r\n                    repoMethod.stream = streamUserObject;\r\n                    resolve(streamUserObject);\r\n                })\r\n                .catch((err) => {\r\n                    if (repoMethod.repoId) {\r\n                        this.serverRepository.remove(repoMethod.repoId);\r\n                    }\r\n                    reject(err);\r\n                });\r\n        });\r\n\r\n        return promisify(promise, successCallback, errorCallback);\r\n    }\r\n\r\n    /**\r\n     * Registers a new agm method\r\n     * @param {MethodDefinition} methodDefinition\r\n     * @param {MethodHandler} callback Callback that will be called when the AGM server is invoked\r\n     */\r\n\r\n    public register(methodDefinition: string | Glue42Core.AGM.MethodDefinition, callback: (args: object, caller: Glue42Core.AGM.Instance) => object | Promise<object>): Promise<void> {\r\n        if (!methodDefinition) {\r\n            return Promise.reject(`Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.`);\r\n        }\r\n\r\n        if (typeof callback !== \"function\") {\r\n            return Promise.reject(`The second parameter must be a callback function. Method: ${typeof methodDefinition === \"string\" ? methodDefinition : methodDefinition.name}`);\r\n        }\r\n\r\n        const wrappedCallbackFunction: WrappedCallbackFunction = async (context: ResultContext, resultCallback: (err: string | undefined, result: object) => void) => {\r\n            // get the result as direct invocation of the callback and return it using resultCallback\r\n            try {\r\n                const result = callback(context.args, context.instance);\r\n                if (result && typeof (result as any).then === \"function\") {\r\n                    const resultValue = await result;\r\n                    resultCallback(undefined, resultValue);\r\n                } else {\r\n                    resultCallback(undefined, result);\r\n                }\r\n            } catch (e) {\r\n                if (!e) {\r\n                    e = \"\";\r\n                }\r\n                resultCallback(e, e);\r\n            }\r\n        };\r\n\r\n        wrappedCallbackFunction.userCallback = callback;\r\n\r\n        return this.registerCore(methodDefinition, wrappedCallbackFunction);\r\n    }\r\n\r\n    // registers a new async agm method (the result can be returned in async way)\r\n    public registerAsync(methodDefinition: string | Glue42Core.AGM.MethodDefinition, callback: (args: object, caller: Glue42Core.AGM.Instance, successCallback: (args?: object) => void, errorCallback: (error?: string | object) => void) => Promise<object> | void): Promise<void> {\r\n        if (!methodDefinition) {\r\n            return Promise.reject(`Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.`);\r\n        }\r\n\r\n        if (typeof callback !== \"function\") {\r\n            return Promise.reject(`The second parameter must be a callback function. Method: ${typeof methodDefinition === \"string\" ? methodDefinition : methodDefinition.name}`);\r\n        }\r\n\r\n        const wrappedCallback: WrappedCallbackFunction = (context: ResultContext, resultCallback: (err: string | undefined, result: object | undefined) => void) => {\r\n            // invoke the callback passing success and error callbacks\r\n            try {\r\n                let resultCalled = false;\r\n                const success = (result?: object) => {\r\n                    if (!resultCalled) {\r\n                        resultCallback(undefined, result);\r\n                    }\r\n                    resultCalled = true;\r\n                };\r\n                const error = (e: any) => {\r\n                    if (!resultCalled) {\r\n                        if (!e) {\r\n                            e = \"\";\r\n                        }\r\n                        resultCallback(e, e);\r\n                    }\r\n                    resultCalled = true;\r\n                };\r\n\r\n                const methodResult = callback(context.args,\r\n                    context.instance,\r\n                    success,\r\n                    error\r\n                );\r\n\r\n                if (methodResult && typeof methodResult.then === \"function\") {\r\n                    methodResult\r\n                        .then(success)\r\n                        .catch(error);\r\n                }\r\n            } catch (e) {\r\n                resultCallback(e, undefined);\r\n            }\r\n        };\r\n        wrappedCallback.userCallbackAsync = callback;\r\n\r\n        return this.registerCore(methodDefinition, wrappedCallback);\r\n    }\r\n\r\n    // Unregisters a previously registered AGM method\r\n    public async unregister(methodFilter: string | Glue42Core.AGM.MethodDefinition, forStream: boolean = false): Promise<void> {\r\n        if (methodFilter === undefined) {\r\n            return Promise.reject(`Please, provide either a unique string for a name or an object containing a “name” property.`);\r\n        }\r\n\r\n        // WHEN A FUNCTION IS PASSED\r\n        if (typeof methodFilter === \"function\") {\r\n            await this.unregisterWithPredicate(methodFilter, forStream);\r\n            return;\r\n        }\r\n\r\n        // WHEN string / object is passed\r\n        let methodDefinition: Glue42Core.AGM.MethodDefinition;\r\n        if (typeof methodFilter === \"string\") {\r\n            methodDefinition = { name: methodFilter };\r\n        } else {\r\n            methodDefinition = methodFilter;\r\n        }\r\n\r\n        if (methodDefinition.name === undefined) {\r\n            return Promise.reject(`Method name is required. Cannot find a method if the method name is undefined!`);\r\n        }\r\n\r\n        const methodToBeRemoved: ServerMethodInfo | undefined = this.serverRepository.getList().find((serverMethod) => {\r\n            return serverMethod.definition.name === methodDefinition.name\r\n                && (serverMethod.definition.supportsStreaming || false) === forStream;\r\n            // return this.containsProps(methodFilter, method.definition);\r\n        });\r\n\r\n        if (!methodToBeRemoved) {\r\n            return Promise.reject(`Method with a name \"${methodDefinition.name}\" does not exist or is not registered by your application!`);\r\n        }\r\n\r\n        await this.removeMethodsOrStreams([methodToBeRemoved]);\r\n    }\r\n\r\n    private async unregisterWithPredicate(filterPredicate: (methodDefinition: Glue42Core.AGM.MethodDefinition) => ServerMethodInfo, forStream?: boolean) {\r\n        const methodsOrStreamsToRemove = this.serverRepository.getList()\r\n            .filter((sm) => filterPredicate(sm.definition))\r\n            .filter((serverMethod) =>\r\n                // because both can be undefined or false\r\n                (serverMethod.definition.supportsStreaming || false) === forStream\r\n            );\r\n\r\n        if (!methodsOrStreamsToRemove || methodsOrStreamsToRemove.length === 0) {\r\n            return Promise.reject(`Could not find a ${forStream ? \"stream\" : \"method\"} matching the specified condition!`);\r\n        }\r\n\r\n        await this.removeMethodsOrStreams(methodsOrStreamsToRemove);\r\n    }\r\n\r\n    private removeMethodsOrStreams(methodsToRemove: ServerMethodInfo[]) {\r\n        const methodUnregPromises: Array<Promise<void>> = [];\r\n\r\n        methodsToRemove.forEach((method) => {\r\n            const promise = this.protocol.server.unregister(method)\r\n                .then(() => {\r\n                    if (method.repoId) {\r\n                        this.serverRepository.remove(method.repoId);\r\n                    }\r\n                });\r\n\r\n            methodUnregPromises.push(promise);\r\n            this.addAsCurrentlyUnregistering(method.definition.name, promise);\r\n        });\r\n\r\n        return Promise.all(methodUnregPromises);\r\n    }\r\n\r\n    private async addAsCurrentlyUnregistering(methodName: string, promise: Promise<void>) {\r\n        const timeout = new Promise((resolve) => setTimeout(resolve, 5000));\r\n\r\n        // will be cleared when promise resolved\r\n        this.currentlyUnregistering[methodName] = Promise.race([promise, timeout]).then(() => {\r\n            delete this.currentlyUnregistering[methodName];\r\n        });\r\n    }\r\n\r\n    // Core method for registering agm method\r\n    private async registerCore(method: string | Glue42Core.AGM.MethodDefinition, theFunction: WrappedCallbackFunction): Promise<void> {\r\n        // transform to a definition\r\n        let methodDefinition: Glue42Core.AGM.MethodDefinition;\r\n\r\n        // This is important because if you change the name for example this will change here as well and it shouldn't change by reference\r\n        if (typeof method === \"string\") {\r\n            methodDefinition = { name: \"\" + method };\r\n        } else {\r\n            methodDefinition = { ...method };\r\n        }\r\n\r\n        if (!methodDefinition.name) {\r\n            return Promise.reject(`Please, provide a (unique) string value for the “name” property in the “methodDefinition” object: ${JSON.stringify(method)}`);\r\n        }\r\n\r\n        const unregisterInProgress = this.currentlyUnregistering[methodDefinition.name];\r\n        if (unregisterInProgress) {\r\n            await unregisterInProgress;\r\n        }\r\n\r\n        const nameAlreadyExists = this.serverRepository.getList()\r\n            .some((serverMethod) => serverMethod.definition.name === methodDefinition.name);\r\n\r\n        if (nameAlreadyExists) {\r\n            return Promise.reject(`A method with the name \"${methodDefinition.name}\" already exists! Please, provide a unique name for the method.`);\r\n        }\r\n\r\n        if (methodDefinition.supportsStreaming) {\r\n            return Promise.reject(`When you create methods with “glue.interop.register()” or “glue.interop.registerAsync()” the property “supportsStreaming” cannot be “true”. If you want “${methodDefinition.name}” to be a stream, please use the “glue.interop.createStream()” method.`);\r\n        }\r\n\r\n        // Add the method ()\r\n        const repoMethod = this.serverRepository.add({\r\n            definition: methodDefinition, // store un-formatted definition for checkups in un-register method\r\n            theFunction,\r\n            protocolState: {},\r\n        });\r\n\r\n        // make it then .catch for those error/success callbacks\r\n        return this.protocol.server.register(repoMethod)\r\n            .catch((err: any) => {\r\n                if (repoMethod?.repoId) {\r\n                    this.serverRepository.remove(repoMethod.repoId);\r\n                }\r\n                throw err;\r\n            });\r\n    }\r\n\r\n    private onMethodInvoked(methodToExecute: ServerMethodInfo, invocationId: string, invocationArgs: ResultContext) {\r\n        if (!methodToExecute || !methodToExecute.theFunction) {\r\n            return;\r\n        }\r\n\r\n        // Execute it and save the result\r\n        methodToExecute.theFunction(invocationArgs, (err: any, result) => {\r\n            if (err !== undefined && err !== null) {\r\n                // handle error case\r\n                if (err.message && typeof err.message === \"string\") {\r\n                    err = err.message;\r\n                } else if (typeof err !== \"string\") {\r\n                    try {\r\n                        err = JSON.stringify(err);\r\n                    } catch (unStrException) {\r\n                        err = `un-stringifyable error in onMethodInvoked! Top level prop names: ${Object.keys(err)}`;\r\n                    }\r\n                }\r\n            }\r\n\r\n            if (!result) {\r\n                result = {};\r\n            } else if (typeof result !== \"object\" || Array.isArray(result)) {\r\n                // The AGM library only transfers objects. If the result is not an object, put it in one\r\n                result = { _value: result };\r\n            }\r\n\r\n            this.protocol.server.methodInvocationResult(methodToExecute, invocationId, err, result);\r\n        });\r\n    }\r\n}\r\n","import generate from \"shortid\";\r\nimport { Glue42Core } from \"./../../glue\";\r\n\r\nexport class InstanceWrapper {\r\n    private wrapped: Glue42Core.Interop.Instance = {};\r\n\r\n    constructor(API: Glue42Core.AGM.API, instance?: Glue42Core.AGM.Instance, connection?: Glue42Core.Connection.API) {\r\n        this.wrapped.getMethods = function (): Glue42Core.Interop.Method[] {\r\n            return API.methodsForInstance(this);\r\n        };\r\n        this.wrapped.getStreams = function (): Glue42Core.Interop.Method[] {\r\n            return API.methodsForInstance(this).filter((m) => m.supportsStreaming);\r\n        };\r\n\r\n        if (instance) {\r\n            this.refreshWrappedObject(instance);\r\n        }\r\n        if (connection) {\r\n            connection.loggedIn(() => {\r\n                this.refresh(connection);\r\n            });\r\n            this.refresh(connection);\r\n        }\r\n    }\r\n\r\n    public unwrap(): Glue42Core.Interop.Instance {\r\n        return this.wrapped;\r\n    }\r\n\r\n    private refresh(connection: Glue42Core.Connection.API) {\r\n        if (!connection) {\r\n            return;\r\n        }\r\n\r\n        // Apply resolved identity (GW3 case)\r\n        const resolvedIdentity = connection?.resolvedIdentity;\r\n        const instance = Object.assign({}, resolvedIdentity ?? {}, { peerId: connection?.peerId });\r\n        this.refreshWrappedObject(instance);\r\n    }\r\n\r\n    private refreshWrappedObject(resolvedIdentity: Glue42Core.Interop.Instance) {\r\n        this.wrapped.user = resolvedIdentity.user;\r\n        this.wrapped.instance = resolvedIdentity.instance;\r\n        this.wrapped.application = resolvedIdentity.application ?? generate();\r\n        this.wrapped.applicationName = resolvedIdentity.applicationName;\r\n        this.wrapped.pid = resolvedIdentity.pid ?? (resolvedIdentity as any).process ?? Math.floor(Math.random() * 10000000000);\r\n        this.wrapped.machine = resolvedIdentity.machine;\r\n        this.wrapped.environment = resolvedIdentity.environment;\r\n        this.wrapped.region = resolvedIdentity.region;\r\n        this.wrapped.windowId = resolvedIdentity.windowId;\r\n        this.wrapped.isLocal = resolvedIdentity.isLocal ?? true;\r\n        this.wrapped.api = resolvedIdentity.api;\r\n        this.wrapped.service = resolvedIdentity.service;\r\n        this.wrapped.peerId = resolvedIdentity.peerId;\r\n    }\r\n}\r\n","/*\r\n * Repository holding servers and methods visible by this peer including those created by the peer itself.\r\n */\r\nimport { default as CallbackRegistryFactory, UnsubscribeFunction } from \"callback-registry\";\r\nimport { Glue42Core } from \"../../../glue\";\r\nimport { ClientMethodInfo, ServerInfo } from \"./types\";\r\nimport { MethodInfoMessage } from \"../protocols/gw3/messages\";\r\nimport { Logger } from \"../../logger/logger\";\r\nimport { InstanceWrapper } from \"../instance\";\r\nimport Client from \"./client\";\r\n\r\nconst hideMethodSystemFlags = (method: ClientMethodInfo): ClientMethodInfo => {\r\n    return {\r\n        ...method,\r\n        flags: method.flags.metadata || {}\r\n    };\r\n};\r\n\r\nexport default class ClientRepository {\r\n\r\n    // each server has format {id:'', info:{}, methods:{}}\r\n    // where methods has format {id:'', info:{}}\r\n    private servers: { [id: string]: ServerInfo } = {};\r\n    private myServer: ServerInfo;\r\n\r\n    // object keyed by method identifier - value is number of servers that offer that method\r\n    private methodsCount: { [id: string]: number } = {};\r\n\r\n    // store for callbacks\r\n    private callbacks = CallbackRegistryFactory();\r\n\r\n    constructor(private logger: Logger, private API: Glue42Core.AGM.API & { unwrappedInstance: InstanceWrapper }) {\r\n        const peerId = this.API.instance.peerId as string;\r\n        this.myServer = {\r\n            id: peerId,\r\n            methods: {},\r\n            instance: this.API.instance,\r\n            wrapper: this.API.unwrappedInstance,\r\n        };\r\n        this.servers[peerId] = this.myServer;\r\n    }\r\n\r\n    // add a new server to internal collection\r\n    public addServer(info: Glue42Core.AGM.Instance, serverId: string): string {\r\n        this.logger.debug(`adding server ${serverId}`);\r\n\r\n        const current = this.servers[serverId];\r\n        if (current) {\r\n            return current.id;\r\n        }\r\n\r\n        const wrapper = new InstanceWrapper(this.API, info);\r\n        const serverEntry: ServerInfo = {\r\n            id: serverId,\r\n            methods: {},\r\n            instance: wrapper.unwrap(),\r\n            wrapper,\r\n        };\r\n\r\n        this.servers[serverId] = serverEntry;\r\n        this.callbacks.execute(\"onServerAdded\", serverEntry.instance);\r\n        return serverId;\r\n    }\r\n\r\n    public removeServerById(id: string, reason?: string) {\r\n        const server = this.servers[id];\r\n        if (!server) {\r\n            // tslint:disable-next-line:no-console\r\n            this.logger.warn(`not aware of server ${id}, my state ${JSON.stringify(Object.keys(this.servers))}`);\r\n            return;\r\n        } else {\r\n            // tslint:disable-next-line:no-console\r\n            this.logger.debug(`removing server ${id}`);\r\n        }\r\n\r\n        Object.keys(server.methods).forEach((methodId) => {\r\n            this.removeServerMethod(id, methodId);\r\n        });\r\n\r\n        delete this.servers[id];\r\n        this.callbacks.execute(\"onServerRemoved\", server.instance, reason);\r\n    }\r\n\r\n    public addServerMethod(serverId: string, method: MethodInfoMessage) {\r\n\r\n        const server = this.servers[serverId];\r\n        if (!server) {\r\n            throw new Error(\"server does not exists\");\r\n        }\r\n\r\n        // server already has that method\r\n        if (server.methods[method.id]) {\r\n            return;\r\n        }\r\n\r\n        const identifier = this.createMethodIdentifier(method);\r\n        const that = this;\r\n        const methodDefinition: ClientMethodInfo = {\r\n            identifier,\r\n            gatewayId: method.id,\r\n            name: method.name,\r\n            displayName: method.display_name,\r\n            description: method.description,\r\n            version: method.version,\r\n            objectTypes: method.object_types || [],\r\n            accepts: method.input_signature,\r\n            returns: method.result_signature,\r\n            supportsStreaming: typeof method.flags !== \"undefined\" ? method.flags.streaming : false,\r\n            flags: method.flags ?? {},\r\n            getServers: () => {\r\n                return that.getServersByMethod(identifier);\r\n            }\r\n        };\r\n        // now add some legacy stuff\r\n        (methodDefinition as any).object_types = methodDefinition.objectTypes;\r\n        (methodDefinition as any).display_name = methodDefinition.displayName;\r\n        (methodDefinition as any).version = methodDefinition.version;\r\n\r\n        server.methods[method.id] = methodDefinition;\r\n\r\n        const clientMethodDefinition = hideMethodSystemFlags(methodDefinition);\r\n\r\n        // increase the ref and notify listeners\r\n        if (!this.methodsCount[identifier]) {\r\n            this.methodsCount[identifier] = 0;\r\n            this.callbacks.execute(\"onMethodAdded\", clientMethodDefinition);\r\n        }\r\n        this.methodsCount[identifier] = this.methodsCount[identifier] + 1;\r\n\r\n        this.callbacks.execute(\"onServerMethodAdded\", server.instance, clientMethodDefinition);\r\n        return methodDefinition;\r\n    }\r\n\r\n    public removeServerMethod(serverId: string, methodId: string) {\r\n        const server = this.servers[serverId];\r\n        if (!server) {\r\n            throw new Error(\"server does not exists\");\r\n        }\r\n\r\n        const method = server.methods[methodId];\r\n        delete server.methods[methodId];\r\n\r\n        const clientMethodDefinition = hideMethodSystemFlags(method);\r\n\r\n        // update ref counting\r\n        this.methodsCount[method.identifier] = this.methodsCount[method.identifier] - 1;\r\n        if (this.methodsCount[method.identifier] === 0) {\r\n            this.callbacks.execute(\"onMethodRemoved\", clientMethodDefinition);\r\n        }\r\n\r\n        this.callbacks.execute(\"onServerMethodRemoved\", server.instance, clientMethodDefinition);\r\n    }\r\n\r\n    public getMethods(): ClientMethodInfo[] {\r\n        return this.extractMethodsFromServers(Object.values(this.servers)).map(hideMethodSystemFlags);\r\n    }\r\n\r\n    public getServers(): ServerInfo[] {\r\n        return Object.values(this.servers).map(this.hideServerMethodSystemFlags);\r\n    }\r\n\r\n    public onServerAdded(callback: (server: Glue42Core.Interop.Instance) => void): UnsubscribeFunction {\r\n        const unsubscribeFunc = this.callbacks.add(\"onServerAdded\", callback);\r\n\r\n        // because we need the servers shapshot before we exist this stack\r\n        const serversWithMethodsToReplay = this.getServers().map((s) => s.instance);\r\n\r\n        return this.returnUnsubWithDelayedReplay(unsubscribeFunc, serversWithMethodsToReplay, callback);\r\n    }\r\n\r\n    public onMethodAdded(callback: (method: ClientMethodInfo) => void): UnsubscribeFunction {\r\n        const unsubscribeFunc = this.callbacks.add(\"onMethodAdded\", callback);\r\n\r\n        // because we need the servers snapshot before we return to the application code\r\n        const methodsToReplay = this.getMethods();\r\n\r\n        return this.returnUnsubWithDelayedReplay(unsubscribeFunc, methodsToReplay, callback);\r\n    }\r\n\r\n    public onServerMethodAdded(callback: (server: Glue42Core.AGM.Instance, method: ClientMethodInfo) => void): UnsubscribeFunction {\r\n        const unsubscribeFunc = this.callbacks.add(\"onServerMethodAdded\", callback);\r\n\r\n        // because we want to interrupt the loop with the existing methods\r\n        let unsubCalled = false;\r\n\r\n        // because we need the servers shapshot before we return to the application code\r\n        const servers = this.getServers();\r\n\r\n        // because we want to have the unsub function before the callback is called with all existing methods\r\n        setTimeout(() => {\r\n            servers.forEach((server) => {\r\n                const methods = server.methods;\r\n                Object.keys(methods).forEach((methodId) => {\r\n                    if (!unsubCalled) {\r\n                        callback(server.instance, methods[methodId]);\r\n                    }\r\n                });\r\n            });\r\n        }, 0);\r\n\r\n        return () => {\r\n            unsubCalled = true;\r\n            unsubscribeFunc();\r\n        };\r\n    }\r\n\r\n    public onMethodRemoved(callback: (method: ClientMethodInfo) => void): UnsubscribeFunction {\r\n        const unsubscribeFunc = this.callbacks.add(\"onMethodRemoved\", callback);\r\n\r\n        return unsubscribeFunc;\r\n    }\r\n\r\n    public onServerRemoved(callback: (server: Glue42Core.Interop.Instance, reason: string) => void): UnsubscribeFunction {\r\n        const unsubscribeFunc = this.callbacks.add(\"onServerRemoved\", callback);\r\n\r\n        return unsubscribeFunc;\r\n    }\r\n\r\n    public onServerMethodRemoved(callback: (server: Glue42Core.Interop.Instance, method: ClientMethodInfo) => void): UnsubscribeFunction {\r\n        const unsubscribeFunc = this.callbacks.add(\"onServerMethodRemoved\", callback);\r\n\r\n        return unsubscribeFunc;\r\n    }\r\n\r\n    public getServerById(id: string) {\r\n        return this.hideServerMethodSystemFlags(this.servers[id]);\r\n    }\r\n\r\n    public reset() {\r\n        Object.keys(this.servers).forEach((key) => {\r\n            this.removeServerById(key, \"reset\");\r\n        });\r\n        this.servers = {\r\n            [this.myServer.id]: this.myServer\r\n        };\r\n        this.methodsCount = {};\r\n    }\r\n\r\n    private createMethodIdentifier(methodInfo: MethodInfoMessage) {\r\n        // Setting properties to defaults:\r\n        const accepts = methodInfo.input_signature !== undefined ? methodInfo.input_signature : \"\";\r\n        const returns = methodInfo.result_signature !== undefined ? methodInfo.result_signature : \"\";\r\n        return (methodInfo.name + accepts + returns).toLowerCase();\r\n    }\r\n\r\n    private getServersByMethod(identifier: string): Glue42Core.AGM.Instance[] {\r\n        const allServers: Glue42Core.AGM.Instance[] = [];\r\n        Object.values(this.servers).forEach((server) => {\r\n            Object.values(server.methods).forEach((method) => {\r\n                if (method.identifier === identifier) {\r\n                    allServers.push(server.instance);\r\n                }\r\n            });\r\n        });\r\n        return allServers;\r\n    }\r\n\r\n    // collectionToReplay: because we need a snapshot before we exist this stack\r\n    private returnUnsubWithDelayedReplay(unsubscribeFunc: UnsubscribeFunction, collectionToReplay: any[], callback: any) {\r\n\r\n        // because we want to interrupt the loop with the existing methods\r\n        let unsubCalled = false;\r\n\r\n        // because we want to have the unsub function before the callback is called with all existing methods\r\n        setTimeout(() => {\r\n            collectionToReplay.forEach((item) => {\r\n                if (!unsubCalled) {\r\n                    callback(item);\r\n                }\r\n            });\r\n        }, 0);\r\n\r\n        return () => {\r\n            unsubCalled = true;\r\n            unsubscribeFunc();\r\n        };\r\n    }\r\n\r\n    private hideServerMethodSystemFlags(server: ServerInfo): ServerInfo {\r\n        const clientMethods: { [name: string]: ClientMethodInfo } = {};\r\n\r\n        Object.entries(server.methods).forEach(([name, method]) => {\r\n            clientMethods[name] = hideMethodSystemFlags(method);\r\n        });\r\n\r\n        return {\r\n            ...server,\r\n            methods: clientMethods\r\n        };\r\n    }\r\n\r\n    private extractMethodsFromServers(servers: ServerInfo[]): ClientMethodInfo[] {\r\n        const methods = Object.values(servers).reduce<ClientMethodInfo[]>((clientMethods, server) => {\r\n            return [...clientMethods, ...Object.values(server.methods)];\r\n        }, []);\r\n\r\n        return methods;\r\n    }\r\n}\r\n","/*\r\n * A store for holding method back-objects registered by this instance's server\r\n */\r\nimport { ServerMethodInfo } from \"./types\";\r\n\r\nexport default class ServerRepository {\r\n\r\n    private nextId = 0;\r\n    private methods: ServerMethodInfo[] = [];\r\n\r\n    public add(method: Partial<ServerMethodInfo>): ServerMethodInfo {\r\n        method.repoId = String(this.nextId);\r\n        this.nextId += 1;\r\n        this.methods.push(method as ServerMethodInfo);\r\n        return method as ServerMethodInfo;\r\n    }\r\n\r\n    public remove(repoId: string) {\r\n        if (typeof repoId !== \"string\") {\r\n            return new TypeError(\"Expecting a string\");\r\n        }\r\n\r\n        this.methods = this.methods.filter((m) => {\r\n            return m.repoId !== repoId;\r\n        });\r\n    }\r\n\r\n    public getById(id: string): ServerMethodInfo | undefined {\r\n        if (typeof id !== \"string\") {\r\n            return undefined;\r\n        }\r\n\r\n        return this.methods.find((m) => {\r\n            return m.repoId === id;\r\n        });\r\n    }\r\n\r\n    public getList() {\r\n        return this.methods.map((m) => m);\r\n    }\r\n\r\n    public length() {\r\n        return this.methods.length;\r\n    }\r\n\r\n    public reset() {\r\n        this.methods = [];\r\n    }\r\n}\r\n","import { default as CallbackRegistryFactory, CallbackRegistry } from \"callback-registry\";\r\nimport { RequestContext, ServerMethodInfo, ServerSubscriptionInfo } from \"../../server/types\";\r\nimport ClientRepository from \"../../client/repository\";\r\nimport ServerRepository from \"../../server/repository\";\r\nimport {\r\n    AddInterestMessage,\r\n    PublishMessage,\r\n    PostMessage,\r\n    DropSubscriptionMessage,\r\n    RemoveInterestMessage\r\n} from \"./messages\";\r\nimport { Glue42Core } from \"../../../../glue\";\r\nimport { Logger } from \"../../../logger/logger\";\r\n\r\nconst SUBSCRIPTION_REQUEST = \"onSubscriptionRequest\";\r\nconst SUBSCRIPTION_ADDED = \"onSubscriptionAdded\";\r\nconst SUBSCRIPTION_REMOVED = \"onSubscriptionRemoved\";\r\n\r\n/**\r\n * Handles registering methods and sending data to clients\r\n */\r\nexport default class ServerStreaming {\r\n\r\n    private ERR_URI_SUBSCRIPTION_FAILED = \"com.tick42.agm.errors.subscription.failure\";\r\n    private callbacks = CallbackRegistryFactory();\r\n    private nextStreamId = 0;\r\n\r\n    constructor(private session: Glue42Core.Connection.GW3DomainSession, private repository: ClientRepository, private serverRepository: ServerRepository) {\r\n        session.on(\"add-interest\", (msg: AddInterestMessage) => {\r\n            this.handleAddInterest(msg);\r\n        });\r\n        session.on(\"remove-interest\", (msg: RemoveInterestMessage) => {\r\n            this.handleRemoveInterest(msg);\r\n        });\r\n    }\r\n\r\n    public acceptRequestOnBranch(requestContext: RequestContext, streamingMethod: ServerMethodInfo, branch: string) {\r\n        if (typeof branch !== \"string\") {\r\n            branch = \"\";\r\n        }\r\n\r\n        if (typeof streamingMethod.protocolState.subscriptionsMap !== \"object\") {\r\n            throw new TypeError(\"The streaming method is missing its subscriptions.\");\r\n        }\r\n\r\n        if (!Array.isArray(streamingMethod.protocolState.branchKeyToStreamIdMap)) {\r\n            throw new TypeError(\"The streaming method is missing its branches.\");\r\n        }\r\n\r\n        const streamId = this.getStreamId(streamingMethod, branch);\r\n\r\n        // Add a new subscription to the method\r\n        const key = requestContext.msg.subscription_id;\r\n\r\n        const subscription: ServerSubscriptionInfo = {\r\n            id: key,\r\n            arguments: requestContext.arguments,\r\n            instance: requestContext.instance,\r\n            branchKey: branch,\r\n            streamId,\r\n            subscribeMsg: requestContext.msg,\r\n        };\r\n\r\n        streamingMethod.protocolState.subscriptionsMap[key] = subscription;\r\n\r\n        // Inform the gw\r\n        this.session.sendFireAndForget({\r\n            type: \"accepted\",\r\n            subscription_id: key,\r\n            stream_id: streamId,\r\n        });\r\n\r\n        // Pass state above-protocol for user objects\r\n        this.callbacks.execute(SUBSCRIPTION_ADDED, subscription, streamingMethod);\r\n    }\r\n\r\n    public rejectRequest(requestContext: RequestContext, streamingMethod: ServerMethodInfo, reason: string) {\r\n        if (typeof reason !== \"string\") {\r\n            reason = \"\";\r\n        }\r\n\r\n        this.sendSubscriptionFailed(\r\n            \"Subscription rejected by user. \" + reason,\r\n            requestContext.msg.subscription_id,\r\n        );\r\n    }\r\n\r\n    public pushData(streamingMethod: ServerMethodInfo, data: object, branches: string | string[]) {\r\n        if (typeof streamingMethod !== \"object\" || !Array.isArray(streamingMethod.protocolState.branchKeyToStreamIdMap)) {\r\n            return;\r\n        }\r\n\r\n        // TODO validate data is a plain object\r\n        if (typeof data !== \"object\") {\r\n            throw new Error(\"Invalid arguments. Data must be an object.\");\r\n        }\r\n\r\n        if (typeof branches === \"string\") {\r\n            branches = [branches]; // user wants to push to single branch\r\n        } else if (!Array.isArray(branches) || branches.length <= 0) {\r\n            branches = [];\r\n        }\r\n\r\n        // get the StreamId's from the method's branch map\r\n        const streamIdList = streamingMethod.protocolState.branchKeyToStreamIdMap\r\n            .filter((br) => {\r\n                if (!branches || branches.length === 0) {\r\n                    return true;\r\n                }\r\n                return branches.indexOf(br.key) >= 0;\r\n            }).map((br) => {\r\n                return br.streamId;\r\n            });\r\n\r\n        // if (streamIdList.length === 0) {\r\n        //     throw new Error(\"0 branches exist with the supplied name/s !\");\r\n        // }\r\n\r\n        streamIdList.forEach((streamId) => {\r\n            const publishMessage: PublishMessage = {\r\n                type: \"publish\",\r\n                stream_id: streamId,\r\n                // sequence: null,  // the streamingMethod might be used for this\r\n                // snapshot: false, // ...and this\r\n                data,\r\n            };\r\n\r\n            this.session.sendFireAndForget(publishMessage);\r\n        });\r\n    }\r\n\r\n    public pushDataToSingle(method: ServerMethodInfo, subscription: ServerSubscriptionInfo, data: object) {\r\n        // TODO validate data is a plain object\r\n        if (typeof data !== \"object\") {\r\n            throw new Error(\"Invalid arguments. Data must be an object.\");\r\n        }\r\n\r\n        const postMessage: PostMessage = {\r\n            type: \"post\",\r\n            subscription_id: subscription.id,\r\n            // sequence: null,  // the streamingMethod might be used for this\r\n            // snapshot: false, // ...and this\r\n            data,\r\n        };\r\n\r\n        this.session.sendFireAndForget(postMessage);\r\n    }\r\n\r\n    public closeSingleSubscription(streamingMethod: ServerMethodInfo, subscription: ServerSubscriptionInfo) {\r\n\r\n        if (streamingMethod.protocolState.subscriptionsMap) {\r\n            delete streamingMethod.protocolState.subscriptionsMap[subscription.id];\r\n        }\r\n\r\n        const dropSubscriptionMessage: DropSubscriptionMessage = {\r\n            type: \"drop-subscription\",\r\n            subscription_id: subscription.id,\r\n            reason: \"Server dropping a single subscription\",\r\n        };\r\n\r\n        this.session.sendFireAndForget(dropSubscriptionMessage);\r\n\r\n        const subscriber = subscription.instance;\r\n\r\n        this.callbacks.execute(SUBSCRIPTION_REMOVED, subscription, streamingMethod);\r\n    }\r\n\r\n    public closeMultipleSubscriptions(streamingMethod: ServerMethodInfo, branchKey?: string) {\r\n        if (typeof streamingMethod !== \"object\" || typeof streamingMethod.protocolState.subscriptionsMap !== \"object\") {\r\n            return;\r\n        }\r\n        if (!streamingMethod.protocolState.subscriptionsMap) {\r\n            return;\r\n        }\r\n\r\n        const subscriptionsMap = streamingMethod.protocolState.subscriptionsMap;\r\n        let subscriptionsToClose = Object.keys(subscriptionsMap)\r\n            .map((key) => {\r\n                return subscriptionsMap[key];\r\n            });\r\n\r\n        if (typeof branchKey === \"string\") {\r\n            subscriptionsToClose = subscriptionsToClose.filter((sub) => {\r\n                return sub.branchKey === branchKey;\r\n            });\r\n        }\r\n\r\n        subscriptionsToClose.forEach((subscription) => {\r\n            delete subscriptionsMap[subscription.id];\r\n\r\n            const drop: DropSubscriptionMessage = {\r\n                type: \"drop-subscription\",\r\n                subscription_id: subscription.id,\r\n                reason: \"Server dropping all subscriptions on stream_id: \" + subscription.streamId,\r\n            };\r\n            this.session.sendFireAndForget(drop);\r\n        });\r\n    }\r\n\r\n    public getSubscriptionList(streamingMethod: ServerMethodInfo, branchKey?: string): ServerSubscriptionInfo[] {\r\n        if (typeof streamingMethod !== \"object\") {\r\n            return [];\r\n        }\r\n\r\n        let subscriptions = [];\r\n        if (!streamingMethod.protocolState.subscriptionsMap) {\r\n            return [];\r\n        }\r\n        const subscriptionsMap = streamingMethod.protocolState.subscriptionsMap;\r\n\r\n        const allSubscriptions = Object.keys(subscriptionsMap)\r\n            .map((key) => {\r\n                return subscriptionsMap[key];\r\n            });\r\n\r\n        if (typeof branchKey !== \"string\") {\r\n            subscriptions = allSubscriptions;\r\n        } else {\r\n            subscriptions = allSubscriptions.filter((sub) => {\r\n                return sub.branchKey === branchKey;\r\n            });\r\n        }\r\n\r\n        return subscriptions;\r\n    }\r\n\r\n    public getBranchList(streamingMethod: ServerMethodInfo): string[] {\r\n        if (typeof streamingMethod !== \"object\") {\r\n            return [];\r\n        }\r\n\r\n        if (!streamingMethod.protocolState.subscriptionsMap) {\r\n            return [];\r\n        }\r\n        const subscriptionsMap = streamingMethod.protocolState.subscriptionsMap;\r\n\r\n        const allSubscriptions =\r\n            Object.keys(subscriptionsMap)\r\n                .map((key) => {\r\n                    return subscriptionsMap[key];\r\n                });\r\n\r\n        const result: string[] = [];\r\n        allSubscriptions.forEach((sub) => {\r\n            let branch = \"\";\r\n            if (typeof sub === \"object\" && typeof sub.branchKey === \"string\") {\r\n                branch = sub.branchKey;\r\n            }\r\n\r\n            if (result.indexOf(branch) === -1) {\r\n                result.push(branch);\r\n            }\r\n        });\r\n\r\n        return result;\r\n    }\r\n\r\n    public onSubAdded(callback: (subscription: ServerSubscriptionInfo, repoMethod: ServerMethodInfo) => void) {\r\n        this.onSubscriptionLifetimeEvent(SUBSCRIPTION_ADDED, callback);\r\n    }\r\n\r\n    public onSubRequest(callback: (requestContext: RequestContext, repoMethod: ServerMethodInfo) => void) {\r\n        this.onSubscriptionLifetimeEvent(SUBSCRIPTION_REQUEST, callback);\r\n    }\r\n\r\n    public onSubRemoved(callback: (subscriber: ServerSubscriptionInfo, repoMethod: ServerMethodInfo) => void) {\r\n        this.onSubscriptionLifetimeEvent(SUBSCRIPTION_REMOVED, callback);\r\n    }\r\n\r\n    private handleRemoveInterest(msg: RemoveInterestMessage) {\r\n        const streamingMethod = this.serverRepository.getById(msg.method_id);\r\n\r\n        if (typeof msg.subscription_id !== \"string\" ||\r\n            typeof streamingMethod !== \"object\") {\r\n            return;\r\n        }\r\n\r\n        if (!streamingMethod.protocolState.subscriptionsMap) {\r\n            return;\r\n        }\r\n\r\n        if (typeof streamingMethod.protocolState.subscriptionsMap[msg.subscription_id] !== \"object\") {\r\n            return;\r\n        }\r\n\r\n        const subscription = streamingMethod.protocolState.subscriptionsMap[msg.subscription_id];\r\n\r\n        delete streamingMethod.protocolState.subscriptionsMap[msg.subscription_id];\r\n\r\n        this.callbacks.execute(SUBSCRIPTION_REMOVED, subscription, streamingMethod);\r\n    }\r\n\r\n    private onSubscriptionLifetimeEvent(eventName: string, handlerFunc: any) {\r\n        this.callbacks.add(eventName, handlerFunc);\r\n    }\r\n\r\n    private getNextStreamId(): string {\r\n        return this.nextStreamId++ + \"\";\r\n    }\r\n\r\n    /**\r\n     * Processes a subscription request\r\n     */\r\n    private handleAddInterest(msg: AddInterestMessage) {\r\n\r\n        const caller = this.repository.getServerById(msg.caller_id);\r\n        const instance = caller.instance;\r\n\r\n        // call subscriptionRequestHandler\r\n        const requestContext: RequestContext = {\r\n            msg,\r\n            arguments: msg.arguments_kv || {},\r\n            instance,\r\n        };\r\n\r\n        const streamingMethod = this.serverRepository.getById(msg.method_id);\r\n\r\n        if (streamingMethod === undefined) {\r\n            const errorMsg = \"No method with id \" + msg.method_id + \" on this server.\";\r\n            this.sendSubscriptionFailed(errorMsg, msg.subscription_id);\r\n            return;\r\n        }\r\n\r\n        if (streamingMethod.protocolState.subscriptionsMap &&\r\n            streamingMethod.protocolState.subscriptionsMap[msg.subscription_id]) {\r\n            this.sendSubscriptionFailed(\"A subscription with id \" + msg.subscription_id + \" already exists.\",\r\n                msg.subscription_id,\r\n            );\r\n            return;\r\n        }\r\n\r\n        this.callbacks.execute(SUBSCRIPTION_REQUEST, requestContext, streamingMethod);\r\n    }\r\n\r\n    private sendSubscriptionFailed(reason: string, subscriptionId: string) {\r\n        const errorMessage = {\r\n            type: \"error\",\r\n            reason_uri: this.ERR_URI_SUBSCRIPTION_FAILED,\r\n            reason,\r\n            request_id: subscriptionId, // this overrides connection wrapper\r\n        };\r\n\r\n        this.session.sendFireAndForget(errorMessage);\r\n    }\r\n\r\n    private getStreamId(streamingMethod: ServerMethodInfo, branchKey: string) {\r\n        if (typeof branchKey !== \"string\") {\r\n            branchKey = \"\";\r\n        }\r\n\r\n        if (!streamingMethod.protocolState.branchKeyToStreamIdMap) {\r\n            throw new Error(`streaming ${streamingMethod.definition.name} method without protocol state`);\r\n        }\r\n\r\n        const needleBranch = streamingMethod.protocolState.branchKeyToStreamIdMap.filter((branch) => {\r\n            return branch.key === branchKey;\r\n        })[0];\r\n\r\n        let streamId = (needleBranch ? needleBranch.streamId : undefined);\r\n\r\n        if (typeof streamId !== \"string\" || streamId === \"\") {\r\n            streamId = this.getNextStreamId();\r\n            streamingMethod.protocolState.branchKeyToStreamIdMap.push({ key: branchKey, streamId });\r\n        }\r\n\r\n        return streamId;\r\n    }\r\n}\r\n","import { default as CallbackRegistryFactory, CallbackRegistry } from \"callback-registry\";\r\nimport ServerStreaming from \"./server-streaming\";\r\nimport {\r\n    InvokeMessage,\r\n    RegisterMethodMessage,\r\n    ErrorMessage,\r\n    YieldMessage,\r\n    UnregisterMessage,\r\n    TaggedMessage\r\n} from \"./messages\";\r\nimport ServerRepository from \"../../server/repository\";\r\nimport { Glue42Core } from \"../../../../glue\";\r\nimport { ServerMethodInfo, ResultContext, ServerSubscriptionInfo, RequestContext } from \"../../server/types\";\r\nimport ClientRepository from \"../../client/repository\";\r\nimport { ServerProtocolDefinition } from \"../../types\";\r\nimport { Logger } from \"../../../logger/logger\";\r\n\r\nexport default class ServerProtocol implements ServerProtocolDefinition {\r\n    private callbacks: CallbackRegistry = CallbackRegistryFactory();\r\n    private streaming: ServerStreaming;\r\n\r\n    constructor(private session: Glue42Core.Connection.GW3DomainSession, private clientRepository: ClientRepository, private serverRepository: ServerRepository, private logger: Logger) {\r\n        this.streaming = new ServerStreaming(session, clientRepository, serverRepository);\r\n        this.session.on(\"invoke\", (msg: InvokeMessage) => this.handleInvokeMessage(msg));\r\n    }\r\n\r\n    public createStream(repoMethod: ServerMethodInfo): Promise<void> {\r\n        // Utility things for this protocol\r\n        repoMethod.protocolState.subscriptionsMap = {}; // ~subscription_id~ : {id:~, branchKey: '~', arguments: {~}, instance:{~}, etc.}\r\n        repoMethod.protocolState.branchKeyToStreamIdMap = []; // [ {branchKey: '', streamId: 7}, {...}, ...]\r\n\r\n        return this.register(repoMethod, true);\r\n    }\r\n\r\n    public register(repoMethod: ServerMethodInfo, isStreaming?: boolean): Promise<void> {\r\n        const methodDef = repoMethod.definition;\r\n        const flags = Object.assign({}, { metadata: methodDef.flags ?? {} }, { streaming: isStreaming || false });\r\n\r\n        const registerMsg: RegisterMethodMessage = {\r\n            type: \"register\",\r\n            methods: [{\r\n                id: repoMethod.repoId,\r\n                name: methodDef.name,\r\n                display_name: methodDef.displayName,\r\n                description: methodDef.description,\r\n                version: methodDef.version,\r\n                flags,\r\n                object_types: methodDef.objectTypes || (methodDef as any).object_types, // object_type for backward compatibility\r\n                input_signature: methodDef.accepts,\r\n                result_signature: methodDef.returns,\r\n                restrictions: undefined,\r\n            }],\r\n        };\r\n\r\n        return this.session.send(registerMsg, { methodId: repoMethod.repoId })\r\n            .then(() => {\r\n                this.logger.debug(\"registered method \" + repoMethod.definition.name + \" with id \" + repoMethod.repoId);\r\n            })\r\n            .catch((msg: ErrorMessage) => {\r\n                this.logger.warn(`failed to register method ${repoMethod.definition.name} with id ${repoMethod.repoId} - ${JSON.stringify(msg)}`);\r\n                throw msg;\r\n            });\r\n    }\r\n\r\n    public onInvoked(callback: (methodToExecute: ServerMethodInfo, invocationId: string, invocationArgs: ResultContext) => void) {\r\n        this.callbacks.add(\"onInvoked\", callback);\r\n    }\r\n\r\n    public methodInvocationResult(method: ServerMethodInfo, invocationId: string, err: string, result: object) {\r\n        let msg: YieldMessage | ErrorMessage;\r\n        if (err || err === \"\") {\r\n            msg = {\r\n                type: \"error\",\r\n                request_id: invocationId,\r\n                reason_uri: \"agm.errors.client_error\",\r\n                reason: err,\r\n                context: result,\r\n                peer_id: undefined,\r\n            };\r\n        } else {\r\n            msg = {\r\n                type: \"yield\",\r\n                invocation_id: invocationId,\r\n                peer_id: this.session.peerId,\r\n                result,\r\n                request_id: undefined,\r\n            };\r\n        }\r\n        this.session.sendFireAndForget(msg);\r\n    }\r\n\r\n    public async unregister(method: ServerMethodInfo): Promise<void> {\r\n        const msg: UnregisterMessage = {\r\n            type: \"unregister\",\r\n            methods: [method.repoId],\r\n        };\r\n\r\n        await this.session.send(msg);\r\n    }\r\n\r\n    public getBranchList(method: ServerMethodInfo): string[] {\r\n        return this.streaming.getBranchList(method);\r\n    }\r\n\r\n    public getSubscriptionList(method: ServerMethodInfo, branchKey?: string): ServerSubscriptionInfo[] {\r\n        return this.streaming.getSubscriptionList(method, branchKey);\r\n    }\r\n\r\n    public closeAllSubscriptions(method: ServerMethodInfo, branchKey?: string): void {\r\n        this.streaming.closeMultipleSubscriptions(method, branchKey);\r\n    }\r\n\r\n    public pushData(method: ServerMethodInfo, data: object, branches: string[]): void {\r\n        this.streaming.pushData(method, data, branches);\r\n    }\r\n\r\n    public pushDataToSingle(method: ServerMethodInfo, subscription: ServerSubscriptionInfo, data: object): void {\r\n        this.streaming.pushDataToSingle(method, subscription, data);\r\n    }\r\n\r\n    public closeSingleSubscription(method: ServerMethodInfo, subscription: ServerSubscriptionInfo): void {\r\n        this.streaming.closeSingleSubscription(method, subscription);\r\n    }\r\n\r\n    public acceptRequestOnBranch(requestContext: RequestContext, method: ServerMethodInfo, branch: string): void {\r\n        this.streaming.acceptRequestOnBranch(requestContext, method, branch);\r\n    }\r\n\r\n    public rejectRequest(requestContext: RequestContext, method: ServerMethodInfo, reason: string): void {\r\n        this.streaming.rejectRequest(requestContext, method, reason);\r\n    }\r\n\r\n    public onSubRequest(callback: (requestContext: RequestContext, repoMethod: ServerMethodInfo) => void): void {\r\n        this.streaming.onSubRequest(callback);\r\n    }\r\n\r\n    public onSubAdded(callback: (subscription: ServerSubscriptionInfo, repoMethod: ServerMethodInfo) => void): void {\r\n        this.streaming.onSubAdded(callback);\r\n    }\r\n\r\n    public onSubRemoved(callback: (subscriber: ServerSubscriptionInfo, repoMethod: ServerMethodInfo) => void): void {\r\n        this.streaming.onSubRemoved(callback);\r\n    }\r\n\r\n    private handleInvokeMessage(msg: InvokeMessage) {\r\n        const invocationId = msg.invocation_id;\r\n        const callerId = msg.caller_id;\r\n        const methodId = msg.method_id;\r\n        const args = msg.arguments_kv;\r\n        const methodList = this.serverRepository.getList();\r\n\r\n        const method = methodList.filter((m) => {\r\n            return m.repoId === methodId;\r\n        })[0];\r\n\r\n        // Stop if the message isn't for us\r\n        if (method === undefined) {\r\n            return;\r\n        }\r\n\r\n        const client = this.clientRepository.getServerById(callerId).instance;\r\n        const invocationArgs = { args, instance: client };\r\n\r\n        this.callbacks.execute(\"onInvoked\", method, invocationId, invocationArgs);\r\n    }\r\n}\r\n","import { Glue42Core } from \"../../../../glue\";\r\nimport { SubscriptionInner } from \"../../types\";\r\nimport ClientRepository from \"../../client/repository\";\r\n\r\nexport class UserSubscription implements Glue42Core.Interop.Subscription {\r\n    public get requestArguments() {\r\n        return this.subscriptionData.params.arguments || {};\r\n    }\r\n\r\n    public get servers(): Glue42Core.Interop.Instance[] {\r\n        return this.subscriptionData.trackedServers\r\n            .filter((pair) => pair.subscriptionId)\r\n            .map((pair) => this.repository.getServerById(pair.serverId).instance);\r\n    }\r\n\r\n    public get serverInstance(): Glue42Core.Interop.Instance {\r\n        return this.servers[0];\r\n    }\r\n\r\n    public get stream(): Glue42Core.Interop.MethodDefinition {\r\n        return this.subscriptionData.method;\r\n    }\r\n\r\n    constructor(private repository: ClientRepository, private subscriptionData: SubscriptionInner) {\r\n    }\r\n\r\n    public onData(dataCallback: (data: Glue42Core.Interop.StreamData) => void): void {\r\n        if (typeof dataCallback !== \"function\") {\r\n            throw new TypeError(\"The data callback must be a function.\");\r\n        }\r\n\r\n        this.subscriptionData.handlers.onData.push(dataCallback);\r\n        if (this.subscriptionData.handlers.onData.length === 1 && this.subscriptionData.queued.data.length > 0) {\r\n            this.subscriptionData.queued.data.forEach((dataItem) => {\r\n                dataCallback(dataItem);\r\n            });\r\n        }\r\n    }\r\n\r\n    public onClosed(closedCallback: (info: Glue42Core.Interop.OnClosedInfo) => void): void {\r\n        if (typeof closedCallback !== \"function\") {\r\n            throw new TypeError(\"The callback must be a function.\");\r\n        }\r\n        this.subscriptionData.handlers.onClosed.push(closedCallback);\r\n    }\r\n\r\n    public onFailed(callback: (err: any) => void): void {\r\n        // DO NOTHING\r\n    }\r\n\r\n    public onConnected(callback: (server: Glue42Core.Interop.Instance, reconnect: boolean) => void): void {\r\n        if (typeof callback !== \"function\") {\r\n            throw new TypeError(\"The callback must be a function.\");\r\n        }\r\n        this.subscriptionData.handlers.onConnected.push(callback);\r\n    }\r\n\r\n    public close(): void {\r\n        this.subscriptionData.close();\r\n    }\r\n\r\n    public setNewSubscription(newSub: SubscriptionInner) {\r\n        this.subscriptionData = newSub;\r\n    }\r\n}\r\n","import { Glue42Core } from \"../../../../glue\";\r\nimport ClientRepository from \"../../client/repository\";\r\nimport { ServerMethodsPair } from \"../../client/types\";\r\nimport * as GW3Messages from \"./messages\";\r\nimport { SubscriptionCancelledMessage, EventMessage, SubscribedMessage, ErrorSubscribingMessage } from \"./messages\";\r\nimport { SubscribeError, SubscriptionInner } from \"../../types\";\r\nimport { Logger } from \"../../../logger/logger\";\r\nimport { UserSubscription } from \"./subscription\";\r\n\r\nconst STATUS_AWAITING_ACCEPT = \"awaitingAccept\"; // not even one server has accepted yet\r\nconst STATUS_SUBSCRIBED = \"subscribed\"; // at least one server has responded as 'Accepting'\r\nconst ERR_MSG_SUB_FAILED = \"Subscription failed.\";\r\nconst ERR_MSG_SUB_REJECTED = \"Subscription rejected.\";\r\nconst ON_CLOSE_MSG_SERVER_INIT = \"ServerInitiated\";\r\nconst ON_CLOSE_MSG_CLIENT_INIT = \"ClientInitiated\";\r\n\r\n/**\r\n * Handles registering methods and sending data to clients\r\n */\r\nexport default class ClientStreaming {\r\n\r\n    private subscriptionsList: { [key: number]: SubscriptionInner } = {};\r\n    private subscriptionIdToLocalKeyMap: { [key: string]: number } = {};\r\n    private nextSubLocalKey = 0;\r\n\r\n    constructor(private session: Glue42Core.Connection.GW3DomainSession, private repository: ClientRepository, private logger: Logger) {\r\n        session.on(\"subscribed\", this.handleSubscribed);\r\n        session.on(\"event\", this.handleEventData);\r\n        session.on(\"subscription-cancelled\", this.handleSubscriptionCancelled);\r\n    }\r\n\r\n    public subscribe(streamingMethod: Glue42Core.AGM.MethodDefinition, params: Glue42Core.AGM.SubscriptionParams, targetServers: ServerMethodsPair[], success: (sub: Glue42Core.AGM.Subscription) => void, error: (err: SubscribeError) => void, existingSub: SubscriptionInner) {\r\n        if (targetServers.length === 0) {\r\n            error({\r\n                method: streamingMethod,\r\n                called_with: params.arguments,\r\n                message: ERR_MSG_SUB_FAILED + \" No available servers matched the target params.\",\r\n            });\r\n            return;\r\n        }\r\n\r\n        // Note: used to find the subscription in subList. Do not confuse it with the gw-generated subscription_id\r\n        const subLocalKey = this.getNextSubscriptionLocalKey();\r\n\r\n        const pendingSub = this.registerSubscription(\r\n            subLocalKey,\r\n            streamingMethod,\r\n            params,\r\n            success,\r\n            error,\r\n            params.methodResponseTimeout || 10000,\r\n            existingSub\r\n        );\r\n\r\n        if (typeof pendingSub !== \"object\") {\r\n            error({\r\n                method: streamingMethod,\r\n                called_with: params.arguments,\r\n                message: ERR_MSG_SUB_FAILED + \" Unable to register the user callbacks.\",\r\n            });\r\n            return;\r\n        }\r\n\r\n        targetServers.forEach((target) => {\r\n\r\n            const serverId = target.server.id;\r\n            const method = target.methods.find((m) => m.name === streamingMethod.name);\r\n\r\n            if (!method) {\r\n                this.logger.error(`can not find method ${streamingMethod.name} for target ${target.server.id}`);\r\n                return;\r\n            }\r\n\r\n            pendingSub.trackedServers.push({\r\n                serverId,\r\n                subscriptionId: undefined,\r\n            });\r\n\r\n            const msg: GW3Messages.SubscribeMessage = {\r\n                type: \"subscribe\",\r\n                server_id: serverId,\r\n                method_id: method.gatewayId,\r\n                arguments_kv: params.arguments,\r\n            };\r\n\r\n            this.session.send<SubscribedMessage>(msg, { serverId, subLocalKey })\r\n                .then((m: SubscribedMessage) => this.handleSubscribed(m))\r\n                .catch((err: ErrorSubscribingMessage) => this.handleErrorSubscribing(err));\r\n        });\r\n    }\r\n\r\n    public drainSubscriptions() {\r\n        const existing = Object.values(this.subscriptionsList);\r\n        this.subscriptionsList = {};\r\n        this.subscriptionIdToLocalKeyMap = {};\r\n        return existing;\r\n    }\r\n\r\n    private getNextSubscriptionLocalKey() {\r\n        const current = this.nextSubLocalKey;\r\n        this.nextSubLocalKey += 1;\r\n        return current;\r\n    }\r\n\r\n    // This adds subscription and after timeout (30000 default) removes it if it isn't STATUS_SUBSCRIBED\r\n    private registerSubscription(subLocalKey: number, method: Glue42Core.AGM.MethodDefinition, params: Glue42Core.Interop.SubscriptionParams, success: (sub: Glue42Core.AGM.Subscription) => void, error: (err: SubscribeError) => void, timeout: number, existingSub: SubscriptionInner) {\r\n        const subsInfo: SubscriptionInner = {\r\n            localKey: subLocalKey,\r\n            status: STATUS_AWAITING_ACCEPT,\r\n            method,\r\n            params,\r\n            success,\r\n            error,\r\n            trackedServers: [],\r\n            handlers: {\r\n                onData: existingSub?.handlers.onData || [],\r\n                onClosed: existingSub?.handlers.onClosed || [],\r\n                onConnected: existingSub?.handlers.onConnected || [],\r\n                // onFailed: []\r\n            },\r\n            queued: {\r\n                data: [],\r\n                closers: [],\r\n            },\r\n            timeoutId: undefined,\r\n            close: () => this.closeSubscription(subLocalKey),\r\n            subscription: existingSub?.subscription // only when re-connecting\r\n        };\r\n\r\n        if (!existingSub) {\r\n            if (params.onData) {\r\n                subsInfo.handlers.onData.push(params.onData);\r\n            }\r\n            if (params.onClosed) {\r\n                subsInfo.handlers.onClosed.push(params.onClosed);\r\n            }\r\n            if (params.onConnected) {\r\n                subsInfo.handlers.onConnected.push(params.onConnected);\r\n            }\r\n        }\r\n\r\n        this.subscriptionsList[subLocalKey] = subsInfo;\r\n\r\n        subsInfo.timeoutId = setTimeout(() => {\r\n            if (this.subscriptionsList[subLocalKey] === undefined) {\r\n                return; // no such subscription\r\n            }\r\n\r\n            const pendingSub = this.subscriptionsList[subLocalKey];\r\n\r\n            if (pendingSub.status === STATUS_AWAITING_ACCEPT) {\r\n                error({\r\n                    method,\r\n                    called_with: params.arguments,\r\n                    message: ERR_MSG_SUB_FAILED + \" Subscription attempt timed out after \" + timeout + \" ms.\",\r\n                });\r\n\r\n                // None of the target servers has answered the subscription attempt\r\n                delete this.subscriptionsList[subLocalKey];\r\n\r\n            } else if (pendingSub.status === STATUS_SUBSCRIBED && pendingSub.trackedServers.length > 0) {\r\n                // Clean the trackedServers, removing those without valid streamId\r\n                pendingSub.trackedServers = pendingSub.trackedServers.filter((server) => {\r\n                    return (typeof server.subscriptionId !== \"undefined\");\r\n                });\r\n\r\n                delete pendingSub.timeoutId;\r\n\r\n                if (pendingSub.trackedServers.length <= 0) {\r\n                    // There are no open streams, some servers accepted then closed very quickly\r\n                    //  (that's why the status changed but there's no good server with a StreamId)\r\n\r\n                    // call the onClosed handlers\r\n                    this.callOnClosedHandlers(pendingSub);\r\n\r\n                    delete this.subscriptionsList[subLocalKey];\r\n                }\r\n            }\r\n        }, timeout);\r\n\r\n        return subsInfo;\r\n    }\r\n\r\n    private handleErrorSubscribing = (errorResponse: ErrorSubscribingMessage) => {\r\n        const tag = errorResponse._tag;\r\n        const subLocalKey = tag.subLocalKey;\r\n        const pendingSub = this.subscriptionsList[subLocalKey];\r\n\r\n        if (typeof pendingSub !== \"object\") {\r\n            return;\r\n        }\r\n\r\n        pendingSub.trackedServers = pendingSub.trackedServers.filter((server) => {\r\n            return server.serverId !== tag.serverId;\r\n        });\r\n\r\n        if (pendingSub.trackedServers.length <= 0) {\r\n            clearTimeout(pendingSub.timeoutId);\r\n\r\n            if (pendingSub.status === STATUS_AWAITING_ACCEPT) {\r\n                // Reject with reason\r\n                const reason = (typeof errorResponse.reason === \"string\" && errorResponse.reason !== \"\") ?\r\n                    ' Publisher said \"' + errorResponse.reason + '\".' :\r\n                    \" No reason given.\";\r\n\r\n                const callArgs = typeof pendingSub.params.arguments === \"object\" ?\r\n                    JSON.stringify(pendingSub.params.arguments) :\r\n                    \"{}\";\r\n\r\n                pendingSub.error({\r\n                    message: ERR_MSG_SUB_REJECTED + reason + \" Called with:\" + callArgs,\r\n                    called_with: pendingSub.params.arguments,\r\n                    method: pendingSub.method,\r\n                });\r\n\r\n            } else if (pendingSub.status === STATUS_SUBSCRIBED) {\r\n                // The timeout may or may not have expired yet,\r\n                // but the status is 'subscribed' and trackedServers is now empty\r\n\r\n                this.callOnClosedHandlers(pendingSub);\r\n            }\r\n\r\n            delete this.subscriptionsList[subLocalKey];\r\n        }\r\n    }\r\n\r\n    private handleSubscribed = (msg: SubscribedMessage) => {\r\n        const subLocalKey = msg._tag.subLocalKey;\r\n        const pendingSub = this.subscriptionsList[subLocalKey];\r\n\r\n        if (typeof pendingSub !== \"object\") {\r\n            return;\r\n        }\r\n        const serverId = msg._tag.serverId;\r\n\r\n        // Add a subscription_id to this trackedServer\r\n\r\n        const acceptingServer = pendingSub.trackedServers\r\n            .filter((server) => {\r\n                return server.serverId === serverId;\r\n            })[0];\r\n\r\n        if (typeof acceptingServer !== \"object\") {\r\n            return;\r\n        }\r\n\r\n        acceptingServer.subscriptionId = msg.subscription_id;\r\n        this.subscriptionIdToLocalKeyMap[msg.subscription_id] = subLocalKey;\r\n\r\n        const isFirstResponse = (pendingSub.status === STATUS_AWAITING_ACCEPT);\r\n\r\n        pendingSub.status = STATUS_SUBSCRIBED;\r\n\r\n        if (isFirstResponse) {\r\n            let reconnect: boolean = false;\r\n            let sub = pendingSub.subscription;\r\n            if (sub) {\r\n                // re-connect case, we already have subscription object\r\n                sub.setNewSubscription(pendingSub);\r\n                pendingSub.success(sub);\r\n                reconnect = true;\r\n            } else {\r\n                sub = new UserSubscription(this.repository, pendingSub);\r\n                pendingSub.subscription = sub;\r\n                // Pass in the subscription object\r\n                pendingSub.success(sub);\r\n            }\r\n\r\n            for (const handler of pendingSub.handlers.onConnected) {\r\n                try {\r\n                    handler(sub.serverInstance, reconnect);\r\n                } catch (e) {\r\n                    // DO nothing\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    private handleEventData = (msg: EventMessage) => {\r\n\r\n        const subLocalKey = this.subscriptionIdToLocalKeyMap[msg.subscription_id];\r\n\r\n        if (typeof subLocalKey === \"undefined\") {\r\n            return;\r\n        }\r\n\r\n        const subscription = this.subscriptionsList[subLocalKey];\r\n\r\n        if (typeof subscription !== \"object\") {\r\n            return;\r\n        }\r\n\r\n        const trackedServersFound = subscription.trackedServers.filter((server) => {\r\n            return server.subscriptionId === msg.subscription_id;\r\n        });\r\n\r\n        if (trackedServersFound.length !== 1) {\r\n            return;\r\n        }\r\n\r\n        // out_of_band. (main stream band)\r\n        const isPrivateData = msg.oob;\r\n\r\n        const sendingServerId = trackedServersFound[0].serverId;\r\n\r\n        // Create the arrivedData object, new object for each handler call\r\n        const receivedStreamData = (): Glue42Core.AGM.StreamData => {\r\n            return {\r\n                data: msg.data,\r\n                server: this.repository.getServerById(sendingServerId).instance,\r\n                requestArguments: subscription.params.arguments,\r\n                message: undefined,\r\n                private: isPrivateData,\r\n            };\r\n        };\r\n\r\n        const onDataHandlers = subscription.handlers.onData;\r\n        const queuedData = subscription.queued.data;\r\n\r\n        if (onDataHandlers.length > 0) {\r\n            onDataHandlers.forEach((callback) => {\r\n                if (typeof callback === \"function\") {\r\n                    callback(receivedStreamData());\r\n                }\r\n            });\r\n        } else {\r\n            queuedData.push(receivedStreamData());\r\n        }\r\n    }\r\n\r\n    // called only on stream.close() multiple times for each subscription\r\n    private handleSubscriptionCancelled = (msg: SubscriptionCancelledMessage) => {\r\n        const subLocalKey = this.subscriptionIdToLocalKeyMap[msg.subscription_id];\r\n\r\n        if (typeof subLocalKey === \"undefined\") {\r\n            return;\r\n        }\r\n\r\n        const subscription = this.subscriptionsList[subLocalKey];\r\n\r\n        if (typeof subscription !== \"object\") {\r\n            return;\r\n        }\r\n\r\n        // Filter tracked servers\r\n        const expectedNewLength = subscription.trackedServers.length - 1;\r\n\r\n        subscription.trackedServers = subscription.trackedServers.filter((server) => {\r\n            if (server.subscriptionId === msg.subscription_id) {\r\n                subscription.queued.closers.push(server.serverId);\r\n                return false;\r\n            } else {\r\n                return true;\r\n            }\r\n        });\r\n\r\n        // Check if a server was actually removed\r\n        if (subscription.trackedServers.length !== expectedNewLength) {\r\n            // TODO: Log some error\r\n            return;\r\n        }\r\n\r\n        // Check if this was the last remaining server\r\n        if (subscription.trackedServers.length <= 0) {\r\n            clearTimeout(subscription.timeoutId);\r\n            this.callOnClosedHandlers(subscription);\r\n            delete this.subscriptionsList[subLocalKey];\r\n        }\r\n\r\n        delete this.subscriptionIdToLocalKeyMap[msg.subscription_id];\r\n    }\r\n\r\n    private callOnClosedHandlers(subscription: SubscriptionInner, reason?: string) {\r\n\r\n        const closersCount = subscription.queued.closers.length;\r\n        const closingServerId = (closersCount > 0) ? subscription.queued.closers[closersCount - 1] : null;\r\n\r\n        let closingServer: Glue42Core.AGM.Instance;\r\n        if (closingServerId !== undefined && typeof closingServerId === \"string\") {\r\n            closingServer = this.repository.getServerById(closingServerId).instance;\r\n        }\r\n\r\n        subscription.handlers.onClosed.forEach((callback) => {\r\n            if (typeof callback !== \"function\") {\r\n                return;\r\n            }\r\n\r\n            callback({\r\n                message: reason || ON_CLOSE_MSG_SERVER_INIT,\r\n                requestArguments: subscription.params.arguments || {},\r\n                server: closingServer,\r\n                stream: subscription.method,\r\n            });\r\n        });\r\n    }\r\n\r\n    // called on client/server close (not on stream.close)\r\n    private closeSubscription(subLocalKey: number) {\r\n        const subscription = this.subscriptionsList[subLocalKey];\r\n\r\n        if (typeof subscription !== \"object\") {\r\n            return;\r\n        }\r\n\r\n        // Tell each server that we're unsubscribing\r\n        subscription.trackedServers.forEach((server) => {\r\n            if (typeof server.subscriptionId === \"undefined\") {\r\n                return;\r\n            }\r\n\r\n            subscription.queued.closers.push(server.serverId);\r\n\r\n            this.session.sendFireAndForget({\r\n                type: \"unsubscribe\",\r\n                subscription_id: server.subscriptionId,\r\n                reason_uri: \"\",\r\n                reason: ON_CLOSE_MSG_CLIENT_INIT,\r\n            });\r\n\r\n            delete this.subscriptionIdToLocalKeyMap[server.subscriptionId];\r\n        });\r\n\r\n        subscription.trackedServers = [];\r\n\r\n        this.callOnClosedHandlers(subscription, ON_CLOSE_MSG_CLIENT_INIT);\r\n\r\n        delete this.subscriptionsList[subLocalKey];\r\n    }\r\n}\r\n","import ClientStreaming from \"./client-streaming\";\r\nimport {\r\n    CallMessage,\r\n    ErrorMessage,\r\n    MethodsAddedMessage,\r\n    MethodsRemovedMessage,\r\n    PeerAddedMessage,\r\n    PeerRemovedMessage,\r\n    ResultMessage,\r\n    MethodInfoMessage\r\n} from \"./messages\";\r\nimport { Glue42Core } from \"../../../../glue\";\r\nimport ClientRepository from \"../../client/repository\";\r\nimport { ClientMethodInfo, ServerInfo, ServerMethodsPair } from \"../../client/types\";\r\nimport { ClientProtocolDefinition, SubscribeError, SubscriptionInner } from \"../../types\";\r\nimport { InvokeResultMessage, InvokeStatus } from \"../../client/client\";\r\nimport { Logger } from \"../../../logger/logger\";\r\n\r\n/**\r\n * Handles session lifetime and events\r\n */\r\nexport default class ClientProtocol implements ClientProtocolDefinition {\r\n\r\n    private streaming: ClientStreaming;\r\n\r\n    constructor(private session: Glue42Core.Connection.GW3DomainSession, private repository: ClientRepository, private logger: Logger) {\r\n        session.on(\"peer-added\", (msg: PeerAddedMessage) => this.handlePeerAdded(msg));\r\n        session.on(\"peer-removed\", (msg: PeerRemovedMessage) => this.handlePeerRemoved(msg));\r\n        session.on(\"methods-added\", (msg: MethodsAddedMessage) => this.handleMethodsAddedMessage(msg));\r\n        session.on(\"methods-removed\", (msg: MethodsRemovedMessage) => this.handleMethodsRemovedMessage(msg));\r\n\r\n        this.streaming = new ClientStreaming(session, repository, logger);\r\n    }\r\n\r\n    public subscribe(stream: Glue42Core.AGM.MethodDefinition, options: Glue42Core.AGM.SubscriptionParams, targetServers: ServerMethodsPair[], success: (sub: Glue42Core.AGM.Subscription) => void, error: (err: SubscribeError) => void, existingSub: SubscriptionInner): void {\r\n        this.streaming.subscribe(stream, options, targetServers, success, error, existingSub);\r\n    }\r\n\r\n    public invoke(id: string, method: ClientMethodInfo, args: object, target: ServerInfo): Promise<InvokeResultMessage> {\r\n\r\n        const serverId = target.id;\r\n        const methodId = method.gatewayId;\r\n        const msg: CallMessage = {\r\n            type: \"call\",\r\n            server_id: serverId,\r\n            method_id: methodId,\r\n            arguments_kv: args,\r\n        };\r\n\r\n        // we transfer the invocation id as tag\r\n        return this.session.send<ResultMessage>(msg, { invocationId: id, serverId })\r\n            .then((m: ResultMessage) => this.handleResultMessage(m))\r\n            .catch((err) => this.handleInvocationError(err));\r\n    }\r\n\r\n    public drainSubscriptions(): SubscriptionInner[] {\r\n        return this.streaming.drainSubscriptions();\r\n    }\r\n\r\n    private handlePeerAdded(msg: PeerAddedMessage) {\r\n        const newPeerId = msg.new_peer_id;\r\n        const remoteId = msg.identity;\r\n        const isLocal = msg.meta ? msg.meta.local : true;\r\n        const pid = Number(remoteId.process);\r\n\r\n        const serverInfo: Glue42Core.AGM.Instance = {\r\n            machine: remoteId.machine,\r\n            pid: isNaN(pid) ? remoteId.process : pid,\r\n            instance: remoteId.instance,\r\n            application: remoteId.application,\r\n            applicationName: remoteId.applicationName,\r\n            environment: remoteId.environment,\r\n            region: remoteId.region,\r\n            user: remoteId.user,\r\n            windowId: remoteId.windowId,\r\n            peerId: newPeerId,\r\n            api: remoteId.api,\r\n            isLocal\r\n        };\r\n\r\n        this.repository.addServer(serverInfo, newPeerId);\r\n    }\r\n\r\n    private handlePeerRemoved(msg: PeerRemovedMessage) {\r\n        const removedPeerId = msg.removed_id;\r\n        const reason = msg.reason;\r\n\r\n        this.repository.removeServerById(removedPeerId, reason);\r\n    }\r\n\r\n    private handleMethodsAddedMessage(msg: MethodsAddedMessage) {\r\n        const serverId = msg.server_id;\r\n        const methods = msg.methods;\r\n\r\n        methods.forEach((method: MethodInfoMessage) => {\r\n            this.repository.addServerMethod(serverId, method);\r\n        });\r\n    }\r\n\r\n    private handleMethodsRemovedMessage(msg: MethodsRemovedMessage) {\r\n        const serverId = msg.server_id;\r\n        const methodIdList = msg.methods;\r\n\r\n        const server = this.repository.getServerById(serverId);\r\n        const serverMethodKeys = Object.keys(server.methods);\r\n\r\n        serverMethodKeys.forEach((methodKey) => {\r\n            const method = server.methods[methodKey];\r\n            if (methodIdList.indexOf(method.gatewayId) > -1) {\r\n                this.repository.removeServerMethod(serverId, methodKey);\r\n            }\r\n        });\r\n    }\r\n\r\n    private handleResultMessage(msg: ResultMessage): InvokeResultMessage {\r\n        const invocationId = msg._tag.invocationId;\r\n        const result = msg.result;\r\n        const serverId = msg._tag.serverId;\r\n        const server = this.repository.getServerById(serverId);\r\n\r\n        return {\r\n            invocationId,\r\n            result,\r\n            instance: server.instance,\r\n            status: InvokeStatus.Success,\r\n            message: \"\"\r\n        };\r\n    }\r\n\r\n    private handleInvocationError(msg: ErrorMessage | Error): InvokeResultMessage {\r\n        this.logger.debug(`handle invocation error ${JSON.stringify(msg)}`);\r\n\r\n        if (\"_tag\" in msg) {\r\n            const invocationId = msg._tag.invocationId;\r\n            const serverId = msg._tag.serverId;\r\n            const server = this.repository.getServerById(serverId);\r\n            const message = msg.reason;\r\n            const context = msg.context;\r\n\r\n            return {\r\n                invocationId,\r\n                result: context,\r\n                instance: server.instance,\r\n                status: InvokeStatus.Error,\r\n                message\r\n            };\r\n        } else {\r\n            return {\r\n                invocationId: \"\",\r\n                message: (msg as Error).message,\r\n                status: InvokeStatus.Error,\r\n                error: msg as Error\r\n            };\r\n        }\r\n    }\r\n}\r\n","import ServerProtocol from \"./server\";\r\nimport ClientProtocol from \"./client\";\r\nimport { Glue42Core } from \"../../../../glue\";\r\nimport ClientRepository from \"../../client/repository\";\r\nimport ServerRepository from \"../../server/repository\";\r\nimport Interop from \"../../interop\";\r\nimport { Protocol, InteropSettings } from \"../../types\";\r\nimport Connection from \"../../../connection/connection\";\r\n\r\nexport default function (instance: Glue42Core.AGM.Instance, connection: Connection, clientRepository: ClientRepository, serverRepository: ServerRepository, libConfig: InteropSettings, interop: Interop): Promise<Protocol> {\r\n    const logger = libConfig.logger.subLogger(\"gw3-protocol\");\r\n    let resolveReadyPromise: ((p: Protocol) => void) | undefined;\r\n\r\n    const readyPromise = new Promise<Protocol>((resolve) => {\r\n        resolveReadyPromise = resolve;\r\n    });\r\n\r\n    // start domain join handshake\r\n    const session = connection.domain(\"agm\", [\"subscribed\"]);\r\n\r\n    const server = new ServerProtocol(session, clientRepository, serverRepository, logger.subLogger(\"server\"));\r\n    const client = new ClientProtocol(session, clientRepository, logger.subLogger(\"client\"));\r\n\r\n    function handleReconnect() {\r\n        // we're reconnecting\r\n        logger.info(\"reconnected - will replay registered methods and subscriptions\");\r\n\r\n        const existingSubscriptions = client.drainSubscriptions();\r\n        for (const sub of existingSubscriptions) {\r\n            const methodInfo = sub.method;\r\n            const params = Object.assign({}, sub.params);\r\n            // remove handlers, otherwise they will be added twice\r\n            logger.info(`trying to re-subscribe to method ${methodInfo.name}`);\r\n            interop.client.subscribe(methodInfo, params, undefined, undefined, sub);\r\n        }\r\n\r\n        // server side\r\n        const registeredMethods = serverRepository.getList();\r\n        serverRepository.reset();\r\n\r\n        // replay server methods\r\n        for (const method of registeredMethods) {\r\n            const def = method.definition;\r\n            logger.info(`re-publishing method ${def.name}`);\r\n            if (method.stream) {\r\n                // streaming method\r\n                interop.server.createStream(def, method.streamCallbacks, undefined, undefined, method.stream);\r\n            } else if (method.theFunction && method.theFunction.userCallback) {\r\n                interop.register(def, method.theFunction.userCallback);\r\n            } else if (method.theFunction && method.theFunction.userCallbackAsync) {\r\n                interop.registerAsync(def, method.theFunction.userCallbackAsync);\r\n            }\r\n        }\r\n    }\r\n\r\n    function handleInitialJoin() {\r\n        if (resolveReadyPromise) {\r\n            resolveReadyPromise({\r\n                client,\r\n                server,\r\n            });\r\n\r\n            resolveReadyPromise = undefined;\r\n        }\r\n    }\r\n\r\n    session.onJoined((reconnect) => {\r\n        // add our server to the client repository\r\n        clientRepository.addServer(instance, connection.peerId);\r\n\r\n        if (reconnect) {\r\n            handleReconnect();\r\n        } else {\r\n            handleInitialJoin();\r\n        }\r\n    });\r\n\r\n    session.onLeft(() => {\r\n        // reset the client repository when the connection is down\r\n        clientRepository.reset();\r\n    });\r\n\r\n    session.join();\r\n\r\n    return readyPromise;\r\n}\r\n","import Client from \"./client/client\";\r\nimport Server from \"./server/server\";\r\nimport { Protocol, SubscribeError, InteropSettings } from \"./types\";\r\nimport { Glue42Core } from \"../../glue\";\r\nimport ClientRepository from \"./client/repository\";\r\nimport ServerRepository from \"./server/repository\";\r\nimport { UnsubscribeFunction } from \"callback-registry\";\r\nimport gW3ProtocolFactory from \"./protocols/gw3/factory\";\r\nimport { InstanceWrapper } from \"./instance\";\r\nimport { PromiseWrapper } from \"../utils/pw\";\r\n\r\nexport default class Interop implements Glue42Core.AGM.API {\r\n    public instance: Glue42Core.AGM.Instance;\r\n    public readyPromise: Promise<Interop>;\r\n\r\n    public client!: Client;\r\n    public server!: Server;\r\n    public unwrappedInstance: InstanceWrapper;\r\n    private protocol!: Protocol;\r\n    private clientRepository: ClientRepository;\r\n    private serverRepository: ServerRepository;\r\n\r\n    constructor(configuration: InteropSettings) {\r\n        if (typeof configuration === \"undefined\") {\r\n            throw new Error(\"configuration is required\");\r\n        }\r\n\r\n        if (typeof configuration.connection === \"undefined\") {\r\n            throw new Error(\"configuration.connections is required\");\r\n        }\r\n\r\n        const connection = configuration.connection;\r\n\r\n        if (typeof configuration.methodResponseTimeout !== \"number\") {\r\n            configuration.methodResponseTimeout = 30 * 1000;\r\n        }\r\n        if (typeof configuration.waitTimeoutMs !== \"number\") {\r\n            configuration.waitTimeoutMs = 30 * 1000;\r\n        }\r\n\r\n        // Initialize our modules\r\n        this.unwrappedInstance = new InstanceWrapper(this, undefined, connection);\r\n        this.instance = this.unwrappedInstance.unwrap();\r\n        this.clientRepository = new ClientRepository(configuration.logger.subLogger(\"cRep\"), this);\r\n        this.serverRepository = new ServerRepository();\r\n        let protocolPromise: Promise<Protocol>;\r\n\r\n        if (connection.protocolVersion === 3) {\r\n            protocolPromise = gW3ProtocolFactory(this.instance, connection, this.clientRepository, this.serverRepository, configuration, this);\r\n        } else {\r\n            throw new Error(`protocol ${connection.protocolVersion} not supported`);\r\n        }\r\n\r\n        // wait for protocol to resolve\r\n        this.readyPromise = protocolPromise.then((protocol: Protocol) => {\r\n            this.protocol = protocol;\r\n            this.client = new Client(this.protocol, this.clientRepository, this.instance, configuration);\r\n            this.server = new Server(this.protocol, this.serverRepository);\r\n            return this;\r\n        });\r\n    }\r\n\r\n    public ready() {\r\n        return this.readyPromise;\r\n    }\r\n\r\n    public serverRemoved(callback: (instance: Glue42Core.AGM.Instance, reason: string) => void): UnsubscribeFunction {\r\n        return this.client.serverRemoved(callback);\r\n    }\r\n\r\n    public serverAdded(callback: (instance: Glue42Core.AGM.Instance) => void): UnsubscribeFunction {\r\n        return this.client.serverAdded(callback);\r\n    }\r\n\r\n    public serverMethodRemoved(callback: (info: { server: Glue42Core.AGM.Instance; method: Glue42Core.AGM.Method; }) => void): UnsubscribeFunction {\r\n        return this.client.serverMethodRemoved(callback);\r\n    }\r\n\r\n    public serverMethodAdded(callback: (info: { server: Glue42Core.AGM.Instance; method: Glue42Core.AGM.Method; }) => void): UnsubscribeFunction {\r\n        return this.client.serverMethodAdded(callback);\r\n    }\r\n\r\n    public methodRemoved(callback: (def: Glue42Core.AGM.Method) => void): UnsubscribeFunction {\r\n        return this.client.methodRemoved(callback);\r\n    }\r\n\r\n    public methodAdded(callback: (def: Glue42Core.AGM.Method) => void): UnsubscribeFunction {\r\n        return this.client.methodAdded(callback);\r\n    }\r\n\r\n    public methodsForInstance(instance: Glue42Core.AGM.Instance): Glue42Core.Interop.Method[] {\r\n        return this.client.methodsForInstance(instance);\r\n    }\r\n\r\n    public methods(methodFilter: Glue42Core.AGM.MethodDefinition): Glue42Core.Interop.Method[] {\r\n        return this.client.methods(methodFilter);\r\n    }\r\n\r\n    public servers(methodFilter: Glue42Core.AGM.MethodDefinition): Glue42Core.AGM.Instance[] {\r\n        return this.client.servers(methodFilter);\r\n    }\r\n\r\n    public subscribe(method: string, options: Glue42Core.AGM.SubscriptionParams, successCallback?: (subscription: Glue42Core.AGM.Subscription) => void, errorCallback?: (err: SubscribeError) => void): Promise<Glue42Core.AGM.Subscription> {\r\n        return this.client.subscribe(method, options, successCallback, errorCallback);\r\n    }\r\n\r\n    public createStream(streamDef: string | Glue42Core.AGM.MethodDefinition, callbacks: Glue42Core.AGM.StreamOptions, successCallback?: (args?: object) => void, errorCallback?: (error?: string | object) => void): Promise<Glue42Core.AGM.Stream> {\r\n        return this.server.createStream(streamDef, callbacks, successCallback, errorCallback);\r\n    }\r\n\r\n    public unregister(methodFilter: string | Glue42Core.AGM.MethodDefinition): Promise<void> {\r\n        return this.server.unregister(methodFilter);\r\n    }\r\n\r\n    public registerAsync(methodDefinition: string | Glue42Core.AGM.MethodDefinition, callback: (args: any, caller: Glue42Core.AGM.Instance, successCallback: (args?: any) => void, errorCallback: (error?: string | object) => void) => void): Promise<void> {\r\n        return this.server.registerAsync(methodDefinition, callback);\r\n    }\r\n\r\n    public register(methodDefinition: string | Glue42Core.AGM.MethodDefinition, callback: (args: any, caller: Glue42Core.AGM.Instance) => any | Promise<void>): Promise<void> {\r\n        return this.server.register(methodDefinition, callback);\r\n    }\r\n\r\n    public invoke(methodFilter: string | Glue42Core.AGM.MethodDefinition, argumentObj?: object, target?: Glue42Core.AGM.InstanceTarget | Glue42Core.AGM.Instance | Glue42Core.AGM.Instance[], additionalOptions?: Glue42Core.AGM.InvokeOptions, success?: (result: Glue42Core.AGM.InvocationResult<any>) => void, error?: (error: { method: Glue42Core.AGM.MethodDefinition; called_with: object; executed_by: Glue42Core.AGM.Instance; message: string; status: number; returned: object; }) => void): Promise<Glue42Core.AGM.InvocationResult<any>> {\r\n        return this.client.invoke(methodFilter, argumentObj, target, additionalOptions, success, error);\r\n    }\r\n\r\n    public waitForMethod(name: string): Promise<Glue42Core.Interop.Method> {\r\n        const pw = new PromiseWrapper<Glue42Core.Interop.Method>();\r\n        const unsubscribe = this.client.methodAdded((m) => {\r\n            if (m.name === name) {\r\n                unsubscribe();\r\n                pw.resolve(m);\r\n            }\r\n        });\r\n\r\n        return pw.promise;\r\n    }\r\n}\r\n","import { Glue42Core } from \"../../glue\";\r\nimport Connection from \"../connection/connection\";\r\nimport { Logger } from \"../logger/logger\";\r\n\r\nexport interface BusSettings {\r\n    connection: Connection;\r\n    logger: Logger;\r\n}\r\ninterface SubscriptionEntry {\r\n    subscription_id: string;\r\n    topic: string;\r\n    callback: (data: object, topic: string, source: Glue42Core.Interop.Instance) => void;\r\n    source?: object;\r\n}\r\n\r\nconst successMessages = [\"subscribed\", \"success\"];\r\n\r\nexport class MessageBus implements Glue42Core.Bus.API {\r\n    public connection: Connection;\r\n    public logger: Logger;\r\n    public peerId: string;\r\n    public session: Glue42Core.Connection.GW3DomainSession;\r\n    public subscriptions: SubscriptionEntry[];\r\n    public readyPromise: Promise<object>;\r\n\r\n    constructor(connection: Connection, logger: Logger) {\r\n        this.connection = connection;\r\n        this.logger = logger;\r\n        this.peerId = connection.peerId;\r\n        this.subscriptions = [];\r\n        this.session = connection.domain(\"bus\", successMessages);\r\n        this.readyPromise = this.session.join();\r\n        this.readyPromise.then(() => {\r\n            this.watchOnEvent();\r\n        });\r\n    }\r\n\r\n    public ready() {\r\n        return this.readyPromise;\r\n    }\r\n\r\n    public publish = (topic: string, data: object, options?: Glue42Core.Bus.MessageOptions): void => {\r\n        const { routingKey, target } = options || {} as any;\r\n        const args = this.removeEmptyValues({\r\n            type: \"publish\",\r\n            topic,\r\n            data,\r\n            peer_id: this.peerId,\r\n            routing_key: routingKey,\r\n            target_identity: target\r\n        });\r\n        this.session.send(args);\r\n    }\r\n\r\n    public subscribe = (\r\n        topic: string,\r\n        callback: (data: object, topic: string, source: object) => void,\r\n        options?: Glue42Core.Bus.MessageOptions\r\n    ): Promise<Glue42Core.Bus.Subscription> => {\r\n        return new Promise((resolve, reject) => {\r\n            const { routingKey, target } = options || {} as any;\r\n            const args = this.removeEmptyValues({\r\n                type: \"subscribe\",\r\n                topic,\r\n                peer_id: this.peerId,\r\n                routing_key: routingKey,\r\n                source: target\r\n            });\r\n\r\n            this.session.send(args)\r\n                .then((response: any) => {\r\n                    const { subscription_id } = response;\r\n                    this.subscriptions.push({ subscription_id, topic, callback, source: target });\r\n\r\n                    resolve({\r\n                        unsubscribe: () => {\r\n                            this.session.send({ type: \"unsubscribe\", subscription_id, peer_id: this.peerId });\r\n                            this.subscriptions = this.subscriptions.filter((s) => s.subscription_id !== subscription_id);\r\n                            return Promise.resolve();\r\n                        }\r\n                    });\r\n                })\r\n                .catch((error: any) => reject(error));\r\n        });\r\n    }\r\n\r\n    public watchOnEvent = () => {\r\n        this.session.on(\"event\", (args: any) => {\r\n            const { data, subscription_id } = args;\r\n            const source = args[\"publisher-identity\"];\r\n            const subscription = this.subscriptions.find((s) => s.subscription_id === subscription_id);\r\n\r\n            if (subscription) {\r\n                if (!subscription.source) {\r\n                    subscription.callback(data, subscription.topic, source);\r\n                } else {\r\n                    if (this.keysMatch(subscription.source, source)) {\r\n                        subscription.callback(data, subscription.topic, source);\r\n                    }\r\n                }\r\n            }\r\n        });\r\n    }\r\n\r\n    private removeEmptyValues(obj: any) {\r\n        const cleaned: any = {};\r\n        Object.keys(obj).forEach((key) => {\r\n            if (obj[key] !== undefined && obj[key] !== null) {\r\n                cleaned[key] = obj[key];\r\n            }\r\n        });\r\n        return cleaned;\r\n    }\r\n\r\n    private keysMatch(obj1: any, obj2: any) {\r\n        const keysObj1 = Object.keys(obj1);\r\n        let allMatch = true;\r\n        keysObj1.forEach((key) => {\r\n            if (obj1[key] !== obj2[key]) {\r\n                allMatch = false;\r\n            }\r\n        });\r\n        return allMatch;\r\n    }\r\n}\r\n","import metrics from \"./metrics/main\";\r\nimport Connection from \"./connection/connection\";\r\nimport { Logger } from \"./logger/logger\";\r\nimport { Glue42Core } from \"../glue\";\r\nimport prepareConfig from \"./config\";\r\nimport timer, { getAllTimers } from \"./utils/timer\";\r\nimport Utils from \"./utils/utils\";\r\nimport { Timer } from \"./types\";\r\nimport { ContextsModule } from \"./contexts/contextsModule\";\r\nimport { ContextMessageReplaySpec } from \"./contexts/contextMessageReplaySpec\";\r\nimport { InteropSettings } from \"./interop/types\";\r\nimport Interop from \"./interop/interop\";\r\nimport { MessageBus } from \"./bus/main\";\r\nimport { version } from \"../package.json\";\r\nimport shortid from \"shortid\";\r\n\r\nconst GlueCore = (userConfig?: Glue42Core.Config, ext?: Glue42Core.Extension): Promise<Glue42Core.GlueCore> => {\r\n    const gdVersion: number | undefined = Utils.getGDMajorVersion();\r\n    let glue42gd: Glue42Core.GDObject | undefined;\r\n    let preloadPromise: Promise<any> = Promise.resolve();\r\n\r\n    if (gdVersion) {\r\n        if (gdVersion < 3) {\r\n            throw new Error(\"GD v2 is not supported. Use v4 of the API to run in that context.\");\r\n        } else if (gdVersion >= 3) {\r\n            glue42gd = window.glue42gd;\r\n            preloadPromise = window.gdPreloadPromise || preloadPromise;\r\n        }\r\n    }\r\n\r\n    const glueInitTimer = timer(\"glue\");\r\n\r\n    userConfig = userConfig || {};\r\n    ext = ext || {};\r\n    const internalConfig = prepareConfig(userConfig, ext, glue42gd);\r\n\r\n    // Init the GLUE namespace\r\n    let _connection: Connection;\r\n    let _interop: Interop;\r\n    let _logger: Logger;\r\n    let _metrics: Glue42Core.Metrics.API;\r\n    let _contexts: Glue42Core.Contexts.API;\r\n    let _bus: Glue42Core.Bus.API;\r\n    let _allowTrace: boolean; // true if trace logging is enabled\r\n\r\n    const libs: { [key: string]: any } = {};\r\n\r\n    function registerLib(name: string | string[], inner: any, t: Timer) {\r\n\r\n        _allowTrace = _logger.canPublish(\"trace\");\r\n        if (_allowTrace) {\r\n            _logger.trace(`registering ${name} module`);\r\n        }\r\n\r\n        const done = () => {\r\n            inner.initTime = t.stop();\r\n            inner.initEndTime = t.endTime;\r\n            inner.marks = t.marks;\r\n            if (_allowTrace) {\r\n                _logger.trace(`${name} is ready - ${t.endTime - t.startTime}`);\r\n            }\r\n        };\r\n\r\n        inner.initStartTime = t.startTime;\r\n        if (inner.ready) {\r\n            inner.ready().then(() => {\r\n                done();\r\n            });\r\n        } else {\r\n            done();\r\n        }\r\n\r\n        if (!Array.isArray(name)) {\r\n            name = [name];\r\n        }\r\n\r\n        name.forEach((n) => {\r\n            libs[n] = inner;\r\n            (GlueCore as any)[n] = inner;\r\n        });\r\n    }\r\n\r\n    function setupConnection(): Promise<object> {\r\n        const initTimer = timer(\"connection\");\r\n        _connection = new Connection(internalConfig.connection, _logger.subLogger(\"connection\"));\r\n\r\n        let authPromise: Promise<any> = Promise.resolve(internalConfig.auth);\r\n\r\n        // no auth - what we do in different protocol versions\r\n        if (internalConfig.connection && !internalConfig.auth) {\r\n            if (glue42gd) {\r\n                authPromise = glue42gd.getGWToken()\r\n                    .then((token) => {\r\n                        // initTimer.mark(\"got-gw-token\");\r\n                        return {\r\n                            gatewayToken: token\r\n                        };\r\n                    });\r\n            } else {\r\n                // assign to auth promise so we ca cleanup the connection\r\n                authPromise = Promise.reject(\"You need to provide auth information\");\r\n            }\r\n        }\r\n\r\n        return authPromise\r\n            .then((authConfig) => {\r\n                initTimer.mark(\"auth-promise-resolved\");\r\n                // convert the authConfig to AuthRequest object\r\n                let authRequest: Glue42Core.Auth;\r\n                if (Object.prototype.toString.call(authConfig) === \"[object Object]\") {\r\n                    authRequest = authConfig;\r\n                } else {\r\n                    throw new Error(\"Invalid auth object - \" + JSON.stringify(authConfig));\r\n                }\r\n                // do the login\r\n                return _connection.login(authRequest);\r\n            })\r\n            .then(() => {\r\n                registerLib(\"connection\", _connection, initTimer);\r\n                return internalConfig;\r\n            })\r\n            .catch((e) => {\r\n                if (_connection) {\r\n                    _connection.logout();\r\n                }\r\n                throw e;\r\n            });\r\n    }\r\n\r\n    function setupLogger(): Promise<void> {\r\n        // Logger\r\n        const initTimer = timer(\"logger\");\r\n        _logger = new Logger(`${internalConfig.connection.identity?.application}`, undefined, internalConfig.customLogger);\r\n        _logger.consoleLevel(internalConfig.logger.console);\r\n        _logger.publishLevel(internalConfig.logger.publish);\r\n\r\n        if (_logger.canPublish(\"debug\")) {\r\n            _logger.debug(\"initializing glue...\");\r\n        }\r\n        registerLib(\"logger\", _logger, initTimer);\r\n\r\n        return Promise.resolve(undefined);\r\n    }\r\n\r\n    function setupMetrics(): Promise<void> {\r\n        const initTimer = timer(\"metrics\");\r\n        const config = internalConfig.metrics;\r\n\r\n        const metricsPublishingEnabledFunc = glue42gd?.getMetricsPublishingEnabled;\r\n        const identity = internalConfig.connection.identity;\r\n        const canUpdateMetric = metricsPublishingEnabledFunc ? metricsPublishingEnabledFunc : () => true;\r\n        const disableAutoAppSystem: boolean = (typeof config !== \"boolean\" && config.disableAutoAppSystem) ?? false;\r\n        _metrics = metrics({\r\n            connection: config ? _connection : undefined,\r\n            logger: _logger.subLogger(\"metrics\"),\r\n            canUpdateMetric,\r\n            system: \"Glue42\",\r\n            service: identity?.service ?? glue42gd?.applicationName ?? internalConfig.application,\r\n            instance: identity?.instance ?? identity?.windowId ?? shortid(),\r\n            disableAutoAppSystem,\r\n            pagePerformanceMetrics: typeof config !== \"boolean\" ? config?.pagePerformanceMetrics : undefined\r\n        });\r\n\r\n        registerLib(\"metrics\", _metrics, initTimer);\r\n        return Promise.resolve();\r\n    }\r\n\r\n    function setupInterop(): Promise<void> {\r\n        const initTimer = timer(\"interop\");\r\n\r\n        const agmConfig: InteropSettings = {\r\n            connection: _connection,\r\n            logger: _logger.subLogger(\"interop\"),\r\n        };\r\n\r\n        _interop = new Interop(agmConfig);\r\n        Logger.Interop = _interop;\r\n        registerLib([\"interop\", \"agm\"], _interop, initTimer);\r\n        return Promise.resolve();\r\n    }\r\n\r\n    function setupContexts() {\r\n        const hasActivities = ((internalConfig as any).activities && _connection.protocolVersion === 3);\r\n        const needsContexts = internalConfig.contexts || hasActivities;\r\n        if (needsContexts) {\r\n            const initTimer = timer(\"contexts\");\r\n\r\n            _contexts = new ContextsModule({\r\n                connection: _connection,\r\n                logger: _logger.subLogger(\"contexts\")\r\n            });\r\n            registerLib(\"contexts\", _contexts, initTimer);\r\n            return _contexts;\r\n\r\n            // NB: The shared contexts data is part of the global domain,\r\n            // which is joined implicitly and there is no 'Success' message\r\n            // to indicate that the initial state has arrived.\r\n            // We're relying on the fact that none of the other Glue libs\r\n            // rely on the shared contexts' state, and that the 'contexts'\r\n            // lib is created first so any other domain's success message\r\n            // will arrive after our state, so the contexts will be visible\r\n            // when the Glue promise resolves.\r\n        } else {\r\n            const replayer = _connection.replayer;\r\n            if (replayer) {\r\n                replayer.drain(ContextMessageReplaySpec.name);\r\n            }\r\n        }\r\n    }\r\n\r\n    async function setupBus(): Promise<void> {\r\n        if (!internalConfig.bus) {\r\n            return Promise.resolve();\r\n        }\r\n\r\n        const initTimer = timer(\"bus\");\r\n        _bus = new MessageBus(_connection, _logger.subLogger(\"bus\"));\r\n        registerLib(\"bus\", _bus, initTimer);\r\n        return Promise.resolve();\r\n    }\r\n\r\n    function setupExternalLibs(externalLibs: Glue42Core.ExternalLib[]): Promise<any> {\r\n        try {\r\n            externalLibs.forEach((lib) => {\r\n                setupExternalLib(lib.name, lib.create);\r\n            });\r\n\r\n            return Promise.resolve();\r\n        } catch (e) {\r\n            return Promise.reject(e);\r\n        }\r\n    }\r\n\r\n    function setupExternalLib(name: string, createCallback: (core: any) => any) {\r\n        const initTimer = timer(name);\r\n        const lib = createCallback(libs);\r\n        if (lib) {\r\n            registerLib(name, lib, initTimer);\r\n        }\r\n    }\r\n\r\n    function waitForLibs(): Promise<object[]> {\r\n        // get all libs that have ready promises and wait for these to be ready\r\n        const libsReadyPromises = Object.keys(libs).map((key) => {\r\n            const lib = libs[key];\r\n            return lib.ready ?\r\n                lib.ready() : Promise.resolve();\r\n        });\r\n\r\n        return Promise.all(libsReadyPromises);\r\n    }\r\n\r\n    function constructGlueObject(): Glue42Core.GlueCore {\r\n\r\n        const feedbackFunc = (feedbackInfo?: Glue42Core.FeedbackInfo) => {\r\n            if (!_interop) {\r\n                return;\r\n            }\r\n            _interop.invoke(\"T42.ACS.Feedback\", feedbackInfo, \"best\");\r\n        };\r\n\r\n        const info: { [key: string]: any } = {\r\n            coreVersion: version,\r\n            version: internalConfig.version\r\n        };\r\n\r\n        glueInitTimer.stop();\r\n\r\n        const glue: Glue42Core.GlueCore & ({ [key: string]: any }) = {\r\n            feedback: feedbackFunc,\r\n            info,\r\n            logger: _logger,\r\n            interop: _interop,\r\n            agm: _interop,\r\n            connection: _connection,\r\n            metrics: _metrics,\r\n            contexts: _contexts,\r\n            bus: _bus,\r\n            version: internalConfig.version,\r\n            userConfig,\r\n            done: () => {\r\n                _logger?.info(`done called by user...`);\r\n                return _connection.logout();\r\n            }\r\n        };\r\n\r\n        // ver performance\r\n        glue.performance = {\r\n            get glueVer() {\r\n                return internalConfig.version;\r\n            },\r\n            get glueConfig() {\r\n                return JSON.stringify(userConfig);\r\n            },\r\n            get browser() {\r\n                return window.performance.timing.toJSON();\r\n            },\r\n            get memory() {\r\n                return (window as any).performance.memory;\r\n            },\r\n            get initTimes() {\r\n                const all = getAllTimers();\r\n                return Object.keys(all).map((key) => {\r\n                    const t = all[key];\r\n                    return {\r\n                        name: key,\r\n                        duration: t.endTime - t.startTime,\r\n                        marks: t.marks,\r\n                        startTime: t.startTime,\r\n                        endTime: t.endTime\r\n                    };\r\n                });\r\n            }\r\n        };\r\n\r\n        // attach each lib to glue\r\n        Object.keys(libs).forEach((key) => {\r\n            const lib = libs[key];\r\n            glue[key] = lib;\r\n        });\r\n\r\n        // construct the config object to be exposed to end user\r\n        // transfer config keys from internalConfig and then ext\r\n        glue.config = {};\r\n\r\n        Object.keys(internalConfig).forEach((k) => {\r\n            glue.config[k] = (internalConfig as any)[k];\r\n        });\r\n\r\n        if (ext && ext.extOptions) {\r\n            Object.keys(ext.extOptions).forEach((k) => {\r\n                glue.config[k] = ext?.extOptions[k];\r\n            });\r\n        }\r\n\r\n        if (ext?.enrichGlue) {\r\n            ext.enrichGlue(glue);\r\n        }\r\n\r\n        if (glue42gd && glue42gd.updatePerfData) {\r\n            glue42gd.updatePerfData(glue.performance);\r\n        }\r\n\r\n        if (glue.agm) {\r\n            const deprecatedDecorator = (fn: any, wrong: string, proper: string) => {\r\n                // tslint:disable-next-line:only-arrow-functions\r\n                return function () {\r\n                    // tslint:disable-next-line:no-console\r\n                    glue.logger.warn(`glue.js - 'glue.agm.${wrong}' method is deprecated, use 'glue.interop.${proper}' instead.`);\r\n                    return fn.apply(glue.agm, arguments);\r\n                };\r\n            };\r\n            // extend glue.agm with legacy support\r\n            const agmAny: any = glue.agm;\r\n            agmAny.method_added = deprecatedDecorator(glue.agm.methodAdded, \"method_added\", \"methodAdded\");\r\n            agmAny.method_removed = deprecatedDecorator(glue.agm.methodRemoved, \"method_removed\", \"methodRemoved\");\r\n            agmAny.server_added = deprecatedDecorator(glue.agm.serverAdded, \"server_added\", \"serverAdded\");\r\n            agmAny.server_method_aded = deprecatedDecorator(glue.agm.serverMethodAdded, \"server_method_aded\", \"serverMethodAdded\");\r\n            agmAny.server_method_removed = deprecatedDecorator(glue.agm.serverMethodRemoved, \"server_method_removed\", \"serverMethodRemoved\");\r\n        }\r\n        return glue;\r\n    }\r\n\r\n    return preloadPromise\r\n        .then(setupLogger)\r\n        .then(setupConnection)\r\n        .then(() => Promise.all([setupMetrics(), setupInterop(), setupContexts(), setupBus()]))\r\n        .then(() => _interop.readyPromise)\r\n        .then(() => {\r\n            return setupExternalLibs(internalConfig.libs || []);\r\n        })\r\n        .then(waitForLibs)\r\n        .then(constructGlueObject)\r\n        .catch((err) => {\r\n            // if there is some some error include the libs object for debugging purposes\r\n            return Promise.reject({\r\n                err,\r\n                libs\r\n            });\r\n        });\r\n};\r\n\r\nif (typeof window !== \"undefined\") {\r\n    (window as any).GlueCore = GlueCore;\r\n}\r\n(GlueCore as any).version = version;\r\n// add default library for ES6 modules\r\n(GlueCore as any).default = GlueCore;\r\n\r\nexport default GlueCore;\r\n"],"names":["metricTypes","CallbackRegistryFactory","setSeed","randomByte","alphabet","encode","decode","require$$0","generate","CallbackFactory","msg.GW_MESSAGE_CREATE_CONTEXT","msg.GW_MESSAGE_ACTIVITY_CREATED","msg.GW_MESSAGE_ACTIVITY_DESTROYED","msg.GW_MESSAGE_CONTEXT_CREATED","msg.GW_MESSAGE_CONTEXT_ADDED","msg.GW_MESSAGE_SUBSCRIBE_CONTEXT","msg.GW_MESSAGE_SUBSCRIBED_CONTEXT","msg.GW_MESSAGE_UNSUBSCRIBE_CONTEXT","msg.GW_MESSAGE_DESTROY_CONTEXT","msg.GW_MESSAGE_CONTEXT_DESTROYED","msg.GW_MESSAGE_UPDATE_CONTEXT","msg.GW_MESSAGE_CONTEXT_UPDATED","msg.GW_MESSAGE_JOINED_ACTIVITY","pjsonVersion","ContextData","random","ServerStreaming"],"mappings":"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"}
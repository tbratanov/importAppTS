!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):((t="undefined"!=typeof globalThis?globalThis:t||self).desktop=t.desktop||{},t.desktop.min=e())}(this,(function(){"use strict";var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(e,n)};function e(e,n){function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}var n=function(){return(n=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};function i(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function a(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){t.done?r(t.value):new n((function(e){e(t.value)})).then(s,a)}c((i=i.apply(t,e||[])).next())}))}function r(t,e){var n,i,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(r=2&o[0]?i.return:o[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,o[1])).done)return r;switch(i=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,i=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],i=0}finally{n=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}function o(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var i=Array(t),r=0;for(e=0;e<n;e++)for(var o=arguments[e],s=0,a=o.length;s<a;s++,r++)i[r]=o[s];return i}var s=function(t,e){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function a(t,e){function n(){this.constructor=t}s(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var c=function(){return(c=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};function u(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function a(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){t.done?r(t.value):new n((function(e){e(t.value)})).then(s,a)}c((i=i.apply(t,e||[])).next())}))}function d(t,e){var n,i,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(r=2&o[0]?i.return:o[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,o[1])).done)return r;switch(i=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,i=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],i=0}finally{n=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}function p(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var i=Array(t),r=0;for(e=0;e<n;e++)for(var o=arguments[e],s=0,a=o.length;s<a;s++,r++)i[r]=o[s];return i}var h=1,l=2,f=3,g=4;function y(t){return t.type===f?"timestamp":t.type===l?"number":t.type===h?"string":t.type===g?"object":"unknown"}function v(t){return t.constructor===Date?"timestamp":"number"==typeof t?"number":"string"==typeof t?"string":"object"==typeof t?"object":"string"}function m(t){var e={},n=y(t);if("object"===n){var i=Object.keys(t.value).reduce((function(e,n){var i=v(t.value[n]);if("object"===i){var r=function t(e){return Object.keys(e).reduce((function(n,i){var r=v(e[i]);return n[i]="object"===r?{type:"object",description:"",context:{},composite:t(e[i])}:{type:r,description:"",context:{}},n}),{})}(t.value[n]);e[n]={type:"object",description:"",context:{},composite:r}}else e[n]={type:i,description:"",context:{}};return e}),{});e.composite=i}return e.name=w(t.path.join("/")+"/"+t.name),e.type=n,e.description=t.description,e.context={},e}function w(t){return void 0!==t&&t.length>0&&"/"!==t[0]?"/"+t:t}function b(t){return"timestamp"===y(t)?Date.now():function t(e){if("object"!=typeof e)return e;return Object.keys(e).reduce((function(n,i){var r=e[i];return"object"==typeof r&&r.constructor!==Date?n[i]=t(r):r.constructor===Date?n[i]=new Date(r).getTime():r.constructor===Boolean?n[i]=r.toString():n[i]=r,n}),{})}(t.value)}function _(t){var e=function t(e){return e.reduce((function(e,n){return e.concat(Array.isArray(n)?t(n):n)}),[])}(t.root.getAggregateState()),n=e.sort((function(t,e){return t.state?e.state?e.state-t.state:-1:1}))[0];return{description:function(t){var e="";return t.forEach((function(t,n,i){var r=t.path.join(".");n===i.length-1?e+=r+"."+t.name+": "+t.description:e+=r+"."+t.name+": "+t.description+","})),e.length>100?e.slice(0,100)+"...":e}(e),value:n.state}}var I=function(t,e,n){if(null===t||"object"!=typeof t)throw new Error("Missing definition");if(null===e||"object"!=typeof e)throw new Error("Missing parent");if(null===n||"object"!=typeof n)throw new Error("Missing transport")},C=function(){function t(t,e,n,i,r){this.definition=t,this.system=e,this.transport=n,this.value=i,this.type=r,this.path=[],I(t,e,n),this.path=e.path.slice(0),this.path.push(e.name),this.name=t.name,this.description=t.description,n.createMetric(this)}return Object.defineProperty(t.prototype,"repo",{get:function(){var t;return null===(t=this.system)||void 0===t?void 0:t.repo},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"id",{get:function(){return this.system.path+"/"+name},enumerable:!0,configurable:!0}),t.prototype.update=function(t){return this.value=t,this.transport.updateMetric(this)},t}(),A=function(t){function e(e,n,i,r){return t.call(this,e,n,i,r,l)||this}return a(e,t),e.prototype.incrementBy=function(t){this.update(this.value+t)},e.prototype.increment=function(){this.incrementBy(1)},e.prototype.decrement=function(){this.incrementBy(-1)},e.prototype.decrementBy=function(t){this.incrementBy(-1*t)},e}(C),T=function(t){function e(e,n,i,r){return t.call(this,e,n,i,r,g)||this}return a(e,t),e.prototype.update=function(t){return this.mergeValues(t),this.transport.updateMetric(this)},e.prototype.mergeValues=function(t){var e=this;return Object.keys(this.value).forEach((function(n){void 0!==t[n]&&(e.value[n]=t[n])}))},e}(C),k=function(t){function e(e,n,i,r){return t.call(this,e,n,i,r,h)||this}return a(e,t),e}(C),S=function(t){function e(e,n,i,r){return t.call(this,e,n,i,r,f)||this}return a(e,t),e.prototype.now=function(){this.update(new Date)},e}(C);var x=function(){function t(t,e){e.init(this),this.root=function t(e,n,i,r,o){if(!n)throw new Error("Repository is required");if(!i)throw new Error("Transport is required");var s,a,c=i,u=e,d=o||"",p=n,y=r,v=function t(e){if(!e||!e.parent)return[];var n=t(e.parent);return n.push(e.name),n}(r),m={},w=(a="/",((s=v)&&s.length>0?s.join(a):"")+e),b=n.root,_=[],I=[];function C(t,e,n,i){var r={name:""};r="string"==typeof t?{name:t}:t;var o=I.filter((function(t){return t.name===r.name}));if(o.length>0){var s=o[0];if(s.type!==e)throw new Error("A metric named "+r.name+" is already defined with different type.");return void 0!==n&&s.update(n).catch((function(){})),s}var a=i(r);return I.push(a),a}var x={get name(){return u},get description(){return d},get repo(){return p},get parent(){return y},path:v,id:w,root:b,get subSystems(){return _},get metrics(){return I},subSystem:function(e,n){if(!e||0===e.length)throw new Error("name is required");var i=_.filter((function(t){return t.name===e}));if(i.length>0)return i[0];var r=t(e,p,c,x,n);return _.push(r),r},getState:function(){return m},setState:function(t,e){m={state:t,description:e},c.updateSystem(x,m)},stringMetric:function(t,e){return C(t,h,e,(function(t){return new k(t,x,c,e)}))},timestampMetric:function(t,e){return C(t,f,e,(function(t){return new S(t,x,c,e)}))},objectMetric:function(t,e){return C(t,g,e,(function(t){return new T(t,x,c,e)}))},numberMetric:function(t,e){return C(t,l,e,(function(t){return new A(t,x,c,e)}))},getAggregateState:function(){var t=[];return Object.keys(m).length>0&&t.push({name:u,path:v,state:m.state,description:m.description}),_.forEach((function(e){var n=e.getAggregateState();n.length>0&&t.push.apply(t,n)})),t}};return c.createSystem(x),x}("",this,e),this.addSystemMetrics(this.root,t.clickStream||void 0===t.clickStream)}return t.prototype.addSystemMetrics=function(t,e){if("undefined"!=typeof navigator&&t.stringMetric("UserAgent",navigator.userAgent),e&&"undefined"!=typeof document){var n=t.subSystem("ClickStream"),i=function(t){if(t.target){var e=t.target;n.objectMetric("LastBrowserEvent",{type:"click",timestamp:new Date,target:{className:t.target?e.className:"",id:e.id,type:"<"+e.tagName.toLowerCase()+">",href:e.href||""}})}};n.objectMetric("Page",{title:document.title,page:window.location.href}),document.addEventListener?document.addEventListener("click",i):document.attachEvent("onclick",i)}t.stringMetric("StartTime",(new Date).toString());var r=t.stringMetric("StartURL",""),o=t.stringMetric("AppName","");if("undefined"!=typeof window){if(void 0!==window.location){var s=window.location.href;r.update(s)}void 0!==window.glue42gd&&o.update(window.glue42gd.appName)}},t}(),P=function(){function t(){}return t.prototype.init=function(t){},t.prototype.createSystem=function(t){return Promise.resolve()},t.prototype.updateSystem=function(t,e){return Promise.resolve()},t.prototype.createMetric=function(t){return Promise.resolve()},t.prototype.updateMetric=function(t){return Promise.resolve()},t}(),M=function(){function t(t,e,n){this.api=t,this.lastCount=0,this.initialPublishTimeout=1e4,this.publishInterval=6e4,this.initialPublishTimeout=null!=e?e:this.initialPublishTimeout,this.publishInterval=null!=n?n:this.publishInterval,this.scheduleCollection(),this.system=this.api.subSystem("performance","Performance data published by the web application")}return t.prototype.scheduleCollection=function(){var t=this;setTimeout((function(){t.collect(),setInterval((function(){t.collect()}),t.publishInterval)}),this.initialPublishTimeout)},t.prototype.collect=function(){try{this.collectMemory(),this.collectEntries()}catch(t){}},t.prototype.collectMemory=function(){var t=window.performance.memory;this.system.stringMetric("memory",JSON.stringify({totalJSHeapSize:t.totalJSHeapSize,usedJSHeapSize:t.usedJSHeapSize}))},t.prototype.collectEntries=function(){var t=window.performance.getEntries();if(!(t.length<=this.lastCount)){this.lastCount=t.length;var e=t.map((function(t){return t.toJSON()}));this.system.stringMetric("entries",JSON.stringify(e))}},t}(),E=function(t){var e;e=t.connection&&"object"==typeof t.connection?function(t,e){var n,i,r=this;if(!t||"object"!=typeof t)throw new Error("Connection is required parameter");var o=function(t){s(t.root)},s=function(t){a(t),t.metrics.forEach((function(t){p(t)})),t.subSystems.forEach((function(t){s(t)}))},a=function(t){return u(r,void 0,void 0,(function(){var e,r;return d(this,(function(o){switch(o.label){case 0:return void 0===t.parent?[2]:[4,n];case 1:return o.sent(),e={name:w(t.path.join("/")+"/"+t.name+"/State"),type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}},r={type:"define",metrics:[e]},i.send(r),[2]}}))}))},p=function(t){return u(r,void 0,void 0,(function(){var e,r,o;return d(this,(function(s){switch(s.label){case 0:return e=l(t),[4,n];case 1:return s.sent(),r=m(e),o={type:"define",metrics:[r]},i.send(o),void 0!==e.value&&h(e),[2]}}))}))},h=function(t){if(f()){var e=b(t),n={type:"publish",values:[{name:w(t.path.join("/")+"/"+t.name),value:e,timestamp:Date.now()}]};return i.sendFireAndForget(n)}return Promise.resolve()},l=function(t){var e=c({},t);return"object"==typeof t.value&&null!==t.value&&(e.value=c({},t.value)),e},f=function(){var t;try{return(null!==(t=e.canUpdateMetric)&&void 0!==t?t:function(){return!0})()}catch(t){return!0}};return{init:function(r){var s;n=new Promise((function(t){s=t})),(i=t.domain("metrics")).onJoined((function(t){!t&&s&&(s(),s=void 0);var e={type:"define",metrics:[{name:"/State",type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};i.send(e),t&&o(r)})),i.join({system:e.system,service:e.service,instance:e.instance})},createSystem:a,updateSystem:function(e,o){return u(r,void 0,void 0,(function(){var r,s,a;return d(this,(function(c){switch(c.label){case 0:return[4,n];case 1:return c.sent(),r={type:"publish",values:[{name:w(e.path.join("/")+"/"+e.name+"/State"),value:{Description:o.description,Value:o.state},timestamp:Date.now()}]},i.send(r),s=_(e),a={type:"publish",peer_id:t.peerId,values:[{name:"/State",value:{Description:s.description,Value:s.value},timestamp:Date.now()}]},i.send(a),[2]}}))}))},createMetric:p,updateMetric:function(t){return u(r,void 0,void 0,(function(){var e;return d(this,(function(i){switch(i.label){case 0:return e=l(t),[4,n];case 1:return i.sent(),h(e),[2]}}))}))}}}(t.connection,t):new P;var n=new x(t,e).root;t.disableAutoAppSystem||(n=n.subSystem("App"));var i=function(t){var e,n=t.subSystem("reporting"),i={name:"features"},r=function(t,r,o){if(void 0===t||""===t)throw new Error("name is mandatory");if(void 0===r||""===r)throw new Error("action is mandatory");if(void 0===o||""===o)throw new Error("payload is mandatory");e?e.update({name:t,action:r,payload:o}):e=n.objectMetric(i,{name:t,action:r,payload:o})};return t.featureMetric=r,t}(n);return function(t,e){var n,i;if("undefined"==typeof window)return;var r=null===(i=null===(n=null===window||void 0===window?void 0:window.glue42gd)||void 0===n?void 0:n.metrics)||void 0===i?void 0:i.pagePerformanceMetrics;r&&(e=r);(null==e?void 0:e.enabled)&&new M(t,e.initialPublishTimeout,e.publishInterval)}(i,t.pagePerformanceMetrics),i};function j(t){if(t&&t.errorHandling&&"function"!=typeof t.errorHandling&&"log"!==t.errorHandling&&"silent"!==t.errorHandling&&"throw"!==t.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof t.errorHandling+" was passed");var e=t&&"function"==typeof t.errorHandling&&t.errorHandling,n={};function i(n,i){var r=n instanceof Error?n:new Error(n);if(e)e(r);else{var o='[ERROR] callback-registry: User callback for key "'+i+'" failed: '+r.stack;if(t)switch(t.errorHandling){case"log":return console.error(o);case"silent":return;case"throw":throw new Error(o)}console.error(o)}}return{add:function(t,e,r){var o=n[t];return o||(o=[],n[t]=o),o.push(e),r&&setTimeout((function(){r.forEach((function(r){var o;if(null===(o=n[t])||void 0===o?void 0:o.includes(e))try{Array.isArray(r)?e.apply(void 0,r):e.apply(void 0,[r])}catch(e){i(e,t)}}))}),0),function(){var i=n[t];i&&(0===(i=i.reduce((function(t,n,i){return n===e&&t.length===i||t.push(n),t}),[])).length?delete n[t]:n[t]=i)}},execute:function(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];var o=n[t];if(!o||0===o.length)return[];var s=[];return o.forEach((function(n){try{var r=n.apply(void 0,e);s.push(r)}catch(e){s.push(void 0),i(e,t)}})),s},clear:function(){n={}},clearKey:function(t){n[t]&&delete n[t]}}}j.default=j;var O=j,W=function(){function t(t,e){var n=this;this.registry=O(),this.gw=t.facade,this.gw.connect((function(t,e){n.messageHandler(e)})).then((function(t){n.client=t}))}return Object.defineProperty(t.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),t.prototype.sendObject=function(t){return this.client?(this.client.send(t),Promise.resolve(void 0)):Promise.reject("not connected")},t.prototype.send=function(t){return Promise.reject("not supported")},t.prototype.onMessage=function(t){return this.registry.add("onMessage",t)},t.prototype.onConnectedChanged=function(t){t(!0)},t.prototype.close=function(){return Promise.resolve()},t.prototype.open=function(){return Promise.resolve()},t.prototype.name=function(){return"in-memory"},t.prototype.reconnect=function(){return Promise.resolve()},t.prototype.messageHandler=function(t){this.registry.execute("onMessage",t)},t}(),R=function(){function t(t,e){var n=this;this.logger=e,this.registry=O(),this.worker=new SharedWorker(t),this.worker.port.onmessage=function(t){n.messageHandler(t.data)}}return Object.defineProperty(t.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),t.prototype.sendObject=function(t){return this.worker.port.postMessage(t),Promise.resolve()},t.prototype.send=function(t){return Promise.reject("not supported")},t.prototype.onMessage=function(t){return this.registry.add("onMessage",t)},t.prototype.onConnectedChanged=function(t){t(!0)},t.prototype.close=function(){return Promise.resolve()},t.prototype.open=function(){return Promise.resolve()},t.prototype.name=function(){return"shared-worker"},t.prototype.reconnect=function(){return Promise.resolve()},t.prototype.messageHandler=function(t){this.registry.execute("onMessage",t)},t}(),F=function(){function t(){}return t.getGDMajorVersion=function(){if("undefined"!=typeof window&&window.glueDesktop&&window.glueDesktop.version){var t=Number(window.glueDesktop.version.substr(0,1));return isNaN(t)?void 0:t}},t.isNode=function(){if(void 0!==t._isNode)return t._isNode;if("undefined"!=typeof window)return t._isNode=!1,!1;try{t._isNode="[object process]"===Object.prototype.toString.call(global.process)}catch(e){t._isNode=!1}return t._isNode},t}(),N=function(){function t(){var t=this;this.rejected=!1,this.resolved=!1,this.promise=new Promise((function(e,n){t.resolve=function(n){t.resolved=!0,e(n)},t.reject=function(e){t.rejected=!0,n(e)}}))}return t.delay=function(t){return new Promise((function(e){return setTimeout(e,t)}))},Object.defineProperty(t.prototype,"ended",{get:function(){return this.rejected||this.resolved},enumerable:!0,configurable:!0}),t}(),L={};function D(t){var e=L[t];if(e)return e;var n=[];function i(){return(new Date).getTime()}var r,o,s=i();function a(t,e){var r=null!=e?e:i(),o=0;n.length>0&&(o=r-n[n.length-1].time),n.push({name:t,time:r,diff:o})}a("start",s);var c={get startTime(){return s},get endTime(){return r},get period(){return o},stop:function(){return a("end",r=i()),o=r-s},mark:a,marks:n};return L[t]=c,c}var G=F.isNode()?require("ws"):window.WebSocket,B=function(){function t(t,e){if(this.startupTimer=D("connection"),this._running=!0,this._registry=O(),this.wsRequests=[],this.settings=t,this.logger=e,!this.settings.ws)throw new Error("ws is missing")}return t.prototype.onMessage=function(t){return this._registry.add("onMessage",t)},t.prototype.send=function(t,e){var n=this;return new Promise((function(e,i){n.waitForSocketConnection((function(){var r;try{null===(r=n.ws)||void 0===r||r.send(t),e()}catch(t){i(t)}}),i)}))},t.prototype.open=function(){var t=this;return this.logger.info("opening ws..."),this._running=!0,new Promise((function(e,n){t.waitForSocketConnection(e,n)}))},t.prototype.close=function(){return this._running=!1,this.ws&&this.ws.close(),Promise.resolve()},t.prototype.onConnectedChanged=function(t){return this._registry.add("onConnectedChanged",t)},t.prototype.name=function(){return"ws "+this.settings.ws},t.prototype.reconnect=function(){var t;null===(t=this.ws)||void 0===t||t.close();var e=new N;return this.waitForSocketConnection((function(){e.resolve()})),e.promise},t.prototype.waitForSocketConnection=function(t,e){var n;e=null!=e?e:function(){},this._running?1!==(null===(n=this.ws)||void 0===n?void 0:n.readyState)?(this.wsRequests.push({callback:t,failed:e}),this.wsRequests.length>1||this.openSocket()):t():e("wait for socket on "+this.settings.ws+" failed - socket closed by user")},t.prototype.openSocket=function(t,e){return u(this,void 0,void 0,(function(){var n=this;return d(this,(function(i){switch(i.label){case 0:if(this.startupTimer.mark("opening-socket"),void 0===t&&(t=this.settings.reconnectInterval),void 0!==e){if(0===e)return this.notifyForSocketState("wait for socket on "+this.settings.ws+" failed - no more retries left"),[2];this.logger.debug("will retry "+e+" more times (every "+t+" ms)")}i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this.initiateSocket()];case 2:return i.sent(),this.startupTimer.mark("socket-initiated"),this.notifyForSocketState(),[3,4];case 3:return i.sent(),setTimeout((function(){var i=void 0===e?void 0:e-1;n.openSocket(t,i)}),t),[3,4];case 4:return[2]}}))}))},t.prototype.initiateSocket=function(){var t=this,e=new N;return this.logger.debug("initiating ws to "+this.settings.ws+"..."),this.ws=new G(this.settings.ws||""),this.ws.onerror=function(n){var i="";try{i=JSON.stringify(n)}catch(t){var r=new WeakSet;i=JSON.stringify(n,(function(t,e){if("object"==typeof e&&null!==e){if(r.has(e))return;r.add(e)}return e}))}e.reject("error"),t.notifyStatusChanged(!1,i)},this.ws.onclose=function(n){t.logger.info("ws closed "+n),e.reject("closed"),t.notifyStatusChanged(!1)},this.ws.onopen=function(){var n;t.startupTimer.mark("ws-opened"),t.logger.info("ws opened "+(null===(n=t.settings.identity)||void 0===n?void 0:n.application)),e.resolve(),t.notifyStatusChanged(!0)},this.ws.onmessage=function(e){t._registry.execute("onMessage",e.data)},e.promise},t.prototype.notifyForSocketState=function(t){this.wsRequests.forEach((function(e){t?e.failed&&e.failed(t):e.callback()})),this.wsRequests=[]},t.prototype.notifyStatusChanged=function(t,e){this._registry.execute("onConnectedChanged",t,e)},t}();var H=1;var q,U,V,z={nextValue:function(){return(H=(9301*H+49297)%233280)/233280},seed:function(t){H=t}},J="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function K(){V=!1}function Z(t){if(t){if(t!==q){if(t.length!==J.length)throw new Error("Custom alphabet for shortid must be "+J.length+" unique characters. You submitted "+t.length+" characters: "+t);var e=t.split("").filter((function(t,e,n){return e!==n.lastIndexOf(t)}));if(e.length)throw new Error("Custom alphabet for shortid must be "+J.length+" unique characters. These characters were not unique: "+e.join(", "));q=t,K()}}else q!==J&&(q=J,K())}function Y(){return V||(V=function(){q||Z(J);for(var t,e=q.split(""),n=[],i=z.nextValue();e.length>0;)i=z.nextValue(),t=Math.floor(i*e.length),n.push(e.splice(t,1)[0]);return n.join("")}())}var X={characters:function(t){return Z(t),q},seed:function(t){z.seed(t),U!==t&&(K(),U=t)},lookup:function(t){return Y()[t]},shuffled:Y},Q="object"==typeof window&&(window.crypto||window.msCrypto);var $=function(){if(!Q||!Q.getRandomValues)return 48&Math.floor(256*Math.random());var t=new Uint8Array(1);return Q.getRandomValues(t),48&t[0]};var tt=function(t,e){for(var n,i=0,r="";!n;)r+=t(e>>4*i&15|$()),n=e<Math.pow(16,i+1),i++;return r};var et=function(t){var e=X.shuffled();return{version:15&e.indexOf(t.substr(0,1)),worker:15&e.indexOf(t.substr(1,1))}};var nt=function(t){if(!t||"string"!=typeof t||t.length<6)return!1;for(var e=X.characters(),n=t.length,i=0;i<n;i++)if(-1===e.indexOf(t[i]))return!1;return!0},it=function(t,e){return t(e={exports:{}},e.exports),e.exports}((function(t){var e,n,i=0;function r(){var t="",r=Math.floor(.001*(Date.now()-1459707606518));return r===n?e++:(e=0,n=r),t+=tt(X.lookup,6),t+=tt(X.lookup,i),e>0&&(t+=tt(X.lookup,e)),t+=tt(X.lookup,r)}t.exports=r,t.exports.generate=r,t.exports.seed=function(e){return X.seed(e),t.exports},t.exports.worker=function(e){return i=e,t.exports},t.exports.characters=function(t){return void 0!==t&&X.characters(t),X.shuffled()},t.exports.decode=et,t.exports.isValid=nt})),rt=(it.generate,it.seed,it.worker,it.characters,it.decode,it.isValid,it);function ot(t,e,n,i,r){null==t&&(t="global"),i=i||["success"],r=r||["error"];var o,s=!1,a=!1,c=!1,u=O();e.disconnected((function(){c=!1,n.debug("connection is down"),s=!1,a=!0,u.execute("onLeft",{disconnected:!0})})),e.loggedIn((function(){c=!0,a&&(n.debug("connection is now up - trying to reconnect..."),p(o))})),e.on("success",(function(t){return l(t)})),e.on("error",(function(t){return h(t)})),e.on("result",(function(t){return l(t)})),i&&i.forEach((function(t){e.on(t,(function(t){return l(t)}))})),r&&r.forEach((function(t){e.on(t,(function(t){return h(t)}))}));var d={};function p(e){return o=e,new Promise((function(i,r){if(s)i();else{var o;if("global"===t)o=c?Promise.resolve({}):Promise.reject("not connected to gateway");else n.debug("joining domain "+t),o=g({type:"join",destination:t,domain:"global",options:e});o.then((function(){!function(){n.debug("did join "+t),s=!0;var e=a;a=!1,u.execute("onJoined",e)}(),i()})).catch((function(e){n.debug("error joining "+t+" domain: "+JSON.stringify(e)),r(e)}))}}))}function h(e){if(t===e.domain){var n=e.request_id;if(n){var i=d[n];i&&i.error(e)}}}function l(e){if(e.domain===t){var n=e.request_id;if(n){var i=d[n];i&&i.success(e)}}}function f(){return rt()}function g(i,r,o){o=o||{},i.request_id=i.request_id||f(),i.domain=i.domain||t,o.skipPeerId||(i.peer_id=e.peerId);var s=i.request_id;return new Promise((function(t,a){d[s]={success:function(e){delete d[s],e._tag=r,t(e)},error:function(t){n.warn("GW error - "+JSON.stringify(t)+" for request "+JSON.stringify(i)),delete d[s],t._tag=r,a(t)}},e.send(i,o).catch((function(t){d[s].error({err:t})}))}))}return{join:p,leave:function(){return"global"===t?Promise.resolve():(n.debug("stopping session "+t+"..."),a=!1,g({type:"leave",destination:t,domain:"global"}).then((function(){s=!1,u.execute("onLeft")})))},onJoined:function(t){return s&&t(!1),u.add("onJoined",t)},onLeft:function(t){return s||t(),u.add("onLeft",t)},send:g,sendFireAndForget:function(n){return n.request_id=n.request_id?n.request_id:f(),n.domain=n.domain||t,n.peer_id=e.peerId,e.send(n)},on:function(i,r){e.on(i,(function(e){if(e.domain===t)try{r(e)}catch(t){n.error("Callback  failed: "+t+" \n "+t.stack+" \n msg was: "+JSON.stringify(e),t)}}))},loggedIn:function(t){return e.loggedIn(t)},connected:function(t){return e.connected(t)},disconnected:function(t){return e.disconnected(t)},get peerId(){return e.peerId},get domain(){return t}}}var st=function(){function t(t,e,n){var i=this;this.connection=t,this.settings=e,this.logger=n,this.protocolVersion=3,this.datePrefix="#T42_DATE#",this.datePrefixLen=this.datePrefix.length,this.dateMinLen=this.datePrefixLen+1,this.datePrefixFirstChar=this.datePrefix[0],this.registry=O(),this._isLoggedIn=!1,this.shouldTryLogin=!0,this.initialLogin=!0,this.initialLoginAttempts=3,this.sessions=[],t.disconnected((function(){i.handleDisconnected()})),this.ping()}return Object.defineProperty(t.prototype,"isLoggedIn",{get:function(){return this._isLoggedIn},enumerable:!0,configurable:!0}),t.prototype.processStringMessage=function(t){var e=this,n=JSON.parse(t,(function(t,n){if("string"!=typeof n)return n;if(n.length<e.dateMinLen)return n;if(n[0]!==e.datePrefixFirstChar)return n;if(n.substring(0,e.datePrefixLen)!==e.datePrefix)return n;try{var i=parseInt(n.substring(e.datePrefixLen,n.length),10);return isNaN(i)?n:new Date(i)}catch(t){return n}}));return{msg:n,msgType:n.type}},t.prototype.createStringMessage=function(t){var e=Date.prototype.toJSON;try{var n=this.datePrefix;return Date.prototype.toJSON=function(){return n+this.getTime()},JSON.stringify(t)}finally{Date.prototype.toJSON=e}},t.prototype.processObjectMessage=function(t){if(!t.type)throw new Error("Object should have type property");return{msg:t,msgType:t.type}},t.prototype.createObjectMessage=function(t){return t},t.prototype.login=function(t,e){return u(this,void 0,void 0,(function(){var n,i,r,o,s,a,c,u,p,h;return d(this,(function(d){switch(d.label){case 0:if(this.logger.debug("logging in..."),this.loginConfig=t,this.loginConfig||(this.loginConfig={username:"",password:""}),this.shouldTryLogin=!0,n={},this.connection.gatewayToken=t.gatewayToken,!t.gatewayToken)return[3,5];if(!e)return[3,4];d.label=1;case 1:return d.trys.push([1,3,,4]),[4,this.getNewGWToken()];case 2:return u=d.sent(),t.gatewayToken=u,[3,4];case 3:return i=d.sent(),this.logger.warn("failed to get GW token when reconnecting "+((null==i?void 0:i.message)||i)),[3,4];case 4:return n.method="gateway-token",n.token=t.gatewayToken,this.connection.gatewayToken=t.gatewayToken,[3,10];case 5:return"sspi"!==t.flowName?[3,9]:(n.provider="win",n.method="access-token",t.flowCallback&&t.sessionId?(r=n,[4,t.flowCallback(t.sessionId,null)]):[3,7]);case 6:return r.token=d.sent().data.toString("base64"),[3,8];case 7:throw new Error("Invalid SSPI config");case 8:return[3,10];case 9:if(t.token)n.method="access-token",n.token=t.token;else{if(!t.username)throw new Error("invalid auth message"+JSON.stringify(t));n.method="secret",n.login=t.username,n.secret=t.password}d.label=10;case 10:o={type:"hello",identity:this.settings.identity,authentication:n},t.sessionId&&(o.request_id=t.sessionId),this.globalDomain=ot("global",this.connection,this.logger.subLogger("global-domain"),["welcome","token","authentication-request"]),s={skipPeerId:!0},this.initialLogin&&(s.retryInterval=this.settings.reconnectInterval,s.maxRetries=this.settings.reconnectAttempts),d.label=11;case 11:d.trys.push([11,19,20,21]),a=void 0,d.label=12;case 12:return[4,this.globalDomain.send(o,void 0,s)];case 13:return"authentication-request"!==(c=d.sent()).type?[3,16]:(u=Buffer.from(c.authentication.token,"base64"),t.flowCallback&&t.sessionId?(p=o.authentication,[4,t.flowCallback(t.sessionId,u)]):[3,15]);case 14:p.token=d.sent().data.toString("base64"),d.label=15;case 15:return o.request_id=t.sessionId,[3,12];case 16:if("welcome"===c.type)return a=c,[3,18];throw"error"===c.type?new Error("Authentication failed: "+c.reason):new Error("Unexpected message type during authentication: "+c.type);case 17:return[3,12];case 18:return this.initialLogin=!1,this.logger.debug("login successful with peerId "+a.peer_id),this.connection.peerId=a.peer_id,this.connection.resolvedIdentity=a.resolved_identity,this.connection.availableDomains=a.available_domains,a.options&&(this.connection.token=a.options.access_token,this.connection.info=a.options.info),this.setLoggedIn(!0),[2,a.resolved_identity];case 19:throw h=d.sent(),this.logger.error("error sending hello message - "+(h.message||h.msg||h.reason||h),h),h;case 20:return t&&t.flowCallback&&t.sessionId&&t.flowCallback(t.sessionId,null),[7];case 21:return[2]}}))}))},t.prototype.logout=function(){return u(this,void 0,void 0,(function(){var t;return d(this,(function(e){switch(e.label){case 0:return this.logger.debug("logging out..."),this.shouldTryLogin=!1,this.pingTimer&&clearTimeout(this.pingTimer),t=this.sessions.map((function(t){t.leave()})),[4,Promise.all(t)];case 1:return e.sent(),[2]}}))}))},t.prototype.loggedIn=function(t){return this._isLoggedIn&&t(),this.registry.add("onLoggedIn",t)},t.prototype.domain=function(t,e,n,i){var r=this.sessions.filter((function(e){return e.domain===t}))[0];return r||(r=ot(t,this.connection,e,n,i),this.sessions.push(r)),r},t.prototype.handleDisconnected=function(){var t=this;if(this.setLoggedIn(!1),this.shouldTryLogin&&this.initialLogin){if(this.initialLoginAttempts<=0)return;this.initialLoginAttempts--}if(this.logger.debug("disconnected - will try new login?"+this.shouldTryLogin),this.shouldTryLogin){if(!this.loginConfig)throw new Error("no login info");this.connection.login(this.loginConfig,!0).catch((function(){setTimeout(t.handleDisconnected.bind(t),t.settings.reconnectInterval||1e3)}))}},t.prototype.setLoggedIn=function(t){this._isLoggedIn=t,this._isLoggedIn&&this.registry.execute("onLoggedIn")},t.prototype.ping=function(){var t=this;this.shouldTryLogin&&(this._isLoggedIn&&this.connection.send({type:"ping"}),this.pingTimer=setTimeout((function(){t.ping()}),3e4))},t.prototype.authToken=function(){return this.globalDomain?this.globalDomain.send({type:"create-token"}).then((function(t){return t.token})):Promise.reject(new Error("no global domain session"))},t.prototype.getNewGWToken=function(){if(void 0!==typeof window){var t=window.glue42gd;if(t)return t.getGWToken()}return Promise.reject(new Error("not running in GD"))},t}(),at=function(){function t(t){this.specsNames=[],this.messages={},this.subs={},this.subsRefCount={},this.specs={};for(var e=0,n=t;e<n.length;e++){var i=n[e];this.specs[i.name]=i,this.specsNames.push(i.name)}}return t.prototype.init=function(t){var e=this;this.connection=t;for(var n=0,i=this.specsNames;n<i.length;n++)for(var r=i[n],o=function(n){var i=s.subsRefCount[n];if(i||(i=0),i+=1,s.subsRefCount[n]=i,i>1)return"continue";var r=t.on(n,(function(t){return e.processMessage(n,t)}));s.subs[n]=r},s=this,a=0,c=this.specs[r].types;a<c.length;a++){o(c[a])}},t.prototype.processMessage=function(t,e){if(!this.isDone&&e)for(var n=0,i=this.specsNames;n<i.length;n++){var r=i[n];if(-1!==this.specs[r].types.indexOf(t)){var o=this.messages[r]||[];this.messages[r]=o,o.push(e)}}},t.prototype.drain=function(t,e){var n;e&&(this.messages[t]||[]).forEach(e),delete this.messages[t];for(var i=0,r=this.specs[t].types;i<r.length;i++){var o=r[i];this.subsRefCount[o]-=1,this.subsRefCount[o]<=0&&(null===(n=this.connection)||void 0===n||n.off(this.subs[o]),delete this.subs[o],delete this.subsRefCount[o])}delete this.specs[t],this.specs.length||(this.isDone=!0)},t}(),ct=function(t,e,n){return new Promise((function(i,r){var o=setTimeout((function(){r(n||"Promise timeout hit: "+e)}),e);new Promise(t).then((function(t){clearTimeout(o),i(t)})).catch((function(t){clearTimeout(o),r(t)}))}))},ut=function(){function t(t,e,n){this.settings=t,this.logger=e,this.identity=n,this.parentReady=!1,this.iAmConnected=!1,this.rejected=!1,this.children=[],this.parentPingTimeout=3e3,this.connectionRequestTimeout=5e3,this.defaultTargetString="*",this.registry=O(),this.messages={connectionAccepted:{name:"connectionAccepted",handle:this.handleConnectionAccepted.bind(this)},connectionRejected:{name:"connectionRejected",handle:this.handleConnectionRejected.bind(this)},connectionRequest:{name:"connectionRequest",handle:this.handleConnectionRequest.bind(this)},parentReady:{name:"parentReady",handle:this.handleParentReady.bind(this)},parentPing:{name:"parentPing",handle:this.handleParentPing.bind(this)},platformPing:{name:"platformPing",handle:this.handlePlatformPing.bind(this)},platformUnload:{name:"platformUnload",handle:this.handlePlatformUnload.bind(this)},platformReady:{name:"platformReady",handle:this.handlePlatformReady.bind(this)},clientUnload:{name:"clientUnload",handle:this.handleClientUnload.bind(this)},manualUnload:{name:"manualUnload",handle:this.handleManualUnload.bind(this)}},this.setUpMessageListener(),this.setUpUnload(),this.settings.port||(this.parent=window.opener||window.top,this.parentType=window.opener?"opener":-1!==window.name.indexOf("#wsp")?"workspace":"top")}return Object.defineProperty(t.prototype,"transportWindowId",{get:function(){return this.publicWindowId},enumerable:!0,configurable:!0}),t.prototype.sendObject=function(t){return u(this,void 0,void 0,(function(){return d(this,(function(e){if(!this.port)throw new Error("Cannot send message, because the port was not opened yet");return this.port.postMessage(t),[2]}))}))},Object.defineProperty(t.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),t.prototype.onMessage=function(t){return this.registry.add("onMessage",t)},t.prototype.send=function(){return Promise.reject("not supported")},t.prototype.onConnectedChanged=function(t){return this.registry.add("onConnectedChanged",t)},t.prototype.open=function(){return u(this,void 0,void 0,(function(){return d(this,(function(t){switch(t.label){case 0:return this.logger.debug("opening a connection to the web platform gateway."),[4,this.connect()];case 1:return t.sent(),this.notifyStatusChanged(!0),[2]}}))}))},t.prototype.close=function(){return Promise.resolve()},t.prototype.name=function(){return"web-platform"},t.prototype.reconnect=function(){return Promise.resolve()},t.prototype.connect=function(){return u(this,void 0,void 0,(function(){var t=this;return d(this,(function(e){switch(e.label){case 0:if(this.parentReady)return this.logger.debug("cancelling connection attempt, because this client's parent has already given a ready signal"),[2];if(this.settings.port)return this.logger.debug("opening an internal web platform connection"),this.port=this.settings.port,this.publicWindowId=this.settings.windowId,this.identity&&(this.identity.windowId=this.publicWindowId),this.port.onmessage=function(e){return t.registry.execute("onMessage",e.data)},this.logger.debug("internal web platform connection completed"),[2];if(!this.parentType||!this.parent)throw new Error("Cannot initiate a connection, because there is no opener, no top and no port.");return this.logger.debug("opening a "+("opener"===this.parentType?"child":"grandchild")+" client web platform connection"),[4,this.waitParent(this.parent,this.parentType)];case 1:return e.sent(),[4,this.initiateRemoteConnection(this.parent,this.parentType)];case 2:return e.sent(),this.logger.debug("the "+("opener"===this.parentType?"child":"grandchild")+" client is connected"),[2]}}))}))},t.prototype.initiateRemoteConnection=function(t,e){var n=this;return ct((function(i,r){n.connectionResolve=i,n.connectionReject=r,n.myClientId=rt();var o="workspace"===n.parentType?window.name.substring(0,window.name.indexOf("#wsp")):window.name,s={glue42core:{type:n.messages.connectionRequest.name,clientId:n.myClientId,clientType:"top"===e||"workspace"===e?"grandChild":"child",bridgeInstanceId:o}};n.logger.debug("sending connection request to "+e),t.postMessage(s,n.defaultTargetString)}),this.connectionRequestTimeout,"The connection to the opener/top window timed out")},t.prototype.waitParent=function(t,e){var n=this;return ct((function(i){n.parentPingResolve=i;var r={glue42core:{type:"opener"===e?n.messages.platformPing.name:n.messages.parentPing.name}};n.logger.debug("checking for "+e+" window availability"),t.postMessage(r,n.defaultTargetString)}),this.parentPingTimeout,"Cannot initiate glue, because this window was not opened or created by a glue client")},t.prototype.setUpMessageListener=function(){var t=this;this.settings.port?this.logger.debug("skipping generic message listener, because this is an internal client"):window.addEventListener("message",(function(e){var n,i=null===(n=e.data)||void 0===n?void 0:n.glue42core;if(i&&!t.rejected)if(t.checkMessageTypeValid(i.type)){var r=i.type;t.logger.debug("received valid glue42core message of type: "+r),t.messages[r].handle(e)}else t.logger.error("cannot handle the incoming glue42 core message, because the type is invalid: "+i.type)}))},t.prototype.setUpUnload=function(){var t=this;this.settings.port?this.logger.debug("skipping unload event listener, because this is an internal client"):window.addEventListener("beforeunload",(function(){var e,n,i={glue42core:{type:t.messages.clientUnload.name,data:{clientId:t.myClientId,ownWindowId:null===(e=t.identity)||void 0===e?void 0:e.windowId}}};t.parent&&t.parent.postMessage(i,t.defaultTargetString),null===(n=t.port)||void 0===n||n.postMessage(i)}))},t.prototype.handleParentReady=function(){if(this.logger.debug("handling the ready signal from the parent, by resoling the pending promise."),this.parentReady=!0,this.parentPingResolve)return this.parentPingResolve(),void delete this.parentPingResolve;this.logger.debug("silently handling the ready signal from the top parent, because there is no defined promise")},t.prototype.handlePlatformReady=function(){if(this.logger.debug("the web platform gave the ready signal"),this.parentReady=!0,this.parentPingResolve)return this.parentPingResolve(),void delete this.parentPingResolve;this.logger.debug("silently handling the ready signal from the top parent, because there is no defined promise")},t.prototype.handleConnectionAccepted=function(t){var e,n=null===(e=t.data)||void 0===e?void 0:e.glue42core;return this.myClientId===n.clientId?this.handleAcceptanceOfMyRequest(n):this.handleAcceptanceOfGrandChildRequest(n,t)},t.prototype.handleAcceptanceOfMyRequest=function(t){var e=this;if(this.logger.debug("handling a connection accepted signal targeted at me."),t.port){if(this.publicWindowId="opener"===this.parentType?window.name:"top"===this.parentType?t.parentWindowId:window.name.substring(0,window.name.indexOf("#wsp")),this.identity&&"top"!==this.parentType&&(this.identity.windowId=this.publicWindowId),this.identity&&t.appName&&(this.identity.application=t.appName,this.identity.applicationName=t.appName),this.port=t.port,this.port.onmessage=function(t){return e.registry.execute("onMessage",t.data)},this.connectionResolve)return this.logger.debug("my connection is set up, calling the connection resolve."),this.connectionResolve(),void delete this.connectionResolve;this.logger.error("unable to call the connection resolve, because no connection promise was found")}else this.logger.error("cannot set up my connection, because I was not provided with a port")},t.prototype.handleAcceptanceOfGrandChildRequest=function(t,e){this.logger.debug("handling a connection accepted signal targeted at a grandchild: "+t.clientId);var n=this.children.find((function(e){return e.grandChildId===t.clientId}));n?(n.connected=!0,this.logger.debug("the grandchild connection for "+t.clientId+" is set up, forwarding the success message and the gateway port"),t.parentWindowId=this.publicWindowId,n.source.postMessage(e.data,n.origin,[t.port])):this.logger.error("cannot handle connection accepted for grandchild: "+t.clientId+", because there is no grandchild with this id")},t.prototype.handleConnectionRejected=function(){this.logger.debug("handling a connection rejection. Most likely the reason is that this window was not created by a glue API call"),this.connectionReject&&(this.connectionReject("The platform connection was rejected. Most likely because this window was not created by a glue API call"),delete this.connectionReject)},t.prototype.handleConnectionRequest=function(t){var e=t.source,n=t.data.glue42core;return n.clientType&&"grandChild"===n.clientType?n.clientId?"opener"===this.parentType&&this.parent?(this.logger.debug("handling a connection request for a grandchild: "+n.clientId),this.children.push({grandChildId:n.clientId,source:e,connected:!1,origin:t.origin}),this.logger.debug("grandchild: "+n.clientId+" is prepared, forwarding connection request to the platform"),void this.parent.postMessage(t.data,this.defaultTargetString)):this.rejectConnectionRequest(e,t.origin,"Cannot forward the connection request, because no direct connection to the platform was found"):this.rejectConnectionRequest(e,t.origin,"rejecting a connection request, because the source did not provide a valid id"):this.rejectConnectionRequest(e,t.origin,"rejecting a connection request, because the source was not opened by a glue API call")},t.prototype.handleParentPing=function(t){if(this.parentReady)if(this.iAmConnected){var e={glue42core:{type:this.messages.parentReady.name}},n=t.source;this.logger.debug("responding to a parent ping with a ready message"),n.postMessage(e,t.origin)}else this.logger.debug("i am not fully connected yet, I am ignoring the parent ping");else this.logger.debug("my parent is not ready, I am ignoring the parent ping")},t.prototype.handlePlatformUnload=function(t){this.logger.debug("detected a web platform unload"),this.parentReady=!1,this.children.length&&(this.logger.debug("forwarding the platform unload to all known children and starting platform discovery polling"),this.children.forEach((function(e){return e.source.postMessage(t.data,e.origin)}))),this.notifyStatusChanged(!1,"Gateway unloaded")},t.prototype.handleManualUnload=function(){var t,e,n={glue42core:{type:this.messages.clientUnload.name,data:{clientId:this.myClientId,ownWindowId:null===(t=this.identity)||void 0===t?void 0:t.windowId}}};this.parent&&this.parent.postMessage(n,this.defaultTargetString),null===(e=this.port)||void 0===e||e.postMessage(n)},t.prototype.handleClientUnload=function(t){var e=t.data.glue42core,n=null==e?void 0:e.data.clientId;n?this.children.find((function(t){return t.grandChildId===n}))?(this.logger.debug("handling grandchild unload for id: "+n),this.children=this.children.filter((function(t){return t.grandChildId!==n}))):this.logger.warn("cannot process grand child unload, because this client is unaware of this grandchild"):this.logger.warn("cannot process grand child unload, because the provided id was not valid")},t.prototype.handlePlatformPing=function(){this.logger.error("cannot handle platform ping, because this is not a platform calls handling component")},t.prototype.notifyStatusChanged=function(t,e){this.iAmConnected=t,this.registry.execute("onConnectedChanged",t,e)},t.prototype.checkMessageTypeValid=function(t){return"string"==typeof t&&!!this.messages[t]},t.prototype.rejectConnectionRequest=function(t,e,n){this.rejected=!0,this.logger.error(n);var i={glue42core:{type:this.messages.connectionRejected.name}};t.postMessage(i,e)},t}(),dt=function(){function t(t,e){if(this.settings=t,this.logger=e,this.messageHandlers={},this.ids=1,this.registry=O(),this._connected=!1,this.isTrace=!1,(t=t||{}).reconnectAttempts=t.reconnectAttempts||10,t.reconnectInterval=t.reconnectInterval||1e3,t.inproc)this.transport=new W(t.inproc,e.subLogger("inMemory"));else if(t.sharedWorker)this.transport=new R(t.sharedWorker,e.subLogger("shared-worker"));else if(t.webPlatform)this.transport=new ut(t.webPlatform,e.subLogger("web-platform"),t.identity);else{if(void 0===t.ws)throw new Error("No connection information specified");this.transport=new B(t,e.subLogger("ws"))}this.isTrace=e.canPublish("trace"),e.debug("starting with "+this.transport.name()+" transport"),this.protocol=new st(this,t,e.subLogger("protocol")),this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),this.transport.onMessage(this.handleTransportMessage.bind(this)),t.replaySpecs&&t.replaySpecs.length&&(this.replayer=new at(t.replaySpecs),this.replayer.init(this))}return Object.defineProperty(t.prototype,"protocolVersion",{get:function(){var t;return null===(t=this.protocol)||void 0===t?void 0:t.protocolVersion},enumerable:!0,configurable:!0}),t.prototype.send=function(t,e){if(this.transport.sendObject&&this.transport.isObjectBasedTransport){var n=this.protocol.createObjectMessage(t);return this.isTrace&&this.logger.trace(">> "+JSON.stringify(n)),this.transport.sendObject(n,e)}var i=this.protocol.createStringMessage(t);return this.isTrace&&this.logger.trace(">> "+i),this.transport.send(i,e)},t.prototype.on=function(t,e){t=t.toLowerCase(),void 0===this.messageHandlers[t]&&(this.messageHandlers[t]={});var n=this.ids++;return this.messageHandlers[t][n]=e,{type:t,id:n}},t.prototype.off=function(t){delete this.messageHandlers[t.type.toLowerCase()][t.id]},Object.defineProperty(t.prototype,"isConnected",{get:function(){return this.protocol.isLoggedIn},enumerable:!0,configurable:!0}),t.prototype.connected=function(t){var e=this;return this.protocol.loggedIn((function(){t(e.settings.ws||e.settings.sharedWorker||"")}))},t.prototype.disconnected=function(t){return this.registry.add("disconnected",t)},t.prototype.login=function(t,e){return u(this,void 0,void 0,(function(){var n;return d(this,(function(i){switch(i.label){case 0:return[4,this.transport.open()];case 1:return i.sent(),D("connection").mark("transport-opened"),n=this.protocol.login(t,e),D("connection").mark("protocol-logged-in"),[2,n]}}))}))},t.prototype.logout=function(){return u(this,void 0,void 0,(function(){return d(this,(function(t){switch(t.label){case 0:return[4,this.protocol.logout()];case 1:return t.sent(),[4,this.transport.close()];case 2:return t.sent(),[2]}}))}))},t.prototype.loggedIn=function(t){return this.protocol.loggedIn(t)},t.prototype.domain=function(t,e,n){return this.protocol.domain(t,this.logger.subLogger("domain="+t),e,n)},t.prototype.authToken=function(){return this.protocol.authToken()},t.prototype.reconnect=function(){return this.transport.reconnect()},t.prototype.distributeMessage=function(t,e){var n=this,i=this.messageHandlers[e.toLowerCase()];void 0!==i&&Object.keys(i).forEach((function(e){var r=i[e];if(void 0!==r)try{r(t)}catch(t){try{n.logger.error("Message handler failed with "+t.stack,t)}catch(e){console.log("Message handler failed",t)}}}))},t.prototype.handleConnectionChanged=function(t){this._connected!==t&&(this._connected=t,t?this.registry.execute("connected"):this.registry.execute("disconnected"))},t.prototype.handleTransportMessage=function(t){var e;e="string"==typeof t?this.protocol.processStringMessage(t):this.protocol.processObjectMessage(t),this.isTrace&&this.logger.trace("<< "+JSON.stringify(e)),this.distributeMessage(e.msg,e.msgType)},t}(),pt=["trace","debug","info","warn","error","off"],ht=function(){function t(t,e,n){this.name=t,this.parent=e,this.subLoggers=[],this.logFn=console,this.customLogFn=!1,this.name=t,this.path=e?e.path+"."+t:t,this.loggerFullName="["+this.path+"]",this.includeTimeAndLevel=!n,n&&(this.logFn=n,this.customLogFn=!0)}return t.prototype.subLogger=function(e){var n=this.subLoggers.filter((function(t){return t.name===e}))[0];if(void 0!==n)return n;Object.keys(this).forEach((function(t){if(t===e)throw new Error("This sub logger name is not allowed.")}));var i=new t(e,this,this.customLogFn?this.logFn:void 0);return this.subLoggers.push(i),i},t.prototype.publishLevel=function(t){var e;return t&&(this._publishLevel=t),this._publishLevel||(null===(e=this.parent)||void 0===e?void 0:e.publishLevel())},t.prototype.consoleLevel=function(t){var e;return t&&(this._consoleLevel=t),this._consoleLevel||(null===(e=this.parent)||void 0===e?void 0:e.consoleLevel())},t.prototype.log=function(t,e,n){this.publishMessage(e||"info",t,n)},t.prototype.trace=function(t){this.log(t,"trace")},t.prototype.debug=function(t){this.log(t,"debug")},t.prototype.info=function(t){this.log(t,"info")},t.prototype.warn=function(t){this.log(t,"warn")},t.prototype.error=function(t,e){this.log(t,"error")},t.prototype.canPublish=function(t,e){return pt.indexOf(t)>=pt.indexOf(e||this.consoleLevel()||"trace")},t.prototype.publishMessage=function(e,n,i){var r=this.loggerFullName;if("error"===e&&!i){var o=new Error;o.stack&&(n=n+"\n"+o.stack.split("\n").slice(3).join("\n"))}if(this.canPublish(e,this.publishLevel())){var s=t.Interop;if(s)try{s.methods({name:t.InteropMethodName}).length>0&&s.invoke(t.InteropMethodName,{msg:""+n,logger:r,level:e})}catch(t){}}if(this.canPublish(e)){var a="";if(this.includeTimeAndLevel){var c=new Date;a="["+(c.getHours()+":"+c.getMinutes()+":"+c.getSeconds()+":"+c.getMilliseconds())+"] ["+e+"] "}var u=""+a+r+": "+n;switch(e){case"trace":this.logFn.debug(u);break;case"debug":this.logFn.debug?this.logFn.debug(u):this.logFn.log(u);break;case"info":this.logFn.info(u);break;case"warn":this.logFn.warn(u);break;case"error":this.logFn.error(u,i)}}},t.InteropMethodName="T42.AppLogger.Log",t}(),lt="create-context",ft="created",gt="destroyed",yt="context-created",vt="context-added",mt="subscribe-context",wt="subscribed-context",bt="unsubscribe-context",_t="destroy-context",It="context-destroyed",Ct="update-context",At="context-updated",Tt="joined",kt={get name(){return"context"},get types(){return[lt,ft,gt,yt,vt,mt,wt,bt,_t,It,Ct,At,Tt]}},St="5.4.9";var xt=function(){function t(t,e,n,i){this.updateCallbacks={},this.contextId=t,this.name=e,this.isAnnounced=n,this.activityId=i,this.context={}}return t.prototype.hasCallbacks=function(){return Object.keys(this.updateCallbacks).length>0},t.prototype.getState=function(){return this.isAnnounced&&this.hasCallbacks()?3:this.isAnnounced?2:this.hasCallbacks()?1:0},t}();function Pt(t,e,n){try{if((null==n?void 0:n.canPublish("trace"))&&(null==n||n.trace("applying context delta "+JSON.stringify(e)+" on context "+JSON.stringify(t))),!e)return t;if(e.reset)return t=c({},e.reset);if(t=Mt(t,void 0),e.commands){for(var i=0,r=e.commands;i<r.length;i++){var o=r[i];"remove"===o.type?Wt(t,o.path):"set"===o.type&&Ot(t,o.value,o.path)}return t}var s=e.added,a=e.updated,u=e.removed;return s&&Object.keys(s).forEach((function(e){t[e]=s[e]})),a&&Object.keys(a).forEach((function(e){Et(e,t,a)})),u&&u.forEach((function(e){delete t[e]})),t}catch(i){return null==n||n.error("error applying context delta "+JSON.stringify(e)+" on context "+JSON.stringify(t),i),t}}function Mt(t,e){if(e=e||new WeakMap,Object(t)!==t)return t;if(t instanceof Set)return new Set(t);if(e.has(t))return e.get(t);var n=t instanceof Date?new Date(t):t instanceof RegExp?new RegExp(t.source,t.flags):t.constructor?new t.constructor:Object.create(null);return e.set(t,n),t instanceof Map&&Array.from(t,(function(t){var i=t[0],r=t[1];return n.set(i,Mt(r,e))})),Object.assign.apply(Object,p([n],Object.keys(t).map((function(n){var i;return(i={})[n]=Mt(t[n],e),i}))))}var Et=function(t,e,n){var i=n[t];if(void 0===i)return e;var r=e[t];return r&&i?"string"==typeof r||"number"==typeof r||"boolean"==typeof r||"string"==typeof i||"number"==typeof i||"boolean"==typeof i||Array.isArray(r)||Array.isArray(i)?(e[t]=i,e):(e[t]=Object.assign({},r,i),e):(e[t]=i,e)};function jt(t,e){if(t===e)return!0;if(!(t instanceof Object&&e instanceof Object))return!1;if(t.constructor!==e.constructor)return!1;for(var n in t)if(t.hasOwnProperty(n)){if(!e.hasOwnProperty(n))return!1;if(t[n]!==e[n]){if("object"!=typeof t[n])return!1;if(!jt(t[n],e[n]))return!1}}for(var n in e)if(e.hasOwnProperty(n)&&!t.hasOwnProperty(n))return!1;return!0}function Ot(t,e,n){var i,r=n.split(".");for(i=0;i<r.length-1;i++)t[r[i]]||(t[r[i]]={}),"object"!=typeof t[r[i]]&&(t[r[i]]={}),t=t[r[i]];t[r[i]]=e}function Wt(t,e){var n,i=e.split(".");for(n=0;n<i.length-1;n++){if(!t[i[n]])return;t=t[i[n]]}delete t[i[n]]}var Rt,Ft=function(){function t(t){var e,n=this;this._contextNameToData={},this._gw3Subscriptions=[],this._nextCallbackSubscriptionNumber=0,this._contextNameToId={},this._contextIdToName={},this._protocolVersion=void 0,this._connection=t.connection,this._logger=t.logger,this._gw3Session=this._connection.domain("global",[yt,wt,It,At]),this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),null===(e=this._connection.replayer)||void 0===e||e.drain(kt.name,(function(t){var e=t.type;e&&(e===yt||e===vt||e===ft?n.handleContextCreatedMessage(t):e===wt||e===At||e===Tt?n.handleContextUpdatedMessage(t):e!==It&&e!==gt||n.handleContextDestroyedMessage(t))}))}return Object.defineProperty(t.prototype,"protocolVersion",{get:function(){var t;if(!this._protocolVersion){var e=this._connection.availableDomains.find((function(t){return"context"===t.uri}));this._protocolVersion=null!==(t=null==e?void 0:e.version)&&void 0!==t?t:1}return this._protocolVersion},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"setPathSupported",{get:function(){return this.protocolVersion>=2},enumerable:!0,configurable:!0}),t.prototype.dispose=function(){for(var t=0,e=this._gw3Subscriptions;t<e.length;t++){var n=e[t];this._connection.off(n)}for(var i in this._gw3Subscriptions.length=0,this._contextNameToData)this._contextNameToId.hasOwnProperty(i)&&delete this._contextNameToData[i]},t.prototype.createContext=function(t,e){var n=this;return this._gw3Session.send({type:lt,domain:"global",name:t,data:e,lifetime:"retained"}).then((function(i){n._contextNameToId[t]=i.context_id,n._contextIdToName[i.context_id]=t;var r=n._contextNameToData[t]||new xt(i.context_id,t,!0,void 0);return r.isAnnounced=!0,r.name=t,r.contextId=i.context_id,r.context=e,n._contextNameToData[t]=r,i.context_id}))},t.prototype.all=function(){var t=this;return Object.keys(this._contextNameToData).filter((function(e){return t._contextNameToData[e].isAnnounced}))},t.prototype.update=function(t,e){var n;return u(this,void 0,void 0,(function(){var i,r,o,s=this;return d(this,(function(a){switch(a.label){case 0:return(i=this._contextNameToData[t])&&i.isAnnounced?(r=i.context,i.hasCallbacks()?[3,2]:[4,this.get(i.name)]):[2,this.createContext(t,e)];case 1:r=a.sent(),a.label=2;case 2:return o=2===this.protocolVersion?this.calculateContextDeltaV2(r,e):this.calculateContextDeltaV1(r,e),Object.keys(o.added).length||Object.keys(o.updated).length||o.removed.length||(null===(n=o.commands)||void 0===n?void 0:n.length)?[2,this._gw3Session.send({type:Ct,domain:"global",context_id:i.contextId,delta:o},{},{skipPeerId:!1}).then((function(t){s.handleUpdated(i,o,{updaterId:t.peer_id})}))]:[2,Promise.resolve()]}}))}))},t.prototype.set=function(t,e){var n=this,i=this._contextNameToData[t];return i&&i.isAnnounced?this._gw3Session.send({type:Ct,domain:"global",context_id:i.contextId,delta:{reset:e}},{},{skipPeerId:!1}).then((function(t){n.handleUpdated(i,{reset:e,added:{},removed:[],updated:{}},{updaterId:t.peer_id})})):this.createContext(t,e)},t.prototype.setPath=function(t,e,n){return this.setPathSupported?this.setPaths(t,[{path:e,value:n}]):Promise.reject("glue.contexts.setPath operation is not supported, use Glue42 3.10 or later")},t.prototype.setPaths=function(t,e){var n=this;if(!this.setPathSupported)return Promise.reject("glue.contexts.setPaths operation is not supported, use Glue42 3.10 or later");var i=this._contextNameToData[t];if(!i||!i.isAnnounced){for(var r={},o=0,s=e;o<s.length;o++){Ot(r,(d=s[o]).value,d.path)}return this.createContext(t,r)}for(var a=[],c=0,u=e;c<u.length;c++){var d;null===(d=u[c]).value?a.push({type:"remove",path:d.path}):a.push({type:"set",path:d.path,value:d.value})}return this._gw3Session.send({type:Ct,domain:"global",context_id:i.contextId,delta:{commands:a}},{},{skipPeerId:!1}).then((function(t){n.handleUpdated(i,{added:{},removed:[],updated:{},commands:a},{updaterId:t.peer_id})}))},t.prototype.get=function(t){var e,n=this,i=this._contextNameToData[t];if(!i||!i.isAnnounced)return Promise.resolve({});if(i&&!i.hasCallbacks())return new Promise((function(e,i){return u(n,void 0,void 0,(function(){var n=this;return d(this,(function(i){return this.subscribe(t,(function(t,i,r,o){n.unsubscribe(o),e(t)})),[2]}))}))}));var r=null!==(e=null==i?void 0:i.context)&&void 0!==e?e:{};return Promise.resolve(r)},t.prototype.subscribe=function(t,e){var n=this._nextCallbackSubscriptionNumber;this._nextCallbackSubscriptionNumber+=1;var i=this._contextNameToData[t];if(!i||!i.isAnnounced)return i=i||new xt(void 0,t,!1,void 0),this._contextNameToData[t]=i,i.updateCallbacks[n]=e,Promise.resolve(n);var r,o=i.hasCallbacks();return i.updateCallbacks[n]=e,o||i.joinedActivity||i.context&&i.sentExplicitSubscription?(e(r=Mt(i.context),r,[],n),Promise.resolve(n)):this.sendSubscribe(i).then((function(){return n}))},t.prototype.unsubscribe=function(t){for(var e=0,n=Object.keys(this._contextNameToData);e<n.length;e++){var i=n[e],r=(this._contextNameToId[i],this._contextNameToData[i]);if(!r)return;var o=r.hasCallbacks();delete r.updateCallbacks[t],r.isAnnounced&&o&&!r.hasCallbacks()&&r.sentExplicitSubscription&&this.sendUnsubscribe(r),r.isAnnounced||r.hasCallbacks()||delete this._contextNameToData[i]}},t.prototype.destroy=function(t){var e=this._contextNameToData[t];return e?this._gw3Session.send({type:_t,domain:"global",context_id:e.contextId}).then((function(t){})):Promise.reject("context with "+t+" does not exist")},t.prototype.handleUpdated=function(t,e,n){var i=t.context;t.context=Pt(t.context,e,this._logger),this._contextNameToData[t.name]!==t||jt(i,t.context)||this.invokeUpdateCallbacks(t,e,n)},t.prototype.subscribeToContextCreatedMessages=function(){for(var t=0,e=[vt,yt,ft];t<e.length;t++){var n=e[t],i=this._connection.on(n,this.handleContextCreatedMessage.bind(this));this._gw3Subscriptions.push(i)}},t.prototype.handleContextCreatedMessage=function(t){var e=t.type;e===ft?(this._contextNameToId[t.activity_id]=t.context_id,this._contextIdToName[t.context_id]=t.activity_id):e===vt&&(this._contextNameToId[t.name]=t.context_id,this._contextIdToName[t.context_id]=t.name);var n=this._contextIdToName[t.context_id];if(!n)throw new Error("Received created event for context with unknown name: "+t.context_id);if(!this._contextNameToId[n])throw new Error("Received created event for context with unknown id: "+t.context_id);var i=this._contextNameToData[n];if(i){if(i.isAnnounced)return;if(!i.hasCallbacks())throw new Error("Assertion failure: contextData.hasCallbacks()");i.isAnnounced=!0,i.contextId=t.context_id,i.activityId=t.activity_id,i.sentExplicitSubscription||this.sendSubscribe(i)}else this._contextNameToData[n]=i=new xt(t.context_id,n,!0,t.activity_id)},t.prototype.subscribeToContextUpdatedMessages=function(){for(var t=0,e=[At,wt,Tt];t<e.length;t++){var n=e[t],i=this._connection.on(n,this.handleContextUpdatedMessage.bind(this));this._gw3Subscriptions.push(i)}},t.prototype.handleContextUpdatedMessage=function(t){var e=t.type,n=t.context_id,i=this._contextNameToData[this._contextIdToName[n]],r=!i||!i.isAnnounced;if(e===Tt)i?(i.contextId=n,i.isAnnounced=!0,i.activityId=t.activity_id):(i=new xt(n,t.activity_id,!0,t.activity_id),this._contextNameToData[t.activity_id]=i,this._contextIdToName[n]=t.activity_id,this._contextNameToId[t.activity_id]=n),i.joinedActivity=!0;else if(!i||!i.isAnnounced)return void(e===wt?((i=i||new xt(n,t.name,!0,void 0)).sentExplicitSubscription=!0,this._contextNameToData[t.name]=i,this._contextIdToName[n]=t.name,this._contextNameToId[t.name]=n):this._logger.error("Received 'update' for unknown context: "+n));var o=i.context;if(e===wt)i.context=t.data||{};else if(e===Tt)i.context=t.context_snapshot||{};else{if(e!==At)throw new Error("Unrecognized context update message "+e);i.context=Pt(i.context,t.delta,this._logger)}!r&&jt(i.context,o)&&e!==wt||this.invokeUpdateCallbacks(i,t.delta,{updaterId:t.updater_id})},t.prototype.invokeUpdateCallbacks=function(t,e,n){if((e=e||{added:{},updated:{},reset:{},removed:[]}).commands){e.added=e.updated=e.reset={},e.removed=[];for(var i=0,r=e.commands;i<r.length;i++){var o=r[i];"remove"===o.type?(-1===o.path.indexOf(".")&&e.removed.push(o.path),Ot(e.updated,null,o.path)):"set"===o.type&&Ot(e.updated,o.value,o.path)}}for(var s in t.updateCallbacks)if(t.updateCallbacks.hasOwnProperty(s))try{(0,t.updateCallbacks[s])(Mt(t.context),Object.assign({},e.added||{},e.updated||{},e.reset||{}),e.removed,parseInt(s,10),n)}catch(t){this._logger.debug("callback error: "+JSON.stringify(t))}},t.prototype.subscribeToContextDestroyedMessages=function(){for(var t=0,e=[It,gt];t<e.length;t++){var n=e[t],i=this._connection.on(n,this.handleContextDestroyedMessage.bind(this));this._gw3Subscriptions.push(i)}},t.prototype.handleContextDestroyedMessage=function(t){var e,n;if(t.type===gt){if(n=t.activity_id,!(e=this._contextNameToId[n]))return void this._logger.error("Received 'destroyed' for unknown activity: "+t.activity_id)}else if(e=t.context_id,!(n=this._contextIdToName[e]))return void this._logger.error("Received 'destroyed' for unknown context: "+t.context_id);delete this._contextIdToName[e],delete this._contextNameToId[n];var i=this._contextNameToData[n];delete this._contextNameToData[n],i&&i.isAnnounced||this._logger.error("Received 'destroyed' for unknown context: "+e)},t.prototype.sendSubscribe=function(t){return t.sentExplicitSubscription=!0,this._gw3Session.send({type:mt,domain:"global",context_id:t.contextId}).then((function(t){}))},t.prototype.sendUnsubscribe=function(t){return t.sentExplicitSubscription=!1,this._gw3Session.send({type:bt,domain:"global",context_id:t.contextId}).then((function(t){}))},t.prototype.calculateContextDeltaV1=function(t,e){var n={added:{},updated:{},removed:[],reset:void 0};if(t)for(var i=0,r=Object.keys(t);i<r.length;i++){var o=r[i];-1===Object.keys(e).indexOf(o)||null===e[o]||jt(t[o],e[o])||(n.updated[o]=e[o])}for(var s=0,a=Object.keys(e);s<a.length;s++){o=a[s];t&&-1!==Object.keys(t).indexOf(o)?null===e[o]&&n.removed.push(o):null!==e[o]&&(n.added[o]=e[o])}return n},t.prototype.calculateContextDeltaV2=function(t,e){for(var n,i,r={added:{},updated:{},removed:[],reset:void 0,commands:[]},o=0,s=Object.keys(e);o<s.length;o++){var a=s[o];if(null!==e[a])jt(t?t[a]:null,e[a])||null===(n=r.commands)||void 0===n||n.push({type:"set",path:a,value:e[a]});else null===(i=r.commands)||void 0===i||i.push({type:"remove",path:a})}return r},t}(),Nt=function(){function t(t){this._bridge=new Ft(t)}return t.prototype.all=function(){return this._bridge.all()},t.prototype.update=function(t,e){return this.checkName(t),this.checkData(e),this._bridge.update(t,e)},t.prototype.set=function(t,e){return this.checkName(t),this.checkData(e),this._bridge.set(t,e)},t.prototype.setPath=function(t,e,n){return this.checkName(t),this.checkPath(e),""===e?(this.checkData(n),this.set(t,n)):this._bridge.setPath(t,e,n)},t.prototype.setPaths=function(t,e){if(this.checkName(t),!Array.isArray(e))throw new Error("Please provide the paths as an array of PathValues!");for(var n=0,i=e;n<i.length;n++){var r=i[n],o=r.path,s=r.value;this.checkPath(o),""===o&&this.checkData(s)}return this._bridge.setPaths(t,e)},t.prototype.subscribe=function(t,e){var n=this;if(this.checkName(t),"function"!=typeof e)throw new Error("Please provide the callback as a function!");return this._bridge.subscribe(t,(function(t,i,r,o,s){return e(t,i,r,(function(){return n._bridge.unsubscribe(o)}),s)})).then((function(t){return function(){n._bridge.unsubscribe(t)}}))},t.prototype.get=function(t){return this.checkName(t),this._bridge.get(t)},t.prototype.ready=function(){return Promise.resolve(this)},t.prototype.destroy=function(t){return this.checkName(t),this._bridge.destroy(t)},Object.defineProperty(t.prototype,"setPathSupported",{get:function(){return this._bridge.setPathSupported},enumerable:!0,configurable:!0}),t.prototype.checkName=function(t){if("string"!=typeof t||""===t)throw new Error("Please provide the name as a non-empty string!")},t.prototype.checkPath=function(t){if("string"!=typeof t)throw new Error("Please provide the path as a dot delimited string!")},t.prototype.checkData=function(t){if("object"!=typeof t)throw new Error("Please provide the data as an object!")},t}();function Lt(t,e,n){return"function"!=typeof e&&"function"!=typeof n?t:("function"!=typeof e?e=function(){}:"function"!=typeof n&&(n=function(){}),t.then(e,n))}function Dt(t,e,n){var i;void 0===t&&(t=0);var r=function(){i&&clearTimeout(i)};return e.then((function(){r()})).catch((function(){r()})),new Promise((function(e,r){i=setTimeout((function(){return r(n)}),t)}))}!function(t){t[t.Success=0]="Success",t[t.Error=1]="Error"}(Rt||(Rt={}));var Gt=function(){function t(t,e,n,i){this.protocol=t,this.repo=e,this.instance=n,this.configuration=i}return t.prototype.subscribe=function(t,e,n,i,r){var o=this,s=function(t,n,i,s){var a;e.methodResponseTimeout=null!==(a=e.methodResponseTimeout)&&void 0!==a?a:e.waitTimeoutMs,o.protocol.client.subscribe(n,e,t,i,s,r)};return Lt(new Promise((function(n,i){var r,a=function(t){n(t)},c=function(t){i(t)};if(t)if((r="string"==typeof t?{name:t}:t).name){void 0===e&&(e={});var u=e.target;if(void 0===u&&(u="best"),"string"!=typeof u||"all"===u||"best"===u){void 0===e.methodResponseTimeout&&(e.methodResponseTimeout=e.method_response_timeout,void 0===e.methodResponseTimeout&&(e.methodResponseTimeout=o.configuration.methodResponseTimeout)),void 0===e.waitTimeoutMs&&(e.waitTimeoutMs=e.wait_for_method_timeout,void 0===e.waitTimeoutMs&&(e.waitTimeoutMs=o.configuration.waitTimeoutMs));var d=0,p=o.getServerMethodsByFilterAndTarget(r,u);if(p.length>0)s(p,p[0].methods[0],a,c);else{var h=function(){if(u&&e.waitTimeoutMs)if(d+=500,(p=o.getServerMethodsByFilterAndTarget(r,u)).length>0){var n=p[0].methods[0];s(p,n,a,c)}else if(d>=e.waitTimeoutMs){s(p,"string"==typeof t?{name:t}:t,a,c)}else setTimeout(h,500)};setTimeout(h,500)}}else i(new Error('"'+u+'" is not a valid target. Valid targets are "all", "best", or an instance.'))}else i("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");else i("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.")})),n,i)},t.prototype.servers=function(t){var e=void 0===t?void 0:c({},t);return this.getServers(e).map((function(t){return t.server.instance}))},t.prototype.methods=function(t){return t="string"==typeof t?{name:t}:c({},t),this.getMethods(t)},t.prototype.methodsForInstance=function(t){return this.getMethodsForInstance(t)},t.prototype.methodAdded=function(t){return this.repo.onMethodAdded(t)},t.prototype.methodRemoved=function(t){return this.repo.onMethodRemoved(t)},t.prototype.serverAdded=function(t){return this.repo.onServerAdded(t)},t.prototype.serverRemoved=function(t){return this.repo.onServerRemoved((function(e,n){t(e,n)}))},t.prototype.serverMethodAdded=function(t){return this.repo.onServerMethodAdded((function(e,n){t({server:e,method:n})}))},t.prototype.serverMethodRemoved=function(t){return this.repo.onServerMethodRemoved((function(e,n){t({server:e,method:n})}))},t.prototype.invoke=function(t,e,n,i,r,o){return u(this,void 0,void 0,(function(){var s=this;return d(this,(function(a){return[2,Lt(function(){return u(s,void 0,void 0,(function(){var r,o,s,a,u,p,h,l,f,g,y,v,m=this;return d(this,(function(d){switch(d.label){case 0:if(!(r="string"==typeof t?{name:t}:c({},t)).name)return[2,Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.")];if(e||(e={}),n||(n="best"),"string"==typeof n&&"all"!==n&&"best"!==n&&"skipMine"!==n)return[2,Promise.reject(new Error('"'+n+'" is not a valid target. Valid targets are "all" and "best".'))];if(i||(i={}),void 0===i.methodResponseTimeoutMs&&(i.methodResponseTimeoutMs=i.method_response_timeout,void 0===i.methodResponseTimeoutMs&&(i.methodResponseTimeoutMs=this.configuration.methodResponseTimeout)),void 0===i.waitTimeoutMs&&(i.waitTimeoutMs=i.wait_for_method_timeout,void 0===i.waitTimeoutMs&&(i.waitTimeoutMs=this.configuration.waitTimeoutMs)),void 0!==i.waitTimeoutMs&&"number"!=typeof i.waitTimeoutMs)return[2,Promise.reject(new Error('"'+i.waitTimeoutMs+'" is not a valid number for "waitTimeoutMs" '))];if("object"!=typeof e)return[2,Promise.reject(new Error("The method arguments must be an object. method: "+r.name))];if(0!==(o=this.getServerMethodsByFilterAndTarget(r,n)).length)return[3,4];d.label=1;case 1:return d.trys.push([1,3,,4]),[4,this.tryToAwaitForMethods(r,n,i)];case 2:return o=d.sent(),[3,4];case 3:return d.sent(),s=c(c({},r),{getServers:function(){return[]},supportsStreaming:!1,objectTypes:null!==(g=r.objectTypes)&&void 0!==g?g:[],flags:null!==(v=null===(y=r.flags)||void 0===y?void 0:y.metadata)&&void 0!==v?v:{}}),a={method:s,called_with:e,message:"Can not find a method matching "+JSON.stringify(t)+" with server filter "+JSON.stringify(n),executed_by:void 0,returned:void 0,status:void 0},[2,Promise.reject(a)];case 4:return u=i.methodResponseTimeoutMs,p=i,h=o.map((function(t){var n=rt(),i=t.methods[0],r=t.server,o=m.protocol.client.invoke(n,i,e,r,p);return Promise.race([o,Dt(u,o,{invocationId:n,message:"Invocation timeout ("+u+" ms) reached for method name: "+(null==i?void 0:i.name)+", target instance: "+JSON.stringify(r.instance)+", options: "+JSON.stringify(p),status:Rt.Error})])})),[4,Promise.all(h)];case 5:return l=d.sent(),f=this.getInvocationResultObj(l,r,e),l.every((function(t){return t.status===Rt.Error}))?[2,Promise.reject(f)]:[2,f]}}))}))}(),r,o)]}))}))},t.prototype.getInvocationResultObj=function(t,e,n){var i=t.filter((function(t){return t.status===Rt.Success})).reduce((function(t,i){return t=p(t,[{executed_by:i.instance,returned:i.result,called_with:n,method:e,message:i.message,status:i.status}])}),[]),r=t.filter((function(t){return t.status===Rt.Error})).reduce((function(t,i){return t=p(t,[{executed_by:i.instance,called_with:n,name:e.name,message:i.message}])}),[]),o=t[0];return{method:e,called_with:n,returned:o.result,executed_by:o.instance,all_return_values:i,all_errors:r,message:o.message,status:o.status}},t.prototype.tryToAwaitForMethods=function(t,e,n){var i=this;return new Promise((function(r,o){if(0!==n.waitTimeoutMs)var s=0,a=setInterval((function(){s+=500;var c=i.getServerMethodsByFilterAndTarget(t,e);if(c.length>0)clearInterval(a),r(c);else if(s>=(n.waitTimeoutMs||1e4))return clearInterval(a),void o()}),500);else o()}))},t.prototype.filterByTarget=function(t,e){var n=this;if("string"!=typeof t){return(Array.isArray(t)?t:[t]).reduce((function(t,i){var r=e.filter((function(t){return n.instanceMatch(i,t.server.instance)}));return t.concat(r)}),[])}if("all"===t)return p(e);if("best"===t){var i=e.find((function(t){return t.server.instance.isLocal}));if(i)return[i];if(void 0!==e[0])return[e[0]]}else if("skipMine"===t)return e.filter((function(t){return t.server.instance.peerId!==n.instance.peerId}));return[]},t.prototype.instanceMatch=function(t,e){return this.containsProps(t,e)},t.prototype.methodMatch=function(t,e){return this.containsProps(t,e)},t.prototype.containsProps=function(t,e){return Object.keys(t).filter((function(e){return void 0!==t[e]&&"function"!=typeof t[e]&&"object_types"!==e&&"display_name"!==e&&"id"!==e&&"gatewayId"!==e&&"identifier"!==e&&"_"!==e[0]})).every((function(n){var i,r=t[n],o=e[n];switch(n){case"objectTypes":i=(r||[]).every((function(t){return(o||[]).includes(t)}));break;case"flags":i=function t(e,n){return Object.keys(n).every((function(i){return"object"==typeof n[i]?t((null==e?void 0:e[i])||{},n[i]||{}):n[i]===(null==e?void 0:e[i])}))}(o||{},r||{});break;default:i=String(r).toLowerCase()===String(o).toLowerCase()}return i}))},t.prototype.getMethods=function(t){var e=this;return void 0===t?this.repo.getMethods():this.repo.getMethods().filter((function(n){return e.methodMatch(t,n)}))},t.prototype.getMethodsForInstance=function(t){var e=this,n=this.repo.getServers().filter((function(n){return e.instanceMatch(t,n.instance)}));if(0===n.length)return[];var i={};return 1===n.length?i=n[0].methods:n.forEach((function(t){Object.keys(t.methods).forEach((function(e){var n=t.methods[e];i[n.identifier]=n}))})),Object.keys(i).map((function(t){return i[t]}))},t.prototype.getServers=function(t){var e=this,n=this.repo.getServers();return void 0===t?n.map((function(t){return{server:t,methods:[]}})):n.reduce((function(n,i){var r=Object.values(i.methods).filter((function(n){return e.methodMatch(t,n)}));return r.length>0&&n.push({server:i,methods:r}),n}),[])},t.prototype.getServerMethodsByFilterAndTarget=function(t,e){var n=this.getServers(t);return this.filterByTarget(e,n)},t}(),Bt=function(){function t(t,e,n){this.protocol=t,this.repoMethod=e,this.subscription=n}return Object.defineProperty(t.prototype,"stream",{get:function(){if(!this.repoMethod.stream)throw new Error("no stream");return this.repoMethod.stream},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"arguments",{get:function(){return this.subscription.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"branchKey",{get:function(){return this.subscription.branchKey},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"instance",{get:function(){if(!this.subscription.instance)throw new Error("no instance");return this.subscription.instance},enumerable:!0,configurable:!0}),t.prototype.close=function(){this.protocol.server.closeSingleSubscription(this.repoMethod,this.subscription)},t.prototype.push=function(t){this.protocol.server.pushDataToSingle(this.repoMethod,this.subscription,t)},t}(),Ht=function(){function t(t,e,n){this.protocol=t,this.repoMethod=e,this.requestContext=n,this.arguments=n.arguments,this.instance=n.instance}return t.prototype.accept=function(){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,"")},t.prototype.acceptOnBranch=function(t){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,t)},t.prototype.reject=function(t){this.protocol.server.rejectRequest(this.requestContext,this.repoMethod,t)},t}(),qt=function(){function t(t,e){var n=this;this.protocol=t,this.server=e,t.server.onSubRequest((function(t,e){return n.handleSubRequest(t,e)})),t.server.onSubAdded((function(t,e){return n.handleSubAdded(t,e)})),t.server.onSubRemoved((function(t,e){return n.handleSubRemoved(t,e)}))}return t.prototype.handleSubRequest=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionRequestHandler){var n=new Ht(this.protocol,e,t);e.streamCallbacks.subscriptionRequestHandler(n)}},t.prototype.handleSubAdded=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionAddedHandler){var n=new Bt(this.protocol,e,t);e.streamCallbacks.subscriptionAddedHandler(n)}},t.prototype.handleSubRemoved=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionRemovedHandler){var n=new Bt(this.protocol,e,t);e.streamCallbacks.subscriptionRemovedHandler(n)}},t}(),Ut=function(){function t(t,e,n){this.key=t,this.protocol=e,this.repoMethod=n}return t.prototype.subscriptions=function(){var t=this;return this.protocol.server.getSubscriptionList(this.repoMethod,this.key).map((function(e){return new Bt(t.protocol,t.repoMethod,e)}))},t.prototype.close=function(){this.protocol.server.closeAllSubscriptions(this.repoMethod,this.key)},t.prototype.push=function(t){this.protocol.server.pushData(this.repoMethod,t,[this.key])},t}(),Vt=function(){function t(t,e,n){this._protocol=t,this._repoMethod=e,this._server=n,this.name=this._repoMethod.definition.name}return t.prototype.branches=function(t){var e=this,n=this._protocol.server.getBranchList(this._repoMethod);return t?n.indexOf(t)>-1?new Ut(t,this._protocol,this._repoMethod):void 0:n.map((function(t){return new Ut(t,e._protocol,e._repoMethod)}))},t.prototype.branch=function(t){return this.branches(t)},t.prototype.subscriptions=function(){var t=this;return this._protocol.server.getSubscriptionList(this._repoMethod).map((function(e){return new Bt(t._protocol,t._repoMethod,e)}))},Object.defineProperty(t.prototype,"definition",{get:function(){var t,e=this._repoMethod.definition;return{accepts:e.accepts,description:e.description,displayName:e.displayName,name:e.name,objectTypes:e.objectTypes,returns:e.returns,supportsStreaming:e.supportsStreaming,flags:null===(t=e.flags)||void 0===t?void 0:t.metadata}},enumerable:!0,configurable:!0}),t.prototype.close=function(){this._protocol.server.closeAllSubscriptions(this._repoMethod),this._server.unregister(this._repoMethod.definition,!0)},t.prototype.push=function(t,e){if("string"!=typeof e&&!Array.isArray(e)&&void 0!==e)throw new Error("invalid branches should be string or string array");if("object"!=typeof t)throw new Error("Invalid arguments. Data must be an object.");this._protocol.server.pushData(this._repoMethod,t,e)},t.prototype.updateRepoMethod=function(t){this._repoMethod=t},t}(),zt=function(){function t(t,e){this.protocol=t,this.serverRepository=e,this.invocations=0,this.currentlyUnregistering={},this.streaming=new qt(t,this),this.protocol.server.onInvoked(this.onMethodInvoked.bind(this))}return t.prototype.createStream=function(t,e,n,i,r){var o=this;return Lt(new Promise((function(n,i){if(t){var s;if(!(s="string"==typeof t?{name:""+t}:c({},t)).name)return i("The name property is required for the streamDefinition object and must be unique. Stream definition: "+JSON.stringify(s));if(o.serverRepository.getList().some((function(t){return t.definition.name===s.name})))return i('A stream with the name "'+s.name+'" already exists! Please, provide a unique name for the stream.');s.supportsStreaming=!0,e||(e={}),"function"!=typeof e.subscriptionRequestHandler&&(e.subscriptionRequestHandler=function(t){t.accept()});var a=o.serverRepository.add({definition:s,streamCallbacks:e,protocolState:{}});o.protocol.server.createStream(a).then((function(){var t;r?(t=r,r.updateRepoMethod(a)):t=new Vt(o.protocol,a,o),a.stream=t,n(t)})).catch((function(t){a.repoId&&o.serverRepository.remove(a.repoId),i(t)}))}else i("The stream name must be unique! Please, provide either a unique string for a stream name to glue.interop.createStream() or a methodDefinition object with a unique name property for the stream.")})),n,i)},t.prototype.register=function(t,e){var n=this;if(!t)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");if("function"!=typeof e)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof t?t:t.name));var i=function(t,i){return u(n,void 0,void 0,(function(){var n,r,o;return d(this,(function(s){switch(s.label){case 0:return s.trys.push([0,4,,5]),(n=e(t.args,t.instance))&&"function"==typeof n.then?[4,n]:[3,2];case 1:return r=s.sent(),i(void 0,r),[3,3];case 2:i(void 0,n),s.label=3;case 3:return[3,5];case 4:return(o=s.sent())||(o=""),i(o,o),[3,5];case 5:return[2]}}))}))};return i.userCallback=e,this.registerCore(t,i)},t.prototype.registerAsync=function(t,e){if(!t)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");if("function"!=typeof e)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof t?t:t.name));var n=function(t,n){try{var i=!1,r=function(t){i||n(void 0,t),i=!0},o=function(t){i||(t||(t=""),n(t,t)),i=!0},s=e(t.args,t.instance,r,o);s&&"function"==typeof s.then&&s.then(r).catch(o)}catch(t){n(t,void 0)}};return n.userCallbackAsync=e,this.registerCore(t,n)},t.prototype.unregister=function(t,e){return void 0===e&&(e=!1),u(this,void 0,void 0,(function(){var n,i;return d(this,(function(r){switch(r.label){case 0:return void 0===t?[2,Promise.reject("Please, provide either a unique string for a name or an object containing a name property.")]:"function"!=typeof t?[3,2]:[4,this.unregisterWithPredicate(t,e)];case 1:return r.sent(),[2];case 2:return void 0===(n="string"==typeof t?{name:t}:t).name?[2,Promise.reject("Method name is required. Cannot find a method if the method name is undefined!")]:(i=this.serverRepository.getList().find((function(t){return t.definition.name===n.name&&(t.definition.supportsStreaming||!1)===e})))?[4,this.removeMethodsOrStreams([i])]:[2,Promise.reject('Method with a name "'+n.name+'" does not exist or is not registered by your application!')];case 3:return r.sent(),[2]}}))}))},t.prototype.unregisterWithPredicate=function(t,e){return u(this,void 0,void 0,(function(){var n;return d(this,(function(i){switch(i.label){case 0:return(n=this.serverRepository.getList().filter((function(e){return t(e.definition)})).filter((function(t){return(t.definition.supportsStreaming||!1)===e})))&&0!==n.length?[4,this.removeMethodsOrStreams(n)]:[2,Promise.reject("Could not find a "+(e?"stream":"method")+" matching the specified condition!")];case 1:return i.sent(),[2]}}))}))},t.prototype.removeMethodsOrStreams=function(t){var e=this,n=[];return t.forEach((function(t){var i=e.protocol.server.unregister(t).then((function(){t.repoId&&e.serverRepository.remove(t.repoId)}));n.push(i),e.addAsCurrentlyUnregistering(t.definition.name,i)})),Promise.all(n)},t.prototype.addAsCurrentlyUnregistering=function(t,e){return u(this,void 0,void 0,(function(){var n,i=this;return d(this,(function(r){return n=new Promise((function(t){return setTimeout(t,5e3)})),this.currentlyUnregistering[t]=Promise.race([e,n]).then((function(){delete i.currentlyUnregistering[t]})),[2]}))}))},t.prototype.registerCore=function(t,e){return u(this,void 0,void 0,(function(){var n,i,r,o=this;return d(this,(function(s){switch(s.label){case 0:return(n="string"==typeof t?{name:""+t}:c({},t)).name?(i=this.currentlyUnregistering[n.name])?[4,i]:[3,2]:[2,Promise.reject("Please, provide a (unique) string value for the name property in the methodDefinition object: "+JSON.stringify(t))];case 1:s.sent(),s.label=2;case 2:return this.serverRepository.getList().some((function(t){return t.definition.name===n.name}))?[2,Promise.reject('A method with the name "'+n.name+'" already exists! Please, provide a unique name for the method.')]:n.supportsStreaming?[2,Promise.reject("When you create methods with glue.interop.register() or glue.interop.registerAsync() the property supportsStreaming cannot be true. If you want "+n.name+" to be a stream, please use the glue.interop.createStream() method.")]:(r=this.serverRepository.add({definition:n,theFunction:e,protocolState:{}}),[2,this.protocol.server.register(r).catch((function(t){throw(null==r?void 0:r.repoId)&&o.serverRepository.remove(r.repoId),t}))])}}))}))},t.prototype.onMethodInvoked=function(t,e,n){var i=this;t&&t.theFunction&&t.theFunction(n,(function(n,r){if(null!=n)if(n.message&&"string"==typeof n.message)n=n.message;else if("string"!=typeof n)try{n=JSON.stringify(n)}catch(t){n="un-stringifyable error in onMethodInvoked! Top level prop names: "+Object.keys(n)}r?("object"!=typeof r||Array.isArray(r))&&(r={_value:r}):r={},i.protocol.server.methodInvocationResult(t,e,n,r)}))},t}(),Jt=function(){function t(t,e,n){var i=this;this.wrapped={},this.wrapped.getMethods=function(){return t.methodsForInstance(this)},this.wrapped.getStreams=function(){return t.methodsForInstance(this).filter((function(t){return t.supportsStreaming}))},e&&this.refreshWrappedObject(e),n&&(n.loggedIn((function(){i.refresh(n)})),this.refresh(n))}return t.prototype.unwrap=function(){return this.wrapped},t.prototype.refresh=function(t){if(t){var e=null==t?void 0:t.resolvedIdentity,n=Object.assign({},null!=e?e:{},{peerId:null==t?void 0:t.peerId});this.refreshWrappedObject(n)}},t.prototype.refreshWrappedObject=function(t){var e,n,i;this.wrapped.user=t.user,this.wrapped.instance=t.instance,this.wrapped.application=null!==(e=t.application)&&void 0!==e?e:rt(),this.wrapped.applicationName=t.applicationName,this.wrapped.pid=null!==(i=null!==(n=t.pid)&&void 0!==n?n:t.process)&&void 0!==i?i:Math.floor(1e10*Math.random()),this.wrapped.machine=t.machine,this.wrapped.environment=t.environment,this.wrapped.region=t.region,this.wrapped.windowId=t.windowId,this.wrapped.isLocal=!0,this.wrapped.api=t.api,this.wrapped.service=t.service,this.wrapped.peerId=t.peerId},t}(),Kt=function(t){return c(c({},t),{flags:t.flags.metadata||{}})},Zt=function(){function t(t,e){this.logger=t,this.API=e,this.servers={},this.methodsCount={},this.callbacks=O();var n=this.API.instance.peerId;this.myServer={id:n,methods:{},instance:this.API.instance,wrapper:this.API.unwrappedInstance},this.servers[n]=this.myServer}return t.prototype.addServer=function(t,e){this.logger.debug("adding server "+e);var n=this.servers[e];if(n)return n.id;var i=new Jt(this.API,t),r={id:e,methods:{},instance:i.unwrap(),wrapper:i};return this.servers[e]=r,this.callbacks.execute("onServerAdded",r.instance),e},t.prototype.removeServerById=function(t,e){var n=this,i=this.servers[t];i?(this.logger.debug("removing server "+t),Object.keys(i.methods).forEach((function(e){n.removeServerMethod(t,e)})),delete this.servers[t],this.callbacks.execute("onServerRemoved",i.instance,e)):this.logger.warn("not aware of server "+t+", my state "+JSON.stringify(Object.keys(this.servers)))},t.prototype.addServerMethod=function(t,e){var n,i=this.servers[t];if(!i)throw new Error("server does not exists");if(!i.methods[e.id]){var r=this.createMethodIdentifier(e),o=this,s={identifier:r,gatewayId:e.id,name:e.name,displayName:e.display_name,description:e.description,version:e.version,objectTypes:e.object_types||[],accepts:e.input_signature,returns:e.result_signature,supportsStreaming:void 0!==e.flags&&e.flags.streaming,flags:null!==(n=e.flags)&&void 0!==n?n:{},getServers:function(){return o.getServersByMethod(r)}};s.object_types=s.objectTypes,s.display_name=s.displayName,s.version=s.version,i.methods[e.id]=s;var a=Kt(s);return this.methodsCount[r]||(this.methodsCount[r]=0,this.callbacks.execute("onMethodAdded",a)),this.methodsCount[r]=this.methodsCount[r]+1,this.callbacks.execute("onServerMethodAdded",i.instance,a),s}},t.prototype.removeServerMethod=function(t,e){var n=this.servers[t];if(!n)throw new Error("server does not exists");var i=n.methods[e];delete n.methods[e];var r=Kt(i);this.methodsCount[i.identifier]=this.methodsCount[i.identifier]-1,0===this.methodsCount[i.identifier]&&this.callbacks.execute("onMethodRemoved",r),this.callbacks.execute("onServerMethodRemoved",n.instance,r)},t.prototype.getMethods=function(){return this.extractMethodsFromServers(Object.values(this.servers)).map(Kt)},t.prototype.getServers=function(){return Object.values(this.servers).map(this.hideServerMethodSystemFlags)},t.prototype.onServerAdded=function(t){var e=this.callbacks.add("onServerAdded",t),n=this.getServers().map((function(t){return t.instance}));return this.returnUnsubWithDelayedReplay(e,n,t)},t.prototype.onMethodAdded=function(t){var e=this.callbacks.add("onMethodAdded",t),n=this.getMethods();return this.returnUnsubWithDelayedReplay(e,n,t)},t.prototype.onServerMethodAdded=function(t){var e=this.callbacks.add("onServerMethodAdded",t),n=!1,i=this.getServers();return setTimeout((function(){i.forEach((function(e){var i=e.methods;Object.keys(i).forEach((function(r){n||t(e.instance,i[r])}))}))}),0),function(){n=!0,e()}},t.prototype.onMethodRemoved=function(t){return this.callbacks.add("onMethodRemoved",t)},t.prototype.onServerRemoved=function(t){return this.callbacks.add("onServerRemoved",t)},t.prototype.onServerMethodRemoved=function(t){return this.callbacks.add("onServerMethodRemoved",t)},t.prototype.getServerById=function(t){return this.hideServerMethodSystemFlags(this.servers[t])},t.prototype.reset=function(){var t,e=this;Object.keys(this.servers).forEach((function(t){e.removeServerById(t,"reset")})),this.servers=((t={})[this.myServer.id]=this.myServer,t),this.methodsCount={}},t.prototype.createMethodIdentifier=function(t){var e=void 0!==t.input_signature?t.input_signature:"",n=void 0!==t.result_signature?t.result_signature:"";return(t.name+e+n).toLowerCase()},t.prototype.getServersByMethod=function(t){var e=[];return Object.values(this.servers).forEach((function(n){Object.values(n.methods).forEach((function(i){i.identifier===t&&e.push(n.instance)}))})),e},t.prototype.returnUnsubWithDelayedReplay=function(t,e,n){var i=!1;return setTimeout((function(){e.forEach((function(t){i||n(t)}))}),0),function(){i=!0,t()}},t.prototype.hideServerMethodSystemFlags=function(t){var e={};return Object.entries(t.methods).forEach((function(t){var n=t[0],i=t[1];e[n]=Kt(i)})),c(c({},t),{methods:e})},t.prototype.extractMethodsFromServers=function(t){return Object.values(t).reduce((function(t,e){return p(t,Object.values(e.methods))}),[])},t}(),Yt=function(){function t(){this.nextId=0,this.methods=[]}return t.prototype.add=function(t){return t.repoId=String(this.nextId),this.nextId+=1,this.methods.push(t),t},t.prototype.remove=function(t){if("string"!=typeof t)return new TypeError("Expecting a string");this.methods=this.methods.filter((function(e){return e.repoId!==t}))},t.prototype.getById=function(t){if("string"==typeof t)return this.methods.find((function(e){return e.repoId===t}))},t.prototype.getList=function(){return this.methods.map((function(t){return t}))},t.prototype.length=function(){return this.methods.length},t.prototype.reset=function(){this.methods=[]},t}(),Xt="onSubscriptionRequest",Qt="onSubscriptionAdded",$t="onSubscriptionRemoved",te=function(){function t(t,e,n){var i=this;this.session=t,this.repository=e,this.serverRepository=n,this.ERR_URI_SUBSCRIPTION_FAILED="com.tick42.agm.errors.subscription.failure",this.callbacks=O(),this.nextStreamId=0,t.on("add-interest",(function(t){i.handleAddInterest(t)})),t.on("remove-interest",(function(t){i.handleRemoveInterest(t)}))}return t.prototype.acceptRequestOnBranch=function(t,e,n){if("string"!=typeof n&&(n=""),"object"!=typeof e.protocolState.subscriptionsMap)throw new TypeError("The streaming method is missing its subscriptions.");if(!Array.isArray(e.protocolState.branchKeyToStreamIdMap))throw new TypeError("The streaming method is missing its branches.");var i=this.getStreamId(e,n),r=t.msg.subscription_id,o={id:r,arguments:t.arguments,instance:t.instance,branchKey:n,streamId:i,subscribeMsg:t.msg};e.protocolState.subscriptionsMap[r]=o,this.session.sendFireAndForget({type:"accepted",subscription_id:r,stream_id:i}),this.callbacks.execute(Qt,o,e)},t.prototype.rejectRequest=function(t,e,n){"string"!=typeof n&&(n=""),this.sendSubscriptionFailed("Subscription rejected by user. "+n,t.msg.subscription_id)},t.prototype.pushData=function(t,e,n){var i=this;if("object"==typeof t&&Array.isArray(t.protocolState.branchKeyToStreamIdMap)){if("object"!=typeof e)throw new Error("Invalid arguments. Data must be an object.");"string"==typeof n?n=[n]:(!Array.isArray(n)||n.length<=0)&&(n=[]),t.protocolState.branchKeyToStreamIdMap.filter((function(t){return!n||0===n.length||n.indexOf(t.key)>=0})).map((function(t){return t.streamId})).forEach((function(t){var n={type:"publish",stream_id:t,data:e};i.session.sendFireAndForget(n)}))}},t.prototype.pushDataToSingle=function(t,e,n){if("object"!=typeof n)throw new Error("Invalid arguments. Data must be an object.");var i={type:"post",subscription_id:e.id,data:n};this.session.sendFireAndForget(i)},t.prototype.closeSingleSubscription=function(t,e){t.protocolState.subscriptionsMap&&delete t.protocolState.subscriptionsMap[e.id];var n={type:"drop-subscription",subscription_id:e.id,reason:"Server dropping a single subscription"};this.session.sendFireAndForget(n);e.instance;this.callbacks.execute($t,e,t)},t.prototype.closeMultipleSubscriptions=function(t,e){var n=this;if("object"==typeof t&&"object"==typeof t.protocolState.subscriptionsMap&&t.protocolState.subscriptionsMap){var i=t.protocolState.subscriptionsMap,r=Object.keys(i).map((function(t){return i[t]}));"string"==typeof e&&(r=r.filter((function(t){return t.branchKey===e}))),r.forEach((function(t){delete i[t.id];var e={type:"drop-subscription",subscription_id:t.id,reason:"Server dropping all subscriptions on stream_id: "+t.streamId};n.session.sendFireAndForget(e)}))}},t.prototype.getSubscriptionList=function(t,e){if("object"!=typeof t)return[];if(!t.protocolState.subscriptionsMap)return[];var n=t.protocolState.subscriptionsMap,i=Object.keys(n).map((function(t){return n[t]}));return"string"!=typeof e?i:i.filter((function(t){return t.branchKey===e}))},t.prototype.getBranchList=function(t){if("object"!=typeof t)return[];if(!t.protocolState.subscriptionsMap)return[];var e=t.protocolState.subscriptionsMap,n=Object.keys(e).map((function(t){return e[t]})),i=[];return n.forEach((function(t){var e="";"object"==typeof t&&"string"==typeof t.branchKey&&(e=t.branchKey),-1===i.indexOf(e)&&i.push(e)})),i},t.prototype.onSubAdded=function(t){this.onSubscriptionLifetimeEvent(Qt,t)},t.prototype.onSubRequest=function(t){this.onSubscriptionLifetimeEvent(Xt,t)},t.prototype.onSubRemoved=function(t){this.onSubscriptionLifetimeEvent($t,t)},t.prototype.handleRemoveInterest=function(t){var e=this.serverRepository.getById(t.method_id);if("string"==typeof t.subscription_id&&"object"==typeof e&&e.protocolState.subscriptionsMap&&"object"==typeof e.protocolState.subscriptionsMap[t.subscription_id]){var n=e.protocolState.subscriptionsMap[t.subscription_id];delete e.protocolState.subscriptionsMap[t.subscription_id],this.callbacks.execute($t,n,e)}},t.prototype.onSubscriptionLifetimeEvent=function(t,e){this.callbacks.add(t,e)},t.prototype.getNextStreamId=function(){return this.nextStreamId+++""},t.prototype.handleAddInterest=function(t){var e=this.repository.getServerById(t.caller_id).instance,n={msg:t,arguments:t.arguments_kv||{},instance:e},i=this.serverRepository.getById(t.method_id);if(void 0!==i)i.protocolState.subscriptionsMap&&i.protocolState.subscriptionsMap[t.subscription_id]?this.sendSubscriptionFailed("A subscription with id "+t.subscription_id+" already exists.",t.subscription_id):this.callbacks.execute(Xt,n,i);else{var r="No method with id "+t.method_id+" on this server.";this.sendSubscriptionFailed(r,t.subscription_id)}},t.prototype.sendSubscriptionFailed=function(t,e){var n={type:"error",reason_uri:this.ERR_URI_SUBSCRIPTION_FAILED,reason:t,request_id:e};this.session.sendFireAndForget(n)},t.prototype.getStreamId=function(t,e){if("string"!=typeof e&&(e=""),!t.protocolState.branchKeyToStreamIdMap)throw new Error("streaming "+t.definition.name+" method without protocol state");var n=t.protocolState.branchKeyToStreamIdMap.filter((function(t){return t.key===e}))[0],i=n?n.streamId:void 0;return"string"==typeof i&&""!==i||(i=this.getNextStreamId(),t.protocolState.branchKeyToStreamIdMap.push({key:e,streamId:i})),i},t}(),ee=function(){function t(t,e,n,i){var r=this;this.session=t,this.clientRepository=e,this.serverRepository=n,this.logger=i,this.callbacks=O(),this.streaming=new te(t,e,n),this.session.on("invoke",(function(t){return r.handleInvokeMessage(t)}))}return t.prototype.createStream=function(t){return t.protocolState.subscriptionsMap={},t.protocolState.branchKeyToStreamIdMap=[],this.register(t,!0)},t.prototype.register=function(t,e){var n,i=this,r=t.definition,o=Object.assign({},{metadata:null!==(n=r.flags)&&void 0!==n?n:{}},{streaming:e||!1}),s={type:"register",methods:[{id:t.repoId,name:r.name,display_name:r.displayName,description:r.description,version:r.version,flags:o,object_types:r.objectTypes||r.object_types,input_signature:r.accepts,result_signature:r.returns,restrictions:void 0}]};return this.session.send(s,{methodId:t.repoId}).then((function(){i.logger.debug("registered method "+t.definition.name+" with id "+t.repoId)})).catch((function(e){throw i.logger.warn("failed to register method "+t.definition.name+" with id "+t.repoId+" - "+JSON.stringify(e)),e}))},t.prototype.onInvoked=function(t){this.callbacks.add("onInvoked",t)},t.prototype.methodInvocationResult=function(t,e,n,i){var r;r=n||""===n?{type:"error",request_id:e,reason_uri:"agm.errors.client_error",reason:n,context:i,peer_id:void 0}:{type:"yield",invocation_id:e,peer_id:this.session.peerId,result:i,request_id:void 0},this.session.sendFireAndForget(r)},t.prototype.unregister=function(t){return u(this,void 0,void 0,(function(){var e;return d(this,(function(n){switch(n.label){case 0:return e={type:"unregister",methods:[t.repoId]},[4,this.session.send(e)];case 1:return n.sent(),[2]}}))}))},t.prototype.getBranchList=function(t){return this.streaming.getBranchList(t)},t.prototype.getSubscriptionList=function(t,e){return this.streaming.getSubscriptionList(t,e)},t.prototype.closeAllSubscriptions=function(t,e){this.streaming.closeMultipleSubscriptions(t,e)},t.prototype.pushData=function(t,e,n){this.streaming.pushData(t,e,n)},t.prototype.pushDataToSingle=function(t,e,n){this.streaming.pushDataToSingle(t,e,n)},t.prototype.closeSingleSubscription=function(t,e){this.streaming.closeSingleSubscription(t,e)},t.prototype.acceptRequestOnBranch=function(t,e,n){this.streaming.acceptRequestOnBranch(t,e,n)},t.prototype.rejectRequest=function(t,e,n){this.streaming.rejectRequest(t,e,n)},t.prototype.onSubRequest=function(t){this.streaming.onSubRequest(t)},t.prototype.onSubAdded=function(t){this.streaming.onSubAdded(t)},t.prototype.onSubRemoved=function(t){this.streaming.onSubRemoved(t)},t.prototype.handleInvokeMessage=function(t){var e=t.invocation_id,n=t.caller_id,i=t.method_id,r=t.arguments_kv,o=this.serverRepository.getList().filter((function(t){return t.repoId===i}))[0];if(void 0!==o){var s={args:r,instance:this.clientRepository.getServerById(n).instance};this.callbacks.execute("onInvoked",o,e,s)}},t}(),ne=function(){function t(t,e){this.repository=t,this.subscriptionData=e}return Object.defineProperty(t.prototype,"requestArguments",{get:function(){return this.subscriptionData.params.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"servers",{get:function(){var t=this;return this.subscriptionData.trackedServers.filter((function(t){return t.subscriptionId})).map((function(e){return t.repository.getServerById(e.serverId).instance}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"serverInstance",{get:function(){return this.servers[0]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stream",{get:function(){return this.subscriptionData.method},enumerable:!0,configurable:!0}),t.prototype.onData=function(t){if("function"!=typeof t)throw new TypeError("The data callback must be a function.");this.subscriptionData.handlers.onData.push(t),1===this.subscriptionData.handlers.onData.length&&this.subscriptionData.queued.data.length>0&&this.subscriptionData.queued.data.forEach((function(e){t(e)}))},t.prototype.onClosed=function(t){if("function"!=typeof t)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onClosed.push(t)},t.prototype.onFailed=function(t){},t.prototype.onConnected=function(t){if("function"!=typeof t)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onConnected.push(t)},t.prototype.close=function(){this.subscriptionData.close()},t.prototype.setNewSubscription=function(t){this.subscriptionData=t},t}(),ie="awaitingAccept",re="subscribed",oe="Subscription failed.",se="ClientInitiated",ae=function(){function t(t,e,n){var i=this;this.session=t,this.repository=e,this.logger=n,this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},this.nextSubLocalKey=0,this.handleErrorSubscribing=function(t){var e=t._tag,n=e.subLocalKey,r=i.subscriptionsList[n];if("object"==typeof r&&(r.trackedServers=r.trackedServers.filter((function(t){return t.serverId!==e.serverId})),r.trackedServers.length<=0)){if(clearTimeout(r.timeoutId),r.status===ie){var o="string"==typeof t.reason&&""!==t.reason?' Publisher said "'+t.reason+'".':" No reason given.",s="object"==typeof r.params.arguments?JSON.stringify(r.params.arguments):"{}";r.error({message:"Subscription rejected."+o+" Called with:"+s,called_with:r.params.arguments,method:r.method})}else r.status===re&&i.callOnClosedHandlers(r);delete i.subscriptionsList[n]}},this.handleSubscribed=function(t){var e=t._tag.subLocalKey,n=i.subscriptionsList[e];if("object"==typeof n){var r=t._tag.serverId,o=n.trackedServers.filter((function(t){return t.serverId===r}))[0];if("object"==typeof o){o.subscriptionId=t.subscription_id,i.subscriptionIdToLocalKeyMap[t.subscription_id]=e;var s=n.status===ie;if(n.status=re,s){var a=!1,c=n.subscription;c?(c.setNewSubscription(n),n.success(c),a=!0):(c=new ne(i.repository,n),n.subscription=c,n.success(c));for(var u=0,d=n.handlers.onConnected;u<d.length;u++){var p=d[u];try{p(c.serverInstance,a)}catch(t){}}}}}},this.handleEventData=function(t){var e=i.subscriptionIdToLocalKeyMap[t.subscription_id];if(void 0!==e){var n=i.subscriptionsList[e];if("object"==typeof n){var r=n.trackedServers.filter((function(e){return e.subscriptionId===t.subscription_id}));if(1===r.length){var o=t.oob,s=r[0].serverId,a=function(){return{data:t.data,server:i.repository.getServerById(s).instance,requestArguments:n.params.arguments,message:void 0,private:o}},c=n.handlers.onData,u=n.queued.data;c.length>0?c.forEach((function(t){"function"==typeof t&&t(a())})):u.push(a())}}}},this.handleSubscriptionCancelled=function(t){var e=i.subscriptionIdToLocalKeyMap[t.subscription_id];if(void 0!==e){var n=i.subscriptionsList[e];if("object"==typeof n){var r=n.trackedServers.length-1;n.trackedServers=n.trackedServers.filter((function(e){return e.subscriptionId!==t.subscription_id||(n.queued.closers.push(e.serverId),!1)})),n.trackedServers.length===r&&(n.trackedServers.length<=0&&(clearTimeout(n.timeoutId),i.callOnClosedHandlers(n),delete i.subscriptionsList[e]),delete i.subscriptionIdToLocalKeyMap[t.subscription_id])}}},t.on("subscribed",this.handleSubscribed),t.on("event",this.handleEventData),t.on("subscription-cancelled",this.handleSubscriptionCancelled)}return t.prototype.subscribe=function(t,e,n,i,r,o){var s=this;if(0!==n.length){var a=this.getNextSubscriptionLocalKey(),c=this.registerSubscription(a,t,e,i,r,e.methodResponseTimeout||1e4,o);"object"==typeof c?n.forEach((function(n){var i=n.server.id,r=n.methods.find((function(e){return e.name===t.name}));if(r){c.trackedServers.push({serverId:i,subscriptionId:void 0});var o={type:"subscribe",server_id:i,method_id:r.gatewayId,arguments_kv:e.arguments};s.session.send(o,{serverId:i,subLocalKey:a}).then((function(t){return s.handleSubscribed(t)})).catch((function(t){return s.handleErrorSubscribing(t)}))}else s.logger.error("can not find method "+t.name+" for target "+n.server.id)})):r({method:t,called_with:e.arguments,message:oe+" Unable to register the user callbacks."})}else r({method:t,called_with:e.arguments,message:oe+" No available servers matched the target params."})},t.prototype.drainSubscriptions=function(){var t=Object.values(this.subscriptionsList);return this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},t},t.prototype.getNextSubscriptionLocalKey=function(){var t=this.nextSubLocalKey;return this.nextSubLocalKey+=1,t},t.prototype.registerSubscription=function(t,e,n,i,r,o,s){var a=this,c={localKey:t,status:ie,method:e,params:n,success:i,error:r,trackedServers:[],handlers:{onData:(null==s?void 0:s.handlers.onData)||[],onClosed:(null==s?void 0:s.handlers.onClosed)||[],onConnected:(null==s?void 0:s.handlers.onConnected)||[]},queued:{data:[],closers:[]},timeoutId:void 0,close:function(){return a.closeSubscription(t)},subscription:null==s?void 0:s.subscription};return s||(n.onData&&c.handlers.onData.push(n.onData),n.onClosed&&c.handlers.onClosed.push(n.onClosed),n.onConnected&&c.handlers.onConnected.push(n.onConnected)),this.subscriptionsList[t]=c,c.timeoutId=setTimeout((function(){if(void 0!==a.subscriptionsList[t]){var i=a.subscriptionsList[t];i.status===ie?(r({method:e,called_with:n.arguments,message:oe+" Subscription attempt timed out after "+o+" ms."}),delete a.subscriptionsList[t]):i.status===re&&i.trackedServers.length>0&&(i.trackedServers=i.trackedServers.filter((function(t){return void 0!==t.subscriptionId})),delete i.timeoutId,i.trackedServers.length<=0&&(a.callOnClosedHandlers(i),delete a.subscriptionsList[t]))}}),o),c},t.prototype.callOnClosedHandlers=function(t,e){var n,i=t.queued.closers.length,r=i>0?t.queued.closers[i-1]:null;void 0!==r&&"string"==typeof r&&(n=this.repository.getServerById(r).instance),t.handlers.onClosed.forEach((function(i){"function"==typeof i&&i({message:e||"ServerInitiated",requestArguments:t.params.arguments||{},server:n,stream:t.method})}))},t.prototype.closeSubscription=function(t){var e=this,n=this.subscriptionsList[t];"object"==typeof n&&(n.trackedServers.forEach((function(t){void 0!==t.subscriptionId&&(n.queued.closers.push(t.serverId),e.session.sendFireAndForget({type:"unsubscribe",subscription_id:t.subscriptionId,reason_uri:"",reason:se}),delete e.subscriptionIdToLocalKeyMap[t.subscriptionId])})),n.trackedServers=[],this.callOnClosedHandlers(n,se),delete this.subscriptionsList[t])},t}(),ce=function(){function t(t,e,n){var i=this;this.session=t,this.repository=e,this.logger=n,t.on("peer-added",(function(t){return i.handlePeerAdded(t)})),t.on("peer-removed",(function(t){return i.handlePeerRemoved(t)})),t.on("methods-added",(function(t){return i.handleMethodsAddedMessage(t)})),t.on("methods-removed",(function(t){return i.handleMethodsRemovedMessage(t)})),this.streaming=new ae(t,e,n)}return t.prototype.subscribe=function(t,e,n,i,r,o){this.streaming.subscribe(t,e,n,i,r,o)},t.prototype.invoke=function(t,e,n,i){var r=this,o=i.id,s={type:"call",server_id:o,method_id:e.gatewayId,arguments_kv:n};return this.session.send(s,{invocationId:t,serverId:o}).then((function(t){return r.handleResultMessage(t)})).catch((function(t){return r.handleInvocationError(t)}))},t.prototype.drainSubscriptions=function(){return this.streaming.drainSubscriptions()},t.prototype.handlePeerAdded=function(t){var e=t.new_peer_id,n=t.identity,i=!t.meta||t.meta.local,r=Number(n.process),o={machine:n.machine,pid:isNaN(r)?n.process:r,instance:n.instance,application:n.application,applicationName:n.applicationName,environment:n.environment,region:n.region,user:n.user,windowId:n.windowId,peerId:e,api:n.api,isLocal:i};this.repository.addServer(o,e)},t.prototype.handlePeerRemoved=function(t){var e=t.removed_id,n=t.reason;this.repository.removeServerById(e,n)},t.prototype.handleMethodsAddedMessage=function(t){var e=this,n=t.server_id;t.methods.forEach((function(t){e.repository.addServerMethod(n,t)}))},t.prototype.handleMethodsRemovedMessage=function(t){var e=this,n=t.server_id,i=t.methods,r=this.repository.getServerById(n);Object.keys(r.methods).forEach((function(t){var o=r.methods[t];i.indexOf(o.gatewayId)>-1&&e.repository.removeServerMethod(n,t)}))},t.prototype.handleResultMessage=function(t){var e=t._tag.invocationId,n=t.result,i=t._tag.serverId;return{invocationId:e,result:n,instance:this.repository.getServerById(i).instance,status:Rt.Success,message:""}},t.prototype.handleInvocationError=function(t){if(this.logger.debug("handle invocation error "+JSON.stringify(t)),"_tag"in t){var e=t._tag.invocationId,n=t._tag.serverId,i=this.repository.getServerById(n),r=t.reason;return{invocationId:e,result:t.context,instance:i.instance,status:Rt.Error,message:r}}return{invocationId:"",message:t.message,status:Rt.Error,error:t}},t}();function ue(t,e,n,i,r,o){var s,a=r.logger.subLogger("gw3-protocol"),c=new Promise((function(t){s=t})),u=e.domain("agm",["subscribed"]),d=new ee(u,n,i,a.subLogger("server")),p=new ce(u,n,a.subLogger("client"));return u.onJoined((function(r){n.addServer(t,e.peerId),r?function(){a.info("reconnected - will replay registered methods and subscriptions");for(var t=0,e=p.drainSubscriptions();t<e.length;t++){var n=e[t],r=n.method,s=Object.assign({},n.params);a.info("trying to re-subscribe to method "+r.name),o.client.subscribe(r,s,void 0,void 0,n)}var c=i.getList();i.reset();for(var u=0,d=c;u<d.length;u++){var h=d[u],l=h.definition;a.info("re-publishing method "+l.name),h.stream?o.server.createStream(l,h.streamCallbacks,void 0,void 0,h.stream):h.theFunction&&h.theFunction.userCallback?o.register(l,h.theFunction.userCallback):h.theFunction&&h.theFunction.userCallbackAsync&&o.registerAsync(l,h.theFunction.userCallbackAsync)}}():s&&(s({client:p,server:d}),s=void 0)})),u.onLeft((function(){n.reset()})),u.join(),c}var de=function(){function t(t){var e=this;if(void 0===t)throw new Error("configuration is required");if(void 0===t.connection)throw new Error("configuration.connections is required");var n,i=t.connection;if("number"!=typeof t.methodResponseTimeout&&(t.methodResponseTimeout=3e4),"number"!=typeof t.waitTimeoutMs&&(t.waitTimeoutMs=3e4),this.unwrappedInstance=new Jt(this,void 0,i),this.instance=this.unwrappedInstance.unwrap(),this.clientRepository=new Zt(t.logger.subLogger("cRep"),this),this.serverRepository=new Yt,3!==i.protocolVersion)throw new Error("protocol "+i.protocolVersion+" not supported");n=ue(this.instance,i,this.clientRepository,this.serverRepository,t,this),this.readyPromise=n.then((function(n){return e.protocol=n,e.client=new Gt(e.protocol,e.clientRepository,e.instance,t),e.server=new zt(e.protocol,e.serverRepository),e}))}return t.prototype.ready=function(){return this.readyPromise},t.prototype.serverRemoved=function(t){return this.client.serverRemoved(t)},t.prototype.serverAdded=function(t){return this.client.serverAdded(t)},t.prototype.serverMethodRemoved=function(t){return this.client.serverMethodRemoved(t)},t.prototype.serverMethodAdded=function(t){return this.client.serverMethodAdded(t)},t.prototype.methodRemoved=function(t){return this.client.methodRemoved(t)},t.prototype.methodAdded=function(t){return this.client.methodAdded(t)},t.prototype.methodsForInstance=function(t){return this.client.methodsForInstance(t)},t.prototype.methods=function(t){return this.client.methods(t)},t.prototype.servers=function(t){return this.client.servers(t)},t.prototype.subscribe=function(t,e,n,i){return this.client.subscribe(t,e,n,i)},t.prototype.createStream=function(t,e,n,i){return this.server.createStream(t,e,n,i)},t.prototype.unregister=function(t){return this.server.unregister(t)},t.prototype.registerAsync=function(t,e){return this.server.registerAsync(t,e)},t.prototype.register=function(t,e){return this.server.register(t,e)},t.prototype.invoke=function(t,e,n,i,r,o){return this.client.invoke(t,e,n,i,r,o)},t.prototype.waitForMethod=function(t){var e=new N,n=this.client.methodAdded((function(i){i.name===t&&(n(),e.resolve(i))}));return e.promise},t}(),pe=["subscribed","success"],he=function(){function t(t,e){var n=this;this.publish=function(t,e,i){var r=i||{},o=r.routingKey,s=r.target,a=n.removeEmptyValues({type:"publish",topic:t,data:e,peer_id:n.peerId,routing_key:o,target_identity:s});n.session.send(a)},this.subscribe=function(t,e,i){return new Promise((function(r,o){var s=i||{},a=s.routingKey,c=s.target,u=n.removeEmptyValues({type:"subscribe",topic:t,peer_id:n.peerId,routing_key:a,source:c});n.session.send(u).then((function(i){var o=i.subscription_id;n.subscriptions.push({subscription_id:o,topic:t,callback:e,source:c}),r({unsubscribe:function(){return n.session.send({type:"unsubscribe",subscription_id:o,peer_id:n.peerId}),n.subscriptions=n.subscriptions.filter((function(t){return t.subscription_id!==o})),Promise.resolve()}})})).catch((function(t){return o(t)}))}))},this.watchOnEvent=function(){n.session.on("event",(function(t){var e=t.data,i=t.subscription_id,r=t["publisher-identity"],o=n.subscriptions.find((function(t){return t.subscription_id===i}));o&&(o.source?n.keysMatch(o.source,r)&&o.callback(e,o.topic,r):o.callback(e,o.topic,r))}))},this.connection=t,this.logger=e,this.peerId=t.peerId,this.subscriptions=[],this.session=t.domain("bus",pe),this.readyPromise=this.session.join(),this.readyPromise.then((function(){n.watchOnEvent()}))}return t.prototype.ready=function(){return this.readyPromise},t.prototype.removeEmptyValues=function(t){var e={};return Object.keys(t).forEach((function(n){void 0!==t[n]&&null!==t[n]&&(e[n]=t[n])})),e},t.prototype.keysMatch=function(t,e){var n=Object.keys(t),i=!0;return n.forEach((function(n){t[n]!==e[n]&&(i=!1)})),i},t}(),le=function(t,e){var n,i=F.getGDMajorVersion(),r=Promise.resolve();if(i){if(i<3)throw new Error("GD v2 is not supported. Use v4 of the API to run in that context.");i>=3&&(n=window.glue42gd,r=window.gdPreloadPromise||r)}var o,s,a,c,p,h,l,f=D("glue"),g=function(t,e,n){var i,r,o,s,a,c;if(F.isNode()){var u=process.env._GD_STARTING_CONTEXT_;if(u)try{c=JSON.parse(u)}catch(t){}}function d(){if(t.application)return t.application;if(n)return n.applicationName;var e=rt();return F.isNode()?c?c.applicationConfig.name:"NodeJS"+e:"undefined"!=typeof window&&"undefined"!=typeof document?document.title+" ("+e+")":e}var p=function(){var i,r,o,s,a,u,p,h,l,f,g=t.gateway,y=null!==(i=null==g?void 0:g.protocolVersion)&&void 0!==i?i:3,v=null==g?void 0:g.reconnectInterval,m=null==g?void 0:g.reconnectAttempts,w=null==g?void 0:g.ws,b=null==g?void 0:g.sharedWorker,_=null==g?void 0:g.inproc,I=null!==(r=null==g?void 0:g.webPlatform)&&void 0!==r?r:void 0;n&&(w=n.gwURL),F.isNode()&&c&&c.gwURL&&(w=c.gwURL),w||b||_||(w="ws://localhost:8385");var C=d(),A=C;void 0!==n?(p=n.windowId,h=n.pid,n.env&&(l=n.env.env,f=n.env.region),A=null!==(o=n.application)&&void 0!==o?o:"glue-app",u=n.appInstanceId):F.isNode()&&(h=process.pid,c&&(l=c.env,f=c.region,u=c.instanceId));var T=null!==(a=null===(s=t.gateway)||void 0===s?void 0:s.replaySpecs)&&void 0!==a?a:[];return T.push(kt),{identity:{application:A,applicationName:C,windowId:p,instance:u,process:h,region:f,environment:l,api:e.version||St},reconnectInterval:v,ws:w,sharedWorker:b,webPlatform:I,inproc:_,protocolVersion:y,reconnectAttempts:m,replaySpecs:T}}(),h=d();if("undefined"!=typeof window){var l=window,f=l.htmlContainer?l.htmlContainer.containerName+"."+l.htmlContainer.application:null===(i=null==l?void 0:l.glue42gd)||void 0===i?void 0:i.application;f&&(h=f)}return{bus:null!==(r=t.bus)&&void 0!==r&&r,application:h,auth:function(){var e,n,i;return"string"==typeof t.auth?{token:t.auth}:t.auth?t.auth:F.isNode()&&c&&c.gwToken?{gatewayToken:c.gwToken}:(null===(e=t.gateway)||void 0===e?void 0:e.webPlatform)||(null===(n=t.gateway)||void 0===n?void 0:n.inproc)||(null===(i=t.gateway)||void 0===i?void 0:i.sharedWorker)?{username:"glue42",password:"glue42"}:void 0}(),logger:function(){var e,i,r,o=t.logger,s="warn";return o||(o=s),n&&(r=n.consoleLogLevel),"string"==typeof o?{console:null!=r?r:o,publish:s}:{console:null!==(e=null!=r?r:o.console)&&void 0!==e?e:s,publish:null!==(i=o.publish)&&void 0!==i?i:s}}(),connection:p,metrics:null===(o=t.metrics)||void 0===o||o,contexts:null===(s=t.contexts)||void 0===s||s,version:e.version||St,libs:null!==(a=e.libs)&&void 0!==a?a:[],customLogger:t.customLogger}}(t=t||{},e=e||{},n),y={};function v(t,e,n){(l=a.canPublish("trace"))&&a.trace("registering "+t+" module");var i=function(){e.initTime=n.stop(),e.initEndTime=n.endTime,e.marks=n.marks,l&&a.trace(t+" is ready - "+(n.endTime-n.startTime))};e.initStartTime=n.startTime,e.ready?e.ready().then((function(){i()})):i(),Array.isArray(t)||(t=[t]),t.forEach((function(t){y[t]=e,le[t]=e}))}function m(){var t=D("interop"),e={connection:o,logger:a.subLogger("interop")};return s=new de(e),ht.Interop=s,v(["interop","agm"],s,t),Promise.resolve()}function w(){var t=g.activities&&3===o.protocolVersion;if(g.contexts||t){var e=D("contexts");return v("contexts",p=new Nt({connection:o,logger:a.subLogger("contexts")}),e),p}var n=o.replayer;n&&n.drain(kt.name)}function b(){return u(this,void 0,void 0,(function(){var t;return d(this,(function(e){return g.bus?(t=D("bus"),v("bus",h=new he(o,a.subLogger("bus")),t),[2,Promise.resolve()]):[2,Promise.resolve()]}))}))}function _(t){try{return t.forEach((function(t){!function(t,e){var n=D(t),i=e(y);i&&v(t,i,n)}(t.name,t.create)})),Promise.resolve()}catch(t){return Promise.reject(t)}}return r.then((function(){var t,e=D("logger");return(a=new ht(""+(null===(t=g.connection.identity)||void 0===t?void 0:t.application),void 0,g.customLogger)).consoleLevel(g.logger.console),a.publishLevel(g.logger.publish),a.canPublish("debug")&&a.debug("initializing glue..."),v("logger",a,e),Promise.resolve(void 0)})).then((function(){var t=D("connection");o=new dt(g.connection,a.subLogger("connection"));var e=Promise.resolve(g.auth);return g.connection&&!g.auth&&(e=n?n.getGWToken().then((function(t){return{gatewayToken:t}})):Promise.reject("You need to provide auth information")),e.then((function(e){var n;if(t.mark("auth-promise-resolved"),"[object Object]"!==Object.prototype.toString.call(e))throw new Error("Invalid auth object - "+JSON.stringify(e));return n=e,o.login(n)})).then((function(){return v("connection",o,t),g})).catch((function(t){throw o&&o.logout(),t}))})).then((function(){return Promise.all([(u=D("metrics"),d=g.metrics,p=null==n?void 0:n.getMetricsPublishingEnabled,h=g.connection.identity,l=p||function(){return!0},f=null!==(t="boolean"!=typeof d&&d.disableAutoAppSystem)&&void 0!==t&&t,v("metrics",c=E({connection:d?o:void 0,logger:a.subLogger("metrics"),canUpdateMetric:l,system:"Glue42",service:null!==(i=null!==(e=null==h?void 0:h.service)&&void 0!==e?e:null==n?void 0:n.applicationName)&&void 0!==i?i:g.application,instance:null!==(s=null!==(r=null==h?void 0:h.instance)&&void 0!==r?r:null==h?void 0:h.windowId)&&void 0!==s?s:rt(),disableAutoAppSystem:f,pagePerformanceMetrics:"boolean"!=typeof d?null==d?void 0:d.pagePerformanceMetrics:void 0}),u),Promise.resolve()),m(),w(),b()]);var t,e,i,r,s,u,d,p,h,l,f})).then((function(){return s.readyPromise})).then((function(){return _(g.libs||[])})).then((function(){var t=Object.keys(y).map((function(t){var e=y[t];return e.ready?e.ready():Promise.resolve()}));return Promise.all(t)})).then((function(){var i={coreVersion:St,version:g.version};f.stop();var r={feedback:function(t){s&&s.invoke("T42.ACS.Feedback",t,"best")},info:i,logger:a,interop:s,agm:s,connection:o,metrics:c,contexts:p,bus:h,version:g.version,userConfig:t,done:function(){return null==a||a.info("done called by user..."),o.logout()}};if(r.performance={get glueVer(){return g.version},get glueConfig(){return JSON.stringify(t)},get browser(){return window.performance.timing.toJSON()},get memory(){return window.performance.memory},get initTimes(){var t=L;return Object.keys(t).map((function(e){var n=t[e];return{name:e,duration:n.endTime-n.startTime,marks:n.marks,startTime:n.startTime,endTime:n.endTime}}))}},Object.keys(y).forEach((function(t){var e=y[t];r[t]=e})),r.config={},Object.keys(g).forEach((function(t){r.config[t]=g[t]})),e&&e.extOptions&&Object.keys(e.extOptions).forEach((function(t){r.config[t]=null==e?void 0:e.extOptions[t]})),(null==e?void 0:e.enrichGlue)&&e.enrichGlue(r),n&&n.updatePerfData&&n.updatePerfData(r.performance),r.agm){var u=function(t,e,n){return function(){return r.logger.warn("glue.js - 'glue.agm."+e+"' method is deprecated, use 'glue.interop."+n+"' instead."),t.apply(r.agm,arguments)}},d=r.agm;d.method_added=u(r.agm.methodAdded,"method_added","methodAdded"),d.method_removed=u(r.agm.methodRemoved,"method_removed","methodRemoved"),d.server_added=u(r.agm.serverAdded,"server_added","serverAdded"),d.server_method_aded=u(r.agm.serverMethodAdded,"server_method_aded","serverMethodAdded"),d.server_method_removed=u(r.agm.serverMethodRemoved,"server_method_removed","serverMethodRemoved")}return r})).catch((function(t){return Promise.reject({err:t,libs:y})}))};"undefined"!=typeof window&&(window.GlueCore=le),le.version=St,le.default=le;var fe=function(){function t(t){this._id=t}return Object.defineProperty(t.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),t.prototype._update=function(t){if(t._id!==this._id)throw Error("Can not update from entity with different id.");this._updateCore(t)},t.prototype._updateCore=function(t){},t.prototype._beforeDelete=function(t){},t}();function ge(t){return"number"==typeof t}function ye(t){return"string"==typeof t}function ve(t){return Array.isArray?Array.isArray(t):"[object Array]"===toString.call(t)}function me(t){return void 0===t}function we(t){return null==t}function be(t){return"string"!=typeof t||!t||0===t.length||/^\s*$/.test(t)}function _e(t){return!!(t&&t.constructor&&t.call&&t.apply)}function Ie(t,e){void 0!==t&&e(t)}var Ce=function(t){function n(e,n,i,r){var o=t.call(this,e)||this;return o._name=e,o._description=r,o._ownerWindow=n,o._helperWindows=i||[],o}return e(n,t),Object.defineProperty(n.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"description",{get:function(){return this._description},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"helperWindows",{get:function(){var t=this;return this._helperWindows.map((function(e){return t.covertToWindowDef(e)}))},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"ownerWindow",{get:function(){return this.covertToWindowDef(this._ownerWindow)},enumerable:!0,configurable:!0}),n.prototype.initiate=function(t,e,n){return this._manager.initiate(this._name,t,e,n)},n.prototype._updateCore=function(e){var n=this;t.prototype._updateCore.call(this,e),Ie(e._description,(function(t){return n._description=t})),Ie(e._ownerWindow,(function(t){return n._ownerWindow=t})),Ie(e._helperWindows,(function(t){return n._helperWindows=t}))},n.prototype.covertToWindowDef=function(t){var e,n,i,r;return{type:null===(n=null===(e=t)||void 0===e?void 0:e.id)||void 0===n?void 0:n.type,name:null===(r=null===(i=t)||void 0===i?void 0:i.id)||void 0===r?void 0:r.name}},n}(fe),Ae=function(t){function n(e,n){var i=t.call(this,e)||this;return i._name=e,i._appByWindowTypeGetter=n,i}return e(n,t),Object.defineProperty(n.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"config",{get:function(){return this._appByWindowTypeGetter(this._name)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"windows",{get:function(){return this._manager.getWindows({type:this._name})},enumerable:!0,configurable:!0}),n.prototype.create=function(t,e){var n=Object.assign({type:this.name,name:this.name,isIndependent:!1},e);return this._manager.createWindow(t,n)},n}(fe),Te=function(t,e){this.entity=t,this.context=e},ke=function(t){this.type=t},Se=function(t){function n(e,n){var i=t.call(this,Pe.StatusChange)||this;return i.newStatus=e,i.oldStatus=n,i}return e(n,t),n}(ke),xe=function(t){function n(e,n,i){var r=t.call(this,Pe.ActivityContextChange)||this;return r.context="string"==typeof e?JSON.parse(e):e,r.updated=n,r.removed=i,r}return e(n,t),n}(ke),Pe=function(){function t(){}return t.Added="added",t.Removed="removed",t.Updated="updated",t.Closed="closed",t.StatusChange="statusChange",t.ActivityContextChange="activityContextUpdate",t.ActivityWindowEvent="activityWindowEvent",t.ActivityWindowJoinedActivity="joined",t.ActivityWindowLeftActivity="left",t}(),Me=function(){function t(){}return t.Created="created",t.Started="started",t.Destroyed="destroyed",t}(),Ee=function(){function t(t){this._activity=t}return t.prototype.register=function(e,n){this._ensureHasAgm(),t.AGM.register(e,n)},t.prototype.servers=function(){return this._ensureHasAgm(),we(this._activity)?[]:this._activity.windows.map((function(t){return t.instance}))},t.prototype.methods=function(){var t=this;if(this._ensureHasAgm(),we(this._activity))return[];var e=this._activity.windows,n=[],i=[];return e.forEach((function(e){t.methodsForWindow(e).forEach((function(t){-1===n.indexOf(t.name)&&(n.push(t.name),i.push(t))}))})),i},t.prototype.methodsForWindow=function(e){return this._ensureHasAgm(),e.instance?t.AGM.methodsForInstance(e.instance):[]},t.prototype.invoke=function(e,n,i,r,o,s){this._ensureHasAgm();var a=this.servers();if(we(i)&&(i="activity.all"),ye(i))if("activity.all"===i)a;else{if("activity.best"!==i){if("all"===i||"best"===i)return function(t,e,n){if("function"!=typeof e&&"function"!=typeof n)return t;"function"!=typeof e?e=function(){}:"function"!=typeof n&&(n=function(){}),t.then(e,n)}(t.AGM.invoke(e,n,i,r),o,s);throw new Error("Invalid invoke target "+i)}var c=a.filter((function(n){return t.AGM.methodsForInstance(n).filter((function(t){return t.name===e})).length>0}));c.length>0&&[c[0]]}else if(ve(i)){if(i.length>=0){var u=i[0];if(this._isInstance(u))i.map((function(t){return t}));else{if(!this._isActivityWindow(u))throw new Error("Unknown target object");i.map((function(t){return t.instance}))}}}else if(this._isInstance(i))[i];else{if(!this._isActivityWindow(i))throw new Error("Unknown target object");[i.instance]}throw new Error("Not implemented")},t.prototype.unregister=function(e){return this._ensureHasAgm(),t.AGM.unregister(e)},t.prototype.createStream=function(e,n,i){this._ensureHasAgm(),t.AGM.createStream(e,{subscriptionAddedHandler:n,subscriptionRemovedHandler:i,subscriptionRequestHandler:void 0})},t.prototype.subscribe=function(e,n,i){return this._ensureHasAgm(),t.AGM.subscribe(e,n)},t.prototype._ensureHasAgm=function(){if(we(t.AGM))throw new Error("Agm should be configured to be used in activity")},t.prototype._isInstance=function(t){return void 0!==t.application},t.prototype._isActivityWindow=function(t){return void 0!==t.instance},t}(),je=function(){function t(t,e,n){this._manager=t,this._ownerActivityId=e,this._state=n}return Object.defineProperty(t.prototype,"ownerId",{get:function(){return this._state.ownerId},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"windowIds",{get:function(){return this._state.windowIds},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"frameColor",{get:function(){return this._state.frameColor},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"context",{get:function(){return this._state.context},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"tag",{get:function(){return this._state.tag},enumerable:!0,configurable:!0}),t.prototype.detach=function(t){var e=this;t=t||{};var n={};return Object.keys(this._state).forEach((function(t){n[t]=e._state[t]})),n.context=t.context||n.context,n.frameColor=t.frameColor||n.frameColor,this._manager.detachActivities(this._ownerActivityId,n)},t}(),Oe=function(t){setTimeout(t,0)};function We(t,e){if(!_e(e))return t;t.then((function(t){Oe((function(){e(null,t)}))}),(function(t){Oe((function(){e(t,null)}))}))}var Re=function(t){function n(e,n,i,r,o){var s=t.call(this,e)||this;return s._id=e,s._actType=n,s._status=i,s._context=r,s._ownerId=o,s._agm=new Ee(s),s}return e(n,t),Object.defineProperty(n.prototype,"type",{get:function(){if(this._manager)return this._manager.getActivityType(this._actType)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"context",{get:function(){return this._context},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"status",{get:function(){return this._status},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"owner",{get:function(){return this._ownerId?this._manager.getWindows({id:this._ownerId})[0]:null},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"windows",{get:function(){return this._manager.getWindows({activityId:this._id})},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"agm",{get:function(){return this._agm},enumerable:!0,configurable:!0}),n.prototype.addWindow=function(t,e){return this._manager.addWindowToActivity(this,t,e)},n.prototype.createWindow=function(t,e){return this._manager.createWindow(this,t,e)},n.prototype.createStackedWindows=function(t,e,n){return this._manager.createStackedWindows(this,t,e,n)},n.prototype.leave=function(t,e){return this._manager.leaveWindowFromActivity(this,t,e)},n.prototype.getWindowsByType=function(t){var e={activityId:this._id,type:t};return this._manager.getWindows(e)},n.prototype.setContext=function(t,e){return this._manager.setActivityContext(this,t,e)},n.prototype.updateContext=function(t,e){return this._manager.updateActivityContext(this,t,e)},n.prototype.onStatusChange=function(t){var e=this;return this._manager.subscribeActivityEvents((function(n,i,r){n.id===e.id&&t(n,i,r)}))},n.prototype.onWindowEvent=function(t){var e=this;return this._manager.subscribeWindowEvents((function(n,i,r){n.id===e.id&&t(n,i,r)}))},n.prototype.onContextChanged=function(t){var e=this;this._manager.subscribeActivityContextChanged((function(n,i,r,o){n.id===e.id&&t(i,r,o,n)}));try{t(this.context,this.context,[],this)}catch(t){return}},n.prototype.stop=function(){this._manager.stopActivity(this)},n.prototype.clone=function(t){return this._manager.clone(this,t)},n.prototype.attach=function(t,e){var n;return n="string"==typeof t?t:t.id,this._manager.attachActivities(n,this.id,e)},n.prototype.onActivityAttached=function(t){var e=this;this._manager.subscribeActivitiesAttached((function(n,i,r){n===e._id&&t(r)}))},n.prototype.onDetached=function(t){var e=this;this._manager.subscribeActivitiesDetached((function(n,i,r){i.id===e._id&&t(n,r)}))},n.prototype._updateCore=function(e){var n=this;t.prototype._updateCore.call(this,e),Ie(e._actType,(function(t){return n._actType=t})),Ie(e._context,(function(t){return n._context=t})),Ie(e._ownerId,(function(t){return n._ownerId=t})),!e._status||this._status&&this._status.state===e._status.state||(this._status=e._status)},n.prototype._updateDescriptors=function(t){var e=this;this._attached=t.map((function(t){return new je(e._manager,e._id,t)}))},Object.defineProperty(n.prototype,"attached",{get:function(){return this._attached},enumerable:!0,configurable:!0}),n.prototype.setFrameColor=function(t,e){var n=this;return We(new Promise((function(e,i){var r=n.windows.length;0===r&&e(n),n.windows.forEach((function(i){i.underlyingWindow.setFrameColor(t,(function(){--r<=0&&e(n)}))})),setTimeout((function(){r>0&&i(n.id+" - timed out waiting for setFrameColor with"+t)}),5e3)})),e)},n.prototype.getFrameColor=function(){return this.windows&&0!==this.windows.length?this.windows[0].underlyingWindow.frameColor:""},n}(fe),Fe=function(){function t(){}return t.Trace="trace",t.Debug="debug",t.Info="info",t.Warn="warn",t.Error="error",t}(),Ne=function(){function t(e){this._name=e,we(t.GlueLogger)||(this._glueLogger=t.GlueLogger.subLogger(e))}return t.GetNamed=function(e){return new t(e)},t.Get=function(e){return new t(t.GetTypeName(e))},t.prototype.trace=function(e){we(this._glueLogger)?t.Level===Fe.Trace&&console.info(this._getMessage(e,Fe.Trace)):this._glueLogger.trace(e)},t.prototype.debug=function(e){we(this._glueLogger)?t.Level!==Fe.Debug&&t.Level!==Fe.Trace||console.info(this._getMessage(e,Fe.Debug)):this._glueLogger.debug(e)},t.prototype.info=function(e){we(this._glueLogger)?t.Level!==Fe.Debug&&t.Level!==Fe.Trace&&t.Level!==Fe.Info||console.info(this._getMessage(e,Fe.Info)):this._glueLogger.info(e)},t.prototype.warn=function(e){we(this._glueLogger)?t.Level!==Fe.Debug&&t.Level!==Fe.Trace&&t.Level!==Fe.Info&&t.Level!==Fe.Warn||console.info(this._getMessage(e,Fe.Info)):this._glueLogger.warn(e)},t.prototype.error=function(t){we(this._glueLogger)?(console.error(this._getMessage(t,Fe.Error)),console.trace()):this._glueLogger.error(t)},t.prototype._getMessage=function(t,e){return"["+e+"] "+this._name+" - "+t},t.GetTypeName=function(t){var e=/function (.{1,})\(/.exec(t.constructor.toString());return e&&e.length>1?e[1]:""},t.Level=Fe.Info,t}(),Le=function(t){function n(e,n,i,r,o,s,a,c){var u=t.call(this,e)||this;return u._logger=Ne.Get("window"),u._type=i,u._activityId=r,u._name=n,u._instance=o,u._isIndependent=s,u._windowGetter=a,u._hcWindowId=c,u}return e(n,t),n.prototype.getBounds=function(){return this._manager.getWindowBounds(this.id)},Object.defineProperty(n.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isIndependent",{get:function(){return this._isIndependent},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"type",{get:function(){if(this._manager)return this._manager.getWindowType(this._type)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"activity",{get:function(){if(!me(this._activityId))return this._manager.getActivityById(this._activityId)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isOwner",{get:function(){var t=this.activity;return!me(t)&&t.owner.id===this.id},enumerable:!0,configurable:!0}),n.prototype.setVisible=function(t,e){return this._manager.setWindowVisibility(this.id,t)},n.prototype.activate=function(t){return this._manager.activateWindow(this.id,t)},n.prototype.setBounds=function(t,e){return this._manager.setWindowBounds(this.id,t,e)},n.prototype.close=function(){return this._manager.closeWindow(this.id)},Object.defineProperty(n.prototype,"instance",{get:function(){return this._instance},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"underlyingWindow",{get:function(){var t=this._windowGetter();return t||{id:this._hcWindowId}},enumerable:!0,configurable:!0}),n.prototype.onActivityJoined=function(t){this._subscribeForActivityWindowEvent(Pe.ActivityWindowJoinedActivity,t)},n.prototype.onActivityRemoved=function(t){this._subscribeForActivityWindowEvent(Pe.ActivityWindowLeftActivity,t)},n.prototype._updateCore=function(t){var e=this;Ie(t._activityId,(function(t){return e._activityId=t})),Ie(t._isIndependent,(function(t){return e._isIndependent=t})),Ie(t._hcWindowId,(function(t){return e._hcWindowId=t})),Ie(t._type,(function(t){return e._type=t})),Ie(t._name,(function(t){return e._name=t})),we(t._instance)||(this._instance=t._instance)},n.prototype._subscribeForActivityWindowEvent=function(t,e){var n=this;this._manager.subscribeWindowEvents((function(i,r,o){r.id===n.id&&o===t&&e(i)}))},n.prototype._beforeDelete=function(t){this._hcWindowId=t._hcWindowId},n}(fe),De=function(){function t(t,e,n){this.state=t,this.message=e,this.time=n}return t.prototype.getState=function(){return this.state},t.prototype.getMessage=function(){return this.message},t.prototype.getTime=function(){return this.time},t}(),Ge="error",Be="add-types",He="created",qe="destroyed",Ue="initiated",Ve="joined",ze="activity-joined",Je="left",Ke="owner-changed",Ze="add-peer-factories",Ye="peer-factories-added",Xe="peer-factories-removed",Qe="peer-created",$e=function(){function t(t){var e=this;if(this._activityChangeCallbacks=[],this._activityTypeStatusChangeCallbacks=[],this._activityWindowChangeCallbacks=[],this._windowTypeStatusChangeCallbacks=[],this._peerIdAndFactoryIdToPeerType={},this._peerFactoriesRegisteredByUs={},this._gw3Subscriptions=[],this._contextSubscriptions={},this._activityTypesInitiatedFromMe={},this._config=t,this._connection=t.connection,this._logger=t.logger,this._contexts=t.contexts,this._windows=t.windows,this._sessionJoinedPromise=new Promise((function(t){e._sessionJoinedPromiseResolve=t})),this._activityJoinedPromise=new Promise((function(t){e._activityJoinedPromiseResolve=t})),this._config.activityId||this._activityJoinedPromiseResolve({}),this._gw3Session=this._connection.domain("activity",["joined","initiated","peer-created","token"]),"undefined"!=typeof window){var n=window.glue42gd;n&&"function"==typeof n.addRefreshHandler&&n.addRefreshHandler((function(t,i){e._gw3Session.send({type:"reload"}).then((function(e){if(e.token){try{n.setGWToken(e.token)}catch(t){return void i(t.message||t)}t()}else i("Expected gateway token for refreshing.")}),i)}))}}return t.activityTypeGwMessageEntityToActivityType=function(t,e){var n=function(t){return new Ae(t,void 0)};return new Ce(t.name,t.owner_type&&n(t.owner_type),t.helper_types&&t.helper_types.map(n),e)},t.peerFactoryGwMessageEntityToWindowType=function(t){return new Ae(t.peer_type,(function(t){}))},t.activityGwMessageToActivity=function(t,e){var n=void 0!==t.owner?t.owner.peer_id:t.owner_id;return new Re(t.activity_id,t.activity_type,e,t.context_snapshot,n)},t.activityToActivityStatusChangeEvent=function(t){return new Te(t,new Se(t.status,void 0))},Object.defineProperty(t.prototype,"bridgeType",{get:function(){return"GW3"},enumerable:!0,configurable:!0}),t.prototype.init=function(){var t=this;this.forwardActivityTypeMessagesToStatusEventHandlers(),this.subscribe(He,this.handleActivityCreatedMessage),this.subscribe(qe,this.handleActivityDestroyedMessage),this.forwardActivityMessagesToStatusEventHandlers(),this.forwardActivityCreatedAndJoinedActivityToActivityWindowEventHandlers(),this.forwardPeerFactoryMessagesToStatusEventHandlers(),this.forwardPeerFactoryMessagesToPeerFactoryRequests(),this.subscribe(Ye,this.handlePeerFactoriesAdded),this.subscribe(Xe,this.handlePeerFactoriesRemoved),this.forwardActivityWindowMessagesToEventHandlers(),this.subscribe("dispose-peer",(function(){if("dispose"!==t._config.disposeRequestHandling){if("exit"===t._config.disposeRequestHandling){if(t._windows&&void 0!==t._windows.my())return void t._windows.my().close();if("undefined"!=typeof window&&"function"==typeof window.close)return void window.close();if("undefined"!=typeof process&&"function"==typeof process.exit)return void process.exit()}}else t.dispose()})),this._gw3Session.onJoined((function(){"trackMyOnly"===t._config.mode||"trackMyTypeAndInitiatedFromMe"===t._config.mode?t._sessionJoinedPromiseResolve(t):t._gw3Session.send({type:"subscribe",activity_types:"trackAll"===t._config.mode?[]:"trackTypes"===t._config.mode?t._config.typesToTrack:[]}).then((function(){t._sessionJoinedPromiseResolve(t)}))})),this._gw3Session.join()},t.prototype.dispose=function(){var t=this;this._gw3Subscriptions.forEach((function(e){return e&&t._connection.off(e)})),this._gw3Subscriptions.length=0},t.prototype.ready=function(){return Promise.all([this._sessionJoinedPromise,this._activityJoinedPromise])},t.prototype.initReady=function(){return this._sessionJoinedPromise},t.prototype.onActivityTypeStatusChange=function(t){this._activityTypeStatusChangeCallbacks.push(t)},t.prototype.registerActivityType=function(e,n,i,r,o){var s=this,a={};a.name=e;var c=function(t){return{type:t.type,name:t.name,configuration:t}};return a.owner_type=c(n),a.helper_types=i.map(c),this._gw3Session.send({type:Be,types:[a]}).then((function(){var e=t.activityTypeGwMessageEntityToActivityType(a,o);return s.invokeCallbacks(s._activityTypeStatusChangeCallbacks,new Te(e,new ke(Pe.Added)),Be),e}))},t.prototype.unregisterActivityType=function(t){var e=this;return this._gw3Session.send({type:"remove-types",types:[t]}).then((function(){var n=new Ce(t,void 0,void 0,void 0);e.invokeCallbacks(e._activityTypeStatusChangeCallbacks,new Te(n,new ke(Pe.Removed)),Be)}))},t.prototype.onWindowTypeStatusChange=function(t){this._windowTypeStatusChangeCallbacks.push(t)},t.prototype.registerWindowFactory=function(e,n,i){var r=this;if(this._peerFactoriesRegisteredByUs[e])return Promise.reject(new Error("Factory for windowType "+e+" already registered."));this._peerFactoriesRegisteredByUs[e]=n;var o={id:e,peer_type:e,configuration:i};return this._gw3Session.send({type:Ze,factories:[o]}).then((function(){r.invokeCallbacks(r._windowTypeStatusChangeCallbacks,new Te(t.peerFactoryGwMessageEntityToWindowType(o),new ke(Pe.Added)),Ze)})).catch((function(){delete r._peerFactoriesRegisteredByUs[e]}))},t.prototype.unregisterWindowFactory=function(t){var e=this;return this._peerFactoriesRegisteredByUs[t]?(delete this._peerFactoriesRegisteredByUs[t],this._gw3Session.send({type:"remove-peer-factories",factory_ids:[t]}).then((function(){e.invokeCallbacks(e._windowTypeStatusChangeCallbacks,new Te(new Ae(t,void 0),new ke(Pe.Removed)),Ze)}))):Promise.reject(new Error("Factory for windowType "+t+" not registered."))},t.prototype.onActivityStatusChange=function(t){this._activityChangeCallbacks.push(t)},t.prototype.initiateActivity=function(t,e,n){var i=this,r={type:"create",activity_type:t,initial_context:e};return this.isOverrideTypeDefinition(n)?r.types_override={owner_type:{type:n.owner.type,name:n.owner.name,configuration:n.owner},helper_types:n.helpers&&n.helpers.map((function(t){return{type:t.type,name:t.name,configuration:t}}))}:r.configuration=n&&n.map((function(t){return{type:t.type,name:t.name,configuration:t}})),this.sendCreateAndMapResultingMessagesToPromise(r,Ue,(function(t,e){return t.request_id===e}),He,(function(t,e,n){return t.activity_id===n.activity_id}),qe,(function(t,e,n){return t.activity_id===n.activity_id}),(function(t){return t.activity_id}),null).then((function(e){return"trackMyTypeAndInitiatedFromMe"!==i._config.mode||i._activityTypesInitiatedFromMe[t]?e:(i._activityTypesInitiatedFromMe[t]=!0,i._gw3Session.send({type:"subscribe",activity_types:[t]}).then((function(){return e})))}))},t.prototype.stopActivity=function(t){return this._gw3Session.send({type:"destroy",activity_id:t.id,reason_uri:"com.tick42.glue.activity.constants.destroyReason.general",reason:"Destroying activity"}).then((function(t){return!0}))},t.prototype.updateActivityContext=function(t,e,n,i){if(n)return this._contexts.set(t.id,e);for(var r=0,o=i=i||[];r<o.length;r++){e[o[r]]=null}return this._contexts.update(t.id,e)},t.prototype.announceWindow=function(t,e){throw new Error("Invalid operation 'announceWindow' for GW3 protocol")},t.prototype.registerWindow=function(t,e,n){var i=void 0!==this._connection.gatewayToken,r=this._connection.peerId;if("undefined"!=typeof window){var o=window.glue42gd;o&&(i=void 0!==o.activityInfo)}return i&&this._gw3Session.send({type:"ready"}),this.invokeCallbacks(this._activityWindowChangeCallbacks,new Te(new Le(r,e,t,void 0,this.getAgmInstance(r),n,this.generateWindowGetter(r),void 0),new ke(Pe.Added)),"register window"),Promise.resolve(r)},t.prototype.onActivityWindowChange=function(t){this._activityWindowChangeCallbacks.push(t)},t.prototype.createWindow=function(t,e){var n=this;e.layout||(e.left||e.width||e.height||e.top)&&(e.layout={mode:"pixels",cellSize:1});var i=function(i){if(t)return n.joinActivity(t,i,e.name).then((function(){return i}))};return this.sendCreateAndMapResultingMessagesToPromise({type:"create-peer",peer_type:e.type,peer_name:e.name||e.type,configuration:e,activity_id:t},void 0,void 0,Qe,(function(t,e){return t.request_id===e}),void 0,void 0,(function(t){return t.created_id}),i).then(i)},t.prototype.closeWindow=function(t){return this._gw3Session.send({type:"destroy-peer",destroy_peer_id:t}).then((function(t){}))},t.prototype.getAnnouncementInfo=function(){var t=this._config.activityId||this._config.announcementInfo&&this._config.announcementInfo.activityId,e=this._config.announcementInfo&&this._config.announcementInfo.activityWindowType,n=this._config.announcementInfo&&this._config.announcementInfo.activityWindowIndependent,i=this._config.announcementInfo&&this._config.announcementInfo.activityWindowName;if("undefined"!=typeof window&&void 0!==window.location&&window.location.search&&"function"==typeof URLSearchParams){var r=new URLSearchParams(location.search.slice(1));e=(e=e||r.get("t42PeerType"))||r.get("t42ActivityWindowType"),void 0===n&&(n=r.get("t42ActivityWindowIndependent")),i=i||r.get("t42ActivityWindowName"),t=t||r.get("t42ActivityId")}return{activityWindowId:void 0,activityId:t,activityWindowType:e=e||"unknown",activityWindowIndependent:n=n||!1,activityWindowName:i=i||this._connection.peerId}},t.prototype.joinActivity=function(t,e,i){var r=this,o=i&&{name:i}||{};return this._gw3Session.send(n({type:"join-activity",target_id:e,activity_id:t},o)).then((function(){r.invokeCallbacks(r._activityWindowChangeCallbacks,new Te(new Le(e,void 0,void 0,t,r.getAgmInstance(e),void 0,r.generateWindowGetter(e),void 0),new ke(Pe.ActivityWindowJoinedActivity)),"activity joined - ActivityWindow"),r.invokeCallbacks(r._activityChangeCallbacks,new Te(new Re(t,void 0,new De("created",void 0,void 0),void 0,void 0),new ke(Pe.Updated)),"activity joined - Activity")}))},t.prototype.leaveActivity=function(t,e){var n=this;return this._gw3Session.send({type:"leave-activity",target_id:e,activity_id:t}).then((function(){n.invokeCallbacks(n._activityWindowChangeCallbacks,new Te(new Le(e,void 0,void 0,null,n.getAgmInstance(e),void 0,n.generateWindowGetter(e),void 0),new ke(Pe.ActivityWindowLeftActivity)),"activity left - ActivityWindow"),n.invokeCallbacks(n._activityChangeCallbacks,new Te(new Re(t,void 0,new De("created",void 0,void 0),void 0,void 0),new ke(Pe.Updated)),"activity left - Activity")}))},t.prototype.getActivityTypes=function(){return Promise.resolve([])},t.prototype.getWindowTypes=function(){return Promise.resolve([])},t.prototype.getActivities=function(){return Promise.resolve([])},t.prototype.getActivityWindows=function(){return Promise.resolve([])},t.prototype.createStackedWindows=function(t,e,n){},t.prototype.getWindowBounds=function(t){},t.prototype.setWindowBounds=function(t,e){},t.prototype.activateWindow=function(t,e){},t.prototype.setWindowVisibility=function(t,e){},t.prototype.cloneActivity=function(t,e){},t.prototype.attachActivities=function(t,e,n){return this._gw3Session.send({type:"merge",into:e,merge:t})},t.prototype.detachActivities=function(t,e){return this._gw3Session.send({type:"split",from:t}).then((function(){return""}))},t.prototype.onActivitiesAttached=function(t){},t.prototype.onActivitiesDetached=function(t){},t.prototype.onActivityAttachedDescriptorsRefreshed=function(t){},t.prototype.getAttachedDescriptors=function(){return Promise.resolve([])},t.prototype.getRandomRequestId=function(){return this._connection.peerId+":"+Math.floor(1e9*Math.random())},t.prototype.forwardAddedAndRemovedMessagesToEventHandler=function(t,e,n,i){var r=function(t){return function(e){return new Te(e,new ke(t?Pe.Added:Pe.Removed))}};return[t&&this.forwardMessageToEventHandler(t,(function(t){return n(t,!0)}),r(!0),i),e&&this.forwardMessageToEventHandler(e,(function(t){return n(t,!1)}),r(!1),i)].filter((function(t){return t}))},t.prototype.forwardMessageToEventHandler=function(t,e,n,i){return this.subscribe(t,(function(t){e(t).forEach((function(e){return i.forEach((function(i){return i(n(e,t))}))}))}))},t.prototype.sendCreateAndMapResultingMessagesToPromise=function(t,e,n,i,r,o,s,a,c){var u,d,p,h,l,f,g=this,y=this.getRandomRequestId(),v=new Promise((function(t,e){u=t,d=e})),m=null,w=function(){g.dropSubscription(p),c||g.dropSubscription(h),g.dropSubscription(l),g.dropSubscription(f)};p=e&&this.subscribe(e,(function(t){n(t,y)&&(m=t,g.dropSubscription(p))}));var b=!1;h=this.subscribe(i,(function(t){r(t,y,m)&&(b?c&&c(a(t)):(b=!0,u(a(t))))})),l=o&&this.subscribe(o,(function(t){s(t,y,m)&&d(t)})),f=o&&this.subscribe(Ge,(function(t){t.request_id===y&&d(t)})),t.request_id=y;var _=this._gw3Session.send(t).then((function(){return v}));return _.then(w,w),_},t.prototype.peerFactoryIdAndOwnerIdToWindowType=function(t,e){var n=this._peerIdAndFactoryIdToPeerType[e+":"+t];return n?new Ae(n,void 0):null},t.prototype.subscribe=function(t,e){var n=this,i=this._connection.on(t,(function(t){return e.bind(n)(t)}));return this._gw3Subscriptions.push(i),i},t.prototype.dropSubscription=function(t){t&&(this._connection.off(t),delete this._gw3Subscriptions[this._gw3Subscriptions.indexOf(t)])},t.prototype.invokeCallbacks=function(t,e,n){var i=this;t.forEach((function(t){try{t(e)}catch(t){i._logger.error("Error in "+(n||e.context.type)+" callback: "+JSON.stringify(t))}}))},t.prototype.handleActivityCreatedMessage=function(t){t.context_id?this._contextSubscriptions[t.activity_id]||this.subscribeToContext(t):this._logger.error("Activity created with unknown context_id: "+t.activity_id)},t.prototype.subscribeToContext=function(t){return i(this,void 0,void 0,(function(){var e,n,i,o=this;return r(this,(function(r){switch(r.label){case 0:return e=t.activity_id,n=this._contextSubscriptions,i=e,[4,this._contexts.subscribe(e,(function(t,n,i){var r=new Te(new Re(e,void 0,void 0,t,void 0),new xe(t,n,i));o.invokeCallbacks(o._activityChangeCallbacks,r,"context updated")}))];case 1:return n[i]=r.sent(),[2]}}))}))},t.prototype.handleActivityDestroyedMessage=function(t){var e=this._contextSubscriptions[t.activity_id];"function"==typeof e&&e(),delete this._contextSubscriptions[t.activity_id]},t.prototype.handlePeerFactoriesAdded=function(t){var e=this;t.factories.forEach((function(n){e._peerIdAndFactoryIdToPeerType[t.owner_id+":"+n.id]=n.peer_type}))},t.prototype.handlePeerFactoriesRemoved=function(t){var e=this;t.factory_ids.forEach((function(n){delete e._peerIdAndFactoryIdToPeerType[t.owner_id+":"+n]}))},t.prototype.forwardActivityTypeMessagesToStatusEventHandlers=function(){this.forwardAddedAndRemovedMessagesToEventHandler("types-added","types-removed",(function(e,n){return n?e.types.map((function(e){return t.activityTypeGwMessageEntityToActivityType(e,void 0)})):e.types.map((function(t){return new Ce(t.name,void 0,void 0,void 0)}))}),this._activityTypeStatusChangeCallbacks)},t.prototype.forwardActivityCreatedAndJoinedActivityToActivityWindowEventHandlers=function(){for(var t=this,e=0,i=[He,Ve,Ke];e<i.length;e++){var r=i[e];this.forwardMessageToEventHandler(r,(function(e){return[e.owner||n(n({},e),{type:e.peer_type,name:e.peer_name,peer_id:e.owner_id})].concat(e.participants||[]).map((function(n){return new Le(n.peer_id,n.name,n.type,e.activity_id,t.getAgmInstance(n.peer_id),void 0,t.generateWindowGetter(n.peer_id),void 0)}))}),(function(t,e){return new Te(t,new ke(Pe.ActivityWindowJoinedActivity))}),this._activityWindowChangeCallbacks)}},t.prototype.forwardActivityMessagesToStatusEventHandlers=function(){for(var e=0,n=[He,Ve];e<n.length;e++){var i=n[e];this.forwardMessageToEventHandler(i,(function(e){return[t.activityGwMessageToActivity(e,new De("started","",new Date))]}),(function(e,n){return t.activityToActivityStatusChangeEvent(e)}),this._activityChangeCallbacks)}this.forwardMessageToEventHandler(qe,(function(e){return[t.activityGwMessageToActivity(e,new De("destroyed",e.reason,new Date))]}),(function(e,n){return t.activityToActivityStatusChangeEvent(e)}),this._activityChangeCallbacks),this.forwardMessageToEventHandler(Ue,(function(e){return[t.activityGwMessageToActivity(e,new De("created","",new Date))]}),(function(e,n){return t.activityToActivityStatusChangeEvent(e)}),this._activityChangeCallbacks),this.forwardMessageToEventHandler(Ke,(function(e){return[t.activityGwMessageToActivity(e,new De("created","",new Date))]}),(function(e,n){return t.activityToActivityStatusChangeEvent(e)}),this._activityChangeCallbacks)},t.prototype.forwardPeerFactoryMessagesToStatusEventHandlers=function(){var e=this;this.forwardAddedAndRemovedMessagesToEventHandler(Ye,Xe,(function(n,i){return i?n.factories.map(t.peerFactoryGwMessageEntityToWindowType):n.factory_ids.map((function(t){return e.peerFactoryIdAndOwnerIdToWindowType(t,n.owner_id)})).filter((function(t){return null!=t}))}),this._windowTypeStatusChangeCallbacks)},t.prototype.forwardPeerFactoryMessagesToPeerFactoryRequests=function(){var t=this;this.subscribe("peer-requested",(function(e){var n=t._peerFactoriesRegisteredByUs[e.peer_factory];if(n)try{var i=e.configuration||{};i.gateway_token=i.gateway_token||e.gateway_token,i.peer_factory=i.peer_factory||e.peer_factory;var r=n({activityId:e.activity&&e.activity.id,activityType:e.activity&&e.activity.type,type:e.configuration&&e.configuration.type,gwToken:i.gateway_token,configuration:i});r&&r.then&&r.catch&&r.catch((function(n){return t._gw3Session.send({type:Ge,request_id:e.request_id,reason:n&&(n.message||JSON.stringify(n))})}))}catch(n){t._gw3Session.send({type:Ge,request_id:e.request_id,reason:n&&(n.message||JSON.stringify(n))})}else t._gw3Session.send({type:Ge,request_id:e.request_id,reason:"Unknown peer factory "+e.peer_factory})}))},t.prototype.forwardActivityWindowMessagesToEventHandlers=function(){for(var t=this,e=function(e){n.subscribe(e,(function(n){var i=e===ze?n.joined_id:n.peer_id,r=e===ze?n.joined_type:n.peer_type,o=e===ze?n.joined_name:n.peer_name,s=new Le(i,o,r,n.activity_id,t.getAgmInstance(i),void 0,t.generateWindowGetter(i),void 0);t._contextSubscriptions[n.activity_id]?e===Ve&&t._activityJoinedPromiseResolve({}):t.subscribeToContext(n).then((function(){e===Ve&&t._activityJoinedPromiseResolve({})})),t.invokeCallbacks(t._activityWindowChangeCallbacks,new Te(s,new ke(Pe.ActivityWindowJoinedActivity)),e)}))},n=this,i=0,r=[ze,Ve];i<r.length;i++){e(r[i])}this.subscribe(Je,(function(e){var n=new Le(e.left_id,void 0,void 0,null,t.getAgmInstance(e.left_id),void 0,t.generateWindowGetter(e.left_id),void 0);t.invokeCallbacks(t._activityWindowChangeCallbacks,new Te(n,new ke(Pe.ActivityWindowLeftActivity)),Je)})),this.forwardAddedAndRemovedMessagesToEventHandler(Qe,void 0,(function(e){return[new Le(e.created_id,void 0,void 0,void 0,void 0,void 0,t.generateWindowGetter(e.created_id),void 0)]}),this._activityWindowChangeCallbacks)},t.prototype.getAgmInstance=function(t){return this._config.agm.servers().find((function(e){return e.peerId===t||e.windowId===t}))},t.prototype.generateWindowGetter=function(t){var e=this;return function(){var n=e.getAgmInstance(t);if(n){var i=n.windowId;return e._config.windows.list().filter((function(t){return t.id===i}))[0]}}},t.prototype.isOverrideTypeDefinition=function(t){return void 0!==t&&!!t.owner},t}(),tn=function(){function t(t,e){var n=this;this._myAttached=[],this._myDetached=[],this._myAttachedTo=[],this._myDetachedFrom=[],this._myActivityFrameColorChanged=[],this._myActivityJoinedCallbacks=[],this._myActivityRemovedCallbacks=[],this._myContextUpdateCallbacks=[],this._logger=Ne.Get(this),this._m=t,t.ready().then((function(t){t.subscribeActivityContextChanged(n._subscribeMyContextChanged.bind(n)),t.subscribeWindowEvents(n._subscribeMyWindowEvent.bind(n)),t.subscribeActivitiesAttached(n._subscribeActivitiesAttached.bind(n)),t.subscribeActivitiesDetached(n._subscribeActivitiesDetached.bind(n)),e&&e.onWindowFrameColorChanged(n._subscribeWindowFrameColorChanged.bind(n))}))}return Object.defineProperty(t.prototype,"window",{get:function(){if(we(this._w)){var t=this._m.announcedWindows;t.length>0&&(this._w=t[0])}return this._w},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activity",{get:function(){var t=this.window;if(!we(t))return t.activity},enumerable:!0,configurable:!0}),t.prototype.createWindow=function(t){return this._m.createWindow(this.activity,t)},t.prototype.createStackedWindows=function(t,e){return this._m.createStackedWindows(this.activity,t,e)},Object.defineProperty(t.prototype,"context",{get:function(){var t=this.activity;return me(t)?{}:t.context},enumerable:!0,configurable:!0}),t.prototype.updateContext=function(t,e){var n=this.activity;return me(n)?new Promise((function(t,e){e("Not in activity")})):n.updateContext(t,e)},t.prototype.setContext=function(t,e){var n=this.activity;return me(n)?new Promise((function(t,e){e("Not in activity")})):n.setContext(t,e)},t.prototype.onActivityJoined=function(t){this._myActivityJoinedCallbacks.push(t);var e=this.window;we(e)||we(e.activity)||t(e.activity)},t.prototype.onActivityLeft=function(t){this._myActivityRemovedCallbacks.push(t)},t.prototype.onContextChanged=function(t){this._myContextUpdateCallbacks.push(t);var e=this.window;if(!we(e)){var n=e.activity;we(n)||t(n.context,n.context,[],n)}},t.prototype.clone=function(t,e){var n=this.activity;return this._m.clone(n,t,e)},t.prototype.attach=function(t,e){var n;return n="string"==typeof t?t:t.id,this._m.attachActivities(n,this.activity.id,e)},t.prototype.onActivityAttached=function(t){this._myAttached.push(t)},t.prototype.onActivityDetached=function(t){this._myDetached.push(t)},t.prototype.onAttachedToActivity=function(t){this._myAttachedTo.push(t)},t.prototype.onDetachedFromActivity=function(t){this._myDetachedFrom.push(t)},Object.defineProperty(t.prototype,"attached",{get:function(){return this.activity?this.activity.attached:[]},enumerable:!0,configurable:!0}),t.prototype.setFrameColor=function(t,e){return this.activity?this.activity.setFrameColor(t,e):Promise.resolve(null)},t.prototype.getFrameColor=function(){return this.activity?this.activity.getFrameColor():""},t.prototype.onFrameColorChanged=function(t){this._myActivityFrameColorChanged.push(t)},t.prototype._subscribeMyContextChanged=function(t,e,n,i){var r=this.window;if(!we(r)){var o=r.activity;we(o)||t.id===o.id&&this._notifyMyContextChanged(t,e,n,i)}},t.prototype._subscribeMyWindowEvent=function(t,e,n){we(this.window)||this.window.id===e.id&&(n===Pe.ActivityWindowJoinedActivity?(this._notifyMyWindowEvent(t,this._myActivityJoinedCallbacks),this._notifyMyContextChanged(t,t.context,null,null)):n===Pe.ActivityWindowLeftActivity&&this._notifyMyWindowEvent(t,this._myActivityRemovedCallbacks))},t.prototype._notifyMyWindowEvent=function(t,e){var n=this;e.forEach((function(e){try{e(t,event)}catch(t){n._logger.warn("error in user callback "+t)}}))},t.prototype._notifyMyContextChanged=function(t,e,n,i){var r=this;n=n||{},i=i||[],this._myContextUpdateCallbacks.forEach((function(o){try{o(e,n,i,t)}catch(t){r._logger.warn("error in user callback "+t)}}))},t.prototype._notifyAttached=function(t){var e=this;this._myAttached.forEach((function(n){try{n(t)}catch(t){e._logger.warn("error in user callback "+t)}}))},t.prototype._notifyDetached=function(t){var e=this;this._myDetached.forEach((function(n){try{n(t)}catch(t){e._logger.warn("error in user callback "+t)}}))},t.prototype._notifyAttachedTo=function(t){var e=this;this._myAttachedTo.forEach((function(n){try{n(e.activity,t)}catch(t){e._logger.warn("error in user callback "+t)}}))},t.prototype._notifyDetachedFrom=function(t,e,n){var i=this;this._myDetachedFrom.forEach((function(r){try{r(t,e,n)}catch(t){i._logger.warn("error in user callback "+t)}}))},t.prototype._subscribeActivitiesAttached=function(t,e){var n=this.window;if(!we(n)){var i=n.activity;we(i)||t.id===i.id&&(e.windowIds.indexOf(n.id)>=0?this._notifyAttachedTo(e):this._notifyAttached(e))}},t.prototype._subscribeActivitiesDetached=function(t,e,n){var i=this.window;if(!we(i)){var r=i.activity;we(r)||(e.id===r.id&&this._notifyDetached(n),t.id===r.id&&this._notifyDetachedFrom(t,e,n))}},t.prototype._subscribeWindowFrameColorChanged=function(t){var e=this.activity;e&&e.owner&&e.owner.underlyingWindow.id===t.id&&this._myActivityFrameColorChanged.forEach((function(e){e(t.frameColor)}))},t}(),en=function(){function t(t,e){if(this._logger=Ne.Get("ReadyMarker ["+t+"]"),this._logger.debug("Initializing ready marker for '"+t+"' with "+e+" signals to wait"),e<=0)throw new Error("Invalid signal number. Should be > 0");this._signals=e,this._callbacks=[],this._name=t}return t.prototype.setCallback=function(t){this.isSet()?t(void 0):this.isError()?t(this._error):this._callbacks.push(t)},t.prototype.signal=function(t){if(this._logger.debug("Signaled - "+t+" - signals left "+(this._signals-1)),this._signals--,this._signals<0)throw new Error("Error in ready marker '"+this._name+" - signals are "+this._signals);this.isSet()&&this._callbacks.forEach((function(t){t(void 0)}))},t.prototype.error=function(t){this._error=t,this._callbacks.forEach((function(e){e(t)}))},t.prototype.isSet=function(){return!this.isError()&&0===this._signals},t.prototype.isError=function(){return!me(this._error)},t.prototype.getError=function(){return this._error},t}(),nn=function(){function t(t){this._items={},this._listeners=[],this._processNew=t}return t.prototype.addOne=function(t){this.add([t])},t.prototype.add=function(t){var e=this;t.forEach((function(t){e.process(new Te(t,new ke(Pe.Added)))}))},t.prototype.process=function(t){var e=t.context,n=e.type,i=t.entity;if(n===Pe.StatusChange&&!e.oldStatus){var r=this._items[i.id];r&&(e.oldStatus=r.status)}n===Pe.StatusChange&&e.oldStatus&&e.newStatus&&e.oldStatus.state===e.newStatus.state&&(e.type=Pe.Updated),"undefined"==typeof htmlContainer&&(n===Pe.ActivityWindowJoinedActivity&&this._items[i.id]&&this._items[i.id].activity&&(e.type=Pe.Updated),n===Pe.ActivityWindowLeftActivity&&this._items[i.id]&&!this._items[i.id].activity&&(e.type=Pe.Updated));var o=this._updateInternalCollections(i,n,e);return this._notifyListeners(o,e),o},t.prototype.get=function(){var t=[];for(var e in this._items)if(this._items.hasOwnProperty(e)){var n=this._items[e];t.push(n)}return t},t.prototype.getByName=function(t){for(var e in this._items)if(e===t)return this._items[e]},t.prototype.getOrWait=function(t){var e=this;return new Promise((function(n){var i=function(r){r.id===t&&(n(r),e.unsubscribe(i))};e.subscribe(i);var r=e.getByName(t);if(r)return e.unsubscribe(i),void n(r)}))},t.prototype.subscribe=function(t){var e=this;return this._listeners.push(t),Object.keys(this._items).forEach((function(n){var i=e._items[n];t(i,new ke(Pe.Added.toString()))})),function(){e.unsubscribe(t)}},t.prototype.unsubscribe=function(t){var e=this._listeners.indexOf(t);-1!==e&&this._listeners.splice(e,1)},t.prototype._notifyListeners=function(t,e){this._listeners.forEach((function(n){try{n(t,e)}catch(t){return}}))},t.prototype._updateInternalCollections=function(t,e,n){var i=t,r=e===Pe.StatusChange&&i.status&&i.status.state===Me.Destroyed||e===Pe.StatusChange&&n&&n.newStatus&&n.newStatus.state===Me.Destroyed,o=e===Pe.Closed;if(e===Pe.Removed&&void 0===i.isIndependent||o||r){var s=this._items[t.id];return delete this._items[t.id],this._processNew(t),s&&t._beforeDelete(s),t}var a=t.id;return this._items.hasOwnProperty(a)?this._items[t.id]._update(t):(this._processNew(t),this._items[t.id]=t),this._items[t.id]},t}(),rn=function(){function t(t,e,n){var i=this;this._logger=Ne.Get("activityManager"),this._announcedWindows=[],this._attachedCallbacks=[],this._detachedCallbacks=[],this._frameColorChangesCallbacks=[],this._windowHandlers=[],this._bridge=t,this._activityTypes=new nn((function(t){return i._grabEntity(t)})),this._windowTypes=new nn((function(t){return i._grabEntity(t)})),this._activities=new nn((function(t){return i._grabEntity(t)})),this._windows=new nn((function(t){return i._grabEntity(t)})),this._dataReadyMarker=new en("Activity Manager Data",["GetActivityTypes","GetWindowTypes","GetActivities","GetWindows"].length),this._descriptorsMarker=new en("Attached Activities Descriptors",["GetDescriptors"].length),e?(this._readyMarker=new en("Activity Manager Announce",["Announcement"].length),this._dataReadyMarker.setCallback((function(t){t&&i._readyMarker.error(t),i._descriptorsMarker.setCallback((function(t){t&&i._readyMarker.error(t),i._logger.debug("Auto announcing window"),i.announceWindow().then((function(t){i._announcedWindows.push(t),i._readyMarker.signal("Successfully announced window with id '"+t.id+"'")})).catch((function(t){i._logger.debug("Will not announce window - "+t),i._readyMarker.signal()}))})),i.refreshDescriptors()}))):this._readyMarker=this._dataReadyMarker,this._bridge.onActivitiesAttached((function(t){i._handleActivitiesAttached(t)})),this._bridge.onActivitiesDetached((function(t){i._handleActivitiesDetached(t)})),this._bridge.onActivityAttachedDescriptorsRefreshed((function(t){i._handleActivityDescriptorsRefreshed(t)})),n&&n.onWindowFrameColorChanged(this._handleWindowFrameColorChanged.bind(this)),this._bridge.init(),this._subscribeForData(),this._bridge.initReady().then((function(t){i._getInitialData()})).catch((function(t){console.log(t)}))}return Object.defineProperty(t.prototype,"usingHc",{get:function(){return"HC"===this._bridge.bridgeType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"announcedWindows",{get:function(){return this._announcedWindows},set:function(t){throw new Error("not allowed")},enumerable:!0,configurable:!0}),t.prototype.ready=function(t){var e=this,n=new Promise((function(t,n){e._readyMarker.setCallback((function(i){i?n(e._readyMarker.getError()):t(e)}))}));return We(Promise.all([this._bridge.ready(),n]).then((function(){return e})),t)},t.prototype.getActivityTypes=function(){return this._activityTypes.get()},t.prototype.getActivityType=function(t){return this._activityTypes.getByName(t)},t.prototype.registerActivityType=function(t,e,n,i,r,o){var s=this;return We(new Promise((function(o,a){var c;if(we(t))a("activityTypeName argument can not be undefined");else if(ye(t))if(we(s.getActivityType(t)))if(me(e))a("Owner window type can not be undefined");else{c=ye(e)?{type:e,name:"",isIndependent:!1,arguments:{}}:e;var u=[];if(!me(n)&&ve(n))for(var d in n){var p=n[d];if(ye(p)){var h={type:p,name:"",isIndependent:!1,arguments:{},relativeTo:"",relativeDirection:"",windowStyleAttributes:{}};u.push(h)}else u.push(p)}s._bridge.registerActivityType(t,c,u,i,r).then((function(t){s._grabEntity(t),o(t)})).catch((function(t){a(t)}))}else a("Activity type '"+t+"' already exists");else a("activityTypeName should be string")})),o)},t.prototype.unregisterActivityType=function(t,e){var n=this;return We(new Promise((function(e,i){var r=n.getActivityType(t);me(r)?i("Activity type '"+t+"' does not exists"):n._bridge.unregisterActivityType(t).then((function(){return e(r)}),i)})),e)},t.prototype.initiate=function(t,e,n,i){var r=this;return We(new Promise((function(n,o){me(r.getActivityType(t))?o("Activity type '"+t+"' does not exists"):r._bridge.initiateActivity(t,e,i).then((function(t){r._activities.getOrWait(t).then((function(t){n(t)})).catch((function(t){return o(t)}))})).catch((function(t){o(t)}))})),n)},t.prototype.subscribeActivityTypeEvents=function(t){this._activityTypes.subscribe((function(e,n){t(e,n.type)}))},t.prototype.getWindowTypes=function(){return this._windowTypes.get()},t.prototype.getWindowType=function(t){return this._windowTypes.getByName(t)},t.prototype.registerWindowFactory=function(t,e,n){var i=this;return We(new Promise((function(n,r){if(we(t))r("no windowType specified");else{if("object"==typeof(o=t)&&null!==o)t=t.getName();else if(!ye(t))return void r("windowType should be string or object that has getName method");var o;i._bridge.registerWindowFactory(t,e).then((function(t){n(t)})).catch((function(t){r(t)}))}})),n)},t.prototype.unregisterWindowFactory=function(t,e){var n=this;return We(new Promise((function(e,i){we(t)?i("no windowType specified"):ye(t)?n._bridge.unregisterWindowFactory(t).then((function(t){e(t)})).catch((function(t){i(t)})):i("windowType should be a string")})),e)},t.prototype.getActivities=function(t){var e=this._activities.get();if(e=e.filter((function(t){return t._ownerId})),!t)return e;var n=t;if(ye(t))n=[t];else if(t instanceof Ce)n=[t.name];else if(!(t instanceof Array))throw new Error("Invalid input argument 'activityType' = "+t);return e.filter((function(t){var e=t.type;return function(t,e){for(var n=0;n<t.length;n++)if(e(t[n],n))return!0;return!1}(n,(function(t){return e.id===t.id}))}))},t.prototype.getActivityById=function(t){return this._activities.getByName(t)},t.prototype.announceWindow=function(t,e){var n=this;return new Promise((function(i,r){var o=n._bridge.getAnnouncementInfo();if(me(t)&&(t=o.activityWindowId),me(e)&&(e=o.activityWindowType),we(e))throw new Error("Can not announce - unknown windowType");var s=o&&o.activityId;if(we(t))n._logger.debug("Registering window with type:'"+e+"', name:'"+o.activityWindowName+"', ind.:'"+o.activityWindowIndependent+"'"),n._bridge.registerWindow(e,o.activityWindowName,o.activityWindowIndependent).then(n._windows.getOrWait.bind(n._windows)).then((function(t){return s?n._activities.getOrWait(s).then((function(e){return t})):t})).then((function(t){i(t)})).catch((function(t){n._logger.error(t)}));else{n._logger.debug("Announcing window with id '"+t+"' and type '"+e+"'");var a=n._windows.getByName(t);if(!we(a))return n._logger.debug("Window with id '"+t+"' already announced - reusing the window"),void i(a);var c=function(e,o,s){t===o.id&&(s===Pe.ActivityWindowJoinedActivity&&(me(o.activity)&&r("UNDEFINED ACTIVITY"),n._logger.trace("Got joined event for id '"+t+"'"),i(o),n.unsubscribeWindowEvents(c)))};n.subscribeWindowEvents(c),n._logger.trace("Waiting for joined event for id '"+t+"'"),n._bridge.announceWindow(e,t)}}))},t.prototype.subscribeWindowTypeEvents=function(t){this._windowTypes.subscribe((function(e,n){t(e,n.type)}))},t.prototype.subscribeActivityEvents=function(t){var e=this;return this._activities.subscribe((function(n,i){if(i.type===Pe.StatusChange){var r=i;t(n,r.newStatus,r.oldStatus)}if(i.type===Pe.Removed||i.type===Pe.StatusChange&&i.newStatus.getState()===Me.Destroyed)for(var o=0,s=e._windows.get();o<s.length;o++){var a=s[o];a.activity&&a.activity.id===n.id&&e._windows.process(new Te(a,new ke(Pe.ActivityWindowLeftActivity)))}}))},t.prototype.subscribeWindowEvents=function(t){var e=function(e,n){var i=n.type;i===Pe.Added&&(i="opened"),t(e.activity,e,i)};return this._windowHandlers.push([t,e]),this._windows.subscribe(e)},t.prototype.unsubscribeWindowEvents=function(t){var e=this._windowHandlers.find((function(e){return e[0]===t}));e&&(this._windowHandlers.splice(this._windowHandlers.indexOf(e),1),this._windows.unsubscribe(e[1]))},t.prototype.createWindow=function(t,e,n){var i=this;return We(new Promise((function(n,r){var o,s;if(we(e)&&r("windowType is undefined"),ye(e))o={type:e,name:"",isIndependent:!1,arguments:{}};else if(e instanceof Ae)o={type:e.type||e.id,name:e.name||e.type||e.id,isIndependent:!1};else{var a=["url"],c={};Object.keys(e).forEach((function(t){-1===a.indexOf(t)&&(c[t]=e[t])})),o=c}if(!we(o.relativeTo))if("string"==typeof(s=o.relativeTo))!we(u=i.getWindows({type:s}))&&u.length>0&&(o.relativeTo=u[0].id);else if(we(s.type))we(s.windowId)||(o.relativeTo=s.windowId);else{var u;!we(u=i.getWindows({type:s.type}))&&u.length>0&&(o.relativeTo=u[0].id)}i._bridge.createWindow(t&&t.id,o).then((function(e){i._logger.debug("Window created, waiting for window entity with id "+e);var r=function(o,s){o.id!==e||t&&!o.activity||(i._logger.debug("Got entity window with id "+e),n(o),i._windows.unsubscribe(r))};i._windows.subscribe(r)})).catch((function(t){r(t)}))})),n)},t.prototype.createStackedWindows=function(t,e,n,i){var r=this;return We(new Promise((function(i,o){we(t)&&o("activity is undefined"),we(e)&&o("relativeWindowTypes is undefined"),Array.isArray(e)||o("relativeWindowTypes has to be an array"),we(n)&&(n=2e4);var s=[];e.forEach((function(t){var e,i;if((e=ye(t)?{type:t,name:"",isIndependent:!1,arguments:{}}:t).stackedWindow=!0,e.timeout=n,!we(e.relativeTo))if(we((i=e.relativeTo).type)){if(!we(i.windowId)){var o=r.getWindows({id:i.windowId});!we(o)&&o.length>0&&(e.relativeTo=o[0].type.name)}}else e.relativeTo=i.type;s.push(e)}));var a=[];s.forEach((function(e){return a.push(r.createWindow(t,e))})),Promise.all(a).then(i).catch(o)})),i)},t.prototype.addWindowToActivity=function(t,e,n){var i=this._bridge.joinActivity(t.id,e.id).then((function(){return e}));return We(i,n),i},t.prototype.leaveWindowFromActivity=function(t,e,n){var i=this._bridge.leaveActivity(t.id,e.id).then((function(){return e}));return We(i,n),i},t.prototype.setActivityContext=function(t,e,n){var i=this;return We(new Promise((function(n,r){we(t)&&r("activity can not be null"),i._bridge.updateActivityContext(t,e,!0).then((function(e){n(t)})).catch((function(t){r(t)}))})),n)},t.prototype.updateActivityContext=function(t,e,n){var i=this;return We(new Promise((function(n,r){we(t)&&r("activity can not be null");var o=[];for(var s in e)e.hasOwnProperty(s)&&null===e[s]&&o.push(s);for(var a=0,c=o;a<c.length;a++){var u=c[a];delete e[u]}i._bridge.updateActivityContext(t,e,!1,o).then((function(e){n(t)})).catch((function(t){r(t)}))})),n)},t.prototype.subscribeActivityContextChanged=function(t){this._activities.subscribe((function(e,n){if(n.type===Pe.ActivityContextChange){var i=n;t(e,i.context,i.updated,i.removed)}}))},t.prototype.stopActivity=function(t,e){return We(this._bridge.stopActivity(t),e)},t.prototype.getWindows=function(t){return me(t)?this._windows.get():me(t.id)?this._windows.get().filter((function(e){if(!me(t.type)&&e.type.id!==t.type)return!1;if(!me(t.name)&&e.name!==t.name)return!1;if(!me(t.activityId)){if(we(e.activity))return!1;if(e.activity.id!==t.activityId)return!1}return!0})):[this._windows.getByName(t.id)]},t.prototype.getWindowBounds=function(t){return this._bridge.getWindowBounds(t)},t.prototype.setWindowBounds=function(t,e,n){var i=this;return We(new Promise((function(n,r){i._bridge.setWindowBounds(t,e).then((function(){return n()})).catch((function(t){return r(t)}))})),n)},t.prototype.closeWindow=function(t){return this._bridge.closeWindow(t)},t.prototype.activateWindow=function(t,e){return this._bridge.activateWindow(t,e)},t.prototype.setWindowVisibility=function(t,e){return this._bridge.setWindowVisibility(t,e)},t.prototype.clone=function(t,e,n){var i=this;return We(new Promise((function(n,r){t||r("activity can not be null"),i._bridge.cloneActivity(t.id,e).then((function(t){i._activities.getOrWait(t).then((function(t){n(t)})).catch((function(t){return r(t)}))})).catch((function(t){return r(t)}))})),n)},t.prototype.attachActivities=function(t,e,n,i){var r=this;return n=n||{},We(new Promise((function(i,o){if(r._activities.getByName(t)){if(r._activities.getByName(e))return r._bridge.attachActivities(t,e,n).then((function(t){var e=t.to,n=t.descriptor,o=t.descriptors;r._activities.getOrWait(e).then((function(t){t._updateDescriptors(o);var e=t.attached.filter((function(t){return t.ownerId===n.ownerId}))[0];i(e)}))})).catch((function(t){o(t)}));o("can not find activity with id "+e)}else o("can not find activity with id "+t)})),i)},t.prototype.detachActivities=function(t,e,n){var i=this;return We(new Promise((function(n,r){return i._bridge.detachActivities(t,e).then((function(){i._activities.getOrWait(undefined).then((function(t){t._updateDescriptors(undefined),i._activities.getOrWait(undefined).then((function(t){n(t)}))})).catch((function(t){return r(t)}))})).catch((function(t){r(t)}))})),n)},t.prototype.subscribeActivitiesAttached=function(t){this._attachedCallbacks.push(t)},t.prototype.subscribeActivitiesDetached=function(t){this._detachedCallbacks.push(t)},t.prototype.subscribeActivityFrameColorChanged=function(t){this._frameColorChangesCallbacks.push(t)},t.prototype._grabEntity=function(t){t._manager=this},t.prototype._getInitialData=function(){var t=this;this._logger.debug("Request initial data..."),this._bridge.getActivityTypes().then((function(e){t._activityTypes.add(e),t._dataReadyMarker.signal("Got act types")})).catch((function(e){t._logger.error(e),t._dataReadyMarker.error("Can not initialize ActivityManager - error getting activity types -"+e)})),this._bridge.getWindowTypes().then((function(e){t._windowTypes.add(e),t._dataReadyMarker.signal("Got window types")})).catch((function(e){t._logger.error(e),t._dataReadyMarker.error("Can not initialize ActivityManager - error getting window types  "+e)})),this._bridge.getActivities().then((function(e){t._activities.add(e),t._dataReadyMarker.signal("Got activities")})).catch((function(e){t._logger.error(e),t._dataReadyMarker.error("Can not initialize ActivityManager - error getting activity instances -"+e)})),this._bridge.getActivityWindows().then((function(e){t._windows.add(e),t._dataReadyMarker.signal("Got windows")})).catch((function(e){t._logger.error(e),t._dataReadyMarker.error("Can not initialize ActivityManager - error getting activity windows -"+e)}))},t.prototype._subscribeForData=function(){var t=this;this._logger.debug("Subscribe for data..."),this._bridge.onActivityTypeStatusChange((function(e){t._activityTypes.process(e)})),this._bridge.onWindowTypeStatusChange((function(e){t._windowTypes.process(e)})),this._bridge.onActivityWindowChange((function(e){t._windows.process(e)})),this._bridge.onActivityStatusChange((function(e){t._activities.process(e)}))},t.prototype._handleActivitiesAttached=function(t){var e=this,n=t.to,i=t.descriptor,r=t.descriptors;this._activities.getOrWait(n).then((function(t){t._updateDescriptors(r);var n=t.attached.filter((function(t){return t.ownerId===i.ownerId}))[0];e._attachedCallbacks.forEach((function(e){try{e(t,n)}catch(t){return}}))}))},t.prototype._handleActivitiesDetached=function(t){var e=this,n=t.oldActivityId,i=t.newActivityId,r=t.descriptors,o=t.descriptor;this._activities.getOrWait(n).then((function(t){t._updateDescriptors(r),e._activities.getOrWait(i).then((function(n){e._detachedCallbacks.forEach((function(e){try{e(n,t,o)}catch(t){return}}))}))}))},t.prototype._handleActivityDescriptorsRefreshed=function(t){var e=t.id,n=t.descriptors,i=this._activities.getByName(e);i&&i._updateDescriptors(n)},t.prototype.refreshDescriptors=function(){var t=this;this._bridge.getAttachedDescriptors().then((function(e){e&&Object.keys(e).forEach((function(n){var i=n,r=e[n],o=t._activities.getByName(i);o&&o._updateDescriptors(r)})),t._descriptorsMarker.signal("Successfully got descriptors")})).catch((function(e){t._descriptorsMarker.error("failed to get descriptors - "+e)}))},t.prototype._handleWindowFrameColorChanged=function(t){if(t.activityId){var e=this._activities.getByName(t.activityId);e&&e.owner&&e.owner.underlyingWindow.id===t.id&&this._frameColorChangesCallbacks.forEach((function(n){try{n(e,t.frameColor)}catch(t){return}}))}},t}(),on=function(){function t(t,e){this._m=t,this._my=e,this.activityTypes={get:this._getActivityTypesWrapper.bind(this),register:this._m.registerActivityType.bind(this._m),unregister:this._m.unregisterActivityType.bind(this._m),subscribe:this._m.subscribeActivityTypeEvents.bind(this._m),unsubscribe:void 0,initiate:this._m.initiate.bind(this._m)},this.windowTypes={get:this._getWindowTypesWrapper.bind(this),registerFactory:this._m.registerWindowFactory.bind(this._m),unregisterFactory:this._m.unregisterWindowFactory.bind(this._m),subscribe:this._m.subscribeWindowTypeEvents.bind(this._m),unsubscribe:void 0},this.windows={get:this._m.getWindows.bind(this._m),subscribe:this._m.subscribeWindowEvents.bind(this._m),announce:this._m.announceWindow.bind(this._m),unsubscribe:void 0,create:this._m.createWindow.bind(this._m)},this.instances={get:this._m.getActivities.bind(this._m),subscribe:this._m.subscribeActivityEvents.bind(this._m),unsubscribe:void 0}}return t.prototype.onAttached=function(t){this._m.subscribeActivitiesAttached(t)},t.prototype.onDetached=function(t){this._m.subscribeActivitiesDetached(t)},t.prototype.onActivityFrameColorChanged=function(t){this._m.subscribeActivityFrameColorChanged(t)},t.prototype._getActivityTypesWrapper=function(t){return me(t)?this._m.getActivityTypes():this._m.getActivityType(t)},t.prototype._getWindowTypesWrapper=function(t){return me(t)?this._m.getWindowTypes():this._m.getWindowType(t)},t}(),sn=function(){function t(t,e){this._mgr=t,this._my=e,this.all=new on(t,e)}return t.prototype.ready=function(t){var e=this;return We(new Promise((function(t,n){e._mgr.ready().then((function(){t(e)})).catch((function(t){n(t)}))})),t)},Object.defineProperty(t.prototype,"my",{get:function(){return this._my},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"aware",{get:function(){return void 0!==this._my.window},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"inActivity",{get:function(){return this.aware&&void 0!==this._my.activity},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"agm",{get:function(){if(this.aware)return this.inActivity?this._my.activity.agm:new Ee(null)},enumerable:!0,configurable:!0}),t.prototype.getAvailableFrameColors=function(){return[]},t}(),an=function(){function t(e){var n,i=this;if(!e)throw new Error("config can not be null");if(me(e.logLevel)||(Ne.Level=e.logLevel),we(e.logger)||(Ne.GlueLogger=e.logger),this._isUsingHCImplementation=2===e.gdMajorVersion,this._isUsingGW3Implementation=t.checkIsUsingGW3Implementation(e.connection),this._isUsingHCImplementation)throw new Error("GD2 not supported");if(!this._isUsingGW3Implementation)throw new Error("Unable to instantiate activity bridge implementation");if(!(n=new $e(e)))throw new Error("A bridge to native activity is needed to create activity lib.");Ee.AGM=e.agm;var r=new rn(n,!e.disableAutoAnnounce,e.windows),o=new tn(r,e.windows);this._api=new sn(r,o),this._readyPromise=r.ready().then((function(t){return i}))}return t.checkIsUsingGW3Implementation=function(t){return 3===t.protocolVersion},Object.defineProperty(t.prototype,"api",{get:function(){return this._api},set:function(t){this._api=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isUsingHCImplementation",{get:function(){return this._isUsingHCImplementation},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isUsingGW3Implementation",{get:function(){return this._isUsingGW3Implementation},enumerable:!0,configurable:!0}),t.prototype.ready=function(t){return We(this._readyPromise,t)},t}(),cn="T42.ACS.GetFunctionalEntitlement",un="T42.ACS.CanI",dn="T42.ACS.OnEvent";function pn(t){if(t&&t.errorHandling&&"function"!=typeof t.errorHandling&&"log"!==t.errorHandling&&"silent"!==t.errorHandling&&"throw"!==t.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof t.errorHandling+" was passed");var e=t&&"function"==typeof t.errorHandling&&t.errorHandling,n={};function i(n,i){var r=n instanceof Error?n:new Error(n);if(e)e(r);else{var o='[ERROR] callback-registry: User callback for key "'+i+'" failed: '+r.stack;if(t)switch(t.errorHandling){case"log":return console.error(o);case"silent":return;case"throw":throw new Error(o)}console.error(o)}}return{add:function(t,e,r){var o=n[t];return o||(o=[],n[t]=o),o.push(e),r&&setTimeout((function(){r.forEach((function(r){var o;if(null===(o=n[t])||void 0===o?void 0:o.includes(e))try{Array.isArray(r)?e.apply(void 0,r):e.apply(void 0,[r])}catch(e){i(e,t)}}))}),0),function(){var i=n[t];i&&(0===(i=i.reduce((function(t,n,i){return n===e&&t.length===i||t.push(n),t}),[])).length?delete n[t]:n[t]=i)}},execute:function(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];var o=n[t];if(!o||0===o.length)return[];var s=[];return o.forEach((function(n){try{var r=n.apply(void 0,e);s.push(r)}catch(e){s.push(void 0),i(e,t)}})),s},clear:function(){n={}},clearKey:function(t){n[t]&&delete n[t]}}}pn.default=pn;var hn=pn;function ln(t){return t?Object.keys(t).map((function(e){return t[e]})):[]}function fn(t){var e;try{e=JSON.parse(JSON.stringify(t||{}))}catch(t){e={}}return e}var gn=function(){function t(t,e,n){var i=this;this._appManager=t,this._name=e,this._agm=n,this._registry=hn(),t.onInstanceStarted((function(t){t.application&&t.application.name!==i._name||i._registry.execute("instanceStarted",t)})),t.onInstanceStopped((function(t){t.application&&t.application.name!==i._name||i._registry.execute("instanceStopped",t)})),t.onAppRemoved((function(t){t.name===i._name&&i._registry.execute("appRemoved",t)})),t.onAppChanged((function(t){t.name===i._name&&i._registry.execute("appChanged",t)})),t.onAppAvailable((function(t){t.name===i._name&&i._registry.execute("appAvailable",t)})),t.onAppUnavailable((function(t){t.name===i._name&&i._registry.execute("appUnavailable",t)}))}return Object.defineProperty(t.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"title",{get:function(){return this._props.Title},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"version",{get:function(){return this._props.Version},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"autoStart",{get:function(){return this._props.AutoStart},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isShell",{get:function(){return this._props.IsShell},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"caption",{get:function(){return this._props.Caption},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hidden",{get:function(){return this._props.IsHidden},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"container",{get:function(){return this._props.ApplicationName},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityType",{get:function(){return this._props.ActivityType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityWindowType",{get:function(){return this._props.ActivityWindowType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"windowSettings",{get:function(){return this._props.Arguments?fn(this._props.Arguments):{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"allowMultiple",{get:function(){return this._props.AllowMultiple},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"available",{get:function(){return this._props.IsReady||!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"icon",{get:function(){return this._props.Icon},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"iconURL",{get:function(){return this._props.IconUrl},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"sortOrder",{get:function(){return this._props.SortOrder},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"userProperties",{get:function(){return this._props.UserProperties?fn(this._props.UserProperties):{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isActivity",{get:function(){return void 0!==this._props.ActivityType&&""!==this._props.ActivityType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"configuration",{get:function(){return{autoStart:this._props.AutoStart,caption:this._props.Caption,hidden:this._props.IsHidden,container:this._props.ApplicationName,activityType:this._props.ActivityType,allowMultiple:this._props.AllowMultiple}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"instances",{get:function(){var t=this;return this._appManager.instances().filter((function(e){return e.application.name===t._name}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"type",{get:function(){return this._props.Type},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"mode",{get:function(){if(!this._props)return"unknown";if(this._props.Mode&&"string"==typeof this._props.Mode)return this._props.Mode.toLowerCase();if(this.isActivity)return"unknown";if(this._props.Arguments&&this._props.Arguments.mode&&"string"==typeof this._props.Arguments.mode)return this._props.Arguments.mode.toLowerCase();var t=this._props.WindowStyleAttributes;if(t){var e='mode:"',n=(t=t.split(" ").join("")).indexOf(e);if(-1!==n){var i=n+e.length,r=t.indexOf('"',i),o=t.substr(i,r-i);if(o&&"string"==typeof o)return o.toLowerCase()}}return"flat"},enumerable:!0,configurable:!0}),t.prototype.updateFromProps=function(t){var e=this;this._props||(this._props={Name:t.Name}),Object.keys(t).forEach((function(n){e._props[n]=t[n]}))},t.prototype.start=function(t,e){var n=this,i=this._name;return new Promise((function(r,o){var s;t=t||{};var a=null==(s=(e=e||{}).waitForAGMReady)||s;n._agm.invoke("T42.ACS.StartApplication",{Name:i,Context:t,Options:e},"best",{methodResponseTimeoutMs:1e4},(function(t){var e=t.returned&&t.returned.Instance_0?t.returned.Instance_0:t.returned;if(e&&e.Id)if("startOnly"===n._appManager.mode){var i=n._appManager.handleInstanceStarted(e);r(i)}else!function(t){var e,i=function(){var e,i=n._appManager.instances().filter((function(e){return e.id===t}));return(e=2===i.length?i[0].isActivityInstance?i[0]:i[1]:i[0])&&a?e.agm?e:void 0:e},s=setTimeout((function(){e&&e(),o("timeout")}),1e4),c=function(n){n.id===t&&(e&&(e(),e=void 0),clearTimeout(s),setTimeout((function(){r(i())}),1))};e=a?n._appManager.onInstanceAgmServerReady(c):n._appManager.onInstanceStarted(c);var u=i();u&&(e&&(e(),e=void 0),clearTimeout(s),r(u))}(e.Id);else r(void 0)}),(function(t){o(t)}))}))},t.prototype.onInstanceStarted=function(t){this._registry.add("instanceStarted",t)},t.prototype.onInstanceStopped=function(t){this._registry.add("instanceStopped",t)},t.prototype.onAvailable=function(t){this._registry.add("appAvailable",t)},t.prototype.onUnavailable=function(t){this._registry.add("appUnavailable",t)},t.prototype.onChanged=function(t){this._registry.add("appChanged",t)},t.prototype.onRemoved=function(t){this._registry.add("appRemoved",t)},t}(),yn=function(){function t(t,e,n,i,r,o,s){var a=this;this._id=t,this._appName=e,this._appManager=n,this._agm=i,this._activities=r,this._windows=o,this.onAgmReady=this._addToRegistry("agmReady"),this.onStopped=this._addToRegistry("stopped"),this._registry=hn(),s||(this._unsubscribeInstanceStopped=this._appManager.onInstanceStopped((function(t){t.id===a._id&&a._registry.execute("stopped",t)})),this._unsubscribeInstanceAgmServerReady=this._appManager.onInstanceAgmServerReady((function(t){t.id===a._id&&a._registry.execute("agmReady",t)})))}return Object.defineProperty(t.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"application",{get:function(){return this._appManager.application(this._appName)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activity",{get:function(){var t=this;if(!this._activities)throw new Error("This method requires glue.activities library to be enabled.");return this._activities.all.instances.get().filter((function(e){return e.id===t._activityId}))[0]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isActivityOwner",{get:function(){return this._isActivityOwner},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityInstances",{get:function(){var t=this;return this._appManager.instances().filter((function(e){return"activity"!==e.application.type&&e.activityId&&e.activityId===t._activityId}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityOwnerInstance",{get:function(){if(this._activityId)return this.activityInstances.filter((function(t){var e;return null===(e=t)||void 0===e?void 0:e.isActivityOwner}))[0]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"window",{get:function(){var t=this;if(!this._windows)throw new Error("This method requires glue.windows library to be enabled.");var e=this._windows.list().filter((function(e){return e.id===t._id}))[0];return!e&&this._activities&&this.activity&&this.activityOwnerInstance&&(e=this.activityOwnerInstance.window),e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"context",{get:function(){var t,e,n;return null!=(n=null!=(t=this._startUpContext)?t:null===(e=this.window)||void 0===e?void 0:e.context)?n:{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"title",{get:function(){return this._title},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isActivityInstance",{get:function(){return this._isActivityInstance},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityId",{get:function(){return this._activityId},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"inActivity",{get:function(){return this._inActivity},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isSingleWindowApp",{get:function(){return!this._inActivity},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"agm",{get:function(){return this._agmInstance},enumerable:!0,configurable:!0}),t.prototype.getWindow=function(){var t=this;return new Promise((function(e,n){var i=t.window;if(i)e(i);else var r=function(t,i){t&&n(t),i&&e(i),setTimeout((function(){clearTimeout(o),s()}),0)},o=setTimeout((function(){r(new Error("can not find a window with id "+t._id))}),3e4),s=t._windows.onWindowAdded((function(e){e.id===t._id&&r(void 0,e)}))}))},t.prototype.updateFromProps=function(t){this._startUpContext=t.Context,this._title=t.Title,this._isActivityInstance=!1,t.ActivityId&&""!==t.ActivityId&&(this._activityId=t.ActivityId,this._isActivityInstance=!0),this._isActivityOwner=t.IsActivityOwner,!this._activityId&&this._startUpContext&&this._startUpContext.activityId&&(this._activityId=this._startUpContext.activityId),this._inActivity=Boolean(this._activityId),this.updateAgmInstanceFromProps(t)},t.prototype.updateAgmInstanceFromProps=function(t){if(t.AgmServers)if(t.GD3){var e=t.AgmServers;e&&(this._agmInstance=e[0])}else{var n=t.AgmServers,i=Object.keys(n)[0];if(!i)return;var r=n[i];this._agmInstance={machine:r.machineName,user:r.userName,environment:r.environment,application:r.applicationName}}},t.prototype.stop=function(){var t=this;return new Promise((function(e,n){var i=t._appManager.onInstanceStopped((function(n){n.id===t._id&&(i(),e())}));t._agm.invoke("T42.ACS.StopApplication",{Name:t._appName,Id:t._id}).then((function(){"startOnly"===t._appManager.mode&&(t._appManager.handleInstanceStopped({Name:t._appName,Id:t.id,Context:void 0,Title:void 0,ActivityId:void 0,IsActivityOwner:void 0,AgmServers:void 0}),e())})).catch((function(t){return n(t)}))}))},t.prototype.activate=function(){return this._agm.invoke("T42.ACS.ActivateApplication",{Name:this._appName,Id:this._id})},t.prototype.done=function(){this._registry.clear(),this._unsubscribeInstanceAgmServerReady(),this._unsubscribeInstanceStopped()},t.prototype.getContext=function(){return Promise.resolve(this.context)},t.prototype._addToRegistry=function(t){var e=this;return function(n){e._registry.add(t,n)}},t}(),vn=function(){function t(t,e,n,i,r,o){var s=this;this.mode=t,this._agm=e,this._activities=n,this._windows=i,this._logger=r,this._gdMajorVersion=o,this._apps={},this._instances=[],this._registry=hn(),this.application=function(t){return s._apps[t]},this.applications=function(){return Object.keys(s._apps).map((function(t){return s._apps[t]}))},this.instances=function(){return s._instances},this.getMyInstance=function(){if(s._gdMajorVersion>=3){var t=window.glue42gd.appInstanceId;return s._instances.filter((function(e){return e.id===t}))[0]}},this.handleAppAdded=function(t){var e=s._getAppId(t);s._logger.trace("adding app "+e),s._apps[e]=new gn(s,e,s._agm);var n=s._updateAppFromProps(t);s._registry.execute("appAdded",n)},this.handleAppUpdated=function(t){var e=s._updateAppFromProps(t);s._registry.execute("appChanged",e)},this.handleAppRemoved=function(t){var e=s._getAppId(t);s._logger.trace("removing app "+e);var n=s.application(e);s._instances=s._instances.filter((function(t){return t.application.name!==n.name})),delete s._apps[e],s._registry.execute("appRemoved",n)},this.handleAppReady=function(t){var e=s._getAppId(t),n=s._getAppOrThrow(e);n.updateFromProps(t),n.available?s._registry.execute("appAvailable",n):s._registry.execute("appUnavailable",n)},this.handleInstanceStarted=function(t){s._logger.trace("started app "+t.Name+" "+t.Id);var e=s._getInstanceId(t),n=s._getInstanceAppName(t),i=new yn(e,n,s,s._agm,s._activities,s._windows);return s._updateInstanceFromProps(i,t),s._instances.push(i),s._registry.execute("instanceStarted",i),i},this.handleInstanceStopped=function(t){s._logger.trace("failed to start app "+t.Name+" "+t.Id);var e=s._getInstanceId(t),n=s._getInstanceAppName(t),i=s._getInstanceOrThrow(e,n);s._instances=s._instances.filter((function(t){return!s._matchInstance(t,e,n)})),s._registry.execute("instanceStopped",i),i.done()},this.handleInstanceAgmServerReady=function(t){var e=s._getInstanceId(t),n=s._getInstanceAppName(t),i=s._getInstanceOrThrow(e,n);i.updateAgmInstanceFromProps(t),s._registry.execute("instanceAgmServerReady",i)},this.handleInstanceStartFailed=function(t){var e=s._getInstanceId(t),n=s._getInstanceAppName(t),i=new yn(e,n,void 0,void 0,void 0,void 0,!0);s._updateInstanceFromProps(i,t),s._registry.execute("instanceStartFailed",i)},this.handleInstanceUpdated=function(t){var e=s._getInstanceId(t),n=s._getInstanceAppName(t),i=s._getInstanceOrThrow(e,n);s._updateInstanceFromProps(i,t)},this.onInstanceStarted=function(t){return s._registry.add("instanceStarted",t,s._instances)},this.onInstanceStartFailed=function(t){return s._registry.add("instanceStartFailed",t)},this.onInstanceStopped=function(t){return s._registry.add("instanceStopped",t)},this.onInstanceUpdated=function(t){return s._registry.add("instanceChanged",t)},this.onInstanceAgmServerReady=function(t){return s._registry.add("instanceAgmServerReady",t)},this.onAppAdded=function(t){return s._registry.add("appAdded",t,Object.values(s._apps))},this.onAppRemoved=function(t){return s._registry.add("appRemoved",t)},this.onAppAvailable=function(t){return s._registry.add("appAvailable",t)},this.onAppUnavailable=function(t){return s._registry.add("appUnavailable",t)},this.onAppChanged=function(t){return s._registry.add("appChanged",t)}}return t.prototype._getAppOrThrow=function(t){var e=this.application(t);if(!e)throw Error("app with id "+t+" not found");return e},t.prototype._getAppId=function(t){return t.Name},t.prototype._matchInstance=function(t,e,n){return t.id===e&&t.application.name===n},t.prototype._getInstanceByIdAndName=function(t,e){var n=this;return this._instances.filter((function(i){return n._matchInstance(i,t,e)}))[0]},t.prototype._getInstanceOrThrow=function(t,e){var n=this._getInstanceByIdAndName(t,e);if(!n)throw Error("instance with id "+t+" not found");return n},t.prototype._getInstanceId=function(t){return t.Id},t.prototype._getInstanceAppName=function(t){return t.Name},t.prototype._updateAppFromProps=function(t){var e=this._getAppId(t);this._logger.trace("updating app with  + "+e+", "+t);var n=this._getAppOrThrow(e);return n.updateFromProps(t),n},t.prototype._updateInstanceFromProps=function(t,e){this._logger.trace("updating instance with "+this._getInstanceId(e)+" for app "+this._getInstanceAppName(e)),t.updateFromProps(e)},t}();function mn(t,e,n){var i=function(t){return!!(t&&t.constructor&&t.call&&t.apply)};if(!i(e)&&!i(n))return t;i(e)?i(n)||(n=function(){}):e=function(){},t.then(e,n)}var wn=function(){function t(t){var e=this;this._agm=t,this._registry=hn(),this._isMethodRegistered=!1,this.handleBranchModified=function(t){e._registry.execute("branchChanged",t)},this.handleBranchesModified=function(t){e._registry.execute("branchesChanged",t)},this.getRegion=function(t,n){return mn(e._agmInvoke("T42.ACS.GetConfigurationRegion",(function(t){return t.returned.Region})),t,n)},this.getBranches=function(t,n){return mn(e._agmInvoke("T42.ACS.GetBranches",(function(t){var e=t.returned.Branches;return Object.keys(e).map((function(t){return e[t]}))})),t,n)},this.getCurrentBranch=function(t,n){return mn(e._agmInvoke("T42.ACS.GetCurrentBranch",(function(t){return t.returned.Branch}),void 0),t,n)},this.setRegion=function(t,n,i){return mn(e._agmInvoke("T42.ACS.SetConfigurationRegion",(function(t){return t.returned.ResultMessage}),{Region:t}),n,i)},this.setCurrentBranch=function(t,n,i){return mn(e._agmInvoke("T42.ACS.SetCurrentBranch",(function(t){return t.returned.ResultMessage}),{Branch:t}),n,i)},this.currentUser=function(t,n){return mn(e._agmInvoke("T42.ACS.GetUser"),t,n)},this.getFunctionalEntitlement=function(t,n,i){return mn(e._agmInvoke(cn,(function(t){return t.returned.Entitlement}),{Function:t}),n,i)},this.getFunctionalEntitlementBranch=function(t,n,i,r){return mn(e._agmInvoke(cn,(function(t){return t.returned.Entitlement}),{Function:t,Branch:n}),i,r)},this.canI=function(t,n,i){return mn(e._agmInvoke(un,(function(t){return t.returned.Result}),{Function:t}),n,i)},this.canIBranch=function(t,n,i,r){return mn(e._agmInvoke(un,(function(t){return t.returned.Result}),{Function:t,Branch:n}),i,r)},this.onBranchesChanged=function(t){return e._registry.add("branchesChanged",t)},this.onBranchChanged=function(t){return e._registry.add("branchChanged",t)},this.exit=function(t){return e._agmInvoke("T42.ACS.Shutdown",null,t)},this.onShuttingDown=function(t){return e.registerMethod(),e._registry.add("onShuttingDown",t)},this.restart=function(t){return e._agmInvoke("T42.ACS.Restart",null,t)},this._agmInvoke=function(t,n,i){return i=i||{},new Promise((function(r,o){e._agm.invoke(t,i).then((function(t){n||(n=function(t){return t.returned}),r(n(t))})).catch((function(t){return o(t)}))}))}}return t.prototype.registerMethod=function(){var t=this;this._isMethodRegistered||(this._agm.register("T42.ACS.OnGDShutdown",(function(e){return i(t,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,Promise.all(this._registry.execute("onShuttingDown",e))];case 1:return t.sent(),[3,3];case 2:return t.sent(),[3,3];case 3:return[2]}}))}))})),this._isMethodRegistered=!0)},t}();var bn="T42.ACS.InMemoryStoreCommand",_n=function(){function t(t){this.interop=t}return t.prototype.import=function(t,e){if(!t||!Array.isArray(t))return Promise.reject("invalid apps argument - should be an array of application definitions");if(e&&"replace"!==e&&"merge"!==e)return Promise.reject("invalid mode argument - should be 'replace' or 'merge'");var n={command:"import",args:{apps:t,mode:e=null!=e?e:"replace"}};return this.interop.invoke(bn,n).then((function(t){return t.returned}))},t.prototype.export=function(){return this.interop.invoke(bn,{command:"export"}).then((function(t){return t.returned.apps}))},t.prototype.remove=function(t){if(!t||"string"!=typeof t)return Promise.reject("invalid app name, should be a string value");var e={command:"remove",args:{apps:[t]}};return this.interop.invoke(bn,e).then((function(t){return t.returned}))},t.prototype.clear=function(){return this.interop.invoke(bn,{command:"clear"}).then((function(t){return t.returned}))},t.prototype.createAppDef=function(t,e){return e||(e="https://google.com"),{name:t,type:"window",title:t,details:{url:e}}},t}(),In=function(t){if(!t)throw Error("config not set");if(!t.agm)throw Error("config.agm is missing");var e="startOnly",n="skipIcons",i=t.mode||e;if(i!==e&&i!==n&&"full"!==i)throw new Error("Invalid mode for appManager lib - "+i+" is not supported");var r,o=t.activities,s=t.agm,a=t.logger,c=t.windows,u=new vn(i,s,o,c,a.subLogger("applications"),t.gdMajorVersion),d=new wn(s);if(i===e)r=function(t,e){return new Promise((function(n,i){t.invoke("T42.ACS.GetApplications",{skipIcon:!0}).then((function(t){var i=t.returned;i||n();var r=i.applications;r||n(),ln(r).map((function(t){return e.handleAppAdded(t)})),n()})).catch((function(t){return i("Error getting application snapshot: "+t.message)}))}))}(s,u);else{var p=function(t,e,n,i){var r;return{start:function(){var o,s,a=new Promise((function(t,e){o=t,s=e}));return t.subscribe(dn,{arguments:{skipIcon:i},waitTimeoutMs:1e4}).then((function(t){(r=t).onData((function(t){var i=t.data;ln(i.OnApplicationAdded).map((function(t){return e.handleAppAdded(t)})),ln(i.OnApplicationChanged).map((function(t){return e.handleAppUpdated(t)})),ln(i.OnApplicationRemoved).map((function(t){return e.handleAppRemoved(t)})),ln(i.OnApplicationReady).map((function(t){return e.handleAppReady(t)})),ln(i.OnApplicationStarted).map((function(t){return e.handleInstanceStarted(t)})),ln(i.OnApplicationStartFailed).map((function(t){return e.handleInstanceStartFailed(t)})),ln(i.OnApplicationStopped).map((function(t){return e.handleInstanceStopped(t)})),ln(i.OnApplicationUpdated).map((function(t){return e.handleInstanceUpdated(t)})),ln(i.OnApplicationAgmServerReady).map((function(t){return e.handleInstanceAgmServerReady(t)})),ln(i.OnBranchChanged).map((function(t){return n.handleBranchModified(t)})),ln(i.OnBranchesModified).map((function(t){return n.handleBranchesModified(t)})),o()})),r.onFailed((function(t){return s(t)}))})).catch((function(t){return s("Error subscribing for T42.ACS.OnEvent stream. Err: "+t)})),a},stop:function(){r&&r.close()}}}(s,u,d,i===n);r=p.start()}return{ready:function(){return r},applications:u.applications,application:u.application,onAppAdded:u.onAppAdded,onAppRemoved:u.onAppRemoved,onAppChanged:u.onAppChanged,onAppAvailable:u.onAppAvailable,onAppUnavailable:u.onAppUnavailable,instances:u.instances,get myInstance(){return u.getMyInstance()},onInstanceStarted:u.onInstanceStarted,onInstanceStopped:u.onInstanceStopped,onInstanceUpdated:u.onInstanceUpdated,onInstanceStartFailed:u.onInstanceStartFailed,getRegion:d.getRegion,getBranches:d.getBranches,getCurrentBranch:d.getCurrentBranch,getFunctionalEntitlement:d.getFunctionalEntitlement,getFunctionalEntitlementBranch:d.getFunctionalEntitlementBranch,setCurrentBranch:d.setCurrentBranch,setRegion:d.setRegion,currentUser:d.currentUser,canI:d.canI,canIBranch:d.canIBranch,onBranchesChanged:d.onBranchesChanged,exit:d.exit,restart:d.restart,onShuttingDown:d.onShuttingDown,inMemory:new _n(s)}},Cn=new(function(){function t(){this.waitForTimeoutInMilliseconds=6e4,this._windows={},this._pendingWindows={},this._pendingWindowsStates={},this._registry=hn()}return t.prototype.init=function(t){this._logger=t},t.prototype.get=function(t){return this._windows[t]||this._pendingWindows[t]},t.prototype.getIfReady=function(t){return this._windows[t]},Object.defineProperty(t.prototype,"list",{get:function(){return this._windows},enumerable:!0,configurable:!0}),t.prototype.add=function(t){if(!!this._pendingWindows[t.API.id])this._logger.error("trying to add window with id "+t.API.id+" from windowStore, which already exists");else{var e="remote"===t.API.windowType;this._pendingWindows[t.API.id]=t,this._pendingWindowsStates[t.API.id]={ready:!1,urlChanged:e},this._registry.execute("on-added",t)}},t.prototype.remove=function(t){delete this._windows[t.API.id],delete this._pendingWindows[t.API.id],delete this._pendingWindowsStates[t.API.id],this._registry.execute("on-removed",t)},t.prototype.setReadyState=function(t){var e=this._pendingWindowsStates[t];void 0!==e&&(e.ready=!0,e.urlChanged&&this.markReadyToShow(t))},t.prototype.setUrlChangedState=function(t){var e=this._pendingWindowsStates[t];void 0!==e&&(e.urlChanged=!0,e.ready&&this.markReadyToShow(t))},t.prototype.waitFor=function(t){var e=this;return new Promise((function(n,i){var r,o=setTimeout((function(){r(),i("waitFor timed out.")}),e.waitForTimeoutInMilliseconds),s=e._windows[t];s?(clearTimeout(o),n(s)):r=e.onReadyWindow((function(e){e.API.id===t&&(clearTimeout(o),r(),n(e))}))}))},t.prototype.onReadyWindow=function(t){return this._registry.add("on-ready",t)},t.prototype.onAdded=function(t){return this._registry.add("on-added",t)},t.prototype.onRemoved=function(t){return this._registry.add("on-removed",t)},t.prototype.markReadyToShow=function(t){this._pendingWindows[t]&&(this._windows[t]=this._pendingWindows[t],delete this._pendingWindows[t],delete this._pendingWindowsStates[t]),this._registry.execute("on-ready",this._windows[t])},t}()),An=function(){function t(){}return t.getGDMajorVersion=function(){if("undefined"==typeof window)return-1;if(!window.glueDesktop)return-1;if(!window.glueDesktop.version)return-1;var t=Number(window.glueDesktop.version.substr(0,1));return isNaN(t)?-1:t},t.callbackifyPromise=function(t,e,n){var i=function(t){var e=t;if(t instanceof Error&&(e=t.message),"function"!=typeof n)return Promise.reject(e);n(e)};try{return t().then((function(t){return"function"==typeof e&&e(t),t})).catch((function(t){return i(t)}))}catch(t){return i(t)}},t.getMonitor=function(t,e){var n=this;return e.map((function(e){var i=e.left,r=e.top,o=e.workingAreaWidth,s=e.workingAreaHeight;return{monitor:e,totalOverlap:n.calculateTotalOverlap({left:i,top:r,width:o,height:s},t)}})).sort((function(t,e){return e.totalOverlap-t.totalOverlap}))[0].monitor},t.getDisplayCenterOfScreen=function(t,e){var n=Math.floor(Math.max(e.left,e.left+(e.workingAreaWidth-t.width)/2));return{top:Math.floor(Math.max(e.top,e.top+(e.workingAreaHeight-t.height)/2)),left:n}},t.calculateTotalOverlap=function(t,e){var n=t.left,i=t.top,r=n+t.width,o=i+t.height,s=e.left,a=e.top,c=s+e.width,u=a+e.height;return Math.max(0,Math.min(r,c)-Math.max(n,s))*Math.max(0,Math.min(o,u)-Math.max(i,a))},t}(),Tn=function(t,e,n,o,s,a,c){var u,d,p,h,l,f=hn(),g=o.subLogger("window "+t),y=t,v=e.name,m=e.mode,w=e.bounds,b=e.url,_=e.title,I=null!=(u=e.context)?u:{},C=e.frameColor,A=e.focus,T=null!=(d=e.neighbours)?d:{},k=e.groupId,S=e.isGroupHeaderVisible,x=e.isTabHeaderVisible,P=null!=(p=e.isTabSelected)&&p,M=e.settings,E=e.isVisible,j=e.isSticky,O=e.isCollapsed,W=e.state,R=e.tabGroupId,F=e.tabIndex,N=e.isLocked,L=[],D=e.zoomFactor,G=e.placementSettings;function B(t,e,i){return An.callbackifyPromise((function(){if(we(t))throw new Error("The properties of `bounds` cannot be null or undefined.");return n.moveResize(h,t)}),e,i)}function H(t,e,i){return An.callbackifyPromise((function(){return n.setVisible(h,t)}),e,i)}function q(t,e,i){return An.callbackifyPromise((function(){if(we(t))throw new Error('"context" must not be null or undefined.');return n.updateContext(h,t)}),e,i)}function U(t){return V("group-changed",t)}function V(t,e,n){if(!_e(e))throw new Error("callback must be a function");return f.add(t,e,n)}function z(t){var e=T[t];if(void 0!==e)return e.reduce((function(t,e){var n=Cn.get(e);return n&&t.push(n.API),t}),[])}function J(){if(I._APPLICATION_NAME)return I._APPLICATION_NAME;if(I&&I._t42&&I._t42.application)return I._t42.application;var t=K();return t?t.applicationName:void 0}function K(){if("undefined"!=typeof window&&window.glue42gd&&window.glue42gd.getWindowInfo){var e=window.glue42gd.getWindowInfo(t);return e||void 0}}return{API:h={get id(){return y},get name(){return v},get application(){var t=s();return t?t.application(J()):void 0},get hostInstance(){return n.hostInstance},get agmInstance(){var t=this;if("undefined"!=typeof window&&window.glue42gd)return c.servers().find((function(e){return e.windowId===t.id}));var e=J();return e?{application:e}:void 0},get url(){return b},get title(){return _},get windowStyleAttributes(){return M},get settings(){return M},get tabGroupId(){return"tab"===m.toLowerCase()?R:void 0},get tabIndex(){return"tab"===m.toLowerCase()?F:void 0},get frameButtons(){return L},get mode(){return m},get state(){return W},get isCollapsed(){return O},get isVisible(){return E},get isLocked(){return N},get context(){return I},get bounds(){return w},get minHeight(){return M.minHeight},get maxHeight(){return M.maxHeight},get minWidth(){return M.minWidth},get maxWidth(){return M.maxWidth},get isFocused(){return A},get frameColor(){return C},get opened(){return void 0!==h.id},get group(){return l},get groupId(){return k},get isSticky(){return j},get topNeighbours(){return z("top")},get leftNeighbours(){return z("left")},get rightNeighbours(){return z("right")},get bottomNeighbours(){return z("bottom")},get isGroupHeaderVisible(){return S},get activityId(){if(I._t42)return I._t42.activityId;var t=K();return t?t.activityId:void 0},get activityWindowId(){if(I._t42)return I._t42.activityWindowId;var t=K();return t?t.activityWindowId:void 0},get windowType(){return e.windowType||"electron"},get zoomFactor(){return D},get screen(){if("undefined"!=typeof window&&window.glue42gd)return An.getMonitor(h.bounds,window.glue42gd.monitors)},get placementSettings(){return Object.assign({},G)},maximize:function(t,e){return An.callbackifyPromise((function(){return"maximized"===W?Promise.resolve(h):n.maximize(h)}),t,e)},restore:function(t,e){return An.callbackifyPromise((function(){return"normal"===W?Promise.resolve(h):n.restore(h)}),t,e)},minimize:function(t,e){return An.callbackifyPromise((function(){return"minimized"===W?Promise.resolve(h):n.minimize(h)}),t,e)},maximizeRestore:function(t,e){return An.callbackifyPromise((function(){return n.maximizeRestore(h)}),t,e)},collapse:function(t,e){return An.callbackifyPromise((function(){return O?Promise.resolve(h):n.collapse(h)}),t,e)},expand:function(t,e){return An.callbackifyPromise((function(){return O?n.expand(h):Promise.resolve(h)}),t,e)},toggleCollapse:function(t,e){return An.callbackifyPromise((function(){return n.toggleCollapse(h)}),t,e)},focus:function(t,e){return An.callbackifyPromise((function(){return A?Promise.resolve(h):n.focus(h)}),t,e)},activate:function(t,e){return An.callbackifyPromise((function(){return A?Promise.resolve(h):n.activate(h)}),t,e)},moveResize:B,setTitle:function(t,e,i){return An.callbackifyPromise((function(){if(we(t))throw new Error("`newTitle` must not be null or undefined.");return t===_?Promise.resolve(h):n.setTitle(h,t)}),e,i)},setStyle:function(t,e,i){return An.callbackifyPromise((function(){if(!t||0===Object.keys(t).length||Object.keys(t).every((function(t){return!t})))throw new Error("Invalid style arguments: "+JSON.stringify(t));if(t&&void 0!==t.focus){if("boolean"!=typeof t.focus)throw new Error("Focus must be a boolean value. Currently, only `focus: true` is supported.");!1===t.focus&&g.warn("`focus: false` is not supported!")}if(t&&void 0!==t.hidden&&"boolean"!=typeof t.hidden)throw new Error("The `hidden` property must hold a boolean value.");for(var e=0,i=["minHeight","maxHeight","minWidth","maxWidth"];e<i.length;e++){var r=i[e],o=t,s=o[r];if(r in t){if(we(s)){delete o[r];continue}if(!ge(o[r]))throw new Error('"'+r+'" must be a number')}}return n.setStyle(h,t)}),e,i)},setOnTop:function(t,e,i){return An.callbackifyPromise((function(){if("boolean"!=typeof t)throw new Error("`onTop` must hold a boolean value.");return n.setOnTop(h,t)}),e,i)},resetButtons:function(t,e,i){return An.callbackifyPromise((function(){return n.resetButtons(h,t)}),e,i)},setSizeConstraints:function(t,e,i){return An.callbackifyPromise((function(){if(!t||Object.keys(t).every((function(t){return void 0===t})))throw new Error("The properties of `constraints` cannot be null or undefined.");return n.setSizeConstraints(h,t)}),e,i)},navigate:function(t,e,i){return An.callbackifyPromise((function(){if(be(t))throw new Error("The new URL must be a non-empty string.");return n.navigate(h,t)}),e,i)},addFrameButton:function(t,e,i){return An.callbackifyPromise((function(){if(void 0===t||0===Object.keys(t).length)throw new Error("Button info is not available.");if(be(t.buttonId))throw new Error("`buttonId` must not be null or undefined.");if(be(t.imageBase64))throw new Error("`imageBase64` must not be null or undefined.");return n.addFrameButton(h,t)}),e,i)},removeFrameButton:function(t,e,i){return An.callbackifyPromise((function(){if(be(t))throw new Error("`buttonId` must not be null or undefined.");return n.removeFrameButton(h,t)}),e,i)},setVisible:H,show:function(){return H(!0)},hide:function(){return H(!1)},center:function(t){return B(An.getDisplayCenterOfScreen(h.bounds,t||h.screen))},close:function(e,i){return An.callbackifyPromise((function(){if(!t)throw new Error("The window is already closed.");return n.close(h)}),e,i)},snap:function(t,e,i,r){return An.callbackifyPromise((function(){if(we(t))throw new Error("A target window is not specified - "+t);if("string"==typeof t){var i=Cn.get(t);if(!i)throw new Error('Invalid "target" parameter or no such window. Invoked with: '+t);t=i.API}return n.snap(h,t,e)}),i,r)},showLoader:function(t){return n.showLoader(h,t)},hideLoader:function(){return n.hideLoader(h)},updateContext:q,lock:function(t,e){return An.callbackifyPromise((function(){return n.lock(h)}),t,e)},unlock:function(t,e){return An.callbackifyPromise((function(){return n.unlock(h)}),t,e)},getIcon:function(t,e){return An.callbackifyPromise((function(){return n.getIcon(h)}),t,e)},setIcon:function(t,e,i){return An.callbackifyPromise((function(){if(be(t))throw new Error('"base64Imag" must be a non-empty string.');return n.setIcon(h,t)}),e,i)},setFrameColor:function(t,e,i){return An.callbackifyPromise((function(){if(be(t))throw new Error('"frameColor" must be a non-empty string');return n.setFrameColor(h,t)}),e,i)},setTabTooltip:function(t){return i(this,void 0,void 0,(function(){return r(this,(function(e){if(be(t))throw new Error('"'+t+'" must not be null or undefined');return[2,n.setTabTooltip(h,t)]}))}))},attachTab:function(t,e,i,r){return An.callbackifyPromise((function(){var i,r,o='Invalid "tab" parameter - must be an object with an "id" property or a string. Invoked for source window with ID:';if(we(t))throw new Error(o+t);if("string"==typeof t){if(we(r=null===(i=Cn.get(t))||void 0===i?void 0:i.API))throw new Error(o+r)}else{if(we(t.id))throw new Error(o);r=t}var s={};return we(e)||("number"==typeof e?s.index=e:(s.selected=e.selected,s.index=e.index)),n.attachTab(h,r,s)}),i,r)},detachTab:function(t,e,i){return void 0===t&&(t={}),An.callbackifyPromise((function(){var e={};return void 0!==t.relativeTo?("string"==typeof t.relativeTo?e.relativeTo=t.relativeTo:we(t.relativeTo.id)||(e.relativeTo=t.relativeTo.id),we(t.relativeDirection)||(e.relativeDirection=t.relativeDirection),we(t.width)||(e.width=t.width),we(t.height)||(e.height=t.height)):we(t.bounds)||(e.bounds=t.bounds),we(t.hideTabHeader)||(e.hideTabHeader=t.hideTabHeader),n.detachTab(h,e)}),e,i)},setTabHeaderVisible:function(t,e,i){return An.callbackifyPromise((function(){if("boolean"!=typeof t)throw new Error('"toBeTabHeaderVisible" must hold a boolean value.');return n.setTabHeaderVisible(h,t)}),e,i)},showPopup:function(t){return n.showPopup(h,t)},createFlydown:function(t){return n.createFlydown(h.id,t)},setModalState:function(t){return n.setModalState(h.id,t||!1)},setZoomFactor:function(t,e,i){return An.callbackifyPromise((function(){if(isNaN(t))throw new Error("zoomFactor is not a number");return n.setZoomFactor(h,t)}),e,i)},zoomIn:function(t,e){return An.callbackifyPromise((function(){return n.zoomIn(h)}),t,e)},zoomOut:function(t,e){return An.callbackifyPromise((function(){return n.zoomOut(h)}),t,e)},showDevTools:function(){return n.showDevTools(h)},capture:function(t){return n.capture(h,t)},flash:function(t,e){var i={shouldFlash:!0,mode:"auto"};return"boolean"==typeof t&&(i.shouldFlash=t),void 0!==e&&(i.mode=e),n.flash(h,i)},setSticky:function(t,e,i){return An.callbackifyPromise((function(){if("boolean"!=typeof t)throw new Error("`isSticky` must hold a boolean value.");return n.setSticky(h,t)}),e,i)},print:function(t){return n.print(h,t)},printToPDF:function(t){return n.printToPDF(h,t)},place:function(t){return n.place(h,t)},ungroup:function(e){return new Promise((function(i,r){var o=U((function(e,n,r){t===e.id&&(o(),i(h))}));n.ungroup(h,e).catch((function(t){o(),r(t)}))}))},refresh:function(t){return n.refresh(h,t)},configure:function(t){return n.configureWindow(h,t)},onClose:function(e){if(!_e(e))throw new Error("callback should be a function");return void 0===t&&e(h),f.add("onClose",e)},onUrlChanged:function(t){return V("onUrlChanged",t)},onTitleChanged:function(t){return V("onTitleChanged",t,[h.title,h])},onFrameButtonAdded:function(t){return V("onFrameButtonAdded",t)},onFrameButtonRemoved:function(t){return V("onFrameButtonRemoved",t)},onFrameButtonClicked:function(t){return V("onFrameButtonClicked",t)},onCollapsed:function(t){if(!_e(t))throw new Error("callback should be a function");return O&&t(h),f.add("collapsed",t)},onExpanded:function(t){if(!_e(t))throw new Error("callback should be a function");return O||t(h),f.add("expanded",t)},onMinimized:function(t){return"minimized"===W?V("minimized",t,[h]):V("minimized",t)},onMaximized:function(t){return"maximized"===W?V("maximized",t,[h]):V("maximized",t)},onNormal:function(t){return"normal"===W?V("normal",t,[h]):V("normal",t)},onAttached:function(t){return V("attached",t)},onDetached:function(t){return V("detached",t)},onVisibilityChanged:function(t){return V("visibility-changed",t)},onContextUpdated:function(t){return V("context-updated",t)},onLockingChanged:function(t){return V("lock-changed",t)},onBoundsChanged:function(t){return V("bounds-changed",t)},onFrameColorChanged:function(t){return V("frame-color-changed",t)},onFocusChanged:function(t){return V("focus-changed",t)},onStickyChanged:function(t){return V("sticky-changed",t)},onGroupChanged:U,onWindowAttached:function(t){return V("window-attached",t)},onWindowDetached:function(t){return V("window-detached",t)},onTabSelectionChanged:function(t){return V("tab-selection-changed",t)},onTabHeaderVisibilityChanged:function(t){return V("tab-header-visibility-changed",t)},onClosing:function(e){if(!_e(e))throw new Error("callback must be a function");return n.onClosing((function(t,n){var i=e();i&&i.then?i.then(t).catch(n):t()}),t)},onRefreshing:function(e){if(!_e(e))throw new Error("callback must be a function");return n.onRefreshing((function(t,n,i){var r=e(i);r&&r.then?r.then(t).catch(n):t()}),t)},onZoomFactorChanged:function(t){return V("zoom-factor-changed",t)},onPlacementSettingsChanged:function(t){return V("placementSettingsChanged",t)},onNeighboursChanged:function(t){return V("neighbours-changed",t)},get tabs(){return t=Cn.list,"tab"!==m.toLowerCase()?[]:Object.keys(t).reduce((function(e,n){var i=t[n];return i&&i.API.tabGroupId&&void 0!==i.API.tabGroupId&&void 0!==h.tabGroupId&&i.API.tabGroupId===h.tabGroupId&&e.push(i.API),e}),[]).sort((function(t,e){if(t.tabIndex!==e.tabIndex){if(-1===t.tabIndex)return Number.MAX_SAFE_INTEGER;if(-1===e.tabIndex)return Number.MIN_SAFE_INTEGER}return t.tabIndex-e.tabIndex}));var t},get isTabHeaderVisible(){return x},get isTabSelected(){return P},getURL:function(){return Promise.resolve(b)},getTitle:function(){return Promise.resolve(_)},getBounds:function(){return Promise.resolve(w)},getContext:function(){return Promise.resolve(I)},setContext:function(t){return q(t)},getDisplay:function(){return a().getByWindowId(t)},resizeTo:function(t,e){return B({width:t,height:e})},moveTo:function(t,e){return B({top:t,left:e})},getParentWindow:function(){var t;return i(this,void 0,void 0,(function(){var e;return r(this,(function(n){return(e=M.parentInstanceId)?[2,null===(t=Cn.list[e])||void 0===t?void 0:t.API]:[2,void 0]}))}))},getChildWindows:function(){return i(this,void 0,void 0,(function(){return r(this,(function(e){return[2,Object.keys(Cn.list).map((function(t){return Cn.list[t].API})).filter((function(e){return e.settings.parentInstanceId===t}))]}))}))}},Events:{handleUpdate:function(t){b=t.url,_=t.title,I=t.context||{},w=t.bounds,C=t.frameColor,A=t.focus,T=t.neighbours||{},k=t.groupId,S=t.isGroupHeaderVisible,x=t.isTabHeaderVisible,P=t.isTabSelected,M=t.settings,E=t.isVisible,j=t.isSticky,O=t.isCollapsed,W=t.state,R=t.tabGroupId,N=t.isLocked,D=t.zoomFactor,G=t.placementSettings},handleWindowClose:function(){void 0!==t&&(f.execute("onClose",h),t=void 0)},handleWindowChangeState:function(t){return i(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return"collapsed"===t?O=!0:"expanded"===t?O=!1:W=t,[4,n.finished];case 1:return e.sent(),f.execute(t,h),[2]}}))}))},handleTitleChanged:function(t){_=t,n.finished.finally((function(){f.execute("onTitleChanged",t,h)}))},handleVisibilityChanged:function(t){t!==E&&(E=t,f.execute("visibility-changed",h))},handleUrlChanged:function(t){b=t,f.execute("onUrlChanged",t,h)},handleWindowSettingsChanged:function(t){M=t,f.execute("settings-changed",h)},handleContextUpdated:function(t){I=t,f.execute("context-updated",I,h)},handleFrameIsLockedChanged:function(t){N=t,f.execute("lock-changed",h)},handleBoundsChanged:function(t){w.top===t.top&&w.left===t.left&&w.width===t.width&&w.height===t.height||(w=t,f.execute("bounds-changed",h))},handleFocusChanged:function(t){A=t,f.execute("focus-changed",h)},handleFrameButtonAdded:function(t){var e=["buttonId","imageBase64","order","tooltip"].reduce((function(e,n){return e[n]=t[n],e}),{});-1===L.map((function(t){return t.buttonId})).indexOf(t.buttonId)&&L.push(e),f.execute("onFrameButtonAdded",e,h)},handleFrameButtonRemoved:function(t){var e;L=L.reduce((function(n,i){return i.buttonId===t?e=i:n.push(i),n}),[]),void 0!==e&&f.execute("onFrameButtonRemoved",e,h)},handleFrameButtonClicked:function(t){var e=L.filter((function(e){return e.buttonId===t.buttonId}));e.length>0&&f.execute("onFrameButtonClicked",e[0],h)},handleFrameColorChanged:function(t){C=t,f.execute("frame-color-changed",h)},handleFrameAttached:function(t,e){R=t,x=e,f.execute("frame-attached",h)},handleFrameSelectionChanged:function(e,o){return i(this,void 0,void 0,(function(){var i,s;return r(this,(function(r){switch(r.label){case 0:return e===t?(P=!0,i=h):(P=!1,i=Cn.get(e)?Cn.get(e).API:void 0),s=Cn.get(o)?Cn.get(o).API:void 0,[4,n.finished];case 1:return r.sent(),f.execute("tab-selection-changed",i,s,h),[2]}}))}))},handleCompositionChanged:function(t){T=t.neighbors||{},F=t.index,f.execute("neighbours-changed",T,h)},handleGroupHeaderVisibilityChanged:function(t){S=t},handleTabHeaderVisibilityChanged:function(t){x!==t&&(x=t,f.execute("tab-header-visibility-changed",h))},handleGroupChanged:function(t,e){var n;l=t,k=null===(n=t)||void 0===n?void 0:n.id,we(t)||we(e)||f.execute("group-changed",h,t,e)},handleAttached:function(t,e,o){return i(this,void 0,void 0,(function(){return r(this,(function(i){switch(i.label){case 0:return R=t,x=e,[4,n.finished];case 1:return i.sent(),o.forEach((function(t){t.Events.handleWindowAttached(h)})),f.execute("attached",h),[2]}}))}))},handleDetached:function(t){return i(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return R=void 0,P=!1,[4,n.finished];case 1:return e.sent(),t.forEach((function(t){t.Events.handleWindowDetached(h)})),f.execute("detached",h),[2]}}))}))},handleWindowAttached:function(t){f.execute("window-attached",t)},handleWindowDetached:function(t){f.execute("window-detached",t)},handleZoomFactorChanged:function(t){D=t,f.execute("zoom-factor-changed",h)},handleIsStickyChanged:function(t){j=t,f.execute("sticky-changed",t,h)},handlePlacementSettingsChanged:function(t){var e,n=t;if(n.display){var i=a();if(i){var r=n.display-1;e=new Promise((function(t,e){i.all().then((function(e){var n=e.find((function(t){return t.index===r}));t(n)})).catch(e)}))}else e=Promise.resolve(void 0)}else e=Promise.resolve(void 0);e.then((function(t){n.display=t,G=n,f.execute("placementSettingsChanged",h)}))}}}};var kn=1;var Sn,xn,Pn,Mn={nextValue:function(){return(kn=(9301*kn+49297)%233280)/233280},seed:function(t){kn=t}},En="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function jn(){Pn=!1}function On(t){if(t){if(t!==Sn){if(t.length!==En.length)throw new Error("Custom alphabet for shortid must be "+En.length+" unique characters. You submitted "+t.length+" characters: "+t);var e=t.split("").filter((function(t,e,n){return e!==n.lastIndexOf(t)}));if(e.length)throw new Error("Custom alphabet for shortid must be "+En.length+" unique characters. These characters were not unique: "+e.join(", "));Sn=t,jn()}}else Sn!==En&&(Sn=En,jn())}function Wn(){return Pn||(Pn=function(){Sn||On(En);for(var t,e=Sn.split(""),n=[],i=Mn.nextValue();e.length>0;)i=Mn.nextValue(),t=Math.floor(i*e.length),n.push(e.splice(t,1)[0]);return n.join("")}())}var Rn={characters:function(t){return On(t),Sn},seed:function(t){Mn.seed(t),xn!==t&&(jn(),xn=t)},lookup:function(t){return Wn()[t]},shuffled:Wn},Fn="object"==typeof window&&(window.crypto||window.msCrypto);var Nn=function(){if(!Fn||!Fn.getRandomValues)return 48&Math.floor(256*Math.random());var t=new Uint8Array(1);return Fn.getRandomValues(t),48&t[0]};var Ln=function(t,e){for(var n,i=0,r="";!n;)r+=t(e>>4*i&15|Nn()),n=e<Math.pow(16,i+1),i++;return r};var Dn,Gn,Bn=function(t){var e=Rn.shuffled();return{version:15&e.indexOf(t.substr(0,1)),worker:15&e.indexOf(t.substr(1,1))}};var Hn=function(t){var e="",n=Math.floor(.001*(Date.now()-1459707606518));return n===Gn?Dn++:(Dn=0,Gn=n),e+=Ln(Rn.lookup,6),e+=Ln(Rn.lookup,t),Dn>0&&(e+=Ln(Rn.lookup,Dn)),e+=Ln(Rn.lookup,n)};var qn=function(t){if(!t||"string"!=typeof t||t.length<6)return!1;for(var e=Rn.characters(),n=t.length,i=0;i<n;i++)if(-1===e.indexOf(t[i]))return!1;return!0},Un=function(t,e){return t(e={exports:{}},e.exports),e.exports}((function(t){var e=0;function n(){return Hn(e)}t.exports=n,t.exports.generate=n,t.exports.seed=function(e){return Rn.seed(e),t.exports},t.exports.worker=function(n){return e=n,t.exports},t.exports.characters=function(t){return void 0!==t&&Rn.characters(t),Rn.shuffled()},t.exports.decode=Bn,t.exports.isValid=qn})),Vn=(Un.generate,Un.seed,Un.worker,Un.characters,Un.decode,Un.isValid,Un),zn=new(function(){function t(){this._registry=hn(),this._finished=Promise.resolve()}return Object.defineProperty(t.prototype,"hostInstance",{get:function(){return this.agmTarget},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"finished",{get:function(){return this._finished},enumerable:!0,configurable:!0}),t.prototype.init=function(t,e){this.agm=t,this.agmTarget=e},t.prototype.handleEvent=function(t){this._registry.execute("event",t)},t.prototype.open=function(t){return i(this,void 0,void 0,(function(){var e,n,i,o;return r(this,(function(r){switch(r.label){case 0:this._finished=new Promise((function(t){e=t})),r.label=1;case 1:return r.trys.push([1,4,5,6]),[4,this.agm.invoke("T42.Wnd.Create",t,this.agmTarget)];case 2:if(void 0===(n=r.sent()).returned)throw new Error("failed to execute T42.Wnd.Create - unknown reason");return i=n.returned.id,[4,Cn.waitFor(i)];case 3:return o=r.sent(),setTimeout((function(){"electron"===o.API.windowType&&o.Events.handleUrlChanged(o.API.url)}),0),[2,o.API];case 4:throw r.sent();case 5:return e(),[7];case 6:return[2]}}))}))},t.prototype.close=function(t){return i(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.execute("close",{windowId:t.id},"Closed")];case 1:return e.sent(),[2,t]}}))}))},t.prototype.navigate=function(t,e){return i(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,this.execute("navigate",{windowId:t.id,options:{url:e}},"UrlChanged")];case 1:return n.sent(),[2,t]}}))}))},t.prototype.setStyle=function(t,e){var n;return i(this,void 0,void 0,(function(){var i,o,s,a,c,u,d,p,h,l,f,g,y;return r(this,(function(r){switch(r.label){case 0:return i=[],o=function(t){return i.push(t)},we(e.focus)||t.isFocused||o(t.focus()),we(e.hidden)||(s=!e.hidden,o(t.setVisible(s))),we(e.onTop)||o(t.setOnTop(e.onTop)),be(e.tabTooltip)&&be(e.tabToolTip)||(n=e.tabTooltip,a=null!=n?n:e.tabToolTip,o(t.setTabTooltip(a))),be(e.tabTitle)||o(this.execute("setTabTitle",{windowId:t.id,options:{tabTitle:e.tabTitle}})),c=e.maxWidth,u=e.maxHeight,d=e.minWidth,p=e.minHeight,h=e.allowClose,l=e.allowCollapse,f=e.allowLockUnlock,g=e.allowMaximize,y=e.allowMinimize,o(t.setSizeConstraints({maxWidth:c,maxHeight:u,minWidth:d,minHeight:p})),o(t.resetButtons({allowClose:h,allowCollapse:l,allowLockUnlock:f,allowMaximize:g,allowMinimize:y})),[4,Promise.all(i)];case 1:return r.sent(),[2,t]}}))}))},t.prototype.setSizeConstraints=function(t,e){return i(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,this.execute("setSizeConstraints",{windowId:t.id,options:e})];case 1:return n.sent(),[2,t]}}))}))},t.prototype.setTabTooltip=function(t,e){return i(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,this.execute("setTabTooltip",{windowId:t.id,options:{tabTooltip:e}})];case 1:return n.sent(),[2,t]}}))}))},t.prototype.resetButtons=function(t,e){return i(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,this.execute("resetButtons",{windowId:t.id,options:e})];case 1:return n.sent(),[2,t]}}))}))},t.prototype.setOnTop=function(t,e){return i(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,this.execute("setOnTop",{windowId:t.id,options:{onTop:e}})];case 1:return n.sent(),[2,t]}}))}))},t.prototype.setTitle=function(t,e){return i(this,void 0,void 0,(function(){var n;return r(this,(function(i){switch(i.label){case 0:return n={windowId:t.id,options:{title:e}},[4,this.execute("setTitle",n,"TitleChanged")];case 1:return i.sent(),[2,t]}}))}))},t.prototype.setSticky=function(t,e){return i(this,void 0,void 0,(function(){var n;return r(this,(function(i){switch(i.label){case 0:return n={windowId:t.id,options:{isSticky:e}},[4,this.execute("setSticky",n)];case 1:return i.sent(),[2,t]}}))}))},t.prototype.moveResize=function(t,e){return i(this,void 0,void 0,(function(){var n=this;return r(this,(function(o){switch(o.label){case 0:return window.glueDesktop.versionNum<31200?[2,new Promise((function(o,s){return i(n,void 0,void 0,(function(){var n,i,a,c,u,d,p=this;return r(this,(function(r){switch(r.label){case 0:n=this.areBoundsEqual(e,t),i=!1,a=function(){i||(i=!0,u&&(u(),u=void 0),o(t),c&&(clearTimeout(c),c=void 0))},n||(u=t.onBoundsChanged((function(t){p.areBoundsEqual(e,t)&&a()}))),r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.execute("moveResize",{windowId:t.id,options:{bounds:e}})];case 2:return r.sent(),[3,4];case 3:return d=r.sent(),s(d),[2];case 4:return n?(a(),[2]):(c=setTimeout((function(){a()}),1e3),[2])}}))}))}))]:[3,1];case 1:return[4,this.execute("moveResize",{windowId:t.id,options:{bounds:e}})];case 2:o.sent(),o.label=3;case 3:return[2,t]}}))}))},t.prototype.addFrameButton=function(t,e){return i(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,this.execute("addButton",{windowId:t.id,options:e},"ButtonAdded")];case 1:return n.sent(),[2,t]}}))}))},t.prototype.removeFrameButton=function(t,e){return i(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,this.execute("removeButton",{windowId:t.id,options:e},"ButtonRemoved")];case 1:return n.sent(),[2,t]}}))}))},t.prototype.activate=function(t){return i(this,void 0,void 0,(function(){var e,n;return r(this,(function(i){switch(i.label){case 0:return i.trys.push([0,2,3,4]),n=new Promise((function(n,i){e=t.onFocusChanged((function(){n()}))})),[4,Promise.all([this.execute("activate",{windowId:t.id},"FocusChanged"),n])];case 1:return i.sent(),[2,t];case 2:throw i.sent();case 3:return e&&e(),[7];case 4:return[2]}}))}))},t.prototype.focus=function(t){return i(this,void 0,void 0,(function(){var e,n;return r(this,(function(i){switch(i.label){case 0:return i.trys.push([0,2,3,4]),n=new Promise((function(n,i){e=t.onFocusChanged((function(){n()}))})),[4,Promise.all([this.execute("focus",{windowId:t.id},"FocusChanged"),n])];case 1:return i.sent(),[2,t];case 2:throw i.sent();case 3:return e&&e(),[7];case 4:return[2]}}))}))},t.prototype.maximizeRestore=function(t){return i(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.execute("maximizeRestore",{windowId:t.id},"StateChanged")];case 1:return e.sent(),[2,t]}}))}))},t.prototype.maximize=function(t){return i(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.execute("maximize",{windowId:t.id},"StateChanged")];case 1:return e.sent(),[2,t]}}))}))},t.prototype.restore=function(t){return i(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.execute("restore",{windowId:t.id},"StateChanged")];case 1:return e.sent(),[2,t]}}))}))},t.prototype.minimize=function(t){return i(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.execute("minimize",{windowId:t.id},"StateChanged")];case 1:return e.sent(),[2,t]}}))}))},t.prototype.collapse=function(t){return i(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.execute("collapse",{windowId:t.id},"StateChanged")];case 1:return e.sent(),[2,t]}}))}))},t.prototype.expand=function(t){return i(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.execute("expand",{windowId:t.id},"StateChanged")];case 1:return e.sent(),[2,t]}}))}))},t.prototype.toggleCollapse=function(t){return i(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.execute("toggleCollapse",{windowId:t.id},"StateChanged")];case 1:return e.sent(),[2,t]}}))}))},t.prototype.snap=function(t,e,n){return i(this,void 0,void 0,(function(){var i;return r(this,(function(r){switch(r.label){case 0:return i={targetWindowId:e.id},n&&(i.snappingEdge=n),[4,this.execute("snap",{windowId:t.id,options:i},"CompositionChanged","CompositionChanged-"+e.id)];case 1:return r.sent(),[2,t]}}))}))},t.prototype.attachTab=function(t,e,n){return i(this,void 0,void 0,(function(){return r(this,(function(i){switch(i.label){case 0:return[4,this.execute("attachTab",{windowId:t.id,options:{index:n,sourceWindowId:e.id,targetWindowId:t.id}},"WindowFrameAdded-"+e.id,"WindowFrameRemoved-"+e.id)];case 1:return i.sent(),[2,t]}}))}))},t.prototype.detachTab=function(t,e){var n;return i(this,void 0,void 0,(function(){var i;return r(this,(function(r){switch(r.label){case 0:return i=["WindowFrameRemoved","WindowFrameAdded"],we(null===(n=e)||void 0===n?void 0:n.relativeTo)?i.push("BoundsChanged"):(i.push("CompositionChanged"),i.push("CompositionChanged-"+e.relativeTo)),[4,this.execute.apply(this,o(["detachTab",{windowId:t.id,options:e}],i))];case 1:return r.sent(),[2,t]}}))}))},t.prototype.setVisible=function(t,e){return void 0===e&&(e=!0),i(this,void 0,void 0,(function(){var n;return r(this,(function(i){switch(i.label){case 0:return n=e?"show":"hide",[4,this.execute(n,{windowId:t.id},"VisibilityChanged")];case 1:return i.sent(),[2,t]}}))}))},t.prototype.showLoader=function(t,e){return i(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,this.execute("showLoadingAnimation",{windowId:t.id,options:e})];case 1:return n.sent(),[2,t]}}))}))},t.prototype.hideLoader=function(t){return i(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.execute("hideLoadingAnimation",{windowId:t.id})];case 1:return e.sent(),[2,t]}}))}))},t.prototype.updateContext=function(t,e){return i(this,void 0,void 0,(function(){var n,i,o;return r(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,3,4]),i=this.swapUndefinedToNull(e),o=new Promise((function(e,i){n=t.onContextUpdated((function(){e()}))})),[4,Promise.all([this.execute("updateContext",{windowId:t.id,context:i,replace:!(Object.keys(t.context).length>0)}),o])];case 1:return r.sent(),[2,t];case 2:throw r.sent();case 3:return n&&n(),[7];case 4:return[2]}}))}))},t.prototype.lock=function(t){return i(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.execute("lockUnlock",{windowId:t.id,options:{lock:!0}},"FrameIsLockedChanged")];case 1:return e.sent(),[2,t]}}))}))},t.prototype.unlock=function(t){return i(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.execute("lockUnlock",{windowId:t.id,options:{lock:!1}},"FrameIsLockedChanged")];case 1:return e.sent(),[2,t]}}))}))},t.prototype.getIcon=function(t){return i(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.execute("getIcon",{windowId:t.id,options:{}})];case 1:return[2,e.sent().icon]}}))}))},t.prototype.setIcon=function(t,e){return i(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,this.execute("setIcon",{windowId:t.id,options:{dataURL:e}})];case 1:return n.sent(),[2,t]}}))}))},t.prototype.setFrameColor=function(t,e){return i(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,this.execute("setFrameColor",{windowId:t.id,options:{frameColor:e}},"FrameColorChanged")];case 1:return n.sent(),[2,t]}}))}))},t.prototype.setTabHeaderVisible=function(t,e){return i(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,this.execute("setTabHeaderVisible",{windowId:t.id,options:{toShow:e}},"TabHeaderVisibilityChanged")];case 1:return n.sent(),[2,t]}}))}))},t.prototype.showPopup=function(t,e){return i(this,void 0,void 0,(function(){var i,o;return r(this,(function(r){switch(r.label){case 0:if(!e)throw new Error("The options object is not valid!");return(i=n({},e)).targetLocation||(i.targetLocation="bottom"),o=n(n({},i),{popupBounds:i.size,targetId:t.id,popupId:i.windowId}),[4,this.execute("showPopupWindow",{windowId:t.id,options:o})];case 1:return r.sent(),[2,t]}}))}))},t.prototype.createFlydown=function(t,e){return i(this,void 0,void 0,(function(){var o,s,a=this;return r(this,(function(c){if(!e)throw new Error("The options object is not valid!");return(o=n({},e)).horizontalOffset||(o.horizontalOffset=0),o.verticalOffset||(o.verticalOffset=0),s=this.reformatFlydownOptions(t,o),[2,this.execute("setFlydownArea",{windowId:t,options:s}).then((function(){var t=s.zones.map((function(t){return t.id}));return s.zones.forEach((function(t){var n="function"==typeof t.flydownSize?t.flydownSize:function(){return t.flydownSize};e.size instanceof Function&&t.flydownSize&&(n=function(n,o){return i(a,void 0,void 0,(function(){var i;return r(this,(function(r){switch(r.label){case 0:return e.size instanceof Function?[4,e.size(n,o)]:[3,2];case 1:i=r.sent(),r.label=2;case 2:return t.flydownSize instanceof Function&&t.flydownSize!==e.size?[4,t.flydownSize(n,o)]:[3,4];case 3:return[2,r.sent()||i];case 4:return[2,i||t.flydownSize]}}))}))}),a._registry.clearKey(s.targetId+"_"+t.id),a._registry.add(s.targetId+"_"+t.id,n)})),{destroy:function(){return a.clearFlydownArea(s.targetId,t)},options:o}}))]}))}))},t.prototype.setModalState=function(t,e){return i(this,void 0,void 0,(function(){return r(this,(function(n){return[2,this.execute("setModalState",{windowId:t,options:{isModal:e}})]}))}))},t.prototype.handleFlydownBoundsRequested=function(t,e){return i(this,void 0,void 0,(function(){var i,o,s,a,c;return r(this,(function(r){switch(r.label){case 0:return i=function(){return e.cancel=!0},o={zoneId:e.flydownId,flydownWindowBounds:e.flydownWindowBounds,flydownWindowId:e.flydownWindowId},[4,Promise.all(this._registry.execute(t+"_"+e.flydownId,o,i))];case 1:return 1===(s=r.sent()).length?(a={height:0,width:0,top:0,left:0},c="object"!=typeof s[0]||Array.isArray(s[0])?a:s[0],[2,n(n({},e),{flydownWindowBounds:c})]):[2]}}))}))},t.prototype.zoomIn=function(t){return i(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.execute("zoomIn",{windowId:t.id})];case 1:return e.sent(),[2,t]}}))}))},t.prototype.zoomOut=function(t){return i(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.execute("zoomOut",{windowId:t.id})];case 1:return e.sent(),[2,t]}}))}))},t.prototype.setZoomFactor=function(t,e){return i(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,this.execute("setZoomFactor",{windowId:t.id,options:{zoomFactor:e}})];case 1:return n.sent(),[2,t]}}))}))},t.prototype.showDevTools=function(t){return i(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.execute("showDevTools",{windowId:t.id})];case 1:return e.sent(),[2,t]}}))}))},t.prototype.capture=function(t,e){return i(this,void 0,void 0,(function(){return r(this,(function(i){switch(i.label){case 0:return[4,this.execute("captureScreenshot",{windowId:t.id,options:n({},e)})];case 1:return[2,i.sent().data]}}))}))},t.prototype.captureGroup=function(t,e){return i(this,void 0,void 0,(function(){return r(this,(function(i){switch(i.label){case 0:return[4,this.execute("captureGroupScreenshot",{windowId:t[0],options:n({groupWindowIds:t},e)})];case 1:return[2,i.sent().data]}}))}))},t.prototype.flash=function(t,e){return i(this,void 0,void 0,(function(){return r(this,(function(i){switch(i.label){case 0:return[4,this.execute("flash",{windowId:t.id,options:n({},e)})];case 1:return i.sent(),[2,t]}}))}))},t.prototype.configure=function(t,e){return i(this,void 0,void 0,(function(){return r(this,(function(i){return[2,this.execute("configure",{windowId:t,options:n({},e)})]}))}))},t.prototype.print=function(t,e){return i(this,void 0,void 0,(function(){return r(this,(function(i){switch(i.label){case 0:return[4,this.execute("print",{windowId:t.id,options:n({},e)})];case 1:return i.sent(),[2,t]}}))}))},t.prototype.printToPDF=function(t,e){return i(this,void 0,void 0,(function(){return r(this,(function(i){switch(i.label){case 0:return[4,this.execute("printToPDF",{windowId:t.id,options:n({},e)})];case 1:return[2,i.sent().filePath]}}))}))},t.prototype.place=function(t,e){return i(this,void 0,void 0,(function(){var i,o;return r(this,(function(r){switch(r.label){case 0:return i=n({},e),e.display&&"current"!==e.display?[3,2]:(o=i,[4,t.getDisplay()]);case 1:o.display=r.sent(),r.label=2;case 2:return i.display=i.display.index+1,[2,this.execute("place",{windowId:t.id,options:n({},i)})]}}))}))},t.prototype.refresh=function(t,e){return i(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,this.execute("refresh",{windowId:t.id,options:{ignoreCache:e}})];case 1:return n.sent(),[2,t]}}))}))},t.prototype.configureWindow=function(t,e){return i(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,this.execute("configureWindow",{windowId:t.id,options:e})];case 1:return n.sent(),[2,t]}}))}))},t.prototype.execute=function(t,e){for(var s=[],a=2;a<arguments.length;a++)s[a-2]=arguments[a];return i(this,void 0,void 0,(function(){var i,a;return r(this,(function(r){switch(r.label){case 0:i=n(n({},e),{command:t}),this._finished=new Promise((function(t){a=t})),r.label=1;case 1:return r.trys.push([1,6,7,8]),window.glueDesktop.versionNum<31200?[4,this.executeWithoutToken.apply(this,o([i],s))]:[3,3];case 2:return[2,r.sent()];case 3:return[4,this.executeWithToken(i)];case 4:return[2,r.sent()];case 5:return[3,8];case 6:throw r.sent();case 7:return a(),[7];case 8:return[2]}}))}))},t.prototype.ungroup=function(t,e){return i(this,void 0,void 0,(function(){var n;return r(this,(function(i){switch(i.label){case 0:return n={windowId:t.id,options:e},[4,this.execute("ungroup",n)];case 1:return i.sent(),[2,t]}}))}))},t.prototype.onClosing=function(t,e){var n="undefined"!=typeof window&&window.glue42gd;if(n)return n.addCloseHandler(t,e)},t.prototype.onRefreshing=function(t,e){var n="undefined"!=typeof window&&window.glue42gd;if(n)return n.addRefreshHandler(t,e)},t.prototype.reformatFlydownOptions=function(t,e){var i=function(t,n){if(e[n]&&(void 0===t[n]||null===t[n])){var i=e[n];t[n]=i}},r=e.zones.map((function(t){return i(t,"windowId"),i(t,"targetLocation"),!e.size||void 0!==t.flydownSize&&null!==t.flydownSize||(t.flydownSize=e.size),t.flydownBounds=t.flydownSize,t.flydownId=t.windowId,t.targetLocation||(t.targetLocation="bottom"),t}));return n(n({},e),{zones:r,targetId:t,flydownBounds:e.size,flydownActiveArea:e.activeArea})},t.prototype.clearFlydownArea=function(t,e){var n=this;return this.execute("clearFlydownWindowArea",{windowId:t,options:{}}).then((function(){e.forEach((function(e){n._registry.clearKey(t+"_"+e)}))}))},t.prototype.executeWithoutToken=function(t){for(var e,n=this,i=[],r=1;r<arguments.length;r++)i[r-1]=arguments[r];var s=[],a=null===(e=i)||void 0===e?void 0:e.filter((function(t){return!we(t)})).map((function(e){return new Promise((function(i){var r=e.split("-"),o=r[0],a=r[1],c=void 0===a?t.windowId:a;s.push(n._registry.add("event",(function(t){t.type===o&&t.windowId===c&&i()})))}))})),c=new Promise((function(e,i){n.agm.invoke("T42.Wnd.Execute",t,n.agmTarget).then((function(t){t.returned&&t.returned.errorMsg?i(t):e(t.returned)})).catch((function(t){return i(t)}))}));return Promise.all(o([c],a)).then((function(t){return t[0]})).finally((function(){s.forEach((function(t){return t()}))}))},t.prototype.executeWithToken=function(t){return i(this,void 0,void 0,(function(){var e,n,i,o,s=this;return r(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,3,4]),n=Vn.generate(),i=new Promise((function(t){e=s._registry.add("event",(function(e){e.token===n&&t()}))})),o=new Promise((function(e,i){t.token=n,s.agm.invoke("T42.Wnd.Execute",t,s.agmTarget).then((function(t){t.returned&&t.returned.errorMsg?i(t):e(t.returned)})).catch((function(t){i(t)}))})),[4,Promise.all([o,i])];case 1:return[2,r.sent()[0]];case 2:throw r.sent();case 3:return e&&e(),[7];case 4:return[2]}}))}))},t.prototype.areBoundsEqual=function(t,e){var n=e.bounds,i=e.settings,r=t.height,o=t.width;t.height<i.minHeight&&(r=i.minHeight),t.height>i.maxHeight&&(r=i.maxHeight),t.width<i.minWidth&&(o=i.minWidth),t.width>i.maxWidth&&(o=i.maxWidth);var s=!r||n.height===r,a=!o||n.width===o,c=!t.left||n.left===t.left,u=!t.top||n.top===t.top;return s&&a&&c&&u},t.prototype.swapUndefinedToNull=function(t){try{for(var e={},n=0,i=Object.keys(t);n<i.length;n++){var r=i[n],o=t[r];void 0===o&&(o=null),e[r]=o}return e}catch(e){return t}},t}());function Jn(t,e){var n=Cn.list;return Object.keys(n).reduce((function(i,r){var o=n[r];return o.API.tabGroupId===e&&o.API.id!==t&&i.push(o),i}),[])}var Kn=function(){function t(t,e,n,i,r,o){this._registry=hn(),this._waitTimeout=1e4,this._agm=t,this._logger=e.subLogger("gd-env"),this._agmInstance=this.normalizeInstance(r),this._windowId=o,this._appManagerGetter=n,this._displayAPIGetter=i}return t.prototype.init=function(){var t=this;return new Promise((function(e,n){void 0===t._agmInstance&&(t._agmInstance="best"),t._agm.registerAsync("T42.Wnd.OnEventWithResponse",(function(e,n,i,r){t.respondToEvent(e).then(i).catch(r)}));new Promise((function(i,r){t._agm.subscribe("T42.Wnd.OnEvent",{waitTimeoutMs:t._waitTimeout,target:t._agmInstance,onData:function(n){t.updateWindow(n.data,e),zn.handleEvent(n.data)},onConnected:function(e){t._agmInstance=t.normalizeInstance(e),zn.init(t._agm,t._agmInstance)}}).catch((function(t){n("Can not subscribe for stream T42.Wnd.OnEvent. Err: "+t)}))}))}))},Object.defineProperty(t.prototype,"executor",{get:function(){return zn},enumerable:!0,configurable:!0}),t.prototype.open=function(t,e,i){var r=n({},i=i||{});return void 0!==r.relativeTo&&"string"!=typeof r.relativeTo&&(r.relativeTo=r.relativeTo.id||""),r.name=t,r.url=e,r.windowState=i.windowState||i.state,delete r.state,this.executor.open(r)},t.prototype.createFlydown=function(t,e){return this.executor.createFlydown(t,e)},t.prototype.showPopup=function(t,e){return i(this,void 0,void 0,(function(){var n;return r(this,(function(i){switch(i.label){case 0:return n=Cn.get(t),[4,this.executor.showPopup(n.API,e)];case 1:return i.sent(),[2]}}))}))},t.prototype.tabAttached=function(t){return this._registry.add("tab-attached",t)},t.prototype.tabDetached=function(t){return this._registry.add("tab-detached",t)},t.prototype.onWindowFrameColorChanged=function(t){return this._registry.add("frame-color-changed",t)},t.prototype.onEvent=function(t){return this._registry.add("window-event",t)},t.prototype.my=function(){return this._windowId},t.prototype.execute=function(t,e,n){return this._agm.invoke("T42.Wnd.Execute",{command:t,options:n,windowId:e})},t.prototype.onCompositionChanged=function(t){return this._registry.add("composition-changed",t)},t.prototype.onGroupHeaderVisibilityChanged=function(t){return this._registry.add("group-header-changed",t)},t.prototype.onWindowGotFocus=function(t){return this._registry.add("got-focus",t)},t.prototype.onWindowLostFocus=function(t){return this._registry.add("lost-focus",t)},t.prototype.normalizeInstance=function(t){if(t)return{application:t.application,machine:t.machine,user:t.user}},t.prototype.respondToEvent=function(t){return"ShowFlydownBoundsRequested"===t.type?this.executor.handleFlydownBoundsRequested(t.data.windowId,t.data):Promise.reject("There isn't a handler for "+t.type)},t.prototype.updateWindow=function(t,e){var n=this,o=this.getExtendedStreamEvent(t);if("Snapshot"===t.type)return t.windows.forEach((function(t){var e=Cn.get(t.id);if(e)e.Events.handleUpdate(n.mapToWindowConstructorOptions(t));else{var i=n.createWindow(t.id,t);Cn.markReadyToShow(i.API.id)}n._registry.execute("window-event",o)})),void e(this);if("CommandExecuted"!==t.type){if("Created"===t.type){var s=t,a=this.createWindow(s.windowId,s.data||{});return Cn.setReadyState(a.API.id),void this._registry.execute("window-event",o)}var c=Cn.get(t.windowId);if(c){var u=c.API,d=c.Events;if("BoundsChanged"===t.type){var p=t;d.handleBoundsChanged(p.data)}if("UrlChanged"===t.type){var h=t;Cn.setUrlChangedState(h.windowId),d.handleUrlChanged(h.data)}if("TitleChanged"===t.type){var l=t;d.handleTitleChanged(l.data)}if("IsStickyChanged"===t.type){var f=t;d.handleIsStickyChanged(f.data)}if("VisibilityChanged"===t.type&&d.handleVisibilityChanged(t.data),"ContextChanged"===t.type&&d.handleContextUpdated(t.data),"StateChanged"===t.type&&d.handleWindowChangeState(t.data),"FrameColorChanged"===t.type&&(d.handleFrameColorChanged(t.data),this._registry.execute("frame-color-changed",u)),"CompositionChanged"===t.type){var g=t;d.handleCompositionChanged(g.data),this._registry.execute("composition-changed",g.data)}if("GroupHeaderVisibilityChanged"===t.type){var y=t;d.handleGroupHeaderVisibilityChanged(y.data.groupHeaderVisible),this._registry.execute("group-header-changed",y.data)}if("FocusChanged"===t.type){var v=t;this.focusChanged(d,u,v.data)}if("WindowFrameChanged"===t.type&&(d.handleFrameAttached(t.data.frameId,t.data.isTabHeaderVisible),this._registry.execute("frame-changed")),"WindowFrameAdded"===t.type){var m=Jn(u.id,t.data.frameId);d.handleAttached(t.data.frameId,t.data.isTabHeaderVisible,m).then((function(){return i(n,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return m.length>0?[4,zn.finished]:[3,2];case 1:e.sent(),this._registry.execute("tab-attached",u,t.data.frameId,t.data.isTabHeaderVisible),e.label=2;case 2:return[2]}}))}))}))}if("WindowFrameRemoved"===t.type){var w=u.tabGroupId,b=Jn(u.id,w);d.handleDetached(b).then((function(){return i(n,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return b.length>0?[4,zn.finished]:[3,2];case 1:e.sent(),this._registry.execute("tab-detached",u,t.data.frameId,u.tabGroupId),e.label=2;case 2:return[2]}}))}))}))}"TabHeaderVisibilityChanged"===t.type&&d.handleTabHeaderVisibilityChanged(t.data.isTabHeaderVisible),"FrameSelectionChanged"===t.type&&d.handleFrameSelectionChanged(t.data.newWindowId,t.data.prevWindowId),"ButtonClicked"===t.type&&d.handleFrameButtonClicked(t.data),"ButtonAdded"===t.type&&d.handleFrameButtonAdded(t.data),"ButtonRemoved"===t.type&&d.handleFrameButtonRemoved(t.data),"WindowZoomFactorChanged"===t.type&&d.handleZoomFactorChanged(t.data),"Closed"===t.type&&(Cn.remove(c),d.handleWindowClose()),"FrameIsLockedChanged"===t.type&&d.handleFrameIsLockedChanged(t.data),"PlacementSettingsChanged"===t.type&&d.handlePlacementSettingsChanged(t.data),this._registry.execute("window-event",o)}else this._logger.error("received update for unknown window. Stream:', "+JSON.stringify(t,null,4))}else this._registry.execute("window-event",o)},t.prototype.createWindow=function(t,e){Cn.get(t);var n=Tn(t,this.mapToWindowConstructorOptions(e),zn,this._logger,this._appManagerGetter,this._displayAPIGetter,this._agm);return Cn.add(n),n},t.prototype.focusChanged=function(t,e,n){t.handleFocusChanged(n),n?this._registry.execute("got-focus",e):this._registry.execute("lost-focus",e)},t.prototype.mapToWindowConstructorOptions=function(t){return{name:t.name,context:t.context,bounds:t.bounds,url:t.url,title:t.title,isVisible:t.isVisible,focus:t.isFocused,state:t.state,frameColor:t.frameColor,groupId:t.groupId,neighbours:t.neighbors,isFocused:t.isFocused,isGroupHeaderVisible:t.groupHeaderVisible,isCollapsed:t.isCollapsed,tabGroupId:t.frameId,mode:t.mode,isTabHeaderVisible:t.isTabHeaderVisible,isTabSelected:t.isActiveTab,settings:t.settings,windowType:t.windowType,zoomFactor:t.zoomFactor,isLocked:t.isLocked,placementSettings:t.placementSettings,isSticky:t.isSticky,tabIndex:t.tabIndex}},t.prototype.getExtendedStreamEvent=function(t){try{if(!t.windowId)return t;var e=Cn.get(t.windowId);if(!e)return t;var i=n({state:t.type,windowName:e.API.name},t);return"WindowFrameAdded"===i.state&&(i.state="TabAttached"),"StateChanged"===i.state&&(i.state=i.data.charAt(0).toUpperCase()+i.data.slice(1)),"ButtonAdded"===i.state&&(i.state="FrameButtonAdded"),"ButtonRemoved"===i.state&&(i.state="FrameButtonRemoved"),i}catch(e){return t}},t}(),Zn=function(t,e){var n=hn(),s=[];function a(t,n){for(var s=[],a=2;a<arguments.length;a++)s[a-2]=arguments[a];return i(this,void 0,void 0,(function(){return r(this,(function(i){switch(i.label){case 0:return[4,e.execute.apply(e,o([t,n],s))];case 1:return i.sent(),[2,d]}}))}))}function c(){var t=[];return s.forEach((function(e){var n=u(e);void 0!==n&&t.push(n)})),t}function u(t){return Cn.get(t)?Cn.get(t).API:void 0}var d={id:t,get windows(){return e=c(),"function"==typeof t&&t(e),e;var t,e},find:function(t,e,n){var i;"string"==typeof t?i=t:we(t)||(i=t.id);var r=u(i);if(r)return"function"==typeof e&&e(r),r;"function"==typeof n&&n("No window with ID: "+i)},get isHeaderVisible(){return void 0===c().find((function(t){return!t.isGroupHeaderVisible}))},showHeader:function(t,e){return An.callbackifyPromise((function(){return a.apply(void 0,o(["setGroupHeaderVisibility",{windowId:s[0],options:{toShow:!0}}],s.map((function(t){return"GroupHeaderVisibilityChanged-"+t}))))}),t,e)},hideHeader:function(t,e){return An.callbackifyPromise((function(){return a.apply(void 0,o(["setGroupHeaderVisibility",{windowId:s[0],options:{toShow:!1}}],s.map((function(t){return"GroupHeaderVisibilityChanged-"+t}))))}),t,e)},getTitle:function(){return i(void 0,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,e.execute("getGroupTitle",{windowId:s[0]})];case 1:return[2,t.sent().title]}}))}))},setTitle:function(t){return i(void 0,void 0,void 0,(function(){return r(this,(function(e){if(be(t))throw new Error("`title` must not be null or undefined.");return[2,a("setGroupTitle",{windowId:s[0],options:{title:t}})]}))}))},capture:function(t){return e.captureGroup(s,t)},maximize:function(t,e){return An.callbackifyPromise((function(){return a.apply(void 0,o(["maximizeGroup",{windowId:s[0]}],s.map((function(t){return"StateChanged-"+t}))))}),t,e)},restore:function(t,e){return An.callbackifyPromise((function(){return a.apply(void 0,o(["restoreGroup",{windowId:s[0]}],s.map((function(t){return"StateChanged-"+t}))))}),t,e)},onHeaderVisibilityChanged:function(t){return n.add("header-visibility-changed",t)},onWindowAdded:function(t){return n.add("window-added",t)},onWindowRemoved:function(t){return n.add("window-removed",t)}};return{groupAPI:d,groupInternal:{get windows(){return s},addWindow:function(t){return i(this,void 0,void 0,(function(){var i;return r(this,(function(r){switch(r.label){case 0:return-1!==s.indexOf(t)?[3,2]:(s.push(t),(i=Cn.get(t)).Events.handleGroupChanged(d,void 0),[4,e.finished]);case 1:r.sent(),n.execute("window-added",d,i.API),r.label=2;case 2:return[2]}}))}))},removeWindow:function(t){return i(this,void 0,void 0,(function(){var i;return r(this,(function(r){switch(r.label){case 0:return-1===(i=s.indexOf(t.API.id))?[3,2]:(s.splice(i,1),t.Events.handleGroupChanged(void 0,d),[4,e.finished]);case 1:r.sent(),n.execute("window-removed",d,t.API),r.label=2;case 2:return[2]}}))}))},handleGroupHeaderVisibilityChanged:function(t){n.execute("header-visibility-changed",d)}}}},Yn=function(t,e){var n=hn(),i={},r=-1,o=Cn.list;function s(t,e,n){var r;"string"==typeof t?r=t:we(t)||(r=t.id);var o=Object.values(i).find((function(t){return t.groupAPI.windows.filter((function(t){return t.id===r})).length}));if(o)return"function"==typeof e&&e(o.groupAPI),o.groupAPI;"function"==typeof n&&n("Cannot find the group of the window.")}function a(e,n){var r=function(e){if(i.hasOwnProperty(e))return i[e];var n=Zn(e,t.executor);return i[e]=n,n}(e);return r.groupInternal.addWindow(n),r}function c(t,e){t&&(t.groupInternal.removeWindow(e),function(t){0===t.groupAPI.windows.length&&delete i[t.groupAPI.id]}(t))}function u(t){var e;return"string"==typeof t?e=t:we(t)||(e=t.id),Object.values(i).find((function(t){return t.groupInternal.windows.filter((function(t){return t===e})).length}))}return Object.keys(o).forEach((function(t){var e=o[t],n=e.API.groupId,i=e.API.id;be(n)||a(n,i)})),Cn.onRemoved((function(t){c(u(t.API),t)})),t.onCompositionChanged((function(t){!function(t){var e=t.groupId,r=t.windowId,o=Cn.get(r);if(!o)return;var s=u(o.API);if(we(e))return void c(s,o);if(we(s)&&!we(e))return void a(e,o.API.id);s.groupAPI.id!==e&&function(t,e,r){var o=t.API.id,s=i[e];c(s,t);var u=a(r,o);t.Events.handleGroupChanged(u.groupAPI,s.groupAPI),n.execute("window-moved",o,e,r)}(o,s.groupAPI.id,e)}(t)})),t.onGroupHeaderVisibilityChanged((function(t){var e=s(t.windowId);if(void 0!==e){var n=i[e.id];-1===r&&(r=e.windows.length),0===--r&&(r=-1,n.groupInternal.handleGroupHeaderVisibilityChanged(t))}})),{groupsAPI:{get my(){return s(t.my())},list:function(t){var e=Object.keys(i).map((function(t){if(i[t])return i[t].groupAPI}));return"function"==typeof t&&t(e),e},findGroupByWindow:s},groupsEvents:{onWindowMoved:function(t){return n.add("window-moved",t)}}}},Xn=function(t,e,n,i,r){var o,s,a=hn(),c=e;Cn.init(c);var u=new Promise((function(e,a){(function(t,e,n,i,r){var o=e;return new Promise((function(e,s){if(2===r)throw o.trace("running in HC"),new Error("GD2 not supported");if(r>=3)o.trace("running in GD 3"),new Kn(t,o,n,i,void 0,window.glue42gd.windowId).init().then(e).catch(s);else{var a=new Kn(t,o,n,i).init();Promise.race([a,(c=1e4,new Promise((function(t,e){return setTimeout((function(){e("timeout waiting for streams")}),c)})))]).then(e).catch(s)}var c}))})(t,c,n,i,r).then((function(t){s=t,o=Yn(t),e()})).catch((function(t){var e="Environment detector fails with: "+t;c.error(e),a(e)}))}));function d(){var t=Cn.getIfReady(s.my());return t?t.API:void 0}function p(t){return a.add("window-added",t)}function h(t){return a.add("window-removed",t)}return Cn.onReadyWindow((function(t){a.execute("window-added",t.API)})),Cn.onRemoved((function(t){a.execute("window-removed",t.API)})),{my:d,open:function(t,e,n,i,r){return An.callbackifyPromise((function(){if(be(t))throw new Error("The window name is missing.");if(be(e))throw new Error("The window URL is missing.");if(!we(n))for(var i=n,r=0,o=["minHeight","maxHeight","minWidth","maxWidth","width","height","top","left"];r<o.length;r++){var a=o[r];if(a in i){var c=i[a];if(we(c)){delete i[a];continue}if(!ge(c)){var u=a+" must be a number";throw new Error(u)}if(("width"===i[a]||"height"===i[a])&&c<=0){u=a+" must be a positive number";throw new Error(u)}}}return s.open(t,e,n)}),i,r)},find:function(t,e,n){var i=Cn.list,r=Object.keys(i).reduce((function(e,n){var r,o,s=i[n];return(null===(o=null===(r=s)||void 0===r?void 0:r.API)||void 0===o?void 0:o.name)===t&&e.push(s.API),e}),[]);if(r[0])return"function"==typeof e&&e(r[0]),r[0];"function"==typeof n&&n("There is no window with name:"+t)},findById:function(t,e,n){var i=Cn.list,r=Object.keys(i).reduce((function(e,n){var r=i[n];return void 0!==r&&r.API.id===t&&e.push(r.API),e}),[]);if(r[0])return"function"==typeof e&&e(r[0]),r[0];"function"==typeof n&&n("There is no window with such id:"+t)},list:function(t){var e=Cn.list,n=Object.keys(e).map((function(t){return e[t].API}));if("function"!=typeof t)return n;t(n)},ready:function(){return u},onWindowAdded:p,windowAdded:p,onWindowRemoved:h,windowRemoved:h,onTabAttached:function(t){var e,n=!1;return u.then((function(){n||(e=s.tabAttached(t))})),function(){n=!0,e&&e()}},onTabDetached:function(t){var e,n=!1;return u.then((function(){n||(e=s.tabDetached(t))})),function(){n=!0,e&&e()}},onWindowFrameColorChanged:function(t){var e,n=!1;return u.then((function(){n||(e=s.onWindowFrameColorChanged(t))})),function(){n=!0,e&&e()}},get groups(){return o.groupsAPI},onWindowGotFocus:function(t){var e,n=!1;return u.then((function(){n||(e=s.onWindowGotFocus(t))})),function(){n=!0,e&&e()}},onWindowLostFocus:function(t){var e,n=!1;return u.then((function(){n||(e=s.onWindowLostFocus(t))})),function(){n=!0,e&&e()}},onEvent:function(t){var e,n=!1;return u.then((function(){n||(e=s.onEvent(t))})),function(){n=!0,e&&e()}},createFlydown:function(t,e){return s.createFlydown(t,e)},showPopup:function(t,e){return s.showPopup(t,e)},configure:function(t){var e=d(),n=e?e.id:"";return zn.configure(n,t)}}},Qn=new(function(){function t(){this.layouts=[]}return t.prototype.removeWhere=function(t){this.layouts=this.layouts.filter(t)},t.prototype.add=function(t){this.layouts.push(t)},Object.defineProperty(t.prototype,"all",{get:function(){return this.layouts},enumerable:!0,configurable:!0}),t.prototype.where=function(t){return this.layouts.filter(t)},t.prototype.first=function(t){return this.where(t)[0]},t}()),$n=function(){function t(t,e,n,i){this.config=t,this.activitiesGetter=e,this.callbacks=n,this.logger=i,this.interop=t.agm,this.registerRequestMethods()}return t.prototype.onSaveRequested=function(t){return this.callbacks.add("saveRequested",t)},t.prototype.isActivityOwner=function(){if("undefined"!=typeof htmlContainer){var t=htmlContainer.getContext();return t&&t._t42&&t._t42.activityIsOwner}var e=this.activitiesGetter();if(!e)return!1;if(!e.inActivity)return!1;var n=e.my.window,i=e.my.activity;return!(!i&&!n)&&i.owner.id===n.id},t.prototype.registerRequestMethods=function(){var t=this;this.interop.register("T42.HC.GetSaveContext",(function(e){var n,i,r,o=t.callbacks.execute("saveRequested",e);(null===(n=o)||void 0===n?void 0:n.length)>1&&t.logger.warn('Multiple subscriptions for "glue.layouts.onSaveRequested" - only the first one will be used');var s=o[0],a=t.config.autoSaveWindowContext;if(a)return{autoSaveWindowContext:a};var c={windowContext:null===(i=s)||void 0===i?void 0:i.windowContext,activityContext:void 0};return t.isActivityOwner()&&(c.activityContext=null===(r=s)||void 0===r?void 0:r.activityContext),c}))},t}();function ti(t){if(!t)return t;if(Array.isArray(t))return t.map((function(t){return ti(t)}));if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return t;return Object.keys(t).reduce((function(e,n){var i=ti(t[n]),r=n;return n[0].toLowerCase()!==n[0]&&(r=n[0].toLowerCase()+n.substr(1)),e[r]=i,e}),{})}var ei=function(t){this.name=t.name,this.type=t.type,this.components=t.components,this.context=t.context,this.metadata=t.metadata,this.version=t.version,this.displays=t.displays},ni=function(){function t(t,e,n,i){this.config=t,this.stream=e,this.callbacks=n,this.appManager=t.appManager,this.onEvent=e.onEvent,this.provider=new $n(t,t.activityGetter,n,i),e.subscribe()}return t.prototype.setDefaultGlobal=function(t){return i(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.config.agm.invoke("T42.ACS.SelectDefaultLayout",{name:t})];case 1:return e.sent(),[2]}}))}))},t.prototype.clearDefaultGlobal=function(){return i(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,this.config.agm.invoke("T42.ACS.DeselectDefaultLayout")];case 1:return t.sent(),[2]}}))}))},t.prototype.getDefaultGlobal=function(){return i(this,void 0,void 0,(function(){var t,e;return r(this,(function(n){switch(n.label){case 0:return[4,this.config.agm.invoke("T42.ACS.GetDefaultLayout")];case 1:return t=n.sent(),(e=t.returned)?this.isSlimMode()?[2,e]:[2,this.list().find((function(t){return t.name===e.name&&"Global"===t.type}))]:[2,void 0]}}))}))},t.prototype.ready=function(){return"fullWaitSnapshot"===this.config.mode?this.stream.gotSnapshot:this.stream.ready},t.prototype.save=function(t){var e=this;return new Promise((function(n,i){if(e.verifyNotSlimMode(),!t.name)throw Error("layout.name argument is required");t.type||(t.type="Global"),t.activityId&&(t.type="Activity"),void 0===t.ignoreHidden&&(t.ignoreHidden=!0);var r={name:t.name,actIds:[],appIds:[],type:t.type,context:t.context,metadata:t.metadata||{},options:{ignoreLayoutRestrictions:!1}};if("Activity"===t.type){var o=t.activityId;if(!o){if(!e.appManager.myInstance.inActivity)throw new Error("Current application is not in activity. Can not save activity layout for it");o=e.appManager.myInstance.activityId}r.actIds.push(o),r.options={ignoreLayoutRestrictions:!0}}else{if("Global"!==t.type)throw new Error("layout type "+t.type+" not supported");if(2===e.config.gdMajorVersion){var s=e.appManager.instances();t.ignoreHidden&&(s=s.filter((function(t){return e.isVisibleWindow(t)}))),t.ignoreMyInstance&&e.appManager.myInstance&&(s=s.filter((function(t){return t.id!==e.appManager.myInstance.id}))),s.reduce((function(t,e){if(!e.id)return t;if(e.inActivity){var n=e.activityId;-1===t.actIds.indexOf(n)&&t.actIds.push(n)}else t.appIds.push(e.id);return t}),r)}else r.autoCollectApps=!0}e.invokeMethodAndTrack("T42.ACS.SaveLayout",r,n,i)}))},t.prototype.restore=function(t){var e=this;return new Promise((function(n,i){if(e.verifyNotSlimMode(),void 0===t)throw Error("options argument is required");if(!t.name)throw Error("options.name argument is required");t.type||(t.type="Global"),t.activityIdToJoin&&(t.type="Activity"),void 0===t.restoreActivityOwner&&(t.restoreActivityOwner=!1),void 0===t.ignoreActivityWindowTypes&&(t.ignoreActivityWindowTypes=[]),void 0===t.setActivityContext&&(t.setActivityContext=!0),void 0===t.closeRunningInstance&&("Global"===t.type?t.closeRunningInstance=!0:"Activity"===t.type&&(t.closeRunningInstance=!1)),void 0===t.reuseWindows&&(t.reuseWindows=!0),t.context=t.context||{};var r={restoreOptions:{activityToJoin:t.activityIdToJoin,setActivityContext:t.setActivityContext,ignoreActivityWindowTypes:t.ignoreActivityWindowTypes,restoreActivityOwner:t.restoreActivityOwner,closeOldWindows:t.closeRunningInstance,reuseExistingWindows:t.reuseWindows}},o={type:t.type,name:t.name,context:t.context,toClose:[],splash:t.splash};2===e.config.gdMajorVersion&&t.closeRunningInstance&&(o.toClose=e.getInstancesToClose(t)),t.timeout&&(o.timeout=t.timeout),o.context._t42=r,e.invokeMethodAndTrack("T42.ACS.RestoreLayout",o,n,i,!0)}))},t.prototype.remove=function(t,e){var n=this;return new Promise((function(i,r){if(n.verifyNotSlimMode(),!e)throw Error("name argument is required");if(!t)throw Error("type argument is required");var o={type:t,name:e};n.invokeMethodAndTrack("T42.ACS.RemoveLayout",o,i,r)}))},t.prototype.list=function(){return this.verifyNotSlimMode(),Qn.all},t.prototype.import=function(t,e){var n=this;return new Promise((function(i,r){n.verifyNotSlimMode();var o={mode:e||"replace",layouts:t};n.invokeMethodAndTrack("T42.ACS.ImportLayouts",o,i,r,!0)}))},t.prototype.export=function(t){var e=this;return new Promise((function(n,i){e.invokeMethodAndTrack("T42.ACS.ExportLayouts",{},(function(i){var r=e.getObjectValues(i.Layouts).map((function(t){return new ei(ti(t))}));t&&(r=r.filter((function(e){return e.type===t}))),n(r)}),i,!0)}))},t.prototype.rename=function(t,e){var n=this;return new Promise((function(i,r){if(n.verifyNotSlimMode(),!t)throw Error("layout argument is required");if(!t.name)throw Error("name argument is required");if(!t.type)throw Error("type argument is required");var o={type:t.type,oldName:t.name,newName:e};n.invokeMethodAndTrack("T42.ACS.RenameLayout",o,i,r)}))},t.prototype.updateMetadata=function(t){var e=this;return new Promise((function(n,i){if(!t)throw Error("layout argument is required");if(!t.name)throw Error("name argument is required");if(!t.type)throw Error("type argument is required");if(!t.metadata)throw Error("metadata argument is required");var r={name:t.name,type:t.type,metadata:t.metadata};e.invokeMethodAndTrack("T42.ACS.UpdateMetadata",r,n,i,!0)}))},t.prototype.hibernate=function(t,e){var n=this;return new Promise((function(i,r){if(!t)return r("name cannot be empty");var o={name:t,type:"Global",context:(e=e||{}).context||{},metadata:e.metadata||{}};n.invokeMethodAndTrack("T42.ACS.HibernateLayout",o,i,r,!0)}))},t.prototype.resume=function(t,e,i){var r=this;return new Promise((function(o,s){if(!t)return s("name cannot be empty");var a=n({name:t,type:"Global",context:e},i);r.invokeMethodAndTrack("T42.ACS.ResumeLayout",a,o,s,!0)}))},t.prototype.getCurrentLayout=function(){return i(this,void 0,void 0,(function(){var t,e;return r(this,(function(n){switch(n.label){case 0:return[4,this.config.agm.invoke("T42.ACS.GetCurrentLayout",{},"best",{methodResponseTimeoutMs:12e4})];case 1:return t=n.sent(),(e=t.returned.layout)?(this.isSlimMode()||(e=this.list().find((function(t){return t.name===e.name&&t.type===e.type}))),[2,e]):[2,void 0]}}))}))},t.prototype.onAdded=function(t){var e=this.callbacks.add("added",t);return Qn.all.length>0&&Qn.all.forEach((function(e){try{t(e)}catch(t){}})),e},t.prototype.onRemoved=function(t){return this.callbacks.add("removed",t)},t.prototype.onChanged=function(t){return this.callbacks.add("changed",t)},t.prototype.onRestored=function(t){return this.callbacks.add("restored",t)},t.prototype.onRenamed=function(t){return this.callbacks.add("renamed",t)},t.prototype.onEvent=function(t){return this.stream.onEvent(t)},t.prototype.onSaveRequested=function(t){return this.provider.onSaveRequested(t)},t.prototype.updateAppContextInCurrent=function(t){var e=this;return new Promise((function(n,i){t&&"object"!=typeof t&&i("context must be an object");var r={context:t=null!=t?t:{}};e.invokeMethodAndTrack("T42.ACS.UpdateLayoutComponentContext",r,n,i,!0)}))},t.prototype.updateDefaultContext=function(t){var e=this;return new Promise((function(n,i){t&&"object"!=typeof t&&i("context must be an object");var r={context:t=null!=t?t:{}};e.invokeMethodAndTrack("T42.ACS.UpdateDefaultContext",r,n,i,!0)}))},t.prototype.get=function(t,e){var n=this.list().find((function(n){return n.name===t&&n.type===e}));return n?Promise.resolve(n):Promise.reject("can not find layout with name="+t+" and type="+e)},t.prototype.getAll=function(t){var e=this.list().filter((function(e){return t===e.type}));return Promise.resolve(e)},t.prototype.isSlimMode=function(){return"slim"===this.config.mode},t.prototype.verifyNotSlimMode=function(){if(this.isSlimMode())throw Error("Operation not allowed in slim mode. Run in full mode.")},t.prototype.isVisibleWindow=function(t){return"exe"===t.application.type||"node"===t.application.type||("activity"===t.application.type||!(!t||!t.window)&&t.window.isVisible)},t.prototype.invokeMethodAndTrack=function(t,e,n,i,r){var o,s=r,a=Vn();e.token=a;var c=function(){s&&o&&n(o)};r||this.stream.waitFor(a).then((function(){s=!0,c()})).catch((function(t){i(t)}));this.config.agm.invoke(t,e,"best",{methodResponseTimeoutMs:12e4}).then((function(e){e.returned||i("No result from method "+t),e.returned.status&&"Success"!==e.returned.status&&"PartialSuccess"!==e.returned.status&&i(e.returned),o=e.returned,c()})).catch((function(t){return i(t)}))},t.prototype.getInstancesToClose=function(t){var e=this,n=[],i=this.appManager.applications().filter((function(t){return t.isShell}))[0],r=i?i.name:"AppManager";return this.appManager.instances().forEach((function(i){e.appManager.myInstance&&i.id===e.appManager.myInstance.id||i.application.name!==r&&e.isVisibleWindow(i)&&("Activity"===t.type&&i.activityId!==t.activityIdToJoin||n.push({application:i.application.name,instance:i.id}))})),n},t.prototype.getObjectValues=function(t){return t?Object.keys(t).map((function(e){return t[e]})):[]},t}(),ii=function(){function t(t,e){var n=this;this.agm=t,this.callbacks=e,this.ready=new Promise((function(t,e){n.resolveReady=t,n.rejectReady=e})),this.gotSnapshot=new Promise((function(t,e){n.resolveGotSnapshot=t,n.rejectGotSnapshot=e}))}return t.prototype.subscribe=function(t){var e=this,n=function(t){return e.getObjectValues(t).map((function(t){return ti(t)}))};this.checkForLayoutEventMethod()?this.agm.subscribe("T42.ACS.OnLayoutEvent",{waitTimeoutMs:1e4}).then((function(t){t.onData((function(t){var i=t.data;i.IsSnapshot&&e.resolveGotSnapshot(),e.addLayouts(n(i.OnLayoutAdded)),e.removeLayouts(n(i.OnLayoutRemoved)),e.changeLayouts(n(i.OnLayoutChanged)),e.renameLayouts(n(i.OnLayoutRenamed)),e.restoredLayout(n(i.OnLayoutRestored)),e.callbacks.execute("streamEvent",i)})),t.onFailed((function(t){var n="can not subscribe to T42.ACS.OnLayoutEvent "+t;e.rejectReady(n),e.rejectGotSnapshot(n)})),e.resolveReady()})).catch((function(t){var n="Error subscribing for T42.ACS.OnLayoutEvent stream. Err: "+t;e.rejectReady(n),e.rejectGotSnapshot(n)})):(t&&this.resolveReady(),setTimeout((function(){e.subscribe(!0)}),500))},t.prototype.onEvent=function(t){return this.callbacks.add("streamEvent",t)},t.prototype.waitFor=function(t,e){var n=this;return e||(e=1e4),new Promise((function(i,r){var o=!1,s=n.onEvent((function(e){e.Token===t&&(o=!0,s(),i())}));setTimeout((function(){o||r("timed out")}),e)}))},t.prototype.checkForLayoutEventMethod=function(){try{return-1!==this.agm.methods().map((function(t){return t.name})).indexOf("T42.ACS.OnLayoutEvent")}catch(t){return!1}},t.prototype.addLayouts=function(t){var e=this;t&&t.forEach((function(t){var n=new ei(t);Qn.add(n),e.callbacks.execute("added",n)}))},t.prototype.removeLayouts=function(t){var e=this;t&&t.forEach((function(t){Qn.removeWhere((function(n){return!e.compareLayouts(n,t)})),e.callbacks.execute("removed",t)}))},t.prototype.changeLayouts=function(t){var e=this;t&&t.forEach((function(t){Qn.removeWhere((function(n){return!e.compareLayouts(n,t)})),Qn.add(new ei(t)),e.callbacks.execute("changed",t)}))},t.prototype.renameLayouts=function(t){var e=this;t&&t.forEach((function(t){var n=Qn.first((function(n){return e.compareLayouts(n,{type:t.type,name:t.oldName})}));if(!n)throw Error("received rename event for unknown layout with type "+t.type+" and name "+t.oldName);n.name=t.newName,e.callbacks.execute("renamed",n)}))},t.prototype.compareLayouts=function(t,e){return t.name===e.name&&t.type===e.type},t.prototype.getObjectValues=function(t){return t?Object.keys(t).map((function(e){return t[e]})):[]},t.prototype.restoredLayout=function(t){var e=this;t&&t.forEach((function(t){var n=Qn.first((function(n){return e.compareLayouts(n,{type:t.type,name:t.name})}));e.callbacks.execute("restored",n)}))},t}();function ri(t){if(!t.agm)throw Error("config.agm is required");if(!t.logger)throw Error("config.logger is required");t.mode=t.mode||"slim";var e,n=t.logger,i=hn();return t.mode,e=new ii(t.agm,i),new ni(t,e,i,n)}var oi,si,ai,ci=function(){function t(t,e){var o=this;this._agm=t,this._logger=e,this.all=function(){return i(o,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,this.callGD(oi.GetAll,{})];case 1:return[2,t.sent().map(this.decorateDisplay)]}}))}))},this.get=function(t){return i(o,void 0,void 0,(function(){var e;return r(this,(function(n){switch(n.label){case 0:return[4,this.callGD(oi.Get,{id:t})];case 1:return e=n.sent(),[2,this.decorateDisplay(e)]}}))}))},this.getPrimary=function(){return i(o,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,this.all()];case 1:return[2,t.sent().find((function(t){return t.isPrimary}))]}}))}))},this.capture=function(t){return i(o,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.callGD(oi.Capture,n({},t))];case 1:return[2,e.sent()]}}))}))},this.captureAll=function(t){return i(o,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.callGD(oi.CaptureAll,n({},t))];case 1:return[2,e.sent()]}}))}))},this.getMousePosition=function(){return i(o,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,this.callGD(oi.GetMousePosition)];case 1:return[2,t.sent()]}}))}))},this.callGD=function(t,e){return i(o,void 0,void 0,(function(){return r(this,(function(i){switch(i.label){case 0:return[4,this._agm.invoke("T42.Displays.Command",{options:n({},e),command:t})];case 1:return[2,i.sent().returned.data]}}))}))},this.decorateDisplay=function(t){return n(n({},t),{capture:function(e){return o.capture({id:t.id,size:e})}})}}return t.prototype.getByWindowId=function(t){return this.callGD(oi.GetByWindowId,{id:t})},t}();function ui(t,e){return i(this,void 0,void 0,(function(){return r(this,(function(n){return si.invoke("T42.Channels.Announce",{swId:null!=e?e:ai,command:"switchChannel",data:{newChannel:t}}),[2]}))}))}!function(t){t.Capture="capture",t.CaptureAll="captureAll",t.GetAll="getAll",t.Get="get",t.GetByWindowId="getByWindowId",t.GetMousePosition="getMousePosition"}(oi||(oi={}));var di="___channel___",pi=function(){function t(t){this.contexts=t}return t.prototype.subscribe=function(t){this.callback=t},t.prototype.subscribeFor=function(t,e){if(!this.isChannel(t))return Promise.reject(new Error("Channel with name: "+t+" doesn't exist!"));var n=this.createContextName(t);return this.contexts.subscribe(n,(function(t,n,i,r,o){var s;e(t.data,t,null===(s=o)||void 0===s?void 0:s.updaterId)}))},t.prototype.switchChannel=function(t){return i(this,void 0,void 0,(function(){var e,n,i=this;return r(this,(function(r){switch(r.label){case 0:return this.unsubscribe(),e=this.createContextName(t),n=this,[4,this.contexts.subscribe(e,(function(t,e,n,r,o){var s;i.callback&&i.callback(t.data,t,null===(s=o)||void 0===s?void 0:s.updaterId)}))];case 1:return n.unsubscribeFunc=r.sent(),[2]}}))}))},t.prototype.unsubscribe=function(){this.unsubscribeFunc&&this.unsubscribeFunc()},t.prototype.all=function(){return this.contexts.all().filter((function(t){return t.startsWith(di)})).map((function(t){return t.substr(di.length)}))},t.prototype.getContextData=function(t){var e=this;return new Promise((function(n,i){if(!e.isChannel(t))return i(new Error("A channel with name: "+t+" doesn't exist!"));var r=e.createContextName(t);e.contexts.subscribe(r,(function(t){n(t)})).then((function(t){return t()}))}))},t.prototype.updateChannel=function(t,e){var n=this.createContextName(t);return this.contexts.update(n,e)},t.prototype.updateData=function(t,e){var n=this.createContextName(t);if(this.contexts.setPathSupported){var i=Object.keys(e).map((function(t){return{path:"data."+t,value:e[t]}}));return this.contexts.setPaths(n,i)}return this.contexts.update(n,{data:e})},t.prototype.isChannel=function(t){return this.all().some((function(e){return e===t}))},t.prototype.createContextName=function(t){return di+t},t}(),hi=function(){function t(t,e,n,i){this.shared=t,this.interop=e,this.getWindows=n,this.logger=i,this.subsKey="subs",this.changedKey="changed",this.isInitialJoin=!0,this.registry=hn(),this.shared.subscribe(this.handler.bind(this)),"undefined"!=typeof window&&(this.currentContext=window.glue42gd.initialChannel,this.currentContext&&this.joinNoSelectorSwitch(this.currentContext))}return t.prototype.subscribe=function(t){if("function"!=typeof t)throw new Error("Please provide the callback as a function!");return this.registry.add(this.subsKey,t)},t.prototype.subscribeFor=function(t,e){return i(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:if("string"!=typeof t)throw new Error("Please provide the name as a string!");if("function"!=typeof e)throw new Error("Please provide the callback as a function!");return[4,this.shared.subscribeFor(t,e)];case 1:return[2,n.sent()]}}))}))},t.prototype.publish=function(t,e){return i(this,void 0,void 0,(function(){return r(this,(function(n){if("object"!=typeof t)throw new Error("Please provide the data as an object!");if(e){if("string"!=typeof e)throw new Error("Please provide the name as a string!");return this.shared.isChannel(e)?[2,this.shared.updateData(e,t)]:[2,Promise.reject(new Error("A channel with name: "+e+" doesn't exist!"))]}if(!this.currentContext)throw new Error("Not joined to any channel!");return[2,this.shared.updateData(this.currentContext,t)]}))}))},t.prototype.all=function(){var t=this.shared.all();return Promise.resolve(t)},t.prototype.list=function(){return i(this,void 0,void 0,(function(){var t,e=this;return r(this,(function(n){switch(n.label){case 0:return[4,this.all()];case 1:return t=n.sent(),[4,Promise.all(t.map((function(t){return e.get(t)})))];case 2:return[2,n.sent()]}}))}))},t.prototype.get=function(t){return"string"!=typeof t?Promise.reject(new Error("Please provide the channel name as a string!")):this.shared.getContextData(t)},t.prototype.getMy=function(){return this.currentContext?this.get(this.currentContext):Promise.resolve(void 0)},t.prototype.join=function(t){return i(this,void 0,void 0,(function(){return r(this,(function(e){return[2,this.joinCore(t)]}))}))},t.prototype.joinNoSelectorSwitch=function(t){return i(this,void 0,void 0,(function(){return r(this,(function(e){return[2,this.joinCore(t,!1)]}))}))},t.prototype.leave=function(){return this.leaveCore()},t.prototype.leaveNoSelectorSwitch=function(){return this.leaveCore(!1)},t.prototype.current=function(){return this.currentContext},t.prototype.my=function(){return this.current()},t.prototype.changed=function(t){if("function"!=typeof t)throw new Error("Please provide the callback as a function!");return this.registry.add(this.changedKey,t)},t.prototype.onChanged=function(t){return this.changed(t)},t.prototype.add=function(t){return i(this,void 0,void 0,(function(){var e;return r(this,(function(n){switch(n.label){case 0:if("object"!=typeof t)throw new Error("Please provide the info as an object!");if(void 0===t.name)throw new Error("info.name is missing!");if("string"!=typeof t.name)throw new Error("Please provide the info.name as a string!");if(void 0===t.meta)throw new Error("info.meta is missing!");if("object"!=typeof t.meta)throw new Error("Please provide the info.meta as an object!");if(void 0===t.meta.color)throw new Error("info.meta.color is missing!");if("string"!=typeof t.meta.color)throw new Error("Please provide the info.meta.color as a string!");return e={name:t.name,meta:t.meta||{},data:t.data||{}},[4,this.shared.updateChannel(t.name,e)];case 1:return n.sent(),[2,e]}}))}))},t.prototype.getWindowsOnChannel=function(t){return i(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.getWindowsWithChannels({channels:[t]})];case 1:return[2,e.sent().map((function(t){return t.window}))]}}))}))},t.prototype.getWindowsWithChannels=function(t){var e,n;return i(this,void 0,void 0,(function(){var i,o,s;return r(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,this.interop.invoke("T42.Channels.Announce",{command:"getChannelsInfo",data:{filter:t}})];case 1:return i=r.sent(),o=this.getWindows(),(null===(n=null===(e=i)||void 0===e?void 0:e.returned)||void 0===n?void 0:n.windows)?[2,i.returned.windows.map((function(t){return{window:o.findById(t.windowId),channel:t.channel,application:t.application}}))]:[3,3];case 2:return s=r.sent(),this.logger.error("Error getting all channel enabled windows. This method is available since Glue42 3.12",s),[3,3];case 3:return[2,[]]}}))}))},t.prototype.handler=function(t,e,n){this.registry.execute(this.subsKey,t,e,n)},t.prototype.joinCore=function(t,e){return void 0===e&&(e=!0),i(this,void 0,void 0,(function(){var n,i=this;return r(this,(function(r){switch(r.label){case 0:if("string"!=typeof t)throw new Error("Please provide the channel name as a string!");return this.isInitialJoin||t!==this.currentContext?(this.isInitialJoin=!1,(n=function(t){return i.shared.all().includes(t)})(t)?[3,2]:[4,new Promise((function(e,i){var r,o=setInterval((function(){n(t)&&(clearTimeout(r),clearInterval(o),e())}),100);r=setTimeout((function(){return clearInterval(o),i(new Error("A channel with name: "+t+" doesn't exist!"))}),3e3)}))]):[2];case 1:r.sent(),r.label=2;case 2:return this.currentContext=t,[4,this.shared.switchChannel(t)];case 3:return r.sent(),e&&ui(t),this.registry.execute(this.changedKey,t),[2]}}))}))},t.prototype.leaveCore=function(t){return void 0===t&&(t=!0),this.currentContext=void 0,this.registry.execute(this.changedKey,void 0),this.shared.unsubscribe(),t&&ui(),Promise.resolve()},t}();function li(t,e,n,o){var s=new pi(t),a=new hi(s,e,n,o);return function(t,e){i(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return si=t,"undefined"!=typeof window&&window.glue42gd&&(ai=window.glue42gd.windowId),ai?[4,si.register("T42.Channels.Command",(function(t){var n=t.command;if(!n)throw new Error("missing command argument");if("join"!==n){if("leave"!==n){if("get"===n)return{id:i=e.current()};throw new Error("unknown command "+n)}e.leaveNoSelectorSwitch()}else{var i;if(!(i=t.channel))throw new Error("missing argument id");e.joinNoSelectorSwitch(i)}}))]:[2];case 1:return n.sent(),si.invoke("T42.Channels.Announce",{swId:ai,instance:si.instance.instance}),[2]}}))}))}(e,a),{subscribe:a.subscribe.bind(a),subscribeFor:a.subscribeFor.bind(a),publish:a.publish.bind(a),all:a.all.bind(a),list:a.list.bind(a),get:a.get.bind(a),join:a.join.bind(a),leave:a.leave.bind(a),current:a.current.bind(a),my:a.my.bind(a),changed:a.changed.bind(a),onChanged:a.onChanged.bind(a),add:a.add.bind(a),getWindowsOnChannel:a.getWindowsOnChannel.bind(a),getWindowsWithChannels:a.getWindowsWithChannels.bind(a),getMy:a.getMy.bind(a),ready:function(){return t.ready()}}}var fi="T42.Hotkeys.Command",gi=function(){function t(t){this.agm=t,this.registry=hn(),this.firstHotkey=!0,this.hotkeys=new Map}return t.prototype.register=function(t,e){return i(this,void 0,void 0,(function(){var n;return r(this,(function(i){switch(i.label){case 0:if(void 0===t)throw new Error("Hotkey parameter missing");if("string"==typeof t)t={hotkey:t};else{if(!t.hotkey)throw new Error("Info's hotkey parameter missing");t={hotkey:t.hotkey,description:t.description}}if(n=this.formatHotkey(t.hotkey),this.hotkeys.has(n))throw new Error("Shortcut for "+n+" already registered");return this.firstHotkey?(this.firstHotkey=!1,[4,this.registerInvokeAGMMethod()]):[3,2];case 1:i.sent(),i.label=2;case 2:return this.registry.add(n,e),[4,this.agm.invoke(fi,{command:"register",hotkey:n,description:t.description})];case 3:return i.sent(),this.hotkeys.set(n,t),[2]}}))}))},t.prototype.unregister=function(t){return i(this,void 0,void 0,(function(){var e;return r(this,(function(n){switch(n.label){case 0:if(void 0===t)throw new Error("hotkey parameter missing");if("string"!=typeof t)throw new Error("hotkey parameter must be string");return e=this.formatHotkey(t),[4,this.agm.invoke(fi,{command:"unregister",hotkey:e})];case 1:return n.sent(),this.hotkeys.delete(e),this.registry.clearKey(e),[2]}}))}))},t.prototype.unregisterAll=function(){return i(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,this.agm.invoke(fi,{command:"unregisterAll"})];case 1:return t.sent(),this.hotkeys.clear(),this.registry.clear(),[2]}}))}))},t.prototype.isRegistered=function(t){var e=this.formatHotkey(t);return this.hotkeys.has(e)},t.prototype.registerInvokeAGMMethod=function(){var t=this;this.agm.register("T42.Hotkeys.Invoke",(function(e){var n=e.key.toLowerCase(),i=t.hotkeys.get(n);t.registry.execute(n,i)}))},t.prototype.formatHotkey=function(t){if(t)return t.replace(/\s/g,"").toLowerCase()},t}();var yi="5.7.1",vi=function(t){function e(t,e,n){if("boolean"!=typeof t||t){var i=function t(e,n,i){if("object"==typeof e)return t(e.mode,n,i)+"";if(void 0===e)return"boolean"!=typeof n||n?n+"":void 0;if("boolean"==typeof e)return e?(void 0===i?n:i)+"":void 0;return e+""}(t,e,n);return"object"==typeof t?(t.mode=i,t):{mode:i}}}return{layouts:e(t.layouts,"slim"),activities:e(t.activities,"trackMyTypeAndInitiatedFromMe"),appManager:e(t.appManager,!1,"startOnly"),windows:e(t.windows,!0),channels:e(t.channels||!1,!1),displays:e(t.displays,!0)}},mi=function(){function t(t){this.options=t,this.callbacks=hn(),this.actions=t.actions,this.body=t.body,this.badge=t.badge,this.data=t.data,this.dir=t.dir,this.icon=t.icon,this.image=t.image,this.lang=t.lang,this.renotify=t.renotify,this.requireInteraction=t.requireInteraction,this.silent=t.silent,this.tag=t.tag,this.timestamp=t.timestamp,this.title=t.title}return t.prototype.close=function(){throw new Error("Method not implemented.")},t.prototype.addEventListener=function(t,e,n){this.callbacks.add(t,e)},t.prototype.removeEventListener=function(t,e,n){},t.prototype.dispatchEvent=function(t){return this.callbacks.execute(t.type,t),!0},t}(),wi=function(){function t(t){this.interop=t}return t.prototype.toggle=function(){return this.interop.invoke("T42.Notifications.Show")},t.prototype.show=function(){return this.interop.invoke("T42.Notifications.Show",{show:!0})},t.prototype.hide=function(){return this.interop.invoke("T42.Notifications.Hide")},t.prototype.isVisible=function(){throw new Error("Method not implemented.")},t}(),bi=function(){function t(t){this.interop=t,this.methodsRegistered=!1,this.methodNameRoot="T42.Notifications.Handler-"+Vn(),this.nextId=0,this.notifications={},this.panel=new wi(t)}return Object.defineProperty(t.prototype,"maxActions",{get:function(){return 2},enumerable:!0,configurable:!0}),t.prototype.raise=function(t){var e,n,o,s;return i(this,void 0,void 0,(function(){var i,a,c,u,d,p,h,l,f,g,y,v,m;return r(this,(function(r){switch(r.label){case 0:if(!t)throw new Error("invalid options - should be an object");if(!t.title)throw new Error("invalid options - should have title");if(this.methodsRegistered)return[3,2];for(i=[],p=0;p<this.maxActions;p++)i.push(this.interop.register(this.methodNameRoot+"_"+p,this.handleNotificationAction.bind(this)));return[4,Promise.all(i)];case 1:r.sent(),this.methodsRegistered=!0,r.label=2;case 2:if(a=String(this.nextId++),e=t.type,c=null!=e?e:"Notification",u={title:t.title,type:c,severity:(n=t.severity,null!=n?n:"None"),description:t.body,glueRoutingDetailMethodName:this.methodNameRoot+"_0",actions:[],sourceId:a,source:t.source},t.actions)for(d=t.actions.slice(0,this.maxActions),p=0,h=function(t){var e={g42notificationId:a,g42action:t.action,g42interopMethod:null===(o=t.interop)||void 0===o?void 0:o.method,g42interopTarget:null===(s=t.interop)||void 0===s?void 0:s.target},n=Object.keys(e).map((function(t){return{name:t,value:{stringValue:e[t]}}})),i={name:l.methodNameRoot+"_"+p,description:t.title,displayName:t.title,parameters:n};u.actions.push(i),p++},l=this,f=0,g=d;f<g.length;f++)y=g[f],h(y);return t.icon&&(u.attributes=u.attributes||[],u.attributes.push({key:"icon",value:{stringValue:t.icon}})),t.data&&(u.attributes=u.attributes||[],v=JSON.stringify(t.data),u.attributes.push({key:"data",value:{stringValue:v}})),[4,this.interop.invoke("T42.GNS.Publish.RaiseNotification",{notification:u})];case 3:return r.sent(),m=new mi(t),this.notifications[a]=m,[2,m]}}))}))},t.prototype.setFilter=function(t){return i(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.interop.invoke("T42.Notifications.Filter",t)];case 1:return[2,e.sent().returned]}}))}))},t.prototype.getFilter=function(){return i(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,this.interop.invoke("T42.Notifications.Filter")];case 1:return[2,t.sent().returned]}}))}))},t.prototype.handleNotificationAction=function(t){if(t.g42notificationId){var e=t,n=e.g42notificationId;if(!(o=this.notifications[n]))return;var i=new Event("onaction");i.action=e.g42action,o.onaction&&o.onaction(i);var r=(o.actions||[]).find((function(t){return t.action===e.g42action})).interop;r&&this.interop.invoke(r.method,r.arguments||{},r.target||"best"),o.dispatchEvent(i)}else if(t.notification&&t.notification.sourceNotificationId){var o;n=t.notification.sourceNotificationId;if(!(o=this.notifications[n]))return;var s=new Event("onclick");o.onclick&&o.onclick(s);var a=o.options.clickInterop;a&&this.interop.invoke(a.method,a.arguments||{},a.target||"best"),o.dispatchEvent(s)}},t}(),_i=function(){function t(t){this.core=t,this.registry=hn(),this.isSubscribed=!1,this.getConfiguration()}return t.prototype.list=function(){return i(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,this.getConfiguration()];case 1:if(t.sent(),!this.getMethodName)throw new Error("not supported");return[4,this.getAll()];case 2:return[2,t.sent().returned.all]}}))}))},t.prototype.getCurrent=function(){return i(this,void 0,void 0,(function(){var t;return r(this,(function(e){switch(e.label){case 0:return[4,this.getConfiguration()];case 1:if(e.sent(),!this.getMethodName)throw new Error("not supported");return[4,this.getAll()];case 2:return[2,(t=e.sent()).returned.all.find((function(e){return e.name===t.returned.selected}))]}}))}))},t.prototype.select=function(t){return i(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.getConfiguration()];case 1:if(e.sent(),!this.setMethodName)throw new Error("not supported");return[4,this.core.interop.invoke(this.setMethodName,{theme:t})];case 2:return e.sent(),[2]}}))}))},t.prototype.onChanged=function(t){return this.subscribe(),this.registry.add("changed",t)},t.prototype.getConfiguration=function(){return i(this,void 0,void 0,(function(){var t;return r(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),this.sharedContextName?[2]:[4,this.core.interop.invoke("T42.Themes.Configuration")];case 1:return t=e.sent(),this.sharedContextName=t.returned.sharedContextName,this.getMethodName=t.returned.getThemesMethodName,this.setMethodName=t.returned.setThemesMethodName,[3,3];case 2:return e.sent(),[2];case 3:return[2]}}))}))},t.prototype.getAll=function(){return i(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,this.getConfiguration()];case 1:return t.sent(),[4,this.core.interop.invoke(this.getMethodName)];case 2:return[2,t.sent()]}}))}))},t.prototype.subscribe=function(){return i(this,void 0,void 0,(function(){var t=this;return r(this,(function(e){switch(e.label){case 0:return[4,this.getConfiguration()];case 1:return e.sent(),this.isSubscribed?[2]:(this.isSubscribed=!0,this.core.contexts.subscribe(this.sharedContextName,(function(e){e&&e.all&&e.selected&&t.registry.execute("changed",e.all.find((function(t){return t.name===e.selected})))})),[2])}}))}))},t}();var Ii,Ci="Tick42.FDC3.Intents.",Ai=function(){function t(t,e,n){this.interop=t,this.windows=e,this.logger=n}return t.prototype.find=function(t){return i(this,void 0,void 0,(function(){var e,n;return r(this,(function(i){switch(i.label){case 0:return[4,this.all()];case 1:if(e=i.sent(),void 0===t)return[2,e];if("string"==typeof t)return[2,e.filter((function(e){return e.name===t}))];if("object"!=typeof t)throw new Error("Please provide the intentFilter as a string or an object!");return t.contextType&&(n=t.contextType.toLowerCase(),e=e.filter((function(t){return t.handlers.some((function(t){var e;return null===(e=t.contextTypes)||void 0===e?void 0:e.some((function(t){return t.toLowerCase()===n}))}))}))),t.name&&(e=e.filter((function(e){return e.name===t.name}))),[2,e]}}))}))},t.prototype.raise=function(t){return i(this,void 0,void 0,(function(){var e,n,i,o,s,a,c,u,d;return r(this,(function(r){switch(r.label){case 0:if("string"!=typeof t&&"object"!=typeof t||"object"==typeof t&&"string"!=typeof t.intent)throw new Error("Please provide the intent as a string or an object with an intent property!");return"string"==typeof t&&(t={intent:t}),e=t.intent,[4,this.get(e)];case 1:if(void 0===(n=r.sent()))throw new Error("Intent "+e+" not found.");if(i=!n.handlers.some((function(t){return"app"===t.type})),o=t.target||(i?"reuse":"startNew"),a=n.handlers.find((function(t){return"app"===t.type})),"startNew"===o)s=a;else if("reuse"===o)c=n.handlers.find((function(t){return"instance"===t.type})),s=c||a;else if(o.instance)s=n.handlers.find((function(t){return"instance"===t.type&&t.instanceId===o.instance}));else{if(!o.app)throw new Error("Invalid intent target: "+JSON.stringify(o));s=n.handlers.find((function(t){return"app"===t.type&&t.applicationName===o.app}))}if(!s)throw new Error("Can not raise intent for request "+JSON.stringify(t)+" - can not find intent handler.");return u=s.instanceId,"app"!==s.type?[3,3]:[4,this.startApp(s.applicationName,t.options)];case 2:u=r.sent(),r.label=3;case 3:return[4,this.raiseIntentToInstance(u,e,t.context)];case 4:return(d=r.sent()).request=t,d.handler=s,[2,d]}}))}))},t.prototype.all=function(){return i(this,void 0,void 0,(function(){var t,e,n,o,s,a,c,u,d,p,h,l,f,g,y,v,m,w,b,_,I,C=this;return r(this,(function(A){switch(A.label){case 0:return A.trys.push([0,2,,3]),[4,this.interop.invoke("T42.ACS.GetApplications",{withIntentsInfo:!0})];case 1:return m=A.sent(),t=m.returned.applications,[3,3];case 2:return e=A.sent(),this.logger.error("Failed to get the applications!",e),[2,[]];case 3:for(n={},o=t.filter((function(t){return t.intents&&t.intents.length>0})),s=0,a=o;s<a.length;s++)for(c=a[s],u=0,d=c.intents;u<d.length;u++)p=d[u],(h=n[p.name])||(h={name:p.name,handlers:[]},n[p.name]=h),l={applicationName:c.name,applicationTitle:c.title||"",applicationDescription:c.caption,displayName:p.displayName,contextTypes:p.contexts,applicationIcon:c.icon,type:"app"},h.handlers.push(l);if(f=this.interop.servers(),g=f.map((function(t){return t.windowId})).filter((function(t){return void 0!==t})),y="T42.Wnd.GetInfo",!this.interop.methods().some((function(t){return t.name===y})))return[3,7];A.label=4;case 4:return A.trys.push([4,6,,7]),[4,this.interop.invoke(y,{ids:g})];case 5:return m=A.sent(),v=m.returned.windows,[3,7];case 6:return A.sent(),[3,7];case 7:w=function(e){return r(this,(function(o){switch(o.label){case 0:return[4,Promise.all(e.getMethods().filter((function(t){return t.name.startsWith(Ci)})).map((function(o){return i(C,void 0,void 0,(function(){var i,s,a,c,u,d,p,h,l,f,g,y;return r(this,(function(r){switch(r.label){case 0:return i=o.name.replace(Ci,""),(s=n[i])||(s={name:i,handlers:[]},n[i]=s),a=o.flags.intent,(c=t.find((function(t){return t.name===e.application})))&&c.intents&&(u=c.intents.find((function(t){return t.name===i}))),[4,this.windowsIdToTitle(e.windowId,v)];case 1:return d=r.sent(),p={instanceId:e.instance,applicationName:e.application,applicationIcon:a.icon||(null===(h=c)||void 0===h?void 0:h.icon),applicationTitle:(null===(l=c)||void 0===l?void 0:l.title)||"",applicationDescription:a.description||(null===(f=c)||void 0===f?void 0:f.caption),displayName:a.displayName||(null===(g=u)||void 0===g?void 0:g.displayName),contextTypes:a.contextTypes||(null===(y=u)||void 0===y?void 0:y.contexts),instanceTitle:d,type:"instance"},s.handlers.push(p),[2]}}))}))})))];case 1:return o.sent(),[2]}}))},b=0,_=f,A.label=8;case 8:return b<_.length?(I=_[b],[5,w(I)]):[3,11];case 9:A.sent(),A.label=10;case 10:return b++,[3,8];case 11:return[2,Object.values(n)]}}))}))},t.prototype.addIntentListener=function(t,e){var n=this;if("string"!=typeof t&&"object"!=typeof t||"object"==typeof t&&"string"!=typeof t.intent)throw new Error("Please provide the intent as a string or an object with an intent property!");if("function"!=typeof e)throw new Error("Please provide the handler as a function!");var i={unsubscribe:function(){return console.log("Could not unsubscribe!")}},r="Tick42.FDC3.Intents."+("string"==typeof t?t:t.intent),o={};if("object"==typeof t){t.intent;o=function(t,e){var n={};for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.indexOf(i)<0&&(n[i]=t[i]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(t);r<i.length;r++)e.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(t,i[r])&&(n[i[r]]=t[i[r]])}return n}(t,["intent"])}return this.interop.register({name:r,flags:{intent:o}},(function(t){return e(t)})).then((function(){i.unsubscribe=function(){n.interop.unregister(r)}})),i},t.prototype.get=function(t){return i(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.all()];case 1:return[2,e.sent().find((function(e){return e.name===t}))]}}))}))},t.prototype.startApp=function(t,e){return i(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,this.interop.invoke("T42.ACS.StartApplication",{Name:t,options:e})];case 1:return[2,n.sent().returned.Id]}}))}))},t.prototype.raiseIntentToInstance=function(t,e,n){return i(this,void 0,void 0,(function(){var i,o,s=this;return r(this,(function(r){switch(r.label){case 0:return i="Tick42.FDC3.Intents."+e,(o=this.interop.servers().find((function(e){return e.instance===t})))?[3,2]:[4,new Promise((function(e,n){var i,r=s.interop.serverAdded((function(n){n.instance===t&&(o=n,e(),clearTimeout(i),r())}));i=setTimeout((function(){r(),n(new Error("Can not find interop server for instance "+t))}),3e4)}))];case 1:r.sent(),r.label=2;case 2:return o.getMethods().find((function(t){return t.name===i}))?[3,4]:[4,new Promise((function(e,n){var r,o=s.interop.methodAdded((function(t){t.name===i&&(e(),clearTimeout(r),o())}));r=setTimeout((function(){o(),n(new Error("Can not find interop method "+i+" for instance "+t))}),1e4)}))];case 3:r.sent(),r.label=4;case 4:return[4,this.interop.invoke(i,n,{instance:t})];case 5:return[2,{result:r.sent().returned}]}}))}))},t.prototype.windowsIdToTitle=function(t,e){var n,o,s;return i(this,void 0,void 0,(function(){var i;return r(this,(function(r){switch(r.label){case 0:return void 0!==e?[2,null===(n=e.find((function(e){return e.id===t})))||void 0===n?void 0:n.title]:(i=null===(o=this.windows)||void 0===o?void 0:o.findById(t),[4,null===(s=i)||void 0===s?void 0:s.getTitle()]);case 1:return[2,r.sent()]}}))}))},t}(),Ti=function(){function t(){var t=this;this.numberOfCalls=0,this.numberOfCalls=1,this.promise=new Promise((function(e,n){t.resolve=e,t.reject=n}))}return t.prototype.getPromise=function(){return this.numberOfCalls++,this.promise},t.prototype.done=function(t){this.resolve(t)},t.prototype.error=function(t){this.reject(t)},t}(),ki=function(){function t(t,e){this.appName=t,this.interop=e}return t.prototype.get=function(t){return i(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.interop.invoke("T42.Prefs.Get",{app:null!=t?t:this.appName})];case 1:return[2,e.sent().returned]}}))}))},t.prototype.set=function(t,e){var n,o;return i(this,void 0,void 0,(function(){return r(this,(function(i){switch(i.label){case 0:return[4,this.interop.invoke("T42.Prefs.Set",{app:(o=null===(n=e)||void 0===n?void 0:n.app,null!=o?o:this.appName),data:t,merge:!1})];case 1:return i.sent(),[2]}}))}))},t.prototype.update=function(t,e){var n,o;return i(this,void 0,void 0,(function(){return r(this,(function(i){switch(i.label){case 0:return[4,this.interop.invoke("T42.Prefs.Set",{app:(o=null===(n=e)||void 0===n?void 0:n.app,null!=o?o:this.appName),data:t,merge:!0})];case 1:return i.sent(),[2]}}))}))},t.prototype.clear=function(t){return i(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.interop.invoke("T42.Prefs.Set",{app:null!=t?t:this.appName,clear:!0})];case 1:return e.sent(),[2]}}))}))},t.prototype.getAll=function(){return i(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,this.interop.invoke("T42.Prefs.Get")];case 1:return[2,t.sent().returned]}}))}))},t.prototype.clearAll=function(){return i(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,this.interop.invoke("T42.Prefs.Set",{clear:!0})];case 1:return t.sent(),[2]}}))}))},t}(),Si=function(t){return i(void 0,void 0,void 0,(function(){var e,n,i;return r(this,(function(r){switch(r.label){case 0:if(e="undefined"!=typeof window&&window.glue42gd){if(Ii)return[2,Ii.getPromise()];Ii=new Ti}return[4,xi(t,e)];case 1:return n=r.sent(),null===(i=Ii)||void 0===i||i.resolve(n),[2,n]}}))}))},xi=function(t,e){return i(void 0,void 0,void 0,(function(){function n(t){if(v.windows){var e=f("windows",t.logger,v.windows);return g(b=Xn(t.agm,e,(function(){return m}),(function(){return _}),y)),b}}function i(t){var n,i;if(v.activities&&an.checkIsUsingGW3Implementation&&an.checkIsUsingGW3Implementation(t.connection)){var r=f("activity",t.logger,v.activities);return g(w=new an({connection:t.connection,contexts:t.contexts,agm:t.agm,logger:r,logLevel:"info",disableAutoAnnounce:!1,disposeRequestHandling:"exit",announcementInfo:null,windows:b,appManagerGetter:function(){return m},mode:v.activities.mode,typesToTrack:v.activities.typesToTrack,activityId:null===(i=null===(n=e)||void 0===n?void 0:n.activityInfo)||void 0===i?void 0:i.activityId,gdMajorVersion:y}).api),w}}function o(t){if(v.appManager){var e=f("appManager",t.logger,v.appManager);return g(m=In({agm:t.agm,windows:b,logger:e,activities:w,mode:v.appManager.mode,gdMajorVersion:y})),m}}function s(t){var e;if(v.layouts){var n=f("layouts",t.logger,v.layouts),i=v.layouts,r=ri({agm:t.agm,appManager:m,activityGetter:function(){return w},logger:n,mode:i.mode,autoSaveWindowContext:(e=i.autoSaveWindowContext,null!=e&&e),gdMajorVersion:y});return g(r),r}}function a(t){if(v.channels&&t.contexts){var e=f("channels",t.logger,v.channels),n=li(t.contexts,t.agm,(function(){return b}),e);return g(n),n}}function c(t){var e,n,i=(e=t.agm,{register:(n=new gi(e)).register.bind(n),unregister:n.unregister.bind(n),unregisterAll:n.unregisterAll.bind(n),isRegistered:n.isRegistered.bind(n),ready:function(){return Promise.resolve()}});return g(i),i}function u(t){var e=new Ai(t.agm,b,t.logger.subLogger("intents"));return g(e),e}function d(t){var e=new bi(t.interop);return g(e),e}function p(t){if(v.displays){var e=f("displays",t.logger,v.displays);return g(_=new ci(t.agm,e)),_}}function h(t){if(t.contexts){var e=function(t){var e=new _i(t);return{list:e.list.bind(e),getCurrent:e.getCurrent.bind(e),select:e.select.bind(e),onChanged:e.onChanged.bind(e),ready:function(){return Promise.resolve()}}}(t);return g(e),e}}function l(n){var i,r,o,s=null!=(o=null!=(i=t.application)?i:null===(r=e)||void 0===r?void 0:r.application)?o:n.interop.instance.application,a=new ki(s,n.interop);return g(a),a}function f(t,e,n){var i=e.subLogger(t);if(n&&n.logger){var r=n.logger;r.console&&i.consoleLevel(r.console),r.publish&&i.publishLevel(r.publish)}return i}function g(t){C.push(t)}var y,v,m,w,b,_,I,C,A,T;return r(this,(function(e){switch(e.label){case 0:return y=An.getGDMajorVersion(),v=vi(t=t||{}),t.gateway=t.gateway||{},I={libs:[{name:"windows",create:n},{name:"activities",create:i},{name:"appManager",create:o},{name:"layouts",create:s},{name:"channels",create:a},{name:"hotkeys",create:c},{name:"displays",create:p},{name:"intents",create:u},{name:"notifications",create:d},{name:"themes",create:h},{name:"prefs",create:l}],version:yi,enrichGlue:function(t){t.config.activities=v.activities,t.config.windows=v.windows,t.config.appManager=v.appManager,t.config.layouts=v.layouts,t.config.channels=v.channels,t.config.displays=v.displays}},C=[],"undefined"!=typeof window&&(window.glueFactoryLog||(window.glueFactoryLog=[]),window.glueFactoryLog.push(C)),[4,le(t,I)];case 1:return A=e.sent(),Array.isArray(null===(T=t)||void 0===T?void 0:T.libraries)&&t.libraries.length?[4,Promise.all(t.libraries.map((function(e){return e(A,t)})))]:[3,3];case 2:e.sent(),e.label=3;case 3:return[2,A]}}))}))};Si.coreVersion=le.version,Si.version=yi,Si.initInfo=Ii;var Pi=Si,Mi=!0;if("undefined"!=typeof window){var Ei=window.glue42gd;Ei&&Ei.autoInjected&&(Pi=window.Glue,Mi=!1),Mi&&(window.Glue=Pi),delete window.GlueCore}return Pi.default=Pi,Pi}));
//# sourceMappingURL=desktop.umd.min.js.map
